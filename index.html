<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Manager v2 - Sidebar Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.05)",
                        glassBorder: "rgba(255, 255, 255, 0.1)",
                    }
                }
            }
        }
    </script>

    <style>
        /* Animated Background Global */
        body {
            background: #0f172a; /* Fallback */
            color: #e2e8f0;
            overflow: hidden; /* Prevent body scroll, handle in containers */
            height: 100vh;
        }

        /* Dynamic Background Layer */
        #bg-layer {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background: linear-gradient(-45deg, #0f172a, #312e81, #4c1d95, #1e1b4b);
            background-size: 400% 400%;
            transition: background 1s ease; /* Smooth transition for theme change */
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glass Utility Classes */
        .glass-panel {
            background: rgba(17, 25, 40, 0.7);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-header {
            background: rgba(17, 25, 40, 0.4);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .glass-input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Nav Item Active State */
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 4px solid; /* Color injected by JS */
        }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* Modal */
        .modal { opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: transform 0.3s ease; }
        .modal.active .modal-content { transform: scale(1); }
        /* --- CUSTOM SCROLLBAR SIDEBAR --- */
/* Untuk Chrome, Safari, dan Edge */
.custom-scrollbar::-webkit-scrollbar {
    width: 4px; /* Sangat tipis */
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: transparent; /* Track transparan */
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.1); /* Warna thumb transparan halus */
    border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.3); /* Lebih terang saat di-hover */
}

/* Untuk Firefox */
.custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
}
    </style>
</head>
<body class="flex text-sm">

    <div id="bg-layer"></div>

  <aside class="w-72 h-screen flex flex-col shrink-0 z-50 relative border-r border-white/5 bg-[#0f172a]/60 backdrop-blur-2xl">
        
        <div class="absolute top-0 left-0 w-full h-64 bg-indigo-600/20 blur-[100px] rounded-full pointer-events-none -translate-y-1/2"></div>
        <div class="absolute bottom-0 right-0 w-40 h-40 bg-purple-600/10 blur-[80px] rounded-full pointer-events-none translate-y-1/2"></div>

        <div class="p-6 pb-2 relative z-10 shrink-0">
            <div class="flex items-center gap-4 mb-6 pl-2">
                <div id="logo-bg" class="w-11 h-11 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center shadow-[0_0_20px_rgba(99,102,241,0.4)] transition-all duration-500 group cursor-pointer hover:scale-105">
                    <i class="fa-solid fa-layer-group text-white text-lg drop-shadow-md group-hover:rotate-180 transition-transform duration-700"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 tracking-tight">Nexus</h1>
                    <p class="text-[10px] text-indigo-300/80 font-medium uppercase tracking-[0.2em]">Workspace</p>
                </div>
            </div>
            
            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-4 flex items-center gap-2 mb-2">
                <span class="w-1 h-1 rounded-full bg-slate-600"></span> Menu Utama
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar px-6 relative z-10 space-y-2 pb-4">
            
            <a href="#" onclick="switchCategory('Dashboard')" id="nav-Dashboard" class="nav-item active group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-indigo-500/20 group-hover:text-indigo-300 transition-colors">
                    <i class="fa-solid fa-house text-sm"></i>
                </div>
                <span class="font-medium text-sm">Dashboard</span>
            </a>

            <a href="#" onclick="switchCategory('SOP')" id="nav-SOP" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-cyan-500/20 group-hover:text-cyan-300 transition-colors">
                    <i class="fa-solid fa-book-open text-sm"></i>
                </div>
                <span class="font-medium text-sm">SOP System</span>
            </a>

            <a href="#" onclick="switchCategory('JobDesk')" id="nav-JobDesk" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-emerald-500/20 group-hover:text-emerald-300 transition-colors">
                    <i class="fa-solid fa-list-check text-sm"></i>
                </div>
                <span class="font-medium text-sm">Job Desk</span>
            </a>

            <a href="#" onclick="switchCategory('KPI')" id="nav-KPI" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-rose-500/20 group-hover:text-rose-300 transition-colors">
                    <i class="fa-solid fa-chart-pie text-sm"></i>
                </div>
                <span class="font-medium text-sm">KPI Monitor</span>
            </a>

            <a href="#" onclick="switchCategory('ProjectCharter')" id="nav-ProjectCharter" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-violet-500/20 group-hover:text-violet-300 transition-colors">
                    <i class="fa-solid fa-file-contract text-sm"></i>
                </div>
                <span class="font-medium text-sm">Project Charter</span>
            </a>

            <a href="#" onclick="switchCategory('BSC')" id="nav-BSC" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-amber-500/20 group-hover:text-amber-300 transition-colors">
                    <i class="fa-solid fa-scale-balanced text-sm"></i>
                </div>
                <span class="font-medium text-sm">Balanced Scorecard</span>
            </a>

            <a href="#" onclick="switchCategory('Agile')" id="nav-Agile" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-sky-500/20 group-hover:text-sky-300 transition-colors">
                    <i class="fa-solid fa-rocket text-sm"></i>
                </div>
                <span class="font-medium text-sm">Agile Project</span>
            </a>

            <a href="#" onclick="switchCategory('BRD')" id="nav-BRD" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-fuchsia-500/20 group-hover:text-fuchsia-300 transition-colors">
                    <i class="fa-solid fa-file-signature text-sm"></i>
                </div>
                <span class="font-medium text-sm">BRD Project Plan</span>
            </a>
            <a href="#" onclick="switchCategory('OKR')" id="nav-OKR" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-lime-500/20 group-hover:text-lime-300 transition-colors">
                        <i class="fa-solid fa-bullseye text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">OKR System</span>
                </a>
                <a href="#" onclick="switchCategory('Risk')" id="nav-Risk" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-red-500/20 group-hover:text-red-300 transition-colors">
                        <i class="fa-solid fa-shield-halved text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Risk Management</span>
                </a>
                <a href="#" onclick="switchCategory('Stakeholder')" id="nav-Stakeholder" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-teal-500/20 group-hover:text-teal-300 transition-colors">
                        <i class="fa-solid fa-handshake text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Stakeholder Analysis</span>
                </a>
                <a href="#" onclick="switchCategory('SWOT')" id="nav-SWOT" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-orange-500/20 group-hover:text-orange-300 transition-colors">
                        <i class="fa-solid fa-chess-board text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">SWOT Analysis</span>
                </a>
                <a href="#" onclick="switchCategory('QC')" id="nav-QC" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-emerald-500/20 group-hover:text-emerald-300 transition-colors">
                        <i class="fa-solid fa-clipboard-check text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Quality Control</span>
                </a>
                <a href="#" onclick="switchCategory('ChangeRequest')" id="nav-ChangeRequest" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-fuchsia-500/20 group-hover:text-fuchsia-300 transition-colors">
                        <i class="fa-solid fa-code-branch text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Change Request</span>
                </a>
                <a href="#" onclick="switchCategory('Appraisal')" id="nav-Appraisal" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-indigo-500/20 group-hover:text-indigo-300 transition-colors">
                        <i class="fa-solid fa-id-card-clip text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Appraisal</span>
                </a>
                <a href="#" onclick="switchCategory('Recruitment')" id="nav-Recruitment" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-pink-500/20 group-hover:text-pink-300 transition-colors">
                        <i class="fa-solid fa-user-group text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Recruitment</span>
                </a>
                <a href="#" onclick="switchCategory('Training')" id="nav-Training" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-cyan-500/20 group-hover:text-cyan-300 transition-colors">
                        <i class="fa-solid fa-graduation-cap text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Training (LMS)</span>
                </a>
                <a href="#" onclick="switchCategory('Procurement')" id="nav-Procurement" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-slate-500/20 group-hover:text-slate-300 transition-colors">
                        <i class="fa-solid fa-boxes-packing text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Procurement Plan</span>
                </a>
                <a href="#" onclick="switchCategory('KPA')" id="nav-KPA" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-purple-500/20 group-hover:text-purple-300 transition-colors">
                        <i class="fa-solid fa-user-tag text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">KPA (Appraisal)</span>
                </a>
                <a href="#" onclick="switchCategory('PIP')" id="nav-PIP" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-red-500/20 group-hover:text-red-300 transition-colors">
                        <i class="fa-solid fa-triangle-exclamation text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">PIP Monitor</span>
                </a>
                <a href="#" onclick="switchCategory('IDP')" id="nav-IDP" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-green-500/20 group-hover:text-green-300 transition-colors">
                        <i class="fa-solid fa-seedling text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">My IDP</span>
                </a>
                <a href="#" onclick="switchCategory('PostMortem')" id="nav-PostMortem" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-stone-500/20 group-hover:text-stone-300 transition-colors">
                        <i class="fa-solid fa-heart-crack text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Incident Review</span>
                </a>
                <a href="#" onclick="switchCategory('RICE')" id="nav-RICE" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-pink-500/20 group-hover:text-pink-300 transition-colors">
                        <i class="fa-solid fa-arrow-up-right-dots text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">RICE Scoring</span>
                </a>
                <a href="#" onclick="switchCategory('GapAnalysis')" id="nav-GapAnalysis" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-fuchsia-500/20 group-hover:text-fuchsia-300 transition-colors">
                        <i class="fa-solid fa-bridge-water text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Gap Analysis</span>
                </a>
                <a href="#" onclick="switchCategory('SIPOC')" id="nav-SIPOC" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-teal-500/20 group-hover:text-teal-300 transition-colors">
                        <i class="fa-solid fa-diagram-project text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">SIPOC Map</span>
                </a>
                <a href="#" onclick="switchCategory('5S')" id="nav-5S" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-lime-500/20 group-hover:text-lime-300 transition-colors">
                        <i class="fa-solid fa-broom text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">5S Audit (Lean)</span>
                </a>
                <a href="#" onclick="switchCategory('SLA')" id="nav-SLA" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-cyan-500/20 group-hover:text-cyan-300 transition-colors">
                        <i class="fa-solid fa-stopwatch text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">SLA Monitor</span>
                </a>
                <a href="#" onclick="switchCategory('FMEA')" id="nav-FMEA" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-orange-500/20 group-hover:text-orange-300 transition-colors">
                        <i class="fa-solid fa-helmet-safety text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">FMEA (Safety/Risk)</span>
                </a>
                <a href="#" onclick="switchCategory('KCI')" id="nav-KCI" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-zinc-500/20 group-hover:text-zinc-300 transition-colors">
                        <i class="fa-solid fa-file-shield text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Audit & Control (KCI)</span>
                </a>
                <a href="#" onclick="switchCategory('KRI')" id="nav-KRI" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-red-500/20 group-hover:text-red-300 transition-colors">
                        <i class="fa-solid fa-bell text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Key Risk Indicators</span>
                </a>
                <a href="#" onclick="switchCategory('MOST')" id="nav-MOST" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-indigo-500/20 group-hover:text-indigo-300 transition-colors">
                        <i class="fa-solid fa-layer-group text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">MOST Analysis</span>
                </a>
                <a href="#" onclick="switchCategory('WIG')" id="nav-WIG" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-rose-500/20 group-hover:text-rose-300 transition-colors">
                        <i class="fa-solid fa-flag-checkered text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">WIGs (4DX)</span>
                </a>
                <a href="#" onclick="switchCategory('V2MOM')" id="nav-V2MOM" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-sky-500/20 group-hover:text-sky-300 transition-colors">
                        <i class="fa-solid fa-cloud-bolt text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">V2MOM Strategy</span>
                </a>
                <a href="#" onclick="switchCategory('MBO')" id="nav-MBO" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-slate-500/20 group-hover:text-slate-300 transition-colors">
                        <i class="fa-solid fa-sitemap text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">MBO System</span>
                </a>
                <a href="#" onclick="switchCategory('CSF')" id="nav-CSF" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-amber-500/20 group-hover:text-amber-300 transition-colors">
                        <i class="fa-solid fa-crosshairs text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Critical Success Factors</span>
                </a>
                <a href="#" onclick="switchCategory('KRA')" id="nav-KRA" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-blue-500/20 group-hover:text-blue-300 transition-colors">
                        <i class="fa-solid fa-briefcase text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">Key Result Areas</span>
                </a>
                <a href="#" onclick="switchCategory('OGSM')" id="nav-OGSM" class="nav-item group flex items-center gap-4 px-4 py-3.5 rounded-xl text-slate-400 hover:text-white transition-all duration-300 hover:bg-white/5 border border-transparent hover:border-white/5 hover:pl-6">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center group-hover:bg-emerald-500/20 group-hover:text-emerald-300 transition-colors">
                        <i class="fa-solid fa-chess-rook text-sm"></i>
                    </div>
                    <span class="font-medium text-sm">OGSM Strategy</span>
                </a>
        </div>

        <div class="p-4 relative z-10 shrink-0 border-t border-white/5 bg-[#0f172a]/40 backdrop-blur-xl">
            <div onclick="openProfileModal()" class="group relative overflow-hidden bg-gradient-to-r from-white/5 to-white/0 border border-white/10 p-3 rounded-2xl cursor-pointer hover:border-white/20 hover:bg-white/10 transition-all duration-300">
                
                <div class="absolute inset-0 bg-indigo-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500 blur-xl"></div>

                <div class="flex items-center gap-3 relative z-10">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full p-[1px] bg-gradient-to-tr from-indigo-400 to-purple-400">
                            <img id="sidebarAvatar" src="https://ui-avatars.com/api/?name=Admin+User&background=1e1b4b&color=fff" class="w-full h-full rounded-full object-cover border-2 border-[#0f172a]">
                        </div>
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-emerald-500 rounded-full border-2 border-[#0f172a] shadow-[0_0_8px_rgba(16,185,129,0.8)] animate-pulse"></div>
                    </div>
                    
                    <div class="flex flex-col flex-1 overflow-hidden">
                        <span id="sidebarName" class="font-bold text-slate-200 text-sm group-hover:text-white transition-colors truncate">Administrator</span>
                        <span class="text-[10px] text-emerald-400 font-medium tracking-wider uppercase flex items-center gap-1.5">
                            <span class="w-1 h-1 rounded-full bg-emerald-400 animate-ping"></span> Online
                        </span>
                    </div>

                    <div class="w-7 h-7 rounded-lg bg-white/10 flex items-center justify-center text-slate-400 opacity-0 group-hover:opacity-100 translate-x-2 group-hover:translate-x-0 transition-all duration-300">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </div>
                </div>
            </div>
            
            <div class="mt-3 text-center">
                <p class="text-[9px] text-slate-600 font-medium">Nexus Manager v3.0</p>
            </div>
        </div>
    </aside>  
    <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
        
        <header class="glass-header w-full p-6 flex justify-between items-center z-40">
           <div>
                <h2 id="page-title" class="text-3xl md:text-4xl font-bold text-white tracking-tight mb-2 drop-shadow-md">
                    Dashboard Utama
                </h2>
                <p id="page-subtitle" class="text-slate-300 text-sm md:text-base font-medium opacity-90 leading-relaxed">
                    Ringkasan seluruh aktivitas project.
                </p>
            </div>

            <div class="flex items-center gap-4">
                <div class="relative group">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="searchInput" placeholder="Cari..." 
                        class="glass-input w-48 md:w-64 pl-10 pr-4 py-2.5 rounded-xl text-sm transition-all focus:w-80">
                </div>

                <div class="relative">
                    <select id="filterInput" class="glass-input w-40 pl-4 pr-8 py-2.5 rounded-xl text-sm appearance-none cursor-pointer bg-transparent focus:bg-[#1e293b] transition-colors">
                        </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-slate-500 pointer-events-none"></i>
                </div>

                <div id="timeWidget" class="hidden items-center gap-3 px-5 py-2 rounded-xl bg-white/5 border border-white/10 backdrop-blur-md shadow-lg select-none min-w-[180px]">
                    <div id="timeIconBg" class="w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-400 border border-amber-500/20 shadow-[0_0_10px_rgba(251,191,36,0.2)]">
                        <i id="timeIcon" class="fa-solid fa-sun text-xs"></i>
                    </div>
                    <div class="flex flex-col">
                        <span id="timeGreeting" class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Selamat Pagi</span>
                        <span id="timeClock" class="text-sm font-bold text-white font-mono tracking-wide">00:00:00</span>
                    </div>
                </div>

                <button id="createActionBtn" onclick="openFormModal()" class="hidden bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2.5 rounded-xl font-semibold shadow-lg shadow-indigo-500/30 transition-all active:scale-95 items-center gap-2 text-sm">
                    <i class="fa-solid fa-plus"></i>
                    <span>Buat Aktivitas</span>
                </button>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto custom-scroll p-8">
            <div id="searchStatus" class="hidden text-center py-4 text-slate-400 bg-white/5 rounded-xl border border-white/5 mb-6">
                Mohon maaf hasil pencarian tidak ada.
            </div>

            <div id="cardGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-20">
    </div>

            <div id="emptyState" class="hidden flex-col items-center justify-center py-20 text-center opacity-50">
                <i class="fa-regular fa-folder-open text-5xl mb-4 text-slate-500"></i>
                <p class="text-slate-400">Belum ada data di kategori ini.</p>
            </div>
        </main>
    </div>

<div id="formModal" class="modal fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/70 backdrop-blur-md">
    <div class="modal-content glass-panel bg-[#0f172a] w-full max-w-5xl max-h-[95vh] rounded-2xl flex flex-col relative border border-white/10 shadow-2xl">
        
        <div class="p-5 border-b border-white/10 flex justify-between items-center bg-white/5 shrink-0">
            <div>
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    Input Data 
                    <span id="modalCategoryBadge" class="text-xs px-2 py-1 rounded bg-indigo-500/20 text-indigo-300 border border-indigo-500/30">General</span>
                </h2>
                <p class="text-xs text-slate-400 mt-1">Pastikan seluruh data terisi dengan lengkap dan valid.</p>
            </div>
            <button onclick="closeFormModal()" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition"><i class="fa-solid fa-times text-white"></i></button>
        </div>
        
        <div id="formContainer" class="p-8 overflow-y-auto custom-scroll flex-1">
            </div>
        
        <div class="p-5 border-t border-white/10 bg-white/5 flex justify-between items-center shrink-0">
            <div class="text-xs text-slate-500">
                * Field bertanda bintang wajib diisi
            </div>
            <div class="flex gap-3">
                <button onclick="closeFormModal()" class="px-5 py-2.5 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 text-sm transition">Batal</button>
                <button id="save-btn" onclick="saveProject()" class="px-6 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20 text-sm font-bold tracking-wide transition transform active:scale-95">Simpan Data</button>
            </div>
        </div>
    </div>
</div>
<div id="detailModal" class="modal fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-xl">
    <div class="modal-content glass-panel bg-[#1e1b4b]/90 w-full max-w-6xl max-h-[95vh] rounded-2xl overflow-hidden relative border border-white/10 flex flex-col">
        
        <div class="absolute top-0 left-0 right-0 h-16 bg-gradient-to-b from-black/80 to-transparent z-20 pointer-events-none"></div>
        <button onclick="closeDetailModal()" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-black/40 text-white flex items-center justify-center z-30 hover:bg-red-500/50 backdrop-blur-md border border-white/10 transition"><i class="fa-solid fa-times"></i></button>

        <div id="detailContainer" class="overflow-y-auto custom-scroll flex-1 bg-[#0f172a]">
            </div>

        <div class="p-4 bg-[#1e1b4b] border-t border-white/10 flex justify-between items-center shrink-0 z-30">
            <div class="text-[10px] text-slate-400">
                Created: <span id="lblCreated" class="text-slate-200"></span> | 
                Last Update: <span id="lblUpdated" class="text-indigo-300"></span>
            </div>
            <div class="flex gap-3">
                <button onclick="deleteCurrentTask()" class="text-red-400 hover:bg-red-500/10 px-4 py-2 rounded-lg text-sm transition"><i class="fa-solid fa-trash mr-2"></i>Hapus</button>
                <button onclick="duplicateCurrentTask()" class="text-slate-300 hover:bg-white/5 px-4 py-2 rounded-lg text-sm transition"><i class="fa-solid fa-copy mr-2"></i>Duplikat</button>
                <button onclick="editCurrentTask()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-lg text-sm font-medium transition shadow-lg shadow-indigo-500/30"><i class="fa-solid fa-pen-to-square mr-2"></i>Edit Data</button>
            </div>
        </div>
    </div>
</div>

  <div id="profileModal" class="modal fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md opacity-0 visibility-hidden transition-all duration-300">
        <div class="modal-content glass-panel bg-[#0f172a] w-full max-w-md rounded-3xl overflow-hidden relative border border-white/10 shadow-2xl transform scale-95 transition-all duration-300">
            
            <div class="h-28 bg-gradient-to-r from-indigo-600 to-purple-600 relative">
                <button onclick="closeProfileModal()" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-black/20 hover:bg-black/40 text-white flex items-center justify-center transition backdrop-blur-sm"><i class="fa-solid fa-times"></i></button>
                <div class="absolute -bottom-10 left-1/2 transform -translate-x-1/2">
                    <div class="relative group">
                        <img id="modalAvatarPreview" src="https://ui-avatars.com/api/?name=Admin+User&background=6366f1&color=fff" class="w-24 h-24 rounded-full object-cover border-4 border-[#0f172a] shadow-xl">
                        <label for="avatarUpload" class="absolute bottom-0 right-0 w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center cursor-pointer hover:bg-indigo-400 transition shadow-lg border border-[#0f172a]">
                            <i class="fa-solid fa-camera text-white text-xs"></i>
                        </label>
                        <input type="file" id="avatarUpload" accept="image/*" class="hidden" onchange="previewAvatar(event)">
                    </div>
                </div>
            </div>

            <div class="pt-14 pb-8 px-8 text-center">
                <h3 class="text-xl font-bold text-white mb-1">Edit Profil</h3>
                <p class="text-xs text-slate-400 mb-6">Perbarui identitas admin dashboard Anda.</p>

                <div class="space-y-5 text-left">
                    <div>
                        <label class="block text-xs text-indigo-300 font-bold uppercase tracking-wider mb-2 ml-1">Nama Lengkap</label>
                        <div class="relative">
                            <i class="fa-solid fa-user absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                            <input type="text" id="editNameInput" class="w-full bg-black/20 border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white text-sm focus:outline-none focus:border-indigo-500/50 focus:bg-black/40 transition" placeholder="Nama Admin...">
                        </div>
                    </div>

                    <div>
                         <label class="block text-xs text-indigo-300 font-bold uppercase tracking-wider mb-2 ml-1">Status</label>
                         <div class="w-full bg-black/20 border border-white/10 rounded-xl py-3 px-4 flex items-center justify-between text-sm text-slate-400 cursor-not-allowed opacity-70">
                             <span>Online (Active)</span>
                             <i class="fa-solid fa-lock text-xs"></i>
                         </div>
                    </div>
                </div>

                <div class="mt-8 flex gap-3">
                    <button onclick="closeProfileModal()" class="flex-1 py-3 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 transition text-sm font-medium">Batal</button>
                    <button onclick="saveProfile()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg shadow-indigo-500/30 hover:scale-[1.02] active:scale-95 transition transform text-sm">Simpan Perubahan</button>
                </div>
            </div>
        </div>
    </div>

   <script>
    // --- PROFILE MANAGEMENT LOGIC ---
    
    // State Awal (Cek LocalStorage atau Default)
    let userProfile = JSON.parse(localStorage.getItem('nexusProfile')) || {
        name: 'Administrator',
        avatar: 'https://ui-avatars.com/api/?name=Admin+User&background=6366f1&color=fff'
    };

    // 1. Inisialisasi Profil saat Web Dimuat
    function initProfile() {
        document.getElementById('sidebarName').innerText = userProfile.name;
        document.getElementById('sidebarAvatar').src = userProfile.avatar;
    }

    // 2. Buka Modal Profil
    function openProfileModal() {
        const modal = document.getElementById('profileModal');
        const content = modal.querySelector('.modal-content');
        
        // Isi input dengan data saat ini
        document.getElementById('editNameInput').value = userProfile.name;
        document.getElementById('modalAvatarPreview').src = userProfile.avatar;

        // Efek Animasi Masuk
        modal.classList.remove('visibility-hidden', 'opacity-0');
        modal.classList.add('visible', 'opacity-100');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');
    }

    // 3. Tutup Modal Profil
    function closeProfileModal() {
        const modal = document.getElementById('profileModal');
        const content = modal.querySelector('.modal-content');
        
        // Efek Animasi Keluar
        content.classList.remove('scale-100');
        content.classList.add('scale-95');
        modal.classList.remove('visible', 'opacity-100');
        modal.classList.add('visibility-hidden', 'opacity-0');
    }

    // 4. Preview Gambar saat Upload
    function previewAvatar(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('modalAvatarPreview').src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    // 5. Simpan Profil Baru
    function saveProfile() {
        const newName = document.getElementById('editNameInput').value;
        const newAvatarSrc = document.getElementById('modalAvatarPreview').src;

        if (!newName.trim()) return alert("Nama tidak boleh kosong!");

        // Update State
        userProfile.name = newName;
        userProfile.avatar = newAvatarSrc;

        // Simpan ke LocalStorage (Data Persisten)
        localStorage.setItem('nexusProfile', JSON.stringify(userProfile));

        // Update Tampilan Sidebar Langsung (Real-time)
        document.getElementById('sidebarName').innerText = newName;
        document.getElementById('sidebarAvatar').src = newAvatarSrc;
        
        // Tampilkan Notifikasi Kecil (Opsional) atau Alert
        // alert("Profil berhasil diperbarui!");
        
        closeProfileModal();
    }

    // Panggil Init saat load
    initProfile();
    // --- STATE MANAGEMENT ---
    let projects = JSON.parse(localStorage.getItem('nexusProjectsV3')) || [];
    let currentCategory = 'Dashboard'; 
    let currentDetailId = null;
   
    // --- CONFIG ---
    const themes = {
        'Dashboard': { color: 'indigo', bgGradient: 'linear-gradient(-45deg, #0f172a, #312e81, #4c1d95, #1e1b4b)', title: 'Dashboard Utama', subtitle: 'Ringkasan seluruh aktivitas project.' },
        'SOP': { color: 'cyan', bgGradient: 'linear-gradient(-45deg, #0f172a, #0e7490, #155e75, #164e63)', title: 'SOP Management', subtitle: 'Kumpulan Standar Operasional Prosedur Lengkap.' },
        'JobDesk': { color: 'emerald', bgGradient: 'linear-gradient(-45deg, #022c22, #065f46, #047857, #064e3b)', title: 'Job Desk Tracker', subtitle: 'Daftar tugas dan tanggung jawab harian.' },
        'KPI': { color: 'rose', bgGradient: 'linear-gradient(-45deg, #4c0519, #881337, #be123c, #9f1239)', title: 'KPI Performance', subtitle: 'Monitoring Indikator Kinerja Utama.' },
    'ProjectCharter': { color: 'violet', bgGradient: 'linear-gradient(-45deg, #2e1065, #5b21b6, #7c3aed, #4c1d95)', title: 'Project Charter', subtitle: 'Dokumen resmi dan mandat proyek.' },
    'BSC': { color: 'amber', bgGradient: 'linear-gradient(-45deg, #451a03, #78350f, #b45309, #d97706)', title: 'Balanced Scorecard', subtitle: 'Penyelarasan strategi bisnis dan eksekusi.' },
   'Agile': { color: 'sky', bgGradient: 'linear-gradient(-45deg, #0c4a6e, #0369a1, #0ea5e9, #0284c7)', title: 'Agile Project', subtitle: 'Manajemen Sprint, Backlog, dan User Stories.' },
   'BRD': { color: 'fuchsia', bgGradient: 'linear-gradient(-45deg, #4a044e, #701a75, #a21caf, #86198f)', title: 'BRD Project Plan', subtitle: 'Analisis Kebutuhan Bisnis dan Solusi.' },
   'OKR': { color: 'lime', bgGradient: 'linear-gradient(-45deg, #1a2e05, #365314, #4d7c0f, #65a30d)', title: 'Objectives & Key Results', subtitle: 'Penetapan tujuan ambisius dan terukur.' },
   'Risk': { color: 'red', bgGradient: 'linear-gradient(-45deg, #450a0a, #7f1d1d, #b91c1c, #991b1b)', title: 'Risk Management', subtitle: 'Identifikasi dan mitigasi potensi bahaya.' },
   'Stakeholder': { color: 'teal', bgGradient: 'linear-gradient(-45deg, #134e4a, #115e59, #0d9488, #14b8a6)', title: 'Stakeholder Analysis', subtitle: 'Pemetaan peran, pengaruh, dan strategi komunikasi.' },
   'SWOT': { color: 'orange', bgGradient: 'linear-gradient(-45deg, #431407, #7c2d12, #c2410c, #ea580c)', title: 'SWOT Analysis', subtitle: 'Evaluasi Kekuatan, Kelemahan, Peluang, & Ancaman.' },
   'QC': { color: 'emerald', bgGradient: 'linear-gradient(-45deg, #064e3b, #065f46, #10b981, #34d399)', title: 'Quality Control Log', subtitle: 'Pengecekan standar kualitas produk & layanan.' },
   'ChangeRequest': { color: 'fuchsia', bgGradient: 'linear-gradient(-45deg, #4a044e, #701a75, #a21caf, #c026d3)', title: 'Change Request Log', subtitle: 'Manajemen permintaan perubahan lingkup proyek.' },
   'Appraisal': { color: 'indigo', bgGradient: 'linear-gradient(-45deg, #312e81, #3730a3, #4338ca, #4f46e5)', title: 'Performance Appraisal', subtitle: 'Evaluasi kinerja dan kompetensi karyawan.' },
   'Recruitment': { color: 'pink', bgGradient: 'linear-gradient(-45deg, #831843, #be185d, #db2777, #f472b6)', title: 'Recruitment Pipeline', subtitle: 'Monitoring proses seleksi dan penerimaan talenta.' },
'Procurement': { color: 'slate', bgGradient: 'linear-gradient(-45deg, #0f172a, #1e293b, #334155, #475569)', title: 'Procurement Plan', subtitle: 'Perencanaan pengadaan barang dan jasa.' },
 'KPA': { color: 'purple', bgGradient: 'linear-gradient(-45deg, #3b0764, #581c87, #7e22ce, #a855f7)', title: 'Key Performance Areas', subtitle: 'Evaluasi area kinerja utama dan tanggung jawab.' },
 'PIP': { color: 'red', bgGradient: 'linear-gradient(-45deg, #450a0a, #7f1d1d, #991b1b, #ef4444)', title: 'Performance Improvement Plan', subtitle: 'Program perbaikan kinerja terstruktur.' },  
 'PostMortem': { color: 'stone', bgGradient: 'linear-gradient(-45deg, #292524, #44403c, #57534e, #78716c)', title: 'Incident Post-Mortem', subtitle: 'Analisis insiden, root cause, dan perbaikan.' },
 'IDP': { color: 'green', bgGradient: 'linear-gradient(-45deg, #14532d, #166534, #15803d, #22c55e)', title: 'Individual Development Plan', subtitle: 'Rencana pertumbuhan karir dan kompetensi individu.' },
 'RICE': { color: 'pink', bgGradient: 'linear-gradient(-45deg, #831843, #be185d, #db2777, #f472b6)', title: 'RICE Prioritization', subtitle: 'Reach, Impact, Confidence, Effort Scoring.' },
 'GapAnalysis': { color: 'fuchsia', bgGradient: 'linear-gradient(-45deg, #4a044e, #701a75, #a21caf, #c026d3)', title: 'Gap Analysis', subtitle: 'Analisis kesenjangan kondisi As-Is vs To-Be.' },
 'SIPOC': { color: 'teal', bgGradient: 'linear-gradient(-45deg, #134e4a, #115e59, #0f766e, #14b8a6)', title: 'SIPOC Diagram', subtitle: 'Suppliers, Inputs, Process, Outputs, Customers.' },
 '5S': { color: 'lime', bgGradient: 'linear-gradient(-45deg, #1a2e05, #365314, #4d7c0f, #65a30d)', title: '5S Audit Checklist', subtitle: 'Seiri, Seiton, Seiso, Seiketsu, Shitsuke.' },
 'SLA': { color: 'cyan', bgGradient: 'linear-gradient(-45deg, #164e63, #0891b2, #06b6d4, #67e8f9)', title: 'SLA Monitor', subtitle: 'Pemantauan tingkat layanan dan kepatuhan kontrak.' },
 'FMEA': { color: 'orange', bgGradient: 'linear-gradient(-45deg, #7c2d12, #9a3412, #c2410c, #ea580c)', title: 'FMEA Analysis', subtitle: 'Analisis mode kegagalan dan efeknya (RPN).' },
 'KCI': { color: 'zinc', bgGradient: 'linear-gradient(-45deg, #18181b, #27272a, #3f3f46, #52525b)', title: 'Key Control Indicators', subtitle: 'Audit kepatuhan dan kontrol internal.' },
'KRI': { color: 'red', bgGradient: 'linear-gradient(-45deg, #450a0a, #7f1d1d, #b91c1c, #ef4444)', title: 'Key Risk Indicators', subtitle: 'Metrik peringatan dini untuk potensi risiko.' },
'MOST': { color: 'indigo', bgGradient: 'linear-gradient(-45deg, #312e81, #4338ca, #6366f1, #818cf8)', title: 'MOST Analysis', subtitle: 'Mission, Objectives, Strategy, Tactics.' },
'WIG': { color: 'rose', bgGradient: 'linear-gradient(-45deg, #881337, #be123c, #f43f5e, #fb7185)', title: 'Wildly Important Goals', subtitle: 'The 4 Disciplines of Execution (4DX).' },
'V2MOM': { color: 'sky', bgGradient: 'linear-gradient(-45deg, #0c4a6e, #0284c7, #38bdf8, #bae6fd)', title: 'V2MOM Alignment', subtitle: 'Vision, Values, Methods, Obstacles, Measures.' },
'MBO': { color: 'slate', bgGradient: 'linear-gradient(-45deg, #1e293b, #334155, #475569, #64748b)', title: 'Management by Objectives', subtitle: 'Penyelarasan tujuan korporat dan individu.' },
'CSF': { color: 'amber', bgGradient: 'linear-gradient(-45deg, #451a03, #78350f, #d97706, #fbbf24)', title: 'Critical Success Factors', subtitle: 'Faktor krusial penentu keberhasilan bisnis.' },
'KRA': { color: 'blue', bgGradient: 'linear-gradient(-45deg, #1e3a8a, #1d4ed8, #2563eb, #60a5fa)', title: 'Key Result Areas', subtitle: 'Area tanggung jawab utama dan indikator keberhasilan.' },
'OGSM': { color: 'emerald', bgGradient: 'linear-gradient(-45deg, #022c22, #064e3b, #059669, #34d399)', title: 'OGSM Framework', subtitle: 'Objectives, Goals, Strategies, Measures.' },
'Training': { 
        color: 'cyan', 
        bgGradient: 'linear-gradient(-45deg, #083344, #155e75, #0e7490, #164e63)', 
        title: 'Learning Management (LMS)', 
        subtitle: 'Manajemen pelatihan dan pengembangan kompetensi.' 
    }




    
  



    };

    const divisions = [
        "HR", "Finance", "Marketing", "Operasional", "IT", "Legal", "R&D", "Sales", "CS", "Procurement", 
        "GA", "Warehouse", "Logistics", "Production", "QC", "Compliance", "Executive", "Admin", "Security", "Maintenance"
    ];

    // --- DOM ELEMENTS ---
    const cardGrid = document.getElementById('cardGrid');
    const bgLayer = document.getElementById('bg-layer');
    const searchInput = document.getElementById('searchInput');
    const filterInput = document.getElementById('filterInput');

    // --- HELPERS ---
    const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
    const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
    const formatTime = (d) => d ? new Date(d).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) : '';

    // --- NAVIGATION ---
    function switchCategory(category) {
        currentCategory = category;
        const theme = themes[category];
        
        bgLayer.style.background = theme.bgGradient;
        document.getElementById('page-title').innerText = theme.title;
        document.getElementById('page-subtitle').innerText = theme.subtitle;

        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.remove('active');
            el.style.borderLeftColor = 'transparent';
        });
        
        const activeNav = document.getElementById(`nav-${category}`);
        if(activeNav) {
            activeNav.classList.add('active');
            let colorHex = category === 'SOP' ? '#06b6d4' : (category === 'JobDesk' ? '#10b981' : '#6366f1');
            activeNav.style.borderLeftColor = colorHex;
        }

        renderProjects();
    }

    // --- RENDER DASHBOARD ---
    // --- RENDER DASHBOARD (FIXED) ---
    function renderProjects() {
        cardGrid.innerHTML = '';
        const search = searchInput.value.toLowerCase(); // Ambil input search dan kecilkan hurufnya
        const filter = filterInput.value;
        let count = 0;

        const filtered = projects.filter(p => {
            // 1. Filter Kategori
            const catMatch = currentCategory === 'Dashboard' ? true : p.category === currentCategory;
            
            // 2. Filter Search (BAGIAN YANG DIPERBAIKI)
            // Kita cek: Ambil sopTitle ATAU name ATAU string kosong jika keduanya tidak ada
            // Ini mencegah error "undefined"
            const titleData = p.sopTitle || p.name || ''; 
            const searchMatch = titleData.toLowerCase().includes(search);
            
            // 3. Filter Status
            const statusMatch = filter === 'all' || p.status === filter;

            return catMatch && searchMatch && statusMatch;
        });

        // Tampilkan Empty State jika kosong
        if (filtered.length === 0) {
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('flex');
        } else {
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('flex');
        }

        // Render Kartu
        filtered.forEach(p => {
            count++;
            cardGrid.appendChild(createCard(p));
        });
        
        // Tampilkan pesan jika hasil search tidak ditemukan
        document.getElementById('searchStatus').style.display = (count === 0 && search) ? 'block' : 'none';
    }
// --- 1. FUNGSI HELPER WARNA STATUS (Baru) ---
    function getStatusColor(status) {
        // Mapping warna berdasarkan status
        const colors = {
            'Aktif': 'bg-emerald-500 shadow-emerald-500/40',
            'Completed': 'bg-emerald-600 shadow-emerald-600/40',
            'Selesai': 'bg-emerald-600 shadow-emerald-600/40',
            
            'In Progress': 'bg-blue-500 shadow-blue-500/40',
            'Sedang Berjalan': 'bg-blue-500 shadow-blue-500/40',
            
            'Revisi': 'bg-amber-500 shadow-amber-500/40',
            'On Hold': 'bg-amber-600 shadow-amber-600/40',
            'Planning': 'bg-indigo-500 shadow-indigo-500/40',
            
            'Draft': 'bg-slate-500 shadow-slate-500/40',
            'Belum Dimulai': 'bg-slate-500 shadow-slate-500/40',
            
            'Tidak Berlaku': 'bg-red-500 shadow-red-500/40',
            'Critical': 'bg-red-600 shadow-red-600/40',
            'High': 'bg-red-500 shadow-red-500/40'
        };
        // Default warna jika status tidak dikenali
        return colors[status] || 'bg-slate-600 shadow-slate-600/40';
    }

    // --- 2. FUNGSI RENDER CARD (Revisi) ---
    // --- RENDER CARD: DISPATCHER (PENGATUR) ---
    // Fungsi ini bertugas memilih jenis kartu yang sesuai berdasarkan kategorinya
    function createCard(p) {
        if (p.category === 'SOP') return createSopCard(p);
        else if (p.category === 'KPI') return createKpiCard(p); // Tambahkan ini
        else if (p.category === 'ProjectCharter') return createProjectCharterCard(p); // <--- INI
        else if (p.category === 'BSC') return createBSCCard(p); // <--- TAMBAHAN
        else if (p.category === 'Agile') return createAgileCard(p);
        else if (p.category === 'BRD') return createBRDCard(p);
        else if (p.category === 'OKR') return createOKRCard(p);
        else if (p.category === 'Risk') return createRiskCard(p);
        else if (p.category === 'PostMortem') return createPostMortemCard(p);
        else if (p.category === 'Stakeholder') return createStakeholderCard(p);
        else if (p.category === 'SWOT') return createSWOTCard(p);
        else if (p.category === 'QC') return createQCCard(p);
        else if (p.category === 'Procurement') return createProcurementCard(p);
        else if (p.category === 'Training') return createTrainingCard(p);
        else if (p.category === 'Recruitment') return createRecruitmentCard(p);
        else if (p.category === 'Appraisal') return createAppraisalCard(p);
        else if (p.category === 'ChangeRequest') return createChangeRequestCard(p);
        else if (p.category === 'KPA') return createKPACard(p);
        else if (p.category === 'FMEA') return createFMEACard(p);
        else if (p.category === 'RICE') return createRICECard(p);
        else if (p.category === 'PIP') return createPIPCard(p);
        else if (p.category === 'IDP') return createIDPCard(p);
        else if (p.category === 'OGSM') return createOGSMCard(p);
        else if (p.category === 'KRA') return createKRACard(p);
        else if (p.category === 'CSF') return createCSFCard(p);
        else if (p.category === 'MBO') return createMBOCard(p);
        else if (p.category === 'V2MOM') return createV2MOMCard(p);
        else if (p.category === 'WIG') return createWIGCard(p);
        else if (p.category === 'MOST') return createMOSTCard(p);
        else if (p.category === 'KRI') return createKRICard(p);
        else if (p.category === 'KCI') return createKCICard(p);
        else if (p.category === 'SLA') return createSLACard(p);
        else if (p.category === '5S') return create5SCard(p);
        else if (p.category === 'GapAnalysis') return createGapAnalysisCard(p);
        else if (p.category === 'SIPOC') return createSIPOCCard(p);
        else return createJobDeskCard(p);
    }
    // --- 1. FUNCTION KHUSUS MEMBUAT KARTU SOP ---
    // --- 1. FUNCTION KHUSUS MEMBUAT KARTU SOP (REVISI TAMPILAN) ---
    // --- FUNCTION KHUSUS MEMBUAT KARTU SOP (REVISI POSISI OWNER) ---
    function createSopCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        
        div.onclick = () => openDetail(p.id);

        const img = p.sopImage || `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const ownerInitial = p.sopOwner ? p.sopOwner.charAt(0).toUpperCase() : '?';
        const divisionLabel = p.sopDivision || '-'; 

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>

                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105" title="Duplikat"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105" title="Hapus"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-cyan-600 shadow-lg tracking-wider border border-white/10 shadow-cyan-500/20">SOP</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-cyan-300 transition-colors tracking-tight">${p.sopTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.sopDesc || 'Tidak ada deskripsi yang tersedia untuk SOP ini.'}
                </p>
                
                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-xs text-white border border-white/10 shadow-inner">
                            ${ownerInitial}
                        </div>
                        
                        <div class="flex flex-col -mt-1">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Owner</span>
                            <span class="text-xs text-slate-200 truncate w-24 font-medium leading-none">${p.sopOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-cyan-200 bg-cyan-500/10 px-3 py-1.5 rounded-lg border border-cyan-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1">
                        <i class="fa-solid fa-layer-group text-[9px]"></i> ${divisionLabel}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- 2. FUNCTION KHUSUS MEMBUAT KARTU JOB DESK (REVISI TAMPILAN) ---
   // --- FUNCTION KHUSUS MEMBUAT KARTU JOB DESK (REVISI FINAL) ---
    function createJobDeskCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        
        div.onclick = () => openDetail(p.id);

        const title = p.jdTitle || p.name || 'Tanpa Judul';
        const desc = p.jdDesc || p.description || 'Tidak ada deskripsi tugas.';
        const pic = p.jdPic || p.manager || '-';
        const picInitial = pic !== '-' ? pic.charAt(0).toUpperCase() : '?';
        const img = p.image || `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const typeLabel = p.jdType || 'Individu'; // Label untuk pojok kanan bawah

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>

                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105" title="Duplikat"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105" title="Hapus"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-emerald-600 shadow-lg tracking-wider border border-white/10 shadow-emerald-500/20">Job Desk</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-emerald-300 transition-colors tracking-tight">${title}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${desc}
                </p>
                
                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-xs text-white border border-white/10 shadow-inner">
                            ${picInitial}
                        </div>
                        
                        <div class="flex flex-col -mt-1">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">PIC</span>
                            <span class="text-xs text-slate-200 truncate w-24 font-medium leading-none">${pic}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-emerald-200 bg-emerald-500/10 px-3 py-1.5 rounded-lg border border-emerald-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1">
                        <i class="fa-solid fa-user-tag text-[9px]"></i> ${typeLabel}
                    </div>
                </div>
            </div>
        `;
        return div;
    } // --- 3. FUNGSI LOGIC TOMBOL CEPAT (Agar tidak membuka modal) ---
    
    function quickDuplicate(id, event) {
        event.stopPropagation(); // Mencegah modal terbuka
        const p = projects.find(x => x.id === id);
        if(!p) return;
        
        const newP = {
            ...p, 
            id: generateId(), 
            name: p.name ? p.name + " (Copy)" : undefined, 
            sopTitle: p.sopTitle ? p.sopTitle + " (Copy)" : undefined,
            status: 'Draft', // Reset status ke Draft saat duplikat
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        projects.push(newP);
        localStorage.setItem('nexusProjectsV3', JSON.stringify(projects));
        renderProjects(); // Refresh tampilan
    }

    function quickDelete(id, event) {
        event.stopPropagation(); // Mencegah modal terbuka
        if(confirm('Apakah Anda yakin ingin menghapus item ini?')) {
            projects = projects.filter(p => p.id !== id);
            localStorage.setItem('nexusProjectsV3', JSON.stringify(projects));
            renderProjects(); // Refresh tampilan
        }
    }
    // --- FORM LOGIC (THE COMPLEX PART) ---
    
   function openFormModal(isEdit = false, id = null) {
        const container = document.getElementById('formContainer');
        const badge = document.getElementById('modalCategoryBadge');
        
        // 1. Tentukan Kategori Aktif
        // Jika Edit -> Ambil dari data project
        // Jika Baru -> Ambil dari menu sidebar (currentCategory). Jika di Dashboard, default ke JobDesk.
        let activeCat = (isEdit && id) 
            ? projects.find(p => p.id === id).category 
            : (currentCategory === 'Dashboard' ? 'JobDesk' : currentCategory);

        // 2. Atur Teks & Warna Badge
       badge.innerText = activeCat;
        // Tambahkan Style Badge Violet
        if (activeCat === 'SOP') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-cyan-500/20 text-cyan-300 border border-cyan-500/30";
        else if (activeCat === 'KPI') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-rose-500/20 text-rose-300 border border-rose-500/30";
        else if (activeCat === 'ProjectCharter') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-violet-500/20 text-violet-300 border border-violet-500/30";
        else if (activeCat === 'BSC') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-amber-500/20 text-amber-300 border border-amber-500/30"; // <--- TAMBAHAN
        else if (activeCat === 'Agile') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-sky-500/20 text-sky-300 border border-sky-500/30";
        else if (activeCat === 'BRD') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-fuchsia-500/20 text-fuchsia-300 border border-fuchsia-500/30";
        else if (activeCat === 'OKR') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-lime-500/20 text-lime-300 border border-lime-500/30";
        else if (activeCat === 'IDP') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-green-500/20 text-green-300 border border-green-500/30";
        else if (activeCat === 'Risk') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-red-500/20 text-red-300 border border-red-500/30";
        else if (activeCat === 'Stakeholder') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-teal-500/20 text-teal-300 border border-teal-500/30";
        else if (activeCat === 'SWOT') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-orange-500/20 text-orange-300 border border-orange-500/30";
        else if (activeCat === 'QC') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-300 border border-emerald-500/30";
        else if (activeCat === 'Procurement') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-slate-500/20 text-slate-300 border border-slate-500/30";
        else if (activeCat === 'RICE') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-pink-500/20 text-pink-300 border border-pink-500/30";
        else if (activeCat === 'Training') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-cyan-500/20 text-cyan-300 border border-cyan-500/30";
        else if (activeCat === 'Recruitment') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-pink-500/20 text-pink-300 border border-pink-500/30";
        else if (activeCat === 'Appraisal') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-indigo-500/20 text-indigo-300 border border-indigo-500/30";
        else if (activeCat === 'ChangeRequest') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-fuchsia-500/20 text-fuchsia-300 border border-fuchsia-500/30";
        else if (activeCat === 'KPA') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-purple-500/20 text-purple-300 border border-purple-500/30";
        else if (activeCat === 'PIP') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-red-500/20 text-red-300 border border-red-500/30";
        else if (activeCat === 'OGSM') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-300 border border-emerald-500/30";
        else if (activeCat === 'KRA') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-300 border border-blue-500/30";
        else if (activeCat === 'CSF') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-amber-500/20 text-amber-300 border border-amber-500/30";
        else if (activeCat === 'MBO') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-slate-500/20 text-slate-300 border border-slate-500/30";
        else if (activeCat === 'V2MOM') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-sky-500/20 text-sky-300 border border-sky-500/30";
        else if (activeCat === 'WIG') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-rose-500/20 text-rose-300 border border-rose-500/30";
        else if (activeCat === 'MOST') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-indigo-500/20 text-indigo-300 border border-indigo-500/30";
        else if (activeCat === 'KRI') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-red-500/20 text-red-300 border border-red-500/30";
        else if (activeCat === 'KCI') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-zinc-500/20 text-zinc-300 border border-zinc-500/30";
        else if (activeCat === 'FMEA') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-orange-500/20 text-orange-300 border border-orange-500/30";
        else if (activeCat === 'SLA') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-cyan-500/20 text-cyan-300 border border-cyan-500/30";
        else if (activeCat === '5S') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-lime-500/20 text-lime-300 border border-lime-500/30";
        else if (activeCat === 'SIPOC') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-teal-500/20 text-teal-300 border border-teal-500/30";
        else if (activeCat === 'GapAnalysis') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-fuchsia-500/20 text-fuchsia-300 border border-fuchsia-500/30";
        else if (activeCat === 'PostMortem') badge.className = "ml-2 text-xs px-2 py-1 rounded bg-stone-500/20 text-stone-300 border border-stone-500/30";
        else badge.className = "ml-2 text-xs px-2 py-1 rounded bg-emerald-500/20 text-emerald-300 border border-emerald-500/30";
        


        document.getElementById('formModal').classList.add('active');
        
        // 3. Reset Array Temporary
        tempSubSops = []; // Reset sub-task SOP/JobDesk
        if (typeof tempSubKpis !== 'undefined') tempSubKpis = []; // Reset sub-task KPI
        if (typeof tempSubPCs !== 'undefined') tempSubPCs = []; // Reset PC
        if (typeof tempSubBSCs !== 'undefined') tempSubBSCs = [];
        if (typeof tempSubGaps !== 'undefined') tempSubGaps = [];
        if (typeof tempSubAgiles !== 'undefined') tempSubAgiles = [];
        if (typeof tempSubOKRs !== 'undefined') tempSubOKRs = [];
        else if (typeof tempSubBRDs !== 'undefined') tempSubBRDs = [];
        else if (typeof tempSubRisks !== 'undefined') tempSubRisks = [];
        else if (typeof tempSubStakeholders !== 'undefined') tempSubStakeholders = [];
        if (typeof tempSubQCs !== 'undefined') tempSubQCs = [];
        if (typeof tempSubProcs !== 'undefined') tempSubProcs = [];
        if (typeof tempSubTrainings !== 'undefined') tempSubTrainings = [];
        if (typeof tempSubRecruits !== 'undefined') tempSubRecruits = [];
        if (typeof tempSubAppraisals !== 'undefined') tempSubAppraisals = [];
        if (typeof tempSubCRs !== 'undefined') tempSubCRs = [];
        if (typeof tempSubKPAs !== 'undefined') tempSubKPAs = [];
        if (typeof tempSubPIPs !== 'undefined') tempSubPIPs = [];
        if (typeof tempSubSIPOCs !== 'undefined') tempSubSIPOCs = [];
        if (typeof tempSubOGSMs !== 'undefined') tempSubOGSMs = [];
        if (typeof tempSubKRAs !== 'undefined') tempSubKRAs = [];
        if (typeof tempSubCSFs !== 'undefined') tempSubCSFs = [];
        if (typeof tempSubMBOs !== 'undefined') tempSubMBOs = [];
        if (typeof tempSubRICEs !== 'undefined') tempSubRICEs = [];
        if (typeof tempSubV2MOMs !== 'undefined') tempSubV2MOMs = [];
        if (typeof tempSubPostMortems !== 'undefined') tempSubPostMortems = [];
        if (typeof tempSubWIGs !== 'undefined') tempSubWIGs = [];
        if (typeof tempSubMOSTs !== 'undefined') tempSubMOSTs = [];
        if (typeof tempSubKRIs !== 'undefined') tempSubKRIs = [];
        if (typeof tempSubKCIs !== 'undefined') tempSubKCIs = [];
        if (typeof tempSubFMEAs !== 'undefined') tempSubFMEAs = [];
        if (typeof tempSubSLAs !== 'undefined') tempSubSLAs = [];
        if (typeof tempSubIDPs !== 'undefined') tempSubIDPs = [];
        if (typeof tempSub5S !== 'undefined') tempSub5S = [];
    

        // 4. Inject Form HTML Sesuai Kategori
        if (activeCat === 'SOP') container.innerHTML = getSopFormHtml();
        else if (activeCat === 'KPI') container.innerHTML = getKpiFormHtml();
        else if (activeCat === 'ProjectCharter') container.innerHTML = getProjectCharterFormHtml(); // <--- Panggil Form PC
        else if (activeCat === 'BSC') container.innerHTML = getBSCFormHtml(); // <--- TAMBAHAN
        else if (activeCat === 'Agile') container.innerHTML = getAgileFormHtml();
        else if (activeCat === 'BRD') container.innerHTML = getBRDFormHtml();
        else if (activeCat === 'RICE') container.innerHTML = getRICEFormHtml();
        else if (activeCat === 'OKR') container.innerHTML = getOKRFormHtml();
        else if (activeCat === 'Risk') container.innerHTML = getRiskFormHtml();
        else if (activeCat === 'Stakeholder') container.innerHTML = getStakeholderFormHtml();
        else if (activeCat === 'SWOT') container.innerHTML = getSWOTFormHtml();
        else if (activeCat === 'QC') container.innerHTML = getQCFormHtml();
        else if (activeCat === 'Procurement') container.innerHTML = getProcurementFormHtml();
        else if (activeCat === 'Training') container.innerHTML = getTrainingFormHtml();
        else if (activeCat === 'Recruitment') container.innerHTML = getRecruitmentFormHtml();
        else if (activeCat === 'Appraisal') container.innerHTML = getAppraisalFormHtml();
        else if (activeCat === 'ChangeRequest') container.innerHTML = getChangeRequestFormHtml();
        else if (activeCat === 'KPA') container.innerHTML = getKPAFormHtml();
        else if (activeCat === 'PIP') container.innerHTML = getPIPFormHtml();
        else if (activeCat === 'SIPOC') container.innerHTML = getSIPOCFormHtml();
        else if (activeCat === 'IDP') container.innerHTML = getIDPFormHtml();
        else if (activeCat === 'OGSM') container.innerHTML = getOGSMFormHtml();
        else if (activeCat === 'KRA') container.innerHTML = getKRAFormHtml();
        else if (activeCat === 'PostMortem') container.innerHTML = getPostMortemFormHtml();
        else if (activeCat === 'CSF') container.innerHTML = getCSFFormHtml();
        else if (activeCat === 'MBO') container.innerHTML = getMBOFormHtml();
        else if (activeCat === 'V2MOM') container.innerHTML = getV2MOMFormHtml();
        else if (activeCat === 'WIG') container.innerHTML = getWIGFormHtml();
        else if (activeCat === 'MOST') container.innerHTML = getMOSTFormHtml();
        else if (activeCat === 'KRI') container.innerHTML = getKRIFormHtml();
        else if (activeCat === 'KCI') container.innerHTML = getKCIFormHtml();
        else if (activeCat === 'FMEA') container.innerHTML = getFMEAFormHtml();
        else if (activeCat === 'SLA') container.innerHTML = getSLAFormHtml();
        else if (activeCat === '5S') container.innerHTML = get5SFormHtml();
        else if (activeCat === 'GapAnalysis') container.innerHTML = getGapAnalysisFormHtml();

        else container.innerHTML = getJobDeskFormHtml();

        // 5. Isi Data (Jika Mode Edit)
        if (isEdit && id) {
            const p = projects.find(x => x.id === id);
            document.getElementById('projectId').value = p.id;
            
            if (activeCat === 'SOP') populateSopForm(p);
            else if (activeCat === 'KPI') populateKpiForm(p);
            else if (activeCat === 'ProjectCharter') populateProjectCharterForm(p); // <--- Panggil Populate PC
            else if (activeCat === 'BSC') populateBSCForm(p); // <--- TAMBAHAN
            else if (activeCat === 'Agile') populateAgileForm(p);
           else if (activeCat === 'BRD') populateBRDForm(p);
           else if (activeCat === 'OKR') populateOKRForm(p);
           else if (activeCat === 'Risk') populateRiskForm(p);
           else if (activeCat === 'Stakeholder') populateStakeholderForm(p);
           else if (activeCat === 'SIPOC') populateSIPOCForm(p);
           else if (activeCat === 'SWOT') populateSWOTForm(p);
           else if (activeCat === 'QC') populateQCForm(p);
           else if (activeCat === 'PostMortem') populatePostMortemForm(p);
           else if (activeCat === 'IDP') populateIDPForm(p);
           else if (activeCat === 'Procurement') populateProcurementForm(p);
           else if (activeCat === 'Training') populateTrainingForm(p);
           else if (activeCat === 'Recruitment') populateRecruitmentForm(p);
           else if (activeCat === 'Appraisal') populateAppraisalForm(p);
           else if (activeCat === 'ChangeRequest') populateChangeRequestForm(p);
           else if (activeCat === 'KPA') populateKPAForm(p);
           else if (activeCat === 'PIP') populatePIPForm(p);
           else if (activeCat === 'OGSM') populateOGSMForm(p);
           else if (activeCat === 'KRA') populateKRAForm(p);
           else if (activeCat === 'CSF') populateCSFForm(p);
           else if (activeCat === 'MBO') populateMBOForm(p);
           else if (activeCat === 'V2MOM') populateV2MOMForm(p);
           else if (activeCat === 'WIG') populateWIGForm(p);
           else if (activeCat === 'FMEA') populateFMEAForm(p);
           else if (activeCat === 'MOST') populateMOSTForm(p);
           else if (activeCat === 'KRI') populateKRIForm(p);
           else if (activeCat === 'RICE') populateRICEForm(p);
           else if (activeCat === 'KCI') populateKCIForm(p);
           else if (activeCat === 'SLA') populateSLAForm(p);
           else if (activeCat === 'GapAnalysis') populateGapForm(p);
           else if (activeCat === '5S') populate5SForm(p);
            else populateJobDeskForm(p);
            
        } else {
            document.getElementById('projectId').value = '';
        }
    }


// --- LOGIKA RICE SCORING ---
    
// --- LOGIKA IDP FRAMEWORK ---
    
    function calculateIDPProgress() {
        if (tempSubIDPs.length === 0) {
            const el = document.getElementById('idpProgress');
            if(el) el.value = '0%';
            return 0;
        }

        const doneCount = tempSubIDPs.filter(s => s.status === 'Done').length;
        const rate = Math.round((doneCount / tempSubIDPs.length) * 100);
        
        const el = document.getElementById('idpProgress');
        if(el) {
            el.value = rate + '%';
            el.style.color = rate >= 100 ? '#4ade80' : (rate >= 50 ? '#facc15' : '#f87171');
        }
        return rate;
    }

    function addSubIDP() {
        const skill = document.getElementById('idpSubSkill').value;
        const activity = document.getElementById('idpSubActivity').value;
        
        if(!skill) return alert("Skill Gap wajib diisi!");

        const newSub = {
            id: generateId(),
            skill: skill,
            method: document.getElementById('idpSubMethod').value,
            activity: activity || '-',
            date: document.getElementById('idpSubDate').value || '-',
            status: document.getElementById('idpSubStatus').value
        };

        tempSubIDPs.push(newSub);
        renderSubIDPTable();
        calculateIDPProgress();
        
        // Reset Inputs
        document.getElementById('idpSubSkill').value = '';
        document.getElementById('idpSubActivity').value = '';
        document.getElementById('idpSubDate').value = '';
    }

    function removeSubIDP(id) {
        tempSubIDPs = tempSubIDPs.filter(s => s.id !== id);
        renderSubIDPTable();
        calculateIDPProgress();
    }

    function renderSubIDPTable() {
        const tbody = document.getElementById('idpSubListBody');
        const emptyDiv = document.getElementById('idpSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubIDPs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubIDPs.forEach(s => {
                // Warna Status
                let statusBadge = 'text-slate-400';
                if(s.status === 'Done') statusBadge = 'text-emerald-400 font-bold';
                else if(s.status === 'On Progress') statusBadge = 'text-yellow-400 font-bold';

                const dateDisplay = s.date !== '-' ? new Date(s.date).toLocaleDateString('id-ID') : '-';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.skill}</td>
                    <td class="p-3 text-sm text-slate-300 align-top">
                        <span class="text-[10px] text-green-300 block mb-1 uppercase tracking-wide">${s.method}</span>
                        ${s.activity}
                    </td>
                    <td class="p-3 text-center text-xs text-slate-400 font-mono align-top">${dateDisplay}</td>
                    <td class="p-3 text-center text-xs ${statusBadge} align-top">${s.status}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubIDP('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateIDPForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('idpName', p.idpName); setVal('idpCurrentRole', p.idpCurrentRole);
        setVal('idpGoal', p.idpGoal); setVal('idpMentor', p.idpMentor); 
        setVal('idpPeriod', p.idpPeriod); setVal('idpStatus', p.status);
        setVal('idpSupport', p.idpSupport); setVal('idpImage', p.image);
        setVal('idpNotes', p.idpNotes);

        tempSubIDPs = p.subIDPs || [];
        renderSubIDPTable();
        calculateIDPProgress();
    }

   function getIDPFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="IDP">

            <div class="space-y-4">
                <h3 class="text-green-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Profil & Aspirasi Karir</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Karyawan *</label>
                        <input type="text" id="idpName" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Nama Lengkap">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Posisi Saat Ini</label><input type="text" id="idpCurrentRole" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: Junior Developer"></div>
                    
                    <div class="col-span-2"><label class="block text-xs text-green-300 mb-1 font-bold">Career Goal (Tujuan Karir)</label><input type="text" id="idpGoal" class="glass-input w-full p-3 rounded-lg text-sm font-bold" placeholder="Contoh: Menjadi Senior Solution Architect dalam 2 tahun"></div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Mentor / Coach</label><input type="text" id="idpMentor" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Periode Perencanaan</label><input type="text" id="idpPeriod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="FY 2026"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Rencana</label>
                        <select id="idpStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Active">Active (Berjalan)</option>
                            <option value="Review">Review (Evaluasi)</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Progress Belajar (Otomatis)</label>
                        <input type="text" id="idpProgress" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-green-400 cursor-not-allowed" value="0%">
                    </div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-green-400 font-bold uppercase text-xs tracking-widest">B. Action Plan (70:20:10)</h3>
                    <span class="text-[10px] text-slate-500 italic">Skill Gap & Metode Belajar</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-green-300 mb-1">Skill Gap / Area Pengembangan</label><input type="text" id="idpSubSkill" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Kompetensi yang perlu ditingkatkan..."></div>
                    
                    <div class="md:col-span-4">
                        <label class="block text-[10px] text-slate-400 mb-1">Metode Belajar</label>
                        <select id="idpSubMethod" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Training (10%)">Training / Course (10%)</option>
                            <option value="Mentoring (20%)">Mentoring / Feedback (20%)</option>
                            <option value="Assignment (70%)">Project / OJT (70%)</option>
                        </select>
                    </div>
                    <div class="md:col-span-5"><label class="block text-[10px] text-slate-400 mb-1">Detail Aktivitas</label><input type="text" id="idpSubActivity" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Judul course atau nama projek..."></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Target Selesai</label><input type="date" id="idpSubDate" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1">Status Item</label>
                        <select id="idpSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Not Started">Not Started</option>
                            <option value="On Progress">On Progress</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubIDP()" class="md:col-span-9 bg-green-600 hover:bg-green-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-green-500/20 mt-5 transition-colors">
                        <i class="fa-solid fa-graduation-cap mr-1"></i> Tambah Rencana
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-green-900/30 text-green-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/4">Skill Gap</th>
                                <th class="p-3 border-b border-white/10">Metode & Aktivitas</th>
                                <th class="p-3 border-b border-white/10 text-center">Deadline</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="idpSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="idpSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada rencana pengembangan.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-green-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Komitmen & Dukungan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Dukungan yang Diperlukan</label><input type="text" id="idpSupport" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Budget / Waktu Khusus / Tools"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image (Foto Profil/Visi)</label><input type="text" id="idpImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Refleksi Diri / Catatan</label><textarea id="idpNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
function createIDPCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.idpImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.idpName)}&background=14532d&color=fff&size=500`;
        const statusClass = getStatusColor(p.status);
        const progress = p.idpProgressRate || 0;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-green-600 shadow-lg tracking-wider border border-green-500 shadow-green-500/20">IDP</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-green-400 font-bold uppercase tracking-wider border border-green-500/30 px-2 py-0.5 rounded bg-green-500/10">
                        ${p.idpPeriod || 'Ongoing'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-1 truncate group-hover:text-green-300 transition-colors tracking-tight">${p.idpName}</h3>
                <p class="text-xs text-slate-400 mb-4 truncate">${p.idpCurrentRole || '-'}</p>
                
                <div class="mb-4">
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-xs text-slate-400">Growth Progress</span>
                        <span class="text-2xl font-bold text-white font-mono leading-none">${progress}%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 h-1.5 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-green-500 to-emerald-400 shadow-[0_0_10px_currentColor]" style="width: ${progress}%"></div>
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.idpMentor ? p.idpMentor.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Mentor</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.idpMentor || '-'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        return div;
    }
function getIDPDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.idpImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.idpName)}&background=14532d&color=fff&size=800`;
        const progress = p.idpProgressRate || 0;

        const subRows = (p.subIDPs || []).map(s => {
            let statusBadge = 'text-slate-400';
            let rowClass = 'hover:bg-white/5';
            if(s.status === 'Done') {
                statusBadge = 'text-emerald-400 font-bold';
                rowClass = 'bg-emerald-900/10 hover:bg-emerald-900/20';
            }
            else if(s.status === 'On Progress') statusBadge = 'text-yellow-400 font-bold';

            const dateDisplay = s.date !== '-' ? new Date(s.date).toLocaleDateString('id-ID') : '-';

            return `
            <tr class="border-b border-white/5 transition ${rowClass}">
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.skill}</td>
                <td class="p-4 text-sm text-slate-300 align-top">
                    <span class="text-[10px] text-green-300 block mb-1 uppercase tracking-wide font-bold">${s.method}</span>
                    <p>${s.activity}</p>
                </td>
                <td class="p-4 text-center text-sm text-slate-400 font-mono align-top">${dateDisplay}</td>
                <td class="p-4 text-center text-xs ${statusBadge} align-top uppercase">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.idpName)}&background=14532d&color=fff&size=800'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-green-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-green-200 text-[10px] uppercase tracking-widest border border-green-500/30">IDP</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.idpPeriod || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-2 drop-shadow-2xl">${p.idpName}</h1>
                    <p class="text-xl text-green-300 mb-4">${p.idpCurrentRole || '-'}</p>
                    
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-person-chalkboard text-green-500"></i> Mentor: ${p.idpMentor || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-green-500"></i> Created: ${formatDate(p.createdAt)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-green-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-star"></i> Career Aspirations</h4>
                        <p class="text-white text-lg font-medium leading-relaxed">"${p.idpGoal || '-'}"</p>
                    </div>

                    <div>
                        <h3 class="text-green-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Action Plan (70:20:10)</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-green-900/20 text-green-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/4">Skill Gap</th><th class="p-4">Method & Activity</th><th class="p-4 text-center">Deadline</th><th class="p-4 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada rencana.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-green-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-green-300 font-bold text-xs uppercase mb-2">Self Reflection / Notes</h4>
                        <p class="text-slate-400 text-sm italic">"${p.idpNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6 relative overflow-hidden">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2 relative z-10">Overall Progress</h3>
                        <div class="relative z-10 text-center py-4">
                            <span class="text-5xl font-bold text-white">${progress}%</span>
                            <span class="block text-xs text-slate-500 mt-2 uppercase tracking-widest">Completed</span>
                        </div>
                        <div class="absolute -bottom-4 -right-4 text-green-500/10 text-9xl"><i class="fa-solid fa-chart-pie"></i></div>
                    </div>

                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Support Needed</h3>
                        <p class="text-slate-300 text-sm leading-relaxed">${p.idpSupport || '-'}</p>
                    </div>
                </div>
            </div>
        `;
    }
// --- LOGIKA POST-MORTEM REVIEW ---
   function getPostMortemFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="PostMortem">

            <div class="space-y-4">
                <h3 class="text-stone-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Ringkasan Insiden</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul Insiden *</label>
                        <input type="text" id="pmTitle" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Database outage region SG-1">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Insiden ID</label><input type="text" id="pmCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="INC-2026-001"></div>
                    
                    <div><label class="block text-xs text-stone-300 mb-1">Durasi Downtime</label><input type="text" id="pmDuration" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="2 Jam 30 Menit"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Severity Level</label>
                        <select id="pmSeverity" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="SEV-1 (Critical)">SEV-1 (Critical)</option>
                            <option value="SEV-2 (High)">SEV-2 (High)</option>
                            <option value="SEV-3 (Moderate)">SEV-3 (Moderate)</option>
                            <option value="SEV-4 (Low)">SEV-4 (Low)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Laporan</label>
                        <select id="pmStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Investigating">Investigating (Sedang Analisis)</option>
                            <option value="Resolved">Resolved (Perbaikan Selesai)</option>
                            <option value="Closed">Closed (Selesai Penuh)</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Insiden</label><input type="date" id="pmDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Impact Summary</label><textarea id="pmImpact" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Apa dampak terhadap user/bisnis?"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-stone-400 font-bold uppercase text-xs tracking-widest">B. Timeline, RCA, & Action Items</h3>
                    <span class="text-[10px] text-slate-500 italic">Rekonstruksi dan perbaikan</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-stone-300 mb-1">Kategori Item</label>
                        <select id="pmSubType" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Timeline">Timeline (Waktu Kejadian)</option>
                            <option value="Root Cause">Root Cause (5 Whys)</option>
                            <option value="Action Item">Action Item (Perbaikan)</option>
                        </select>
                    </div>
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Deskripsi Detail</label><input type="text" id="pmSubDesc" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Apa yang terjadi / Penyebab / Tindakan"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Waktu / Owner</label><input type="text" id="pmSubMeta" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Jam 14:00 / Tim DevOps"></div>

                    <button type="button" onclick="addSubPostMortem()" class="md:col-span-12 bg-stone-600 hover:bg-stone-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-stone-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-list-check mr-1"></i> Tambahkan Poin
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-stone-700/50 text-stone-200 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/5">Tipe</th>
                                <th class="p-3 border-b border-white/10">Deskripsi</th>
                                <th class="p-3 border-b border-white/10 w-1/4">Waktu / Owner</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="pmSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="pmSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada data analisis.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-stone-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Lessons Learned</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Tiket/Monitoring</label><input type="text" id="pmDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image (Grafik Insiden)</label><input type="text" id="pmImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2 bg-stone-900/10 p-4 rounded-xl border border-stone-500/20">
                         <label class="block text-xs text-stone-300 mb-1 font-bold">Apa yang berhasil & Apa yang gagal?</label>
                         <textarea id="pmLessons" rows="3" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Refleksi tim agar tidak terulang..."></textarea>
                    </div>
                </div>
            </div>
        </form>
        `;
    } 
    function addSubPostMortem() {
        const desc = document.getElementById('pmSubDesc').value;
        const type = document.getElementById('pmSubType').value;
        
        if(!desc) return alert("Deskripsi wajib diisi!");

        const newSub = {
            id: generateId(),
            type: type,
            desc: desc,
            meta: document.getElementById('pmSubMeta').value || '-'
        };

        tempSubPostMortems.push(newSub);
        renderSubPostMortemTable();
        
        // Reset Inputs
        document.getElementById('pmSubDesc').value = '';
        document.getElementById('pmSubMeta').value = '';
    }

    function removeSubPostMortem(id) {
        tempSubPostMortems = tempSubPostMortems.filter(s => s.id !== id);
        renderSubPostMortemTable();
    }

    function renderSubPostMortemTable() {
        const tbody = document.getElementById('pmSubListBody');
        const emptyDiv = document.getElementById('pmSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubPostMortems.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubPostMortems.forEach(s => {
                // Warna Badge Tipe
                let typeBadge = 'bg-slate-700 text-slate-300';
                if(s.type === 'Timeline') typeBadge = 'bg-blue-500/20 text-blue-300 border border-blue-500/30';
                else if(s.type === 'Root Cause') typeBadge = 'bg-red-500/20 text-red-300 border border-red-500/30';
                else if(s.type === 'Action Item') typeBadge = 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 align-top"><span class="text-[10px] px-2 py-1 rounded uppercase ${typeBadge}">${s.type}</span></td>
                    <td class="p-3 text-white font-medium text-sm align-top leading-relaxed">${s.desc}</td>
                    <td class="p-3 text-slate-400 text-xs align-top font-mono">${s.meta}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubPostMortem('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populatePostMortemForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('pmTitle', p.pmTitle); setVal('pmCode', p.pmCode);
        setVal('pmDuration', p.pmDuration); setVal('pmSeverity', p.pmSeverity); 
        setVal('pmStatus', p.status); setVal('pmDate', p.pmDate);
        setVal('pmImpact', p.pmImpact);
        setVal('pmDocLink', p.pmDocLink); setVal('pmImage', p.image);
        setVal('pmLessons', p.pmLessons);

        tempSubPostMortems = p.subPostMortems || [];
        renderSubPostMortemTable();
    }

function createPostMortemCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.pmImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Severity Badge Color Logic
        let sevColor = 'bg-stone-500';
        if(p.pmSeverity?.includes('SEV-1')) sevColor = 'bg-red-600 animate-pulse';
        else if(p.pmSeverity?.includes('SEV-2')) sevColor = 'bg-orange-500';
        else if(p.pmSeverity?.includes('SEV-3')) sevColor = 'bg-yellow-500 text-black';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded ${sevColor} shadow-lg tracking-wider border border-white/10 shadow-black/30">${p.pmSeverity || 'SEV-?'}</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-stone-400 font-bold uppercase tracking-wider border border-stone-500/30 px-2 py-0.5 rounded bg-stone-500/10">
                        ${p.pmCode || 'INC-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-stone-300 transition-colors tracking-tight">${p.pmTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.pmImpact || 'Belum ada impact summary.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-2 text-xs text-red-400 font-bold bg-red-900/10 px-2 py-1 rounded border border-red-500/20">
                        <i class="fa-solid fa-stopwatch"></i>
                        <span>${p.pmDuration || '-'}</span>
                    </div>
                    
                    <div class="flex items-center gap-2 text-[10px] text-stone-400">
                        <i class="fa-solid fa-calendar-day"></i>
                        <span>${p.pmDate ? new Date(p.pmDate).toLocaleDateString('id-ID') : '-'}</span>
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getPostMortemDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.pmImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        // Pisahkan Data
        const timelines = (p.subPostMortems || []).filter(s => s.type === 'Timeline');
        const rcas = (p.subPostMortems || []).filter(s => s.type === 'Root Cause');
        const actions = (p.subPostMortems || []).filter(s => s.type === 'Action Item');

        // Helper Render List
        const renderList = (items, icon, color) => {
            if(items.length === 0) return `<div class="text-slate-500 text-xs italic p-4 text-center border border-dashed border-white/10 rounded">Tidak ada data.</div>`;
            return items.map(s => `
                <div class="flex gap-4 mb-4 relative last:mb-0 group">
                    <div class="w-10 shrink-0 flex flex-col items-center">
                        <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-black font-bold shadow-lg z-10"><i class="${icon} text-xs"></i></div>
                        <div class="w-0.5 bg-white/10 h-full absolute top-8 -z-0 group-last:hidden"></div>
                    </div>
                    <div class="flex-1 bg-white/5 p-3 rounded-xl border border-white/5 hover:bg-white/10 transition">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-slate-200 font-medium text-sm">${s.desc}</span>
                            <span class="text-[10px] text-slate-400 bg-black/20 px-2 py-0.5 rounded font-mono">${s.meta}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover grayscale opacity-50" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-stone-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-stone-200 text-[10px] uppercase tracking-widest border border-stone-500/30">POST-MORTEM</span>
                         <span class="px-3 py-1 rounded-lg bg-red-600/80 text-white text-[10px] font-bold uppercase tracking-widest border border-red-500/50">${p.pmSeverity || 'SEV-?'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.pmTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-stopwatch text-red-500"></i> Downtime: ${p.pmDuration || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-stone-500"></i> Date: ${formatDate(p.pmDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-stone-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-burst"></i> Dampak & Pelajaran</h4>
                        <div class="space-y-4">
                            <div>
                                <span class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Impact Summary</span>
                                <p class="text-slate-300 text-sm leading-relaxed">${p.pmImpact || '-'}</p>
                            </div>
                            <div class="border-t border-white/5 pt-4">
                                <span class="text-[10px] text-emerald-500 uppercase font-bold block mb-1">Lessons Learned</span>
                                <p class="text-slate-300 text-sm italic">"${p.pmLessons || '-'}"</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-6">
                        
                        <div>
                            <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest mb-4 border-b border-blue-500/30 pb-2 flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left"></i> Timeline Kejadian</h3>
                            <div>${renderList(timelines, 'fa-clock', 'bg-blue-500')}</div>
                        </div>

                        <div>
                            <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest mb-4 border-b border-red-500/30 pb-2 flex items-center gap-2"><i class="fa-solid fa-magnifying-glass-chart"></i> Root Cause (5 Whys)</h3>
                            <div>${renderList(rcas, 'fa-bug', 'bg-red-500')}</div>
                        </div>

                        <div>
                            <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest mb-4 border-b border-emerald-500/30 pb-2 flex items-center gap-2"><i class="fa-solid fa-screwdriver-wrench"></i> Action Items</h3>
                            <div>${renderList(actions, 'fa-check', 'bg-emerald-500')}</div>
                        </div>

                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Detail Dokumen</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Insiden ID</span><span class="text-stone-300 text-right font-bold">${p.pmCode}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.pmDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-stone-500/50 hover:bg-stone-500/10 transition text-xs text-stone-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-ticket group-hover:scale-110 transition"></i> Link Tiket/Jira</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    // Auto Calculate Preview
    document.addEventListener('input', function(e) {
        if(['riceSubR', 'riceSubI', 'riceSubC', 'riceSubE'].includes(e.target.id)) {
            const r = parseFloat(document.getElementById('riceSubR').value) || 0;
            const i = parseFloat(document.getElementById('riceSubI').value) || 0;
            const c = parseFloat(document.getElementById('riceSubC').value) || 0;
            const eVal = parseFloat(document.getElementById('riceSubE').value) || 1; // Prevent div by zero
            
            const score = (r * i * c) / (eVal === 0 ? 1 : eVal);
            const el = document.getElementById('ricePreview');
            if(el) el.innerText = score.toFixed(2);
        }
    });

    function calculateTopRICE() {
        let max = 0;
        tempSubRICEs.forEach(s => {
            if(parseFloat(s.score) > max) max = parseFloat(s.score);
        });
        
        const el = document.getElementById('riceTopScore');
        if(el) el.value = max.toFixed(2);
        return max;
    }

    function addSubRICE() {
        const feature = document.getElementById('riceSubFeature').value;
        const r = parseFloat(document.getElementById('riceSubR').value) || 0;
        const i = parseFloat(document.getElementById('riceSubI').value) || 0;
        const c = parseFloat(document.getElementById('riceSubC').value) || 0;
        const eVal = parseFloat(document.getElementById('riceSubE').value) || 0;
        
        if(!feature) return alert("Nama Fitur wajib diisi!");
        if(eVal <= 0) return alert("Effort harus lebih dari 0!");

        const score = (r * i * c) / eVal;

        const newSub = {
            id: generateId(),
            feature: feature,
            r: r,
            i: i,
            c: c,
            e: eVal,
            score: score.toFixed(2)
        };

        // Sort descending by score
        tempSubRICEs.push(newSub);
        tempSubRICEs.sort((a, b) => parseFloat(b.score) - parseFloat(a.score));

        renderSubRICETable();
        calculateTopRICE();
        
        // Reset Inputs
        document.getElementById('riceSubFeature').value = '';
        document.getElementById('riceSubR').value = '';
        document.getElementById('riceSubE').value = '';
        document.getElementById('ricePreview').innerText = '0.00';
    }

    function removeSubRICE(id) {
        tempSubRICEs = tempSubRICEs.filter(s => s.id !== id);
        renderSubRICETable();
        calculateTopRICE();
    }

    function renderSubRICETable() {
        const tbody = document.getElementById('riceSubListBody');
        const emptyDiv = document.getElementById('riceSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubRICEs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubRICEs.forEach((s, index) => {
                // Rank Badge
                let rank = index + 1;
                let rankBadge = `<span class="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-slate-300">#${rank}</span>`;
                if(rank === 1) rankBadge = `<span class="text-[10px] bg-pink-500 text-white font-bold px-2 py-0.5 rounded shadow-lg shadow-pink-500/50">TOP 1</span>`;

                // Confidence Display
                const confPercent = (s.c * 100) + '%';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top">
                        <div class="flex items-center gap-2">
                            ${rankBadge}
                            <span>${s.feature}</span>
                        </div>
                    </td>
                    <td class="p-3 text-center text-xs text-slate-300 font-mono align-top">${s.r}</td>
                    <td class="p-3 text-center text-xs text-slate-300 font-mono align-top">${s.i}</td>
                    <td class="p-3 text-center text-xs text-slate-300 font-mono align-top">${confPercent}</td>
                    <td class="p-3 text-center text-xs text-slate-300 font-mono align-top">${s.e}</td>
                    <td class="p-3 text-right text-sm font-bold text-pink-400 font-mono align-top">${s.score}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubRICE('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateRICEForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('riceName', p.riceName); setVal('riceCode', p.riceCode);
        setVal('ricePM', p.ricePM); setVal('ricePeriod', p.ricePeriod); 
        setVal('riceStatus', p.status); setVal('riceGoal', p.riceGoal);
        setVal('riceDocLink', p.riceDocLink); setVal('riceImage', p.image);
        setVal('riceNotes', p.riceNotes);

        tempSubRICEs = p.subRICEs || [];
        // Re-sort just in case
        tempSubRICEs.sort((a, b) => parseFloat(b.score) - parseFloat(a.score));
        
        renderSubRICETable();
        calculateTopRICE();
    }

function getRICEFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="RICE">

            <div class="space-y-4">
                <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Konteks Prioritas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Project / Sprint *</label>
                        <input type="text" id="riceName" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Q1 Mobile App Roadmap">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Dokumen</label><input type="text" id="riceCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="PM-2026-Q1"></div>
                    
                    <div><label class="block text-xs text-pink-300 mb-1">Product Manager</label><input type="text" id="ricePM" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Periode Perencanaan</label><input type="text" id="ricePeriod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Q1 2026"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="riceStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Prioritized">Prioritized (Selesai Hitung)</option>
                            <option value="Approved">Approved (Disetujui)</option>
                            <option value="Backlog">Backlog</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Top Feature Score</label>
                        <input type="text" id="riceTopScore" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-pink-400 cursor-not-allowed" value="0">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Tujuan Strategis (Objective)</label><textarea id="riceGoal" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Apa tujuan utama dari fitur-fitur ini?"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest">B. Calculator (R x I x C / E)</h3>
                    <span class="text-[10px] text-slate-500 italic">Input data untuk hitung skor</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-pink-300 mb-1">Nama Fitur</label><input type="text" id="riceSubFeature" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Fitur..."></div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1" title="Jumlah user/event per periode">Reach (R)</label>
                        <input type="number" id="riceSubR" class="glass-input w-full px-3 py-2 rounded text-xs text-center" placeholder="1000">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1" title="Dampak ke user">Impact (I)</label>
                        <select id="riceSubI" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300 text-center">
                            <option value="3">3 - Massive</option>
                            <option value="2">2 - High</option>
                            <option value="1">1 - Medium</option>
                            <option value="0.5">0.5 - Low</option>
                            <option value="0.25">0.25 - Minimal</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1" title="Tingkat keyakinan">Confidence (C)</label>
                        <select id="riceSubC" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300 text-center">
                            <option value="1">100% - High</option>
                            <option value="0.8">80% - Medium</option>
                            <option value="0.5">50% - Low</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1" title="Usaha (Man-month/Weeks)">Effort (E)</label>
                        <input type="number" id="riceSubE" class="glass-input w-full px-3 py-2 rounded text-xs text-center" placeholder="1">
                    </div>

                    <div class="md:col-span-12 flex items-center justify-between bg-white/5 p-2 rounded-lg mt-2 border border-white/5">
                        <span class="text-[10px] text-slate-400">Preview Score:</span>
                        <span id="ricePreview" class="text-xl font-bold text-pink-400 font-mono">0.00</span>
                    </div>

                    <button type="button" onclick="addSubRICE()" class="md:col-span-12 bg-pink-600 hover:bg-pink-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-pink-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-calculator mr-1"></i> Hitung & Tambah
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-pink-900/30 text-pink-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Fitur</th>
                                <th class="p-3 border-b border-white/10 text-center" title="Reach">R</th>
                                <th class="p-3 border-b border-white/10 text-center" title="Impact">I</th>
                                <th class="p-3 border-b border-white/10 text-center" title="Confidence">C</th>
                                <th class="p-3 border-b border-white/10 text-center" title="Effort">E</th>
                                <th class="p-3 border-b border-white/10 text-right text-white font-bold">RICE Score</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="riceSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="riceSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada fitur.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link PRD / Jira</label><input type="text" id="riceDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="riceImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Tambahan</label><textarea id="riceNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
// --- LOGIKA SLA MONITOR ---
function createRICECard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.riceImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        const featCount = (p.subRICEs || []).length;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-pink-600 shadow-lg tracking-wider border border-pink-500 shadow-pink-500/20">RICE</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-pink-400 font-bold uppercase tracking-wider border border-pink-500/30 px-2 py-0.5 rounded bg-pink-500/10">
                        ${p.ricePeriod || 'Future'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-pink-300 transition-colors tracking-tight">${p.riceName}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.riceGoal || 'Belum ada objective strategi.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.ricePM ? p.ricePM.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">PM</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.ricePM || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-pink-200 bg-pink-500/10 px-3 py-1.5 rounded-lg border border-pink-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        ${featCount} Features
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getRICEDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.riceImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        // Ensure sorted
        const sortedSubs = [...(p.subRICEs || [])].sort((a,b) => parseFloat(b.score) - parseFloat(a.score));

        const subRows = sortedSubs.map((s, index) => {
            let rankClass = 'text-slate-400 bg-white/5 border-white/5';
            let rankText = `#${index+1}`;
            
            if(index === 0) {
                rankClass = 'text-pink-300 bg-pink-500/20 border-pink-500/30 font-bold';
                rankText = ' #1';
            } else if (index === 1) {
                rankClass = 'text-rose-300 bg-rose-500/10 border-rose-500/20 font-bold';
                rankText = ' #2';
            } else if (index === 2) {
                rankClass = 'text-orange-300 bg-orange-500/10 border-orange-500/20 font-bold';
                rankText = ' #3';
            }

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition group">
                <td class="p-4 align-middle">
                    <span class="text-xs px-2 py-1 rounded border ${rankClass}">${rankText}</span>
                </td>
                <td class="p-4 text-white font-medium align-middle leading-relaxed">${s.feature}</td>
                <td class="p-4 text-center text-sm text-slate-300 font-mono align-middle">${s.r}</td>
                <td class="p-4 text-center text-sm text-slate-300 font-mono align-middle">${s.i}</td>
                <td class="p-4 text-center text-sm text-slate-300 font-mono align-middle">${(s.c * 100)}%</td>
                <td class="p-4 text-center text-sm text-slate-300 font-mono align-middle">${s.e}</td>
                <td class="p-4 text-right text-lg font-bold text-pink-400 font-mono align-middle bg-pink-900/10">${s.score}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-pink-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-pink-200 text-[10px] uppercase tracking-widest border border-pink-500/30">RICE</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.riceCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.riceName}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-astronaut text-pink-500"></i> PM: ${p.ricePM || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-timeline text-pink-500"></i> Period: ${p.ricePeriod || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-3 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-pink-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> Objective</h4>
                        <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-line">${p.riceGoal || '-'}</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2"><i class="fa-solid fa-arrow-up-wide-short"></i> Feature Prioritization Leaderboard</h3>
                            <span class="text-[10px] text-slate-500 italic">Sorted by Highest RICE Score</span>
                        </div>
                        
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[1000px]">
                                <thead class="bg-pink-900/20 text-pink-200 text-[10px] uppercase font-bold">
                                    <tr>
                                        <th class="p-4 w-[8%]">Rank</th>
                                        <th class="p-4">Feature Name</th>
                                        <th class="p-4 text-center">Reach</th>
                                        <th class="p-4 text-center">Impact</th>
                                        <th class="p-4 text-center">Confidence</th>
                                        <th class="p-4 text-center">Effort</th>
                                        <th class="p-4 text-right">RICE Score</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/5">
                                    ${subRows || '<tr><td colspan="7" class="p-4 text-center italic text-slate-500 text-xs">Belum ada fitur diprioritaskan.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-[#1e1b2e] border border-l-4 border-l-pink-500 border-white/5 p-6 rounded-r-2xl">
                            <h4 class="text-pink-300 font-bold text-xs uppercase mb-2">Catatan Tambahan</h4>
                            <p class="text-slate-400 text-sm italic">"${p.riceNotes || '-'}"</p>
                        </div>
                        
                        <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6 flex flex-col justify-center">
                            <div class="flex justify-between items-center text-xs text-slate-500 mb-2">
                                <span>Created At</span>
                                <span class="text-white">${formatDate(p.createdAt)}</span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-slate-500 mb-4">
                                <span>Updated At</span>
                                <span class="text-white">${formatDate(p.updatedAt)}</span>
                            </div>
                            <a href="${p.riceDocLink || '#'}" target="_blank" class="flex items-center justify-center w-full p-3 bg-pink-600/10 border border-pink-500/30 rounded-xl hover:bg-pink-600 hover:text-white transition text-xs text-pink-300 group gap-2">
                                <i class="fa-solid fa-link"></i> Link PRD / Jira
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
// --- LOGIKA GAP ANALYSIS ---
    function getGapAnalysisFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="GapAnalysis">

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Definisi Transformasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Fokus Area / Inisiatif *</label>
                        <input type="text" id="gapFocus" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Digitalisasi HR System / Peningkatan Skill Tim">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Analisis</label><input type="text" id="gapCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="GAP-2026-HR"></div>
                    
                    <div><label class="block text-xs text-fuchsia-300 mb-1">Target Waktu (Deadline)</label><input type="date" id="gapTarget" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Analyst / Lead</label><input type="text" id="gapLead" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Transformasi</label>
                        <select id="gapStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="In Progress">In Progress (Sedang Berjalan)</option>
                            <option value="Bridged">Bridged (Selesai/Tercapai)</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Progress Gap (Otomatis)</label>
                        <input type="text" id="gapProgress" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-fuchsia-400 cursor-not-allowed" value="0%">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Tujuan Strategis (Strategic Goal)</label><textarea id="gapGoal" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Mengapa gap ini harus ditutup?"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest">B. Matriks Kesenjangan</h3>
                    <span class="text-[10px] text-slate-500 italic">Bandingkan kondisi sekarang vs harapan</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-fuchsia-300 mb-1">Aspek / Komponen</label><input type="text" id="gapSubAspect" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Kompetensi Data Analytics"></div>
                    
                    <div class="md:col-span-6 border-r border-white/5 pr-2">
                        <label class="block text-[10px] text-slate-400 mb-1 font-bold">Kondisi Saat Ini (As-Is)</label>
                        <textarea id="gapSubAsIs" rows="2" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Kenyataan sekarang..."></textarea>
                    </div>
                    <div class="md:col-span-6 pl-2">
                        <label class="block text-[10px] text-fuchsia-400 mb-1 font-bold">Kondisi Harapan (To-Be)</label>
                        <textarea id="gapSubToBe" rows="2" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Target masa depan..."></textarea>
                    </div>
                    
                    <div class="md:col-span-9"><label class="block text-[10px] text-slate-400 mb-1">Action Plan (Tindakan Penutup Gap)</label><input type="text" id="gapSubAction" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Langkah konkret..."></div>
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1">Status Item</label>
                        <select id="gapSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Open">Open</option>
                            <option value="On Going">On Going</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubGap()" class="md:col-span-12 bg-fuchsia-600 hover:bg-fuchsia-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-fuchsia-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-arrows-left-right-to-line mr-1"></i> Tambah Analisis
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[1000px]">
                        <thead class="bg-fuchsia-900/30 text-fuchsia-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-[15%]">Aspek</th>
                                <th class="p-3 border-b border-white/10 w-[20%] text-slate-400">As-Is (Sekarang)</th>
                                <th class="p-3 border-b border-white/10 w-[20%] text-fuchsia-300">To-Be (Harapan)</th>
                                <th class="p-3 border-b border-white/10 w-[25%]">Action Plan</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="gapSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="gapSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada analisis gap.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Strategi & Kesimpulan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen Pendukung</label><input type="text" id="gapDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="gapImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Executive Summary / Strategi Utama</label><textarea id="gapSummary" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
    function calculateGapProgress() {
        if (tempSubGaps.length === 0) {
            const el = document.getElementById('gapProgress');
            if(el) el.value = '0%';
            return 0;
        }

        const doneCount = tempSubGaps.filter(s => s.status === 'Done').length;
        const rate = Math.round((doneCount / tempSubGaps.length) * 100);
        
        const el = document.getElementById('gapProgress');
        if(el) {
            el.value = rate + '%';
            el.style.color = rate >= 100 ? '#4ade80' : (rate >= 50 ? '#e879f9' : '#f87171');
        }
        return rate;
    }

    function addSubGap() {
        const aspect = document.getElementById('gapSubAspect').value;
        const asIs = document.getElementById('gapSubAsIs').value;
        const toBe = document.getElementById('gapSubToBe').value;
        
        if(!aspect) return alert("Aspek wajib diisi!");
        if(!asIs || !toBe) return alert("Kondisi As-Is dan To-Be wajib diisi!");

        const newSub = {
            id: generateId(),
            aspect: aspect,
            asIs: asIs,
            toBe: toBe,
            action: document.getElementById('gapSubAction').value || '-',
            status: document.getElementById('gapSubStatus').value
        };

        tempSubGaps.push(newSub);
        renderSubGapTable();
        calculateGapProgress();
        
        // Reset Inputs
        document.getElementById('gapSubAspect').value = '';
        document.getElementById('gapSubAsIs').value = '';
        document.getElementById('gapSubToBe').value = '';
        document.getElementById('gapSubAction').value = '';
    }

    function removeSubGap(id) {
        tempSubGaps = tempSubGaps.filter(s => s.id !== id);
        renderSubGapTable();
        calculateGapProgress();
    }

    function renderSubGapTable() {
        const tbody = document.getElementById('gapSubListBody');
        const emptyDiv = document.getElementById('gapSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubGaps.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubGaps.forEach(s => {
                // Warna Status
                let statusBadge = 'text-slate-400';
                if(s.status === 'Done') statusBadge = 'text-emerald-400 font-bold';
                else if(s.status === 'On Going') statusBadge = 'text-fuchsia-400 font-bold';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed text-xs uppercase tracking-wide">${s.aspect}</td>
                    <td class="p-3 text-slate-400 text-sm align-top italic bg-black/10">${s.asIs}</td>
                    <td class="p-3 text-fuchsia-300 text-sm align-top font-medium bg-fuchsia-900/10">${s.toBe}</td>
                    <td class="p-3 text-white text-sm align-top">${s.action}</td>
                    <td class="p-3 text-center text-xs ${statusBadge} align-top">${s.status}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubGap('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateGapForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('gapFocus', p.gapFocus); setVal('gapCode', p.gapCode);
        setVal('gapTarget', p.gapTarget); setVal('gapLead', p.gapLead); 
        setVal('gapStatus', p.status); setVal('gapGoal', p.gapGoal);
        setVal('gapDocLink', p.gapDocLink); setVal('gapImage', p.image);
        setVal('gapSummary', p.gapSummary);

        tempSubGaps = p.subGaps || [];
        renderSubGapTable();
        calculateGapProgress();
    }

    
function createGapAnalysisCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.gapImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        const gapCount = (p.subGaps || []).length;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-fuchsia-600 shadow-lg tracking-wider border border-fuchsia-500 shadow-fuchsia-500/20">GAP</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-fuchsia-400 font-bold uppercase tracking-wider border border-fuchsia-500/30 px-2 py-0.5 rounded bg-fuchsia-500/10">
                        ${p.gapCode || 'GAP-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-fuchsia-300 transition-colors tracking-tight">${p.gapFocus}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.gapGoal || 'Belum ada tujuan strategis yang didefinisikan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.gapLead ? p.gapLead.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Analyst</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.gapLead || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-fuchsia-200 bg-fuchsia-500/10 px-3 py-1.5 rounded-lg border border-fuchsia-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        ${gapCount} Aspects
                    </div>
                </div>
            </div>
        `;
        return div;
    }

    // --- LOGIKA SIPOC DIAGRAM ---
    function getGapAnalysisDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.gapImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subGaps || []).map(s => {
            let statusBadge = 'text-slate-400';
            if(s.status === 'Done') statusBadge = 'text-emerald-400 font-bold';
            else if(s.status === 'On Going') statusBadge = 'text-fuchsia-400 font-bold';

            return `
            <div class="bg-[#161b2e] border border-white/5 rounded-xl overflow-hidden mb-4 hover:border-fuchsia-500/30 transition duration-300">
                <div class="bg-gradient-to-r from-slate-800 to-[#1e2336] p-3 flex justify-between items-center border-b border-white/5">
                    <h5 class="text-fuchsia-300 font-bold text-sm uppercase tracking-wide"><i class="fa-solid fa-cube mr-2"></i> ${s.aspect}</h5>
                    <span class="text-xs ${statusBadge}">${s.status}</span>
                </div>
                <div class="p-4 grid grid-cols-1 md:grid-cols-7 gap-4 items-center">
                    <div class="md:col-span-3 bg-red-900/10 p-3 rounded-lg border border-red-500/10">
                        <div class="text-[10px] text-slate-500 uppercase mb-1 font-bold">Current State (As-Is)</div>
                        <p class="text-slate-300 text-sm leading-relaxed">${s.asIs}</p>
                    </div>
                    
                    <div class="md:col-span-1 flex justify-center text-fuchsia-500 text-xl animate-pulse">
                        <i class="fa-solid fa-arrow-right-long hidden md:block"></i>
                        <i class="fa-solid fa-arrow-down-long md:hidden"></i>
                    </div>
                    
                    <div class="md:col-span-3 bg-emerald-900/10 p-3 rounded-lg border border-emerald-500/10">
                        <div class="text-[10px] text-emerald-500 uppercase mb-1 font-bold">Desired State (To-Be)</div>
                        <p class="text-white text-sm leading-relaxed font-medium">${s.toBe}</p>
                    </div>
                </div>
                <div class="px-4 pb-4 pt-0">
                    <div class="border-t border-white/5 pt-3">
                        <div class="flex gap-2 items-start">
                            <i class="fa-solid fa-person-digging text-slate-500 mt-1"></i>
                            <div>
                                <span class="text-[10px] text-slate-500 uppercase font-bold block">Action Plan (Gap Closure)</span>
                                <p class="text-slate-200 text-sm italic">"${s.action}"</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-fuchsia-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-fuchsia-200 text-[10px] uppercase tracking-widest border border-fuchsia-500/30">GAP ANALYSIS</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.gapCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.gapFocus}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-astronaut text-fuchsia-500"></i> Analyst: ${p.gapLead || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-flag-checkered text-fuchsia-500"></i> Target: ${formatDate(p.gapTarget)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-fuchsia-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-chess-knight"></i> Tujuan Strategis</h4>
                        <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-line">${p.gapGoal || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-bridge-water"></i> Matriks Transformasi</h3>
                        <div>
                             ${subRows || '<div class="p-4 text-center italic text-slate-500 text-xs bg-[#161b2e] rounded-xl border border-white/5">Belum ada analisis gap.</div>'}
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-fuchsia-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-fuchsia-300 font-bold text-xs uppercase mb-2">Executive Summary</h4>
                        <p class="text-slate-400 text-sm italic">"${p.gapSummary || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Status Progress</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Gap Closed</span><span class="text-fuchsia-300 text-right font-bold">${p.gapProgressRate}%</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.gapDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-fuchsia-500/50 hover:bg-fuchsia-500/10 transition text-xs text-fuchsia-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-folder-open group-hover:scale-110 transition"></i> Dokumen Pendukung</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    function calculateSIPOCSteps() {
        const count = tempSubSIPOCs.length;
        const el = document.getElementById('spcCount');
        if(el) el.value = count + ' Steps';
        return count;
    }

    function addSubSIPOC() {
        const proc = document.getElementById('spcSubProc').value;
        
        if(!proc) return alert("Deskripsi Proses (Step) wajib diisi!");

        const newSub = {
            id: generateId(),
            sup: document.getElementById('spcSubSup').value || '-',
            inp: document.getElementById('spcSubIn').value || '-',
            proc: proc,
            out: document.getElementById('spcSubOut').value || '-',
            cust: document.getElementById('spcSubCust').value || '-'
        };

        tempSubSIPOCs.push(newSub);
        renderSubSIPOCTable();
        calculateSIPOCSteps();
        
        // Reset Inputs
        document.getElementById('spcSubSup').value = '';
        document.getElementById('spcSubIn').value = '';
        document.getElementById('spcSubProc').value = '';
        document.getElementById('spcSubOut').value = '';
        document.getElementById('spcSubCust').value = '';
    }

    function removeSubSIPOC(id) {
        tempSubSIPOCs = tempSubSIPOCs.filter(s => s.id !== id);
        renderSubSIPOCTable();
        calculateSIPOCSteps();
    }

    function renderSubSIPOCTable() {
        const tbody = document.getElementById('spcSubListBody');
        const emptyDiv = document.getElementById('spcSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubSIPOCs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubSIPOCs.forEach((s, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-slate-400 italic text-xs align-top">${s.sup}</td>
                    <td class="p-3 text-slate-300 text-xs align-top">${s.inp}</td>
                    <td class="p-3 align-top">
                        <div class="flex items-start gap-2">
                            <span class="text-teal-500 font-bold text-xs mt-0.5">${index + 1}.</span>
                            <span class="text-white font-medium text-sm">${s.proc}</span>
                        </div>
                    </td>
                    <td class="p-3 text-slate-300 text-xs align-top">${s.out}</td>
                    <td class="p-3 text-slate-400 italic text-xs align-top">${s.cust}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubSIPOC('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateSIPOCForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('spcName', p.spcName); setVal('spcCode', p.spcCode);
        setVal('spcOwner', p.spcOwner); setVal('spcDate', p.spcDate); 
        setVal('spcStatus', p.status); setVal('spcScope', p.spcScope);
        setVal('spcDocLink', p.spcDocLink); setVal('spcImage', p.image);
        setVal('spcNotes', p.spcNotes);

        tempSubSIPOCs = p.subSIPOCs || [];
        renderSubSIPOCTable();
        calculateSIPOCSteps();
    }

   function getSIPOCFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="SIPOC">

            <div class="space-y-4">
                <h3 class="text-teal-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Definisi Proses</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Proses Bisnis *</label>
                        <input type="text" id="spcName" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Pemenuhan Order Pelanggan">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Proses</label><input type="text" id="spcCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="PROC-2026-01"></div>
                    
                    <div><label class="block text-xs text-teal-300 mb-1">Process Owner</label><input type="text" id="spcOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Terakhir Update</label><input type="date" id="spcDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Pemetaan</label>
                        <select id="spcStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Mapped">Mapped (Terpetakan)</option>
                            <option value="Optimized">Optimized</option>
                            <option value="Approved">Approved</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Jumlah Langkah (Otomatis)</label>
                        <input type="text" id="spcCount" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-teal-400 cursor-not-allowed" value="0 Steps">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Batasan Proses (Start & End)</label><textarea id="spcScope" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Dimulai dari... Berakhir saat..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-teal-400 font-bold uppercase text-xs tracking-widest">B. Alur SIPOC</h3>
                    <span class="text-[10px] text-slate-500 italic">Supplier > Input > Process > Output > Customer</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-3 border-r border-white/5 pr-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Supplier (Penyedia)</label>
                        <input type="text" id="spcSubSup" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Siapa yang memberi?">
                        <label class="block text-[10px] text-slate-400 mt-2 mb-1">Input (Masukan)</label>
                        <input type="text" id="spcSubIn" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Apa yang masuk?">
                    </div>
                    
                    <div class="md:col-span-6 border-r border-white/5 pr-2 pl-2">
                        <label class="block text-[10px] text-teal-300 mb-1 font-bold">Process Step (Langkah)</label>
                        <textarea id="spcSubProc" rows="3" class="glass-input w-full px-3 py-2 rounded text-sm font-medium" placeholder="Deskripsi aktivitas..."></textarea>
                    </div>

                    <div class="md:col-span-3 pl-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Output (Hasil)</label>
                        <input type="text" id="spcSubOut" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Apa hasilnya?">
                        <label class="block text-[10px] text-slate-400 mt-2 mb-1">Customer (Penerima)</label>
                        <input type="text" id="spcSubCust" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Siapa yang terima?">
                    </div>

                    <button type="button" onclick="addSubSIPOC()" class="md:col-span-12 bg-teal-600 hover:bg-teal-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-teal-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-arrow-right-arrow-left mr-1"></i> Tambah Langkah
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[1000px]">
                        <thead class="bg-teal-900/30 text-teal-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-[15%]">Supplier</th>
                                <th class="p-3 border-b border-white/10 w-[15%]">Input</th>
                                <th class="p-3 border-b border-white/10 w-[30%] text-center text-teal-300">PROCESS</th>
                                <th class="p-3 border-b border-white/10 w-[15%]">Output</th>
                                <th class="p-3 border-b border-white/10 w-[15%]">Customer</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="spcSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="spcSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada langkah proses.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-teal-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi Tambahan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Flowchart (Visio/Lucid)</label><input type="text" id="spcDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="spcImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Perbaikan (Kaizen)</label><textarea id="spcNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
function createSIPOCCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.spcImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const steps = (p.subSIPOCs || []).length;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-teal-400 shadow-lg tracking-wider border border-teal-300 shadow-teal-500/20">SIPOC</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-teal-400 font-bold uppercase tracking-wider border border-teal-500/30 px-2 py-0.5 rounded bg-teal-500/10">
                        ${p.spcCode || 'PROC-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-teal-300 transition-colors tracking-tight">${p.spcName}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.spcScope || 'Belum ada batasan proses yang didefinisikan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.spcOwner ? p.spcOwner.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Owner</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.spcOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-teal-200 bg-teal-500/10 px-3 py-1.5 rounded-lg border border-teal-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        ${steps} Steps Mapped
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- LOGIKA 5S AUDIT ---
  function getSIPOCDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.spcImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subSIPOCs || []).map((s, index) => `
            <tr class="border-b border-white/5 hover:bg-white/5 transition group">
                <td class="p-4 text-xs text-slate-400 italic align-top border-r border-white/5">${s.sup}</td>
                <td class="p-4 text-xs text-slate-300 align-top border-r border-white/5">${s.inp}</td>
                <td class="p-4 align-top bg-white/5 border-r border-white/5 relative">
                    <span class="absolute top-4 left-2 text-[10px] text-teal-500 font-bold">${index + 1}</span>
                    <span class="text-white font-medium text-sm pl-4 block">${s.proc}</span>
                </td>
                <td class="p-4 text-xs text-slate-300 align-top border-r border-white/5">${s.out}</td>
                <td class="p-4 text-xs text-slate-400 italic align-top">${s.cust}</td>
            </tr>`).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-teal-600 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-teal-200 text-[10px] uppercase tracking-widest border border-teal-500/30">SIPOC</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.spcCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.spcName}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-gear text-teal-500"></i> Owner: ${p.spcOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-check text-teal-500"></i> Updated: ${formatDate(p.spcDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 gap-8 bg-[#0f172a]">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-teal-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-arrows-left-right"></i> Batasan Proses (Scope)</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.spcScope || '-'}</p>
                    </div>
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-teal-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-notes-medical"></i> Catatan Perbaikan</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.spcNotes || '-'}</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-teal-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-diagram-project"></i> Diagram Alur (SIPOC)</h3>
                    <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                         <table class="w-full text-left text-sm min-w-[1000px]">
                            <thead class="bg-teal-900/20 text-teal-200 text-[10px] uppercase font-bold">
                                <tr>
                                    <th class="p-4 w-[15%] border-r border-white/5">Supplier</th>
                                    <th class="p-4 w-[15%] border-r border-white/5">Input</th>
                                    <th class="p-4 w-[40%] text-center bg-teal-500/10 border-r border-white/5 border-t-2 border-t-teal-500">Process</th>
                                    <th class="p-4 w-[15%] border-r border-white/5">Output</th>
                                    <th class="p-4 w-[15%]">Customer</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5">
                                ${subRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada langkah proses.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-6 flex flex-wrap gap-4 justify-between items-center text-xs text-slate-500 border-t border-white/5 pt-6">
                    <div>
                        <span class="mr-4">Dibuat: ${formatDate(p.createdAt)}</span>
                        <span>Update: ${formatDate(p.updatedAt)}</span>
                    </div>
                    <a href="${p.spcDocLink || '#'}" target="_blank" class="flex items-center gap-2 text-teal-400 hover:text-white transition"><i class="fa-solid fa-file-image"></i> Lihat Diagram Visio/Lucid</a>
                </div>
            </div>
        `;
    }  
    function calculate5SScore() {
        if (tempSub5S.length === 0) {
            document.getElementById('fsScore').value = '0%';
            document.getElementById('fsStatus').value = 'Pending';
            return 0;
        }

        let totalScore = 0;
        let maxScore = tempSub5S.length * 5; // Max score per item is 5

        tempSub5S.forEach(s => {
            totalScore += parseInt(s.score) || 0;
        });
        
        const percentage = Math.round((totalScore / maxScore) * 100);
        
        // Determine Predicate
        let predicate = 'Poor';
        if (percentage >= 90) predicate = 'Excellent';
        else if (percentage >= 75) predicate = 'Good';
        else if (percentage >= 60) predicate = 'Average';

        // Update UI
        const elScore = document.getElementById('fsScore');
        if(elScore) {
            elScore.value = percentage + '%';
            elScore.style.color = percentage >= 75 ? '#a3e635' : (percentage >= 60 ? '#facc15' : '#f87171');
        }
        
        const elStatus = document.getElementById('fsStatus');
        if(elStatus) elStatus.value = predicate;

        return percentage;
    }

    function addSub5S() {
        const item = document.getElementById('fsSubItem').value;
        const score = parseInt(document.getElementById('fsSubScore').value) || 0;
        
        if(!item) return alert("Item Cek wajib diisi!");
        if(score < 1 || score > 5) return alert("Skor harus antara 1 sampai 5!");

        const newSub = {
            id: generateId(),
            cat: document.getElementById('fsSubCat').value,
            item: item,
            score: score,
            proof: document.getElementById('fsSubProof').value || ''
        };

        tempSub5S.push(newSub);
        renderSub5STable();
        calculate5SScore();
        
        // Reset Inputs
        document.getElementById('fsSubItem').value = '';
        document.getElementById('fsSubScore').value = '5';
        document.getElementById('fsSubProof').value = '';
    }

    function removeSub5S(id) {
        tempSub5S = tempSub5S.filter(s => s.id !== id);
        renderSub5STable();
        calculate5SScore();
    }

    function renderSub5STable() {
        const tbody = document.getElementById('fsSubListBody');
        const emptyDiv = document.getElementById('fsSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSub5S.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSub5S.forEach(s => {
                // Skor Visual
                let scoreColor = 'text-red-400';
                if(s.score >= 5) scoreColor = 'text-lime-400 font-bold';
                else if(s.score >= 3) scoreColor = 'text-yellow-400';

                // Proof Link
                let proofDisplay = '-';
                if(s.proof) proofDisplay = `<a href="${s.proof}" target="_blank" class="text-lime-300 hover:text-white"><i class="fa-solid fa-image"></i></a>`;

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-lime-200/80 font-medium text-[10px] uppercase tracking-wide align-top">${s.cat.split('.')[1]}</td>
                    <td class="p-3 text-white text-sm align-top leading-relaxed">${s.item}</td>
                    <td class="p-3 text-center text-sm font-mono align-top ${scoreColor} bg-white/5">${s.score}</td>
                    <td class="p-3 text-center align-top">${proofDisplay}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSub5S('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populate5SForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('fsLocation', p.fsLocation); setVal('fsCode', p.fsCode);
        setVal('fsAuditor', p.fsAuditor); setVal('fsDate', p.fsDate); 
        setVal('fsStatus', p.status); setVal('fsScore', p.fsScore);
        setVal('fsNotes', p.fsNotes);
        setVal('fsDocLink', p.fsDocLink); setVal('fsImage', p.image);
        setVal('fsFindings', p.fsFindings);

        tempSub5S = p.sub5S || [];
        renderSub5STable();
        calculate5SScore(); // Recalculate visual
    }

    function get5SFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="5S">

            <div class="space-y-4">
                <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Informasi Area Audit</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Lokasi / Zona Area *</label>
                        <input type="text" id="fsLocation" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Warehouse Zone A / Produksi Line 1">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Audit</label><input type="text" id="fsCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="5S-2026-001"></div>
                    
                    <div><label class="block text-xs text-lime-300 mb-1">Auditor</label><input type="text" id="fsAuditor" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Audit</label><input type="date" id="fsDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Predikat Audit (Otomatis)</label>
                        <input type="text" id="fsStatus" readonly class="glass-input w-full p-3 rounded-lg text-sm text-slate-300 cursor-not-allowed" value="Pending">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Skor Total (%)</label>
                        <input type="text" id="fsScore" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-lime-400 cursor-not-allowed" value="0%">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Umum</label><textarea id="fsNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Kondisi umum area saat audit..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest">B. Checklist Item</h3>
                    <span class="text-[10px] text-slate-500 italic">Nilai 1 (Buruk) s/d 5 (Sempurna)</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-lime-300 mb-1">Kategori (5S)</label>
                        <select id="fsSubCat" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="1. Seiri (Ringkas)">1. Seiri (Sort)</option>
                            <option value="2. Seiton (Rapi)">2. Seiton (Set in Order)</option>
                            <option value="3. Seiso (Resik)">3. Seiso (Shine)</option>
                            <option value="4. Seiketsu (Rawat)">4. Seiketsu (Standardize)</option>
                            <option value="5. Shitsuke (Rajin)">5. Shitsuke (Sustain)</option>
                        </select>
                    </div>
                    <div class="md:col-span-5"><label class="block text-[10px] text-slate-400 mb-1">Item Cek</label><input type="text" id="fsSubItem" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Tidak ada barang tidak terpakai"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Skor (1-5)</label><input type="number" id="fsSubScore" class="glass-input w-full px-3 py-2 rounded text-xs" min="1" max="5" placeholder="5"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Foto Bukti (Link)</label><input type="text" id="fsSubProof" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="URL Foto"></div>

                    <button type="button" onclick="addSub5S()" class="md:col-span-12 bg-lime-600 hover:bg-lime-500 text-black py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-lime-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-check-double mr-1"></i> Tambah Item
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-lime-900/30 text-lime-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/5">Kategori</th>
                                <th class="p-3 border-b border-white/10">Item Cek</th>
                                <th class="p-3 border-b border-white/10 text-center">Skor</th>
                                <th class="p-3 border-b border-white/10 text-center">Bukti</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="fsSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="fsSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada item checklist.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Temuan & Dokumentasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image (Foto Area)</label><input type="text" id="fsImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Laporan PDF</label><input type="text" id="fsDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Temuan Major / Tindakan Perbaikan</label><textarea id="fsFindings" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Apa yang perlu diperbaiki segera?"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
function create5SCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.fsImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        
        // Tentukan warna badge status di footer berdasarkan predikat
        let footerBadgeColor = 'text-slate-400 border-slate-500/30 bg-slate-500/10';
        if (p.status === 'Excellent') footerBadgeColor = 'text-lime-400 border-lime-500/50 bg-lime-500/10';
        else if (p.status === 'Good') footerBadgeColor = 'text-emerald-400 border-emerald-500/50 bg-emerald-500/10';
        else if (p.status === 'Average') footerBadgeColor = 'text-yellow-400 border-yellow-500/50 bg-yellow-500/10';
        else if (p.status === 'Poor') footerBadgeColor = 'text-red-400 border-red-500/50 bg-red-500/10';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg bg-lime-500 text-black">${p.fsScore || '0%'}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-lime-400 shadow-lg tracking-wider border border-lime-300 shadow-lime-500/20">5S AUDIT</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-lime-400 font-bold uppercase tracking-wider border border-lime-500/30 px-2 py-0.5 rounded bg-lime-500/10">
                        ${p.fsCode || 'AUD-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-lime-300 transition-colors tracking-tight">${p.fsLocation}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.fsNotes || 'Belum ada catatan audit.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.fsAuditor ? p.fsAuditor.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Auditor</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.fsAuditor || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold px-3 py-1.5 rounded-lg border uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0 ${footerBadgeColor}">
                        <i class="fa-solid fa-award text-[9px]"></i> ${p.status || 'Pending'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }    function get5SDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.fsImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        const score = p.fsScore || 0;

        const subRows = (p.sub5S || []).map(s => {
            let scoreColor = 'text-red-400';
            if(s.score >= 5) scoreColor = 'text-lime-400 font-bold';
            else if(s.score >= 3) scoreColor = 'text-yellow-400';

            const proofIcon = s.proof ? `<a href="${s.proof}" target="_blank" class="text-lime-400 hover:text-white"><i class="fa-solid fa-camera"></i></a>` : '<span class="text-slate-600">-</span>';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-lime-200/70 font-bold uppercase tracking-wide text-xs align-top w-1/5">${s.cat}</td>
                <td class="p-4 text-white font-medium align-top leading-relaxed text-sm">${s.item}</td>
                <td class="p-4 text-center text-lg font-mono align-top ${scoreColor} bg-white/5">${s.score}</td>
                <td class="p-4 text-center align-top">${proofIcon}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-lime-500 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-lime-200 text-[10px] uppercase tracking-widest border border-lime-500/30">5S AUDIT</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.fsCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.fsLocation}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-check text-lime-500"></i> Auditor: ${p.fsAuditor || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-lime-500"></i> Date: ${formatDate(p.fsDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Total Item Cek</span>
                            <span class="text-xl font-bold text-white">${(p.sub5S || []).length} Points</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Skor Kerapihan</span>
                            <span class="text-2xl font-bold ${score>=75?'text-lime-400':'text-yellow-400'} font-mono">${score}%</span>
                            <div class="absolute top-0 right-0 p-3 opacity-10 text-lime-500 text-4xl"><i class="fa-solid fa-broom"></i></div>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-lime-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-note-sticky"></i> Catatan Umum</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.fsNotes || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Detail Checklist</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-lime-900/20 text-lime-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/5">Category</th><th class="p-4">Item Check</th><th class="p-4 text-center">Score</th><th class="p-4 text-center">Proof</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada checklist.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-lime-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-lime-300 font-bold text-xs uppercase mb-2">Temuan & Perbaikan</h4>
                        <p class="text-slate-400 text-sm italic">"${p.fsFindings || 'Area bersih, tidak ada temuan major.'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Status Audit</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Predikat</span><span class="text-lime-300 text-right font-bold">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.fsDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-lime-500/50 hover:bg-lime-500/10 transition text-xs text-lime-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-pdf group-hover:scale-110 transition"></i> Laporan Lengkap</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    function calculateSLAPenalty() {
        let total = 0;
        tempSubSLAs.forEach(s => {
            total += parseFloat(s.penalty) || 0;
        });
        
        const el = document.getElementById('slaTotalPenalty');
        if(el) el.value = 'Rp ' + total.toLocaleString('id-ID');
        return total;
    }

    function addSubSLA() {
        const metric = document.getElementById('slaSubMetric').value;
        const target = document.getElementById('slaSubTarget').value;
        
        if(!metric) return alert("Nama Metrik wajib diisi!");

        const newSub = {
            id: generateId(),
            metric: metric,
            target: target || '-',
            actual: document.getElementById('slaSubActual').value || '-',
            result: document.getElementById('slaSubResult').value,
            penalty: parseFloat(document.getElementById('slaSubPenalty').value) || 0
        };

        tempSubSLAs.push(newSub);
        renderSubSLATable();
        calculateSLAPenalty();
        
        // Reset Inputs
        document.getElementById('slaSubMetric').value = '';
        document.getElementById('slaSubTarget').value = '';
        document.getElementById('slaSubActual').value = '';
        document.getElementById('slaSubPenalty').value = '';
    }

    function removeSubSLA(id) {
        tempSubSLAs = tempSubSLAs.filter(s => s.id !== id);
        renderSubSLATable();
        calculateSLAPenalty();
    }

    function renderSubSLATable() {
        const tbody = document.getElementById('slaSubListBody');
        const emptyDiv = document.getElementById('slaSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubSLAs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubSLAs.forEach(s => {
                // Warna Hasil
                let resBadge = 'text-slate-400';
                if(s.result === 'Achieved') resBadge = 'text-emerald-400 font-bold';
                else if(s.result === 'Failed') resBadge = 'text-red-500 font-bold';

                const penaltyDisplay = s.penalty > 0 ? `<span class="text-red-400">Rp ${s.penalty.toLocaleString('id-ID')}</span>` : '-';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.metric}</td>
                    <td class="p-3 text-center text-xs text-slate-300 align-top">${s.target}</td>
                    <td class="p-3 text-center text-xs text-white font-mono align-top">${s.actual}</td>
                    <td class="p-3 text-center text-xs ${resBadge} align-top uppercase">${s.result}</td>
                    <td class="p-3 text-right text-xs font-mono align-top">${penaltyDisplay}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubSLA('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateSLAForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('slaClient', p.slaClient); setVal('slaService', p.slaService);
        setVal('slaPeriod', p.slaPeriod); setVal('slaDate', p.slaDate); 
        setVal('slaStatus', p.status); setVal('slaUptime', p.slaUptime);
        setVal('slaDesc', p.slaDesc);
        setVal('slaDocLink', p.slaDocLink); setVal('slaImage', p.image);
        setVal('slaNotes', p.slaNotes);

        tempSubSLAs = p.subSLAs || [];
        renderSubSLATable();
        calculateSLAPenalty();
    }

function getSLAFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="SLA">

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Informasi Kontrak Layanan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Klien / User *</label>
                        <input type="text" id="slaClient" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: PT Teknologi Maju / Divisi Sales">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Nama Layanan</label><input type="text" id="slaService" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Internet Dedicated 100Mbps"></div>
                    
                    <div><label class="block text-xs text-cyan-300 mb-1">Periode Laporan</label><input type="text" id="slaPeriod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Januari 2026"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Review</label><input type="date" id="slaDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Kepatuhan</label>
                        <select id="slaStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Compliant">Compliant (Patuh)</option>
                            <option value="At Risk">At Risk (Risiko)</option>
                            <option value="Breached">Breached (Melanggar)</option>
                            <option value="Review">Review</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Target Uptime (%)</label>
                        <input type="number" id="slaUptime" class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-cyan-400" placeholder="99.9" step="0.1">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Deskripsi Layanan</label><textarea id="slaDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Lingkup layanan yang diberikan..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest">B. Metrik Kinerja (KPIs)</h3>
                    <span class="text-[10px] text-slate-500 italic">Parameter ukur dan realisasi</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-4"><label class="block text-[10px] text-cyan-300 mb-1">Nama Metrik</label><input type="text" id="slaSubMetric" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Response Time"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Target (Janji)</label><input type="text" id="slaSubTarget" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="< 15 Menit"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Realisasi (Aktual)</label><input type="text" id="slaSubActual" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="10 Menit"></div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1">Hasil</label>
                        <select id="slaSubResult" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Achieved">Achieved (Tercapai)</option>
                            <option value="Failed">Failed (Gagal)</option>
                        </select>
                    </div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Penalti (Jika Ada)</label><input type="number" id="slaSubPenalty" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="0"></div>
                    
                    <button type="button" onclick="addSubSLA()" class="md:col-span-5 bg-cyan-600 hover:bg-cyan-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-cyan-500/20 mt-5 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Metrik
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-cyan-900/30 text-cyan-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/4">Metrik</th>
                                <th class="p-3 border-b border-white/10 text-center">Target</th>
                                <th class="p-3 border-b border-white/10 text-center">Realisasi</th>
                                <th class="p-3 border-b border-white/10 text-center">Hasil</th>
                                <th class="p-3 border-b border-white/10 text-right">Penalti</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="slaSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="slaSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada metrik.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Kesimpulan & Bukti</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-300 font-bold mb-1">Total Estimasi Penalti</label>
                        <input type="text" id="slaTotalPenalty" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-red-400 cursor-not-allowed" value="Rp 0">
                    </div>
                    <div class="col-span-2 md:col-span-1"><label class="block text-xs text-slate-400 mb-1">Link Laporan Insiden</label><input type="text" id="slaDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="slaImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Catatan Tambahan</label><textarea id="slaNotes" rows="1" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
function createSLACard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.slaImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Tentukan warna badge footer
        let footerBadgeColor = 'text-slate-400 border-slate-500/30 bg-slate-500/10';
        if (p.status === 'Compliant') footerBadgeColor = 'text-emerald-400 border-emerald-500/50 bg-emerald-500/10';
        else if (p.status === 'At Risk') footerBadgeColor = 'text-yellow-400 border-yellow-500/50 bg-yellow-500/10';
        else if (p.status === 'Breached') footerBadgeColor = 'text-red-400 border-red-500/50 bg-red-500/10';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-cyan-400 shadow-lg tracking-wider border border-cyan-300 shadow-cyan-500/20">SLA</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-cyan-400 font-bold uppercase tracking-wider border border-cyan-500/30 px-2 py-0.5 rounded bg-cyan-500/10">
                        ${p.slaPeriod || 'Periode?'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-1 truncate group-hover:text-cyan-300 transition-colors tracking-tight">${p.slaClient}</h3>
                <p class="text-xs text-slate-500 mb-3 font-mono tracking-wide">${p.slaService || '-'}</p>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.slaDesc || 'Belum ada deskripsi layanan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                        <i class="fa-solid fa-list-check text-cyan-500"></i>
                        <span>${(p.subSLAs || []).length} Metrics</span>
                    </div>

                    <div class="text-[10px] font-bold px-3 py-1.5 rounded-lg border uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0 ${footerBadgeColor}">
                        <i class="fa-solid fa-file-contract text-[9px]"></i> ${p.status || 'Draft'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- LOGIKA FMEA FRAMEWORK ---
   function getSLADetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.slaImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        const penalty = parseFloat(p.slaTotalPenalty || 0);
        const uptime = parseFloat(p.slaUptime || 0);

        const subRows = (p.subSLAs || []).map(s => {
            let resBadge = 'text-slate-400';
            if(s.result === 'Achieved') resBadge = 'text-emerald-400 font-bold';
            else if(s.result === 'Failed') resBadge = 'text-red-500 font-bold';

            const penDisp = s.penalty > 0 ? `<span class="text-red-400 bg-red-500/10 px-2 py-0.5 rounded border border-red-500/20">Rp ${s.penalty.toLocaleString('id-ID')}</span>` : '-';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-white font-medium align-top leading-relaxed w-1/4">${s.metric}</td>
                <td class="p-4 text-center text-sm text-slate-300 font-mono align-top">${s.target}</td>
                <td class="p-4 text-center text-sm text-white font-mono align-top bg-white/5">${s.actual}</td>
                <td class="p-4 text-center text-xs ${resBadge} align-top uppercase">${s.result}</td>
                <td class="p-4 text-right text-xs font-mono align-top">${penDisp}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-cyan-600 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-cyan-200 text-[10px] uppercase tracking-widest border border-cyan-500/30">SLA REPORT</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.slaPeriod || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.slaClient}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-server text-cyan-500"></i> Service: ${p.slaService || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-check text-cyan-500"></i> Review: ${formatDate(p.slaDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Uptime Performance</span>
                            <span class="text-3xl font-bold ${uptime>=99?'text-emerald-400':'text-yellow-400'} font-mono">${uptime}%</span>
                            <div class="absolute top-0 right-0 p-3 opacity-10 text-cyan-500 text-4xl"><i class="fa-solid fa-wave-square"></i></div>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Total Penalty</span>
                            <span class="text-xl font-bold ${penalty>0?'text-red-400':'text-slate-200'} font-mono">Rp ${penalty.toLocaleString('id-ID')}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-cyan-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Lingkup Layanan</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.slaDesc || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-chart-simple"></i> Detail Metrik & KPI</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-cyan-900/20 text-cyan-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/4">Metrik</th><th class="p-4 text-center">Target</th><th class="p-4 text-center">Aktual</th><th class="p-4 text-center">Hasil</th><th class="p-4 text-right">Penalti</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada metrik.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-cyan-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-cyan-300 font-bold text-xs uppercase mb-2">Catatan Tambahan</h4>
                        <p class="text-slate-400 text-sm italic">"${p.slaNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Status Laporan</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.slaDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-cyan-500/50 hover:bg-cyan-500/10 transition text-xs text-cyan-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-contract group-hover:scale-110 transition"></i> Dokumen Insiden</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    } 
    // Listener untuk preview RPN saat ketik
    document.addEventListener('input', function(e) {
        if(e.target.id === 'fmeaSubS' || e.target.id === 'fmeaSubO' || e.target.id === 'fmeaSubD') {
            const s = parseInt(document.getElementById('fmeaSubS').value) || 0;
            const o = parseInt(document.getElementById('fmeaSubO').value) || 0;
            const d = parseInt(document.getElementById('fmeaSubD').value) || 0;
            const preview = document.getElementById('fmeaPreviewRPN');
            if(preview) preview.innerText = (s * o * d);
        }
    });

    function calculateMaxRPN() {
        let max = 0;
        tempSubFMEAs.forEach(s => {
            if(s.rpn > max) max = s.rpn;
        });
        
        const el = document.getElementById('fmeaMaxRPN');
        if(el) {
            el.value = max;
            // Coloring based on risk
            el.style.color = max > 100 ? '#ef4444' : (max > 50 ? '#fbbf24' : '#4ade80');
        }
        return max;
    }

    function addSubFMEA() {
        const mode = document.getElementById('fmeaSubMode').value;
        const s = parseInt(document.getElementById('fmeaSubS').value) || 0;
        const o = parseInt(document.getElementById('fmeaSubO').value) || 0;
        const d = parseInt(document.getElementById('fmeaSubD').value) || 0;
        
        if(!mode) return alert("Failure Mode wajib diisi!");
        if(s < 1 || s > 10 || o < 1 || o > 10 || d < 1 || d > 10) return alert("Nilai S, O, dan D harus antara 1 - 10!");

        const newSub = {
            id: generateId(),
            mode: mode,
            effect: document.getElementById('fmeaSubEffect').value || '-',
            cause: document.getElementById('fmeaSubCause').value || '-',
            s: s,
            o: o,
            d: d,
            rpn: s * o * d,
            action: document.getElementById('fmeaSubAction').value || '-'
        };

        tempSubFMEAs.push(newSub);
        renderSubFMEATable();
        calculateMaxRPN();
        
        // Reset Inputs
        document.getElementById('fmeaSubMode').value = '';
        document.getElementById('fmeaSubEffect').value = '';
        document.getElementById('fmeaSubCause').value = '';
        document.getElementById('fmeaSubS').value = '';
        document.getElementById('fmeaSubO').value = '';
        document.getElementById('fmeaSubD').value = '';
        document.getElementById('fmeaSubAction').value = '';
        document.getElementById('fmeaPreviewRPN').innerText = '-';
    }

    function removeSubFMEA(id) {
        tempSubFMEAs = tempSubFMEAs.filter(s => s.id !== id);
        renderSubFMEATable();
        calculateMaxRPN();
    }

    function renderSubFMEATable() {
        const tbody = document.getElementById('fmeaSubListBody');
        const emptyDiv = document.getElementById('fmeaSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubFMEAs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubFMEAs.forEach(s => {
                // Warna RPN
                let rpnClass = 'text-green-400';
                if(s.rpn >= 100) rpnClass = 'text-red-500 font-bold animate-pulse';
                else if(s.rpn >= 50) rpnClass = 'text-yellow-400 font-bold';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.mode}</td>
                    <td class="p-3 text-xs text-slate-300 align-top">
                        <div class="mb-1"><span class="text-slate-500">E:</span> ${s.effect}</div>
                        <div><span class="text-slate-500">C:</span> ${s.cause}</div>
                    </td>
                    <td class="p-3 text-center text-xs text-red-300 align-top font-mono bg-white/5">${s.s}</td>
                    <td class="p-3 text-center text-xs text-yellow-300 align-top font-mono bg-white/5">${s.o}</td>
                    <td class="p-3 text-center text-xs text-blue-300 align-top font-mono bg-white/5">${s.d}</td>
                    <td class="p-3 text-center text-sm ${rpnClass} align-top font-mono border-x border-white/10">${s.rpn}</td>
                    <td class="p-3 text-xs text-slate-400 italic align-top">${s.action}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubFMEA('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateFMEAForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('fmeaProcess', p.fmeaProcess); setVal('fmeaCode', p.fmeaCode);
        setVal('fmeaTeam', p.fmeaTeam); setVal('fmeaDate', p.fmeaDate); 
        setVal('fmeaStatus', p.status); setVal('fmeaScope', p.fmeaScope);
        setVal('fmeaDocLink', p.fmeaDocLink); setVal('fmeaImage', p.image);
        setVal('fmeaSummary', p.fmeaSummary);

        tempSubFMEAs = p.subFMEAs || [];
        renderSubFMEATable();
        calculateMaxRPN();
    }
function getFMEAFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="FMEA">

            <div class="space-y-4">
                <h3 class="text-orange-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Informasi Proses/Produk</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Proses / Komponen *</label>
                        <input type="text" id="fmeaProcess" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Sistem Pengereman Hidrolik">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Nomor Dokumen</label><input type="text" id="fmeaCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="FMEA-2026-ENG-01"></div>
                    
                    <div><label class="block text-xs text-orange-300 mb-1">Tim Reviewer (Cross-functional)</label><input type="text" id="fmeaTeam" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Engineering, QA, Production"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Revisi</label><input type="date" id="fmeaDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="fmeaStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Open">Open (Analisis)</option>
                            <option value="Mitigated">Mitigated (Tindakan Diambil)</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Highest RPN (Max Risk)</label>
                        <input type="text" id="fmeaMaxRPN" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-orange-400 cursor-not-allowed" value="0">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Ruang Lingkup (Scope)</label><textarea id="fmeaScope" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Batasan sistem yang dianalisis..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-orange-400 font-bold uppercase text-xs tracking-widest">B. Failure Modes & RPN</h3>
                    <span class="text-[10px] text-slate-500 italic">RPN = Severity x Occurrence x Detection</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-4"><label class="block text-[10px] text-orange-300 mb-1">Potential Failure Mode</label><input type="text" id="fmeaSubMode" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Cara gagal..."></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Potential Effect (Dampak)</label><input type="text" id="fmeaSubEffect" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Apa akibatnya?"></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Potential Cause (Penyebab)</label><input type="text" id="fmeaSubCause" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Kenapa terjadi?"></div>
                    
                    <div class="md:col-span-3 bg-red-900/20 p-2 rounded border border-red-500/20">
                        <label class="block text-[9px] text-red-300 font-bold mb-1">Severity (S) 1-10</label>
                        <input type="number" id="fmeaSubS" class="glass-input w-full px-2 py-1 rounded text-xs text-center" min="1" max="10" placeholder="S">
                    </div>
                    <div class="md:col-span-3 bg-yellow-900/20 p-2 rounded border border-yellow-500/20">
                        <label class="block text-[9px] text-yellow-300 font-bold mb-1">Occurrence (O) 1-10</label>
                        <input type="number" id="fmeaSubO" class="glass-input w-full px-2 py-1 rounded text-xs text-center" min="1" max="10" placeholder="O">
                    </div>
                    <div class="md:col-span-3 bg-blue-900/20 p-2 rounded border border-blue-500/20">
                        <label class="block text-[9px] text-blue-300 font-bold mb-1">Detection (D) 1-10</label>
                        <input type="number" id="fmeaSubD" class="glass-input w-full px-2 py-1 rounded text-xs text-center" min="1" max="10" placeholder="D">
                    </div>
                    <div class="md:col-span-3 flex items-end">
                         <div class="w-full bg-slate-700 p-2 rounded text-center">
                            <span class="block text-[9px] text-slate-400">Auto RPN</span>
                            <span class="text-lg font-bold text-white" id="fmeaPreviewRPN">-</span>
                         </div>
                    </div>

                    <div class="md:col-span-12"><label class="block text-[10px] text-slate-400 mb-1">Tindakan Rekomendasi</label><input type="text" id="fmeaSubAction" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Apa yang harus dilakukan untuk menurunkan RPN?"></div>

                    <button type="button" onclick="addSubFMEA()" class="md:col-span-12 bg-orange-600 hover:bg-orange-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-orange-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-calculator mr-1"></i> Hitung & Tambah
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[1000px]">
                        <thead class="bg-orange-900/30 text-orange-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/4">Failure Mode</th>
                                <th class="p-3 border-b border-white/10">Effect & Cause</th>
                                <th class="p-3 border-b border-white/10 text-center" title="Severity">S</th>
                                <th class="p-3 border-b border-white/10 text-center" title="Occurrence">O</th>
                                <th class="p-3 border-b border-white/10 text-center" title="Detection">D</th>
                                <th class="p-3 border-b border-white/10 text-center font-bold text-white">RPN</th>
                                <th class="p-3 border-b border-white/10">Action</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Hapus</th>
                            </tr>
                        </thead>
                        <tbody id="fmeaSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="fmeaSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada analisis.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-orange-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Tanda Tangan & Bukti</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Diagram/Drawing</label><input type="text" id="fmeaDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="fmeaImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Kesimpulan Engineering</label><textarea id="fmeaSummary" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
function createFMEACard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.fmeaImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const maxRPN = p.fmeaMaxRPN || 0;

        // Tentukan warna badge RPN di footer
        let rpnColor = 'text-green-400 border-green-500/50 bg-green-500/10';
        if(maxRPN >= 100) rpnColor = 'text-red-400 border-red-500/50 bg-red-500/10 animate-pulse';
        else if(maxRPN >= 50) rpnColor = 'text-yellow-400 border-yellow-500/50 bg-yellow-500/10';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-orange-400 shadow-lg tracking-wider border border-orange-300 shadow-orange-500/20">FMEA</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-orange-400 font-bold uppercase tracking-wider border border-orange-500/30 px-2 py-0.5 rounded bg-orange-500/10">
                        ${p.fmeaCode || 'DOC-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-orange-300 transition-colors tracking-tight">${p.fmeaProcess}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.fmeaScope || 'Belum ada ruang lingkup analisis.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            <i class="fa-solid fa-users text-orange-400"></i>
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Team</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.fmeaTeam || '-'}</span>
                        </div>
                    </div>

                    <div class="text-[10px] font-bold px-3 py-1.5 rounded-lg border uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0 ${rpnColor}">
                        <i class="fa-solid fa-triangle-exclamation text-[9px]"></i> RPN: ${maxRPN}
                    </div>
                </div>
            </div>
        `;
        return div;
    }    // --- LOGIKA KCI FRAMEWORK ---
    function getFMEADetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.fmeaImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        const maxRPN = p.fmeaMaxRPN || 0;

        const subRows = (p.subFMEAs || []).map(s => {
            let rpnClass = 'text-green-400';
            if(s.rpn >= 100) rpnClass = 'text-red-500 font-bold';
            else if(s.rpn >= 50) rpnClass = 'text-yellow-400 font-bold';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-white font-medium align-top leading-relaxed w-1/4">${s.mode}</td>
                <td class="p-4 text-sm text-slate-300 align-top">
                    <div class="mb-2"><span class="text-[10px] text-slate-500 uppercase">Effect:</span> <span class="text-white">${s.effect}</span></div>
                    <div><span class="text-[10px] text-slate-500 uppercase">Cause:</span> <span class="text-white">${s.cause}</span></div>
                </td>
                <td class="p-4 text-center text-sm font-mono align-top text-red-300 bg-white/5">${s.s}</td>
                <td class="p-4 text-center text-sm font-mono align-top text-yellow-300 bg-white/5">${s.o}</td>
                <td class="p-4 text-center text-sm font-mono align-top text-blue-300 bg-white/5">${s.d}</td>
                <td class="p-4 text-center text-lg font-mono align-top ${rpnClass} border-l border-white/10">${s.rpn}</td>
                <td class="p-4 text-sm text-slate-400 italic align-top">${s.action}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-orange-600 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-orange-200 text-[10px] uppercase tracking-widest border border-orange-500/30">FMEA</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.fmeaCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.fmeaProcess}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-users-gear text-orange-500"></i> Team: ${p.fmeaTeam || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-orange-500"></i> Rev Date: ${formatDate(p.fmeaDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Failure Modes</span>
                            <span class="text-xl font-bold text-white">${(p.subFMEAs || []).length} Items</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Highest RPN</span>
                            <span class="text-2xl font-bold ${maxRPN>=100?'text-red-500':'text-orange-400'} font-mono">${maxRPN}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-orange-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-magnifying-glass"></i> Ruang Lingkup Analisis</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.fmeaScope || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-orange-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-ol"></i> Analisis Mode Kegagalan</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[900px]"><thead class="bg-orange-900/20 text-orange-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/4">Mode</th><th class="p-4">Details</th><th class="p-4 text-center">S</th><th class="p-4 text-center">O</th><th class="p-4 text-center">D</th><th class="p-4 text-center">RPN</th><th class="p-4">Action</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="7" class="p-4 text-center italic text-slate-500 text-xs">Belum ada analisis.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-orange-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-orange-300 font-bold text-xs uppercase mb-2">Kesimpulan Engineering</h4>
                        <p class="text-slate-400 text-sm italic">"${p.fmeaSummary || 'Tidak ada kesimpulan.'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Status</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Current Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.fmeaDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-orange-500/50 hover:bg-orange-500/10 transition text-xs text-orange-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-invoice group-hover:scale-110 transition"></i> Dokumen Teknis</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    function calculateKCICompliance() {
        if (tempSubKCIs.length === 0) {
            const el = document.getElementById('kciRate');
            if(el) el.value = '0%';
            return 0;
        }

        // Hitung Pass vs Total (exclude N/A)
        const validItems = tempSubKCIs.filter(s => s.result !== 'N/A');
        if (validItems.length === 0) return 0;

        const passCount = validItems.filter(s => s.result === 'Pass').length;
        const rate = Math.round((passCount / validItems.length) * 100);
        
        const el = document.getElementById('kciRate');
        if(el) {
            el.value = rate + '%';
            el.style.color = rate >= 90 ? '#4ade80' : (rate >= 70 ? '#fbbf24' : '#f87171');
        }
        return rate;
    }

    function addSubKCI() {
        const point = document.getElementById('kciSubPoint').value;
        const method = document.getElementById('kciSubMethod').value;
        
        if(!point) return alert("Titik Kontrol wajib diisi!");

        const newSub = {
            id: generateId(),
            point: point,
            method: method || '-',
            findings: document.getElementById('kciSubFindings').value || 'Tidak ada temuan.',
            result: document.getElementById('kciSubResult').value
        };

        tempSubKCIs.push(newSub);
        renderSubKCITable();
        calculateKCICompliance();
        
        // Reset Inputs
        document.getElementById('kciSubPoint').value = '';
        document.getElementById('kciSubMethod').value = '';
        document.getElementById('kciSubFindings').value = '';
    }

    function removeSubKCI(id) {
        tempSubKCIs = tempSubKCIs.filter(s => s.id !== id);
        renderSubKCITable();
        calculateKCICompliance();
    }

    function renderSubKCITable() {
        const tbody = document.getElementById('kciSubListBody');
        const emptyDiv = document.getElementById('kciSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubKCIs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubKCIs.forEach(s => {
                // Warna Hasil
                let resultBadge = 'text-slate-400';
                if(s.result === 'Pass') resultBadge = 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30';
                else if(s.result === 'Fail') resultBadge = 'bg-red-500/20 text-red-300 border border-red-500/30 font-bold';
                else resultBadge = 'bg-slate-700 text-slate-300';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.point}</td>
                    <td class="p-3 text-xs text-slate-300 align-top">${s.method}</td>
                    <td class="p-3 text-xs text-slate-400 italic align-top">${s.findings}</td>
                    <td class="p-3 text-center align-top"><span class="text-[10px] px-2 py-1 rounded uppercase ${resultBadge}">${s.result}</span></td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubKCI('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateKCIForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('kciProcess', p.kciProcess); setVal('kciCode', p.kciCode);
        setVal('kciAuditor', p.kciAuditor); setVal('kciDate', p.kciDate); 
        setVal('kciStatus', p.status); setVal('kciScope', p.kciScope);
        setVal('kciDocLink', p.kciDocLink); setVal('kciImage', p.image);
        setVal('kciSummary', p.kciSummary);

        tempSubKCIs = p.subKCIs || [];
        renderSubKCITable();
        calculateKCICompliance();
    }
function getKCIFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="KCI">

            <div class="space-y-4">
                <h3 class="text-zinc-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Informasi Audit</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Proses Bisnis (Objek Audit) *</label>
                        <input type="text" id="kciProcess" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Proses Pembayaran Vendor">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Dokumen Audit</label><input type="text" id="kciCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="AUD-2026-001"></div>
                    
                    <div><label class="block text-xs text-zinc-300 mb-1">Auditor / Penguji</label><input type="text" id="kciAuditor" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Audit</label><input type="date" id="kciDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Kepatuhan</label>
                        <select id="kciStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Compliant">Compliant (Patuh)</option>
                            <option value="Non-Compliant">Non-Compliant (Pelanggaran)</option>
                            <option value="On Review">On Review</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Compliance Rate (Otomatis)</label>
                        <input type="text" id="kciRate" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-zinc-400 cursor-not-allowed" value="0%">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Lingkup Audit (Scope)</label><textarea id="kciScope" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Batasan area yang diperiksa..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-zinc-400 font-bold uppercase text-xs tracking-widest">B. Pengujian Kontrol (Test of Control)</h3>
                    <span class="text-[10px] text-slate-500 italic">Rincian titik kontrol</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-zinc-300 mb-1">Titik Kontrol (Control Point)</label><input type="text" id="kciSubPoint" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Apa yang dicek? (Misal: Otorisasi PO)"></div>
                    
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Metode Tes</label><input type="text" id="kciSubMethod" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Observasi/Sampling/Reperformance"></div>
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Temuan (Findings)</label><input type="text" id="kciSubFindings" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Hasil observasi..."></div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Hasil Tes</label>
                        <select id="kciSubResult" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Pass">Pass</option>
                            <option value="Fail">Fail</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubKCI()" class="md:col-span-12 bg-zinc-600 hover:bg-zinc-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-zinc-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-list-check mr-1"></i> Catat Hasil Tes
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-zinc-700/50 text-zinc-200 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Titik Kontrol</th>
                                <th class="p-3 border-b border-white/10">Metode Tes</th>
                                <th class="p-3 border-b border-white/10">Temuan</th>
                                <th class="p-3 border-b border-white/10 text-center">Hasil</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="kciSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="kciSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada pengujian.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-zinc-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Pelaporan & Bukti</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Kertas Kerja (Working Paper)</label><input type="text" id="kciDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="kciImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Executive Summary / Rekomendasi</label><textarea id="kciSummary" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
function createKCICard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.kciImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const rate = p.kciComplianceRate || 0;

        // Tentukan warna badge rate di footer
        let rateColor = 'text-red-400 border-red-500/50 bg-red-500/10';
        if (rate >= 90) rateColor = 'text-emerald-400 border-emerald-500/50 bg-emerald-500/10';
        else if (rate >= 70) rateColor = 'text-amber-400 border-amber-500/50 bg-amber-500/10';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-zinc-600 shadow-lg tracking-wider border border-zinc-500 shadow-zinc-500/20">AUDIT</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-zinc-400 font-bold uppercase tracking-wider border border-zinc-500/30 px-2 py-0.5 rounded bg-zinc-500/10">
                        ${p.kciCode || 'AUD-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-zinc-300 transition-colors tracking-tight">${p.kciProcess}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.kciScope || 'Belum ada lingkup audit yang didefinisikan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.kciAuditor ? p.kciAuditor.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Auditor</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.kciAuditor || '-'}</span>
                        </div>
                    </div>

                    <div class="text-[10px] font-bold px-3 py-1.5 rounded-lg border uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0 ${rateColor}">
                        <i class="fa-solid fa-percent text-[9px]"></i> ${rate}% Compliant
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- LOGIKA KRI FRAMEWORK ---
  function getKRIFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="KRI">

            <div class="space-y-4">
                <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Profil Risiko Utama</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Kategori Risiko *</label>
                        <input type="text" id="kriCategory" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Cyber Security / Likuiditas">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode KRI</label><input type="text" id="kriCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="KRI-2026-SEC"></div>
                    
                    <div>
                        <label class="block text-xs text-red-300 mb-1">Level Toleransi (Risk Appetite)</label>
                        <select id="kriTolerance" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Low">Low (Ketataat Tinggi)</option>
                            <option value="Medium">Medium (Moderat)</option>
                            <option value="High">High (Agresif)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Keseluruhan</label>
                        <select id="kriStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Safe">Safe (Aman)</option>
                            <option value="Warning">Warning (Waspada)</option>
                            <option value="Danger">Danger (Bahaya)</option>
                        </select>
                    </div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Risk Owner</label><input type="text" id="kriOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Periode Review</label><input type="text" id="kriPeriod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Bulanan / Kuartalan"></div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Deskripsi & Dampak</label><textarea id="kriDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Jelaskan risiko ini..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest">B. Early Warning Indicators</h3>
                    <span class="text-[10px] text-slate-500 italic">Metrik pemantauan dini</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-5"><label class="block text-[10px] text-red-300 mb-1">Indikator Risiko</label><input type="text" id="kriSubIndicator" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Gagal Login > 5x"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Ambang Batas (Threshold)</label><input type="text" id="kriSubThreshold" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Max 10 per jam"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Nilai Saat Ini</label><input type="text" id="kriSubCurrent" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Status Item</label>
                        <select id="kriSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Safe">Safe</option>
                            <option value="Warning">Warning</option>
                            <option value="Danger">Danger</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubKRI()" class="md:col-span-12 bg-red-600 hover:bg-red-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-red-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-bell mr-1"></i> Tambah Indikator
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-red-900/30 text-red-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Indikator</th>
                                <th class="p-3 border-b border-white/10 text-center">Threshold</th>
                                <th class="p-3 border-b border-white/10 text-center">Current</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="kriSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="kriSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada indikator.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Rencana Mitigasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen SOP</label><input type="text" id="kriDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="kriImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Tindakan Perbaikan (Jika Danger)</label><textarea id="kriAction" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }  
    function addSubKRI() {
        const ind = document.getElementById('kriSubIndicator').value;
        const current = document.getElementById('kriSubCurrent').value;
        
        if(!ind) return alert("Indikator wajib diisi!");

        const newSub = {
            id: generateId(),
            ind: ind,
            threshold: document.getElementById('kriSubThreshold').value || '-',
            current: current || '-',
            status: document.getElementById('kriSubStatus').value
        };

        tempSubKRIs.push(newSub);
        renderSubKRITable();
        
        // Reset Inputs
        document.getElementById('kriSubIndicator').value = '';
        document.getElementById('kriSubThreshold').value = '';
        document.getElementById('kriSubCurrent').value = '';
    }

    function removeSubKRI(id) {
        tempSubKRIs = tempSubKRIs.filter(s => s.id !== id);
        renderSubKRITable();
    }
function getKCIDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.kciImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        const rate = p.kciComplianceRate || 0;

        const subRows = (p.subKCIs || []).map(s => {
            let resultBadge = 'text-slate-400';
            if(s.result === 'Pass') resultBadge = 'text-emerald-400 font-bold';
            else if(s.result === 'Fail') resultBadge = 'text-red-400 font-bold uppercase';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-white font-medium align-top leading-relaxed w-1/3">${s.point}</td>
                <td class="p-4 text-sm text-slate-300 align-top">${s.method}</td>
                <td class="p-4 text-sm text-slate-400 italic align-top">${s.findings}</td>
                <td class="p-4 text-center text-xs ${resultBadge} align-top">${s.result}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-zinc-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-zinc-200 text-[10px] uppercase tracking-widest border border-zinc-500/30">AUDIT KCI</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.kciCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.kciProcess}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-secret text-zinc-400"></i> Auditor: ${p.kciAuditor || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-zinc-400"></i> Date: ${formatDate(p.kciDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Total Controls</span>
                            <span class="text-xl font-bold text-white">${(p.subKCIs || []).length} Points</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Compliance Rate</span>
                            <span class="text-2xl font-bold ${rate>=90?'text-emerald-400':'text-red-400'} font-mono">${rate}%</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-zinc-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-crosshairs"></i> Lingkup Audit</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.kciScope || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-zinc-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-clipboard-check"></i> Hasil Pengujian Kontrol</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-zinc-700/50 text-zinc-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/3">Titik Kontrol</th><th class="p-4">Metode</th><th class="p-4">Temuan</th><th class="p-4 text-center">Result</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada pengujian.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-zinc-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-zinc-300 font-bold text-xs uppercase mb-2">Executive Summary</h4>
                        <p class="text-slate-400 text-sm italic">"${p.kciSummary || 'Tidak ada catatan.'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Status Audit</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Hasil Akhir</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.kciDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-zinc-500/50 hover:bg-zinc-500/10 transition text-xs text-zinc-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-pdf group-hover:scale-110 transition"></i> Working Paper</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }

    function renderSubKRITable() {
        const tbody = document.getElementById('kriSubListBody');
        const emptyDiv = document.getElementById('kriSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubKRIs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubKRIs.forEach(s => {
                // Warna Status Item
                let statusBadge = 'text-slate-400';
                if(s.status === 'Safe') statusBadge = 'text-emerald-400 font-bold';
                else if(s.status === 'Warning') statusBadge = 'text-amber-400 font-bold';
                else if(s.status === 'Danger') statusBadge = 'text-red-500 font-bold animate-pulse';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.ind}</td>
                    <td class="p-3 text-center text-xs text-slate-300 font-mono align-top">${s.threshold}</td>
                    <td class="p-3 text-center text-xs text-white font-mono align-top font-bold">${s.current}</td>
                    <td class="p-3 text-center text-xs ${statusBadge} align-top uppercase">${s.status}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubKRI('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateKRIForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('kriCategory', p.kriCategory); setVal('kriCode', p.kriCode);
        setVal('kriTolerance', p.kriTolerance); setVal('kriStatus', p.status); 
        setVal('kriOwner', p.kriOwner); setVal('kriPeriod', p.kriPeriod);
        setVal('kriDesc', p.kriDesc);
        setVal('kriDocLink', p.kriDocLink); setVal('kriImage', p.image);
        setVal('kriAction', p.kriAction);

        tempSubKRIs = p.subKRIs || [];
        renderSubKRITable();
    }
function createKRICard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.kriImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Count Danger Items
        const dangerCount = (p.subKRIs || []).filter(s => s.status === 'Danger').length;
        
        // Alert Effect
        let alertEffect = '';
        if(p.status === 'Danger' || dangerCount > 0) {
            alertEffect = `
                <div class="absolute inset-0 bg-red-600/10 z-0 animate-pulse"></div>
                <div class="absolute top-3 right-16 w-8 h-8 rounded-full bg-red-600 flex items-center justify-center text-white shadow-[0_0_15px_rgba(220,38,38,0.7)] z-20 animate-bounce"><i class="fa-solid fa-triangle-exclamation text-xs"></i></div>
            `;
        }

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                ${alertEffect}
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass} z-20">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-red-600 shadow-lg tracking-wider border border-red-500 shadow-red-500/20 z-20">KRI</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-red-400 font-bold uppercase tracking-wider border border-red-500/30 px-2 py-0.5 rounded bg-red-500/10">
                        ${p.kriTolerance || 'Risk Appetite?'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-red-300 transition-colors tracking-tight">${p.kriCategory}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.kriDesc || 'Tidak ada deskripsi risiko.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.kriOwner ? p.kriOwner.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Risk Owner</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.kriOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold ${dangerCount > 0 ? 'text-red-400 bg-red-500/10 border-red-500/20' : 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20'} px-3 py-1.5 rounded-lg border uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-chart-line text-[9px]"></i> ${dangerCount} Alerts
                    </div>
                </div>
            </div>
        `;
        return div;
    }    
 function getKRIDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.kriImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subKRIs || []).map(s => {
            let statusBadge = 'text-slate-400';
            let rowClass = '';
            if(s.status === 'Safe') statusBadge = 'text-emerald-400 font-bold';
            else if(s.status === 'Warning') statusBadge = 'text-amber-400 font-bold';
            else if(s.status === 'Danger') {
                statusBadge = 'text-red-500 font-bold uppercase animate-pulse';
                rowClass = 'bg-red-500/5';
            }

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition ${rowClass}">
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.ind}</td>
                <td class="p-4 text-center text-sm text-slate-300 font-mono align-top">${s.threshold}</td>
                <td class="p-4 text-center text-sm text-white font-mono align-top font-bold bg-white/5 rounded">${s.current}</td>
                <td class="p-4 text-center text-xs ${statusBadge} align-top">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-red-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-red-200 text-[10px] uppercase tracking-widest border border-red-500/30">KRI</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.kriCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.kriCategory}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-shield text-red-500"></i> Owner: ${p.kriOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-scale-unbalanced text-red-500"></i> Tolerance: ${p.kriTolerance || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-red-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Deskripsi Risiko</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.kriDesc || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-chart-line"></i> Monitoring Indikator</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-red-900/20 text-red-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/3">Indikator</th><th class="p-4 text-center">Threshold</th><th class="p-4 text-center">Current Value</th><th class="p-4 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada indikator.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-red-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-red-300 font-bold text-xs uppercase mb-2">Tindakan Perbaikan</h4>
                        <p class="text-slate-400 text-sm italic">"${p.kriAction || 'Tidak ada tindakan khusus.'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Review Period</span><div class="text-right"><div class="text-red-300 font-bold">${p.kriPeriod}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.kriDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-red-500/50 hover:bg-red-500/10 transition text-xs text-red-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-shield group-hover:scale-110 transition"></i> Dokumen SOP</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }   
// --- LOGIKA MOST ANALYSIS ---
    function getMOSTFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="MOST">

            <div class="space-y-4">
                <h3 class="text-indigo-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Mission & Objectives</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Mission Statement (Misi Utama) *</label>
                        <textarea id="mostMission" rows="2" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Memberikan layanan logistik tercepat di Asia Pasifik..."></textarea>
                    </div>
                    
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Organization Unit (Divisi/Tim)</label>
                        <input type="text" id="mostUnit" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Divisi Operasional">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Analisis</label><input type="text" id="mostCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="MST-2026-OPS"></div>
                    
                    <div><label class="block text-xs text-indigo-300 mb-1">Analyst / Creator</label><input type="text" id="mostAnalyst" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="mostStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Active">Active (Berjalan)</option>
                            <option value="Completed">Completed</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Top Level Objectives (O)</label><textarea id="mostObjectives" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Tujuan kunci yang mendukung misi..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-indigo-400 font-bold uppercase text-xs tracking-widest">B. Breakdown: Strategy to Tactics</h3>
                    <span class="text-[10px] text-slate-500 italic">Terjemahkan strategi ke aksi harian</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-indigo-300 mb-1">Strategi Induk (S)</label><input type="text" id="mostSubStrat" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Pendekatan jangka panjang..."></div>
                    
                    <div class="md:col-span-7"><label class="block text-[10px] text-slate-400 mb-1">Taktik Spesifik (T)</label><input type="text" id="mostSubTactic" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Aksi harian/mingguan konkret..."></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Owner (PIC)</label><input type="text" id="mostSubOwner" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Status Eksekusi</label>
                        <select id="mostSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Planned">Planned</option>
                            <option value="Doing">Doing</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubMOST()" class="md:col-span-12 bg-indigo-600 hover:bg-indigo-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Taktik
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-indigo-900/30 text-indigo-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Strategi Induk</th>
                                <th class="p-3 border-b border-white/10 w-1/3">Taktik Spesifik</th>
                                <th class="p-3 border-b border-white/10">Owner</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="mostSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="mostSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada taktik.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-indigo-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Peta Strategi</label><input type="text" id="mostDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="mostImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Tambahan</label><textarea id="mostNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
    function addSubMOST() {
        const strat = document.getElementById('mostSubStrat').value;
        const tactic = document.getElementById('mostSubTactic').value;
        
        if(!strat) return alert("Strategi Induk wajib diisi!");
        if(!tactic) return alert("Taktik Spesifik wajib diisi!");

        const newSub = {
            id: generateId(),
            strat: strat,
            tactic: tactic,
            owner: document.getElementById('mostSubOwner').value || '-',
            status: document.getElementById('mostSubStatus').value
        };

        tempSubMOSTs.push(newSub);
        renderSubMOSTTable();
        
        // Reset Inputs (Keep Strategy for fast entry)
        document.getElementById('mostSubTactic').value = '';
        document.getElementById('mostSubOwner').value = '';
    }

    function removeSubMOST(id) {
        tempSubMOSTs = tempSubMOSTs.filter(s => s.id !== id);
        renderSubMOSTTable();
    }

    function renderSubMOSTTable() {
        const tbody = document.getElementById('mostSubListBody');
        const emptyDiv = document.getElementById('mostSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubMOSTs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubMOSTs.forEach(s => {
                // Warna Status
                let statusBadge = 'text-slate-400';
                if(s.status === 'Doing') statusBadge = 'text-indigo-400 font-bold';
                else if(s.status === 'Done') statusBadge = 'text-emerald-400 font-bold';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-indigo-300 font-medium align-top leading-relaxed text-xs uppercase tracking-wide">${s.strat}</td>
                    <td class="p-3 text-white text-sm align-top">${s.tactic}</td>
                    <td class="p-3 text-xs text-slate-400 align-top">${s.owner}</td>
                    <td class="p-3 text-center text-xs ${statusBadge} align-top">${s.status}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubMOST('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateMOSTForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('mostMission', p.mostMission); setVal('mostUnit', p.mostUnit);
        setVal('mostCode', p.mostCode); setVal('mostAnalyst', p.mostAnalyst); 
        setVal('mostStatus', p.status); setVal('mostObjectives', p.mostObjectives);
        setVal('mostDocLink', p.mostDocLink); setVal('mostImage', p.image);
        setVal('mostNotes', p.mostNotes);

        tempSubMOSTs = p.subMOSTs || [];
        renderSubMOSTTable();
    }
    function createMOSTCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.mostImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        const tacticCount = (p.subMOSTs || []).length;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-indigo-600 shadow-lg tracking-wider border border-indigo-500 shadow-indigo-500/20">MOST</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-indigo-400 font-bold uppercase tracking-wider border border-indigo-500/30 px-2 py-0.5 rounded bg-indigo-500/10">
                        ${p.mostUnit || 'General'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-indigo-300 transition-colors tracking-tight">${p.mostMission}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.mostObjectives || 'Objektif belum didefinisikan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.mostAnalyst ? p.mostAnalyst.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Analyst</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.mostAnalyst || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-indigo-200 bg-indigo-500/10 px-3 py-1.5 rounded-lg border border-indigo-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        ${tacticCount} Tactics
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getMOSTDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.mostImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subMOSTs || []).map(s => {
            let statusBadge = 'text-slate-400';
            if(s.status === 'Doing') statusBadge = 'text-indigo-400 font-bold';
            else if(s.status === 'Done') statusBadge = 'text-emerald-400 font-bold';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-xs text-indigo-300 font-bold uppercase tracking-wide align-top w-1/3">${s.strat}</td>
                <td class="p-4 text-white font-medium align-top leading-relaxed text-sm w-1/3">${s.tactic}</td>
                <td class="p-4 text-sm text-slate-400 align-top">${s.owner}</td>
                <td class="p-4 text-center text-xs ${statusBadge} align-top">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-indigo-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-indigo-200 text-[10px] uppercase tracking-widest border border-indigo-500/30">MOST</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.mostCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl font-serif">"${p.mostMission}"</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-sitemap text-indigo-500"></i> Unit: ${p.mostUnit || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-gear text-indigo-500"></i> Analyst: ${p.mostAnalyst || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-indigo-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> Top Level Objectives</h4>
                        <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-line">${p.mostObjectives || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-indigo-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-arrow-down-wide-short"></i> Strategy & Tactics Breakdown</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-indigo-900/20 text-indigo-200 text-[10px] uppercase font-bold"><tr><th class="p-4">Strategi Induk</th><th class="p-4">Taktik Spesifik</th><th class="p-4">Owner</th><th class="p-4 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada taktik.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-indigo-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-indigo-300 font-bold text-xs uppercase mb-2">Catatan Tambahan</h4>
                        <p class="text-slate-400 text-sm italic">"${p.mostNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.mostDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-indigo-500/50 hover:bg-indigo-500/10 transition text-xs text-indigo-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-map group-hover:scale-110 transition"></i> Peta Strategi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    // HTML Generator for SOP (Super Complex)
    function getSopFormHtml() {
        const divisionOptions = divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="SOP">

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Informasi Umum SOP</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul SOP (Nama Resmi) *</label>
                        <input type="text" id="sopTitle" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: SOP Onboarding Karyawan">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kode SOP</label>
                        <input type="text" id="sopCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: SOP-HR-001">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Deskripsi & Tujuan SOP</label>
                        <textarea id="sopDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Ringkasan tujuan dan ruang lingkup..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Divisi Terkait</label>
                        <select id="sopDivision" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            ${divisionOptions}
                        </select>
                    </div>
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Kategori</label>
                        <select id="sopCategoryType" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Operasional">Operasional</option>
                            <option value="Administratif">Administratif</option>
                            <option value="Strategis">Strategis</option>
                            <option value="Teknis">Teknis</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Kepemilikan & Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Pemilik SOP</label>
                        <input type="text" id="sopOwner" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Nama Manager">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Penyusun</label>
                        <input type="text" id="sopCreator" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Nama Staff">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status</label>
                        <select id="sopStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Aktif">Aktif</option>
                            <option value="Revisi">Revisi</option>
                            <option value="Tidak Berlaku">Tidak Berlaku</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Versi</label>
                        <input type="text" id="sopVersion" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="v1.0">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Tanggal Berlaku</label>
                        <input type="date" id="sopDateValid" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Tgl Review Terakhir</label>
                        <input type="date" id="sopDateLastReview" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]">
                    </div>
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Tgl Review Berikutnya</label>
                        <input type="date" id="sopDateNextReview" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Detail & Referensi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Sifat SOP</label>
                        <select id="sopUrgency" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Sangat Penting">Sangat Penting</option>
                            <option value="Penting">Penting</option>
                            <option value="Tidak Mendesak">Tidak Mendesak</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Tingkat Risiko</label>
                        <select id="sopRisk" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Rendah">Rendah</option>
                            <option value="Sedang">Sedang</option>
                            <option value="Tinggi">Tinggi</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Ruang Lingkup</label>
                        <input type="text" id="sopScope" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Apa yang termasuk & tidak termasuk">
                    </div>
                     <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Dasar / Referensi (ISO/UU/Kebijakan)</label>
                        <input type="text" id="sopRef" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Regulasi terkait...">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Indikator Keberhasilan (KPI)</label>
                        <textarea id="sopKpi" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Parameter SOP berhasil..."></textarea>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">D. Peran & Dokumen</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Pihak Terlibat</label>
                        <input type="text" id="sopParties" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Admin, Staff, Manager...">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Media SOP</label>
                        <input type="text" id="sopMedia" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Dokumen / Video / Sistem">
                    </div>
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Link Dokumen Pendukung (URL)</label>
                        <input type="text" id="sopLinkDoc" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Google Drive...">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Link Template / Form (URL)</label>
                        <input type="text" id="sopLinkTemplate" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Google Form...">
                    </div>
                     <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Cover Image (URL)</label>
                        <input type="text" id="sopImage" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="URL Gambar Header...">
                    </div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-4 rounded-xl border border-white/5">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest flex justify-between items-center">
                    E. Langkah Kerja (Sub SOP)
                    <span class="text-[10px] text-slate-500 font-normal">Tambahkan langkah satu per satu</span>
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 p-3 bg-black/20 rounded-lg">
                    <input type="text" id="subName" placeholder="Nama Aktivitas" class="glass-input col-span-2 px-3 py-2 rounded text-xs">
                    <input type="number" id="subOrder" placeholder="Urutan (1,2..)" class="glass-input px-3 py-2 rounded text-xs">
                    <input type="text" id="subPic" placeholder="PIC" class="glass-input px-3 py-2 rounded text-xs">
                    <input type="date" id="subDate" class="glass-input px-3 py-2 rounded text-xs [color-scheme:dark]">
                    <input type="time" id="subTime" class="glass-input px-3 py-2 rounded text-xs [color-scheme:dark]">
                    <input type="number" id="subDur" placeholder="Durasi (mnt)" class="glass-input px-3 py-2 rounded text-xs">
                    <div class="col-span-4 flex gap-2">
                        <input type="text" id="subDesc" placeholder="Deskripsi Aktivitas" class="glass-input w-full px-3 py-2 rounded text-xs">
                        <button type="button" onclick="addSubSop()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-4 rounded text-xs font-bold whitespace-nowrap">
                            <i class="fa-solid fa-plus mr-1"></i> Add
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs text-slate-300">
                        <thead class="bg-white/5 text-slate-400 uppercase">
                            <tr>
                                <th class="p-2">No</th>
                                <th class="p-2">Aktivitas</th>
                                <th class="p-2">Waktu</th>
                                <th class="p-2">PIC</th>
                                <th class="p-2 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="subSopListBody">
                            </tbody>
                    </table>
                    <div id="subSopEmpty" class="text-center py-4 text-slate-500 text-xs italic">Belum ada langkah kerja.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">F. Evaluasi & Catatan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kendala Umum</label>
                        <textarea id="sopIssues" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Solusi / Best Practice</label>
                        <textarea id="sopSolutions" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Implementasi</label>
                         <select id="sopImplStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Belum Dimulai">Belum Dimulai</option>
                            <option value="Sedang Berjalan">Sedang Berjalan</option>
                            <option value="Selesai">Selesai</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Catatan Audit</label>
                        <textarea id="sopAudit" rows="1" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                </div>
            </div>

        </form>
        `;
    }

    // HTML Generator for Job Desk (Original/Simple)
function getJobDeskFormHtml() {
        const positions = ["Staff", "Senior Staff", "Supervisor", "Assistant Manager", "Manager", "Senior Manager", "Head of Division", "Director", "Intern", "Freelancer", "Consultant", "Specialist", "Officer", "Lead", "Coordinator", "Administrator", "Analyst", "Engineer", "Executive", "Helper"];
        const posOptions = positions.map(p => `<option value="${p}">${p}</option>`).join('');

        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="JobDesk">

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Identitas Job Desk</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul Job Desk *</label>
                        <input type="text" id="jdTitle" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: Mengelola Konten Instagram">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kode Job Desk</label>
                        <input type="text" id="jdCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="JD-MKT-001">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Deskripsi Tanggung Jawab</label>
                        <textarea id="jdDesc" rows="3" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Penjelasan umum..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Posisi / Jabatan</label>
                        <select id="jdPosition" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            ${posOptions}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Divisi</label>
                        <select id="jdDivision" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Marketing">Marketing</option>
                            <option value="HR">HR</option>
                            <option value="Finance">Finance</option>
                            <option value="Operasional">Operasional</option>
                            <option value="IT">IT</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kategori</label>
                        <select id="jdCategory" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Rutin">Rutin</option>
                            <option value="Proyek">Proyek</option>
                            <option value="Ad-hoc">Ad-hoc</option>
                            <option value="Strategis">Strategis</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Jenis Pekerjaan</label>
                        <select id="jdType" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Individu">Individu</option>
                            <option value="Tim">Tim</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Pemilik Job Desk (PIC)</label>
                        <input type="text" id="jdPic" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Nama Penanggung Jawab">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Waktu & Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Tgl Mulai</label>
                        <input type="date" id="jdStartDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Tgl Selesai Target</label>
                        <input type="date" id="jdEndDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Jam Mulai</label>
                        <input type="time" id="jdStartTime" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Jam Selesai</label>
                        <input type="time" id="jdEndTime" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Durasi (Menit)</label>
                        <input type="number" id="jdDuration" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="60">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status</label>
                        <select id="jdStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Planning">Belum Dimulai</option>
                            <option value="In Progress">Sedang Dikerjakan</option>
                            <option value="Completed">Selesai</option>
                            <option value="On Hold">On Hold</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Sifat Pekerjaan</label>
                        <select id="jdNature" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Sangat Penting">Sangat Penting</option>
                            <option value="Penting">Penting</option>
                            <option value="Tidak Mendesak">Tidak Mendesak</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Prioritas</label>
                        <select id="jdPriority" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Tinggi">Tinggi</option>
                            <option value="Sedang">Sedang</option>
                            <option value="Rendah">Rendah</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Kesulitan</label>
                        <select id="jdDifficulty" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Mudah">Mudah</option>
                            <option value="Menengah">Menengah</option>
                            <option value="Sulit">Sulit</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Tujuan & Output</h3>
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Tujuan Job Desk</label>
                    <textarea id="jdGoal" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Apa yang ingin dicapai..."></textarea>
                </div>
                 <div>
                    <label class="block text-xs text-slate-400 mb-1">Output yang Diharapkan</label>
                    <textarea id="jdOutput" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Deliverables..."></textarea>
                </div>
                 <div>
                    <label class="block text-xs text-slate-400 mb-1">Indikator Keberhasilan (KPI)</label>
                    <textarea id="jdKpi" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Tolak ukur sukses..."></textarea>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">D. Koordinasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Pihak Terlibat</label>
                        <input type="text" id="jdParties" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Tim Internal / Eksternal">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Atasan / Approver</label>
                        <input type="text" id="jdApprover" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Nama Atasan">
                    </div>
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Media Pekerjaan</label>
                        <input type="text" id="jdMedia" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Trello, Notion, Zoom...">
                    </div>
                     <div>
                        <label class="block text-xs text-slate-400 mb-1">Link Dokumentasi</label>
                        <input type="text" id="jdDocLink" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="URL Google Drive...">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Template / File Pendukung</label>
                        <input type="text" id="jdTemplateLink" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="URL File...">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Cover Image (URL)</label>
                        <input type="text" id="jdImage" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="URL Gambar Header...">
                    </div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-4 rounded-xl border border-white/5">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest flex justify-between items-center">
                    E. Sub Job Desk (Langkah Kerja)
                    <span class="text-[10px] text-slate-500 font-normal">Tambahkan aktivitas detail</span>
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 p-3 bg-black/20 rounded-lg">
                    <input type="text" id="jdSubName" placeholder="Nama Aktivitas" class="glass-input col-span-2 px-3 py-2 rounded text-xs">
                    <input type="number" id="jdSubOrder" placeholder="No" class="glass-input px-3 py-2 rounded text-xs">
                    <input type="text" id="jdSubPic" placeholder="PIC" class="glass-input px-3 py-2 rounded text-xs">
                    <input type="date" id="jdSubDate" class="glass-input px-3 py-2 rounded text-xs [color-scheme:dark]">
                    <input type="time" id="jdSubTime" class="glass-input px-3 py-2 rounded text-xs [color-scheme:dark]">
                    <div class="col-span-4 flex gap-2">
                        <input type="text" id="jdSubDesc" placeholder="Deskripsi Aktivitas" class="glass-input w-full px-3 py-2 rounded text-xs">
                        
                        <button type="button" onclick="addSubJobDesk()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 rounded text-xs font-bold whitespace-nowrap transition">
                            <i class="fa-solid fa-plus mr-1"></i> Add
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs text-slate-300">
                        <thead class="bg-white/5 text-slate-400 uppercase">
                            <tr>
                                <th class="p-2">No</th>
                                <th class="p-2">Aktivitas</th>
                                <th class="p-2">Waktu</th>
                                <th class="p-2">PIC</th>
                                <th class="p-2 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="jdSubListBody"></tbody>
                    </table>
                    <div id="jdSubEmpty" class="text-center py-4 text-slate-500 text-xs italic">Belum ada langkah kerja.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">F. Evaluasi & Catatan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Catatan Tambahan</label>
                        <textarea id="jdNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Hambatan / Kendala</label>
                        <textarea id="jdIssues" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Solusi / Tindak Lanjut</label>
                        <textarea id="jdSolutions" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Evaluasi Akhir</label>
                        <textarea id="jdEval" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                </div>
            </div>

        </form>
        `;
    }    
    // --- SUB SOP LOGIC ---
    function setupSubSopListeners() {
        renderSubSopTable();
    }

// --- LOGIKA PROJECT CHARTER ---
    function addSubPC() {
        const name = document.getElementById('pcSubName').value;
        const order = document.getElementById('pcSubOrder').value;
        if(!name || !order) return alert("Nama Milestone dan Urutan wajib diisi!");

        const newSub = {
            id: generateId(),
            name: name,
            order: order,
            date: document.getElementById('pcSubDate').value || '-',
            time: document.getElementById('pcSubTime').value || '-',
            pic: document.getElementById('pcSubPic').value || '-',
            output: document.getElementById('pcSubOutput').value || '-',
            desc: document.getElementById('pcSubDesc').value || '-'
        };

        tempSubPCs.push(newSub);
        tempSubPCs.sort((a,b) => a.order - b.order);
        renderSubPCTable();
        
        document.getElementById('pcSubName').value = '';
        document.getElementById('pcSubOutput').value = '';
        document.getElementById('pcSubDesc').value = '';
        document.getElementById('pcSubOrder').value = parseInt(order) + 1;
    }

    function removeSubPC(id) {
        tempSubPCs = tempSubPCs.filter(s => s.id !== id);
        renderSubPCTable();
    }

    function renderSubPCTable() {
        const tbody = document.getElementById('pcSubListBody');
        const emptyDiv = document.getElementById('pcSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubPCs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubPCs.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-center text-slate-400">${s.order}</td>
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-xs text-slate-400">${s.date} ${s.time !== '-' ? s.time : ''}</td>
                    <td class="p-3 text-xs">${s.pic}</td>
                    <td class="p-3 text-xs italic text-slate-500">${s.output}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubPC('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
    // --- LOGIKA KHUSUS JOB DESK SUB-TASK ---

    function addSubJobDesk() {
        // Ambil value dari ID yang baru (jdSub...)
        const name = document.getElementById('jdSubName').value;
        const order = document.getElementById('jdSubOrder').value;
        
        // Validasi sederhana
        if(!name || !order) return alert("Nama aktivitas dan Urutan wajib diisi!");

        const newSub = {
            id: generateId(),
            name: name,
            order: order,
            pic: document.getElementById('jdSubPic').value,
            date: document.getElementById('jdSubDate').value,
            time: document.getElementById('jdSubTime').value,
            desc: document.getElementById('jdSubDesc').value
        };

        // Push ke array temporary (variabel global yang sama dengan SOP tidak masalah, karena form-nya gantian)
        tempSubSops.push(newSub);
        tempSubSops.sort((a,b) => a.order - b.order);
        
        renderSubJobDeskTable(); // Render ke tabel khusus Job Desk
        
        // Reset inputs
        document.getElementById('jdSubName').value = '';
        document.getElementById('jdSubDesc').value = '';
        document.getElementById('jdSubOrder').value = parseInt(order) + 1; // Auto increment urutan biar enak
    }

    function removeSubJobDesk(id) {
        tempSubSops = tempSubSops.filter(s => s.id !== id);
        renderSubJobDeskTable();
    }

    function renderSubJobDeskTable() {
        const tbody = document.getElementById('jdSubListBody');
        const empty = document.getElementById('jdSubEmpty');
        
        if (!tbody) return; // Safety check

        tbody.innerHTML = '';
        
        if(tempSubSops.length === 0) {
            empty.style.display = 'block';
        } else {
            empty.style.display = 'none';
            tempSubSops.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-2 text-emerald-400 font-bold">${s.order}</td>
                    <td class="p-2 font-medium text-white">${s.name}</td>
                    <td class="p-2">${s.date || '-'} ${s.time || ''}</td>
                    <td class="p-2">${s.pic || '-'}</td>
                    <td class="p-2 text-right">
                        <button type="button" onclick="removeSubJobDesk('${s.id}')" class="text-red-400 hover:text-red-300 transition px-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
    function removeSubSop(id) {
        tempSubSops = tempSubSops.filter(s => s.id !== id);
        renderSubSopTable();
    }

    function renderSubSopTable() {
        const tbody = document.getElementById('subSopListBody');
        const empty = document.getElementById('subSopEmpty');
        tbody.innerHTML = '';
        
        if(tempSubSops.length === 0) {
            empty.style.display = 'block';
        } else {
            empty.style.display = 'none';
            tempSubSops.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-2">${s.order}</td>
                    <td class="p-2 font-medium text-white">${s.name}</td>
                    <td class="p-2">${s.date || '-'} ${s.time || ''}</td>
                    <td class="p-2">${s.pic || '-'}</td>
                    <td class="p-2 text-right">
                        <button onclick="removeSubSop('${s.id}')" class="text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- SAVE LOGIC (HANDLES BOTH FORMS) ---
    function saveProject() {
        const idInput = document.getElementById('projectId').value;
        const cat = document.getElementById('pCategory').value;
        const getVal = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : ''; 
        };
        
        // Cek Kategori (Safe Check)
        let catElement = document.getElementById('pCategory');
        
        let data = {};

        // TIMESTAMPS
        const now = new Date().toISOString();

        if (cat === 'SOP') {
            const title = document.getElementById('sopTitle').value;
            if(!title) return alert("Judul SOP wajib diisi!");

            data = {
                id: idInput || generateId(),
                category: 'SOP',
                sopTitle: title,
                sopCode: document.getElementById('sopCode').value,
                sopDesc: document.getElementById('sopDesc').value,
                sopDivision: document.getElementById('sopDivision').value,
                sopCategoryType: document.getElementById('sopCategoryType').value,
                sopOwner: document.getElementById('sopOwner').value,
                sopCreator: document.getElementById('sopCreator').value,
                status: document.getElementById('sopStatus').value,
                sopVersion: document.getElementById('sopVersion').value,
                sopDateValid: document.getElementById('sopDateValid').value,
                sopDateLastReview: document.getElementById('sopDateLastReview').value,
                sopDateNextReview: document.getElementById('sopDateNextReview').value,
                sopUrgency: document.getElementById('sopUrgency').value,
                sopRisk: document.getElementById('sopRisk').value,
                sopScope: document.getElementById('sopScope').value,
                sopRef: document.getElementById('sopRef').value,
                sopKpi: document.getElementById('sopKpi').value,
                sopParties: document.getElementById('sopParties').value,
                sopMedia: document.getElementById('sopMedia').value,
                sopLinkDoc: document.getElementById('sopLinkDoc').value,
                sopLinkTemplate: document.getElementById('sopLinkTemplate').value,
                sopImage: document.getElementById('sopImage').value,
                subSops: tempSubSops, // Attach Sub SOP Array
                sopIssues: document.getElementById('sopIssues').value,
                sopSolutions: document.getElementById('sopSolutions').value,
                sopImplStatus: document.getElementById('sopImplStatus').value,
                sopAudit: document.getElementById('sopAudit').value,
                createdAt: idInput ? (projects.find(p=>p.id===idInput).createdAt) : now,
                updatedAt: now
            };
         } else if (cat === 'JobDesk') {
            // --- LOGIKA BARU JOB DESK ---
            const title = document.getElementById('jdTitle').value;
            if(!title) return alert("Judul Job Desk wajib diisi!");

            data = {
                id: idInput || generateId(),
                category: 'JobDesk',
                jdTitle: title,
                name: title, // Fallback for search
                jdCode: document.getElementById('jdCode').value,
                jdDesc: document.getElementById('jdDesc').value,
                jdPosition: document.getElementById('jdPosition').value,
                jdDivision: document.getElementById('jdDivision').value,
                jdCategory: document.getElementById('jdCategory').value,
                jdType: document.getElementById('jdType').value,
                jdPic: document.getElementById('jdPic').value,
                jdStartDate: document.getElementById('jdStartDate').value,
                jdEndDate: document.getElementById('jdEndDate').value,
                jdStartTime: document.getElementById('jdStartTime').value,
                jdEndTime: document.getElementById('jdEndTime').value,
                jdDuration: document.getElementById('jdDuration').value,
                status: document.getElementById('jdStatus').value,
                jdNature: document.getElementById('jdNature').value,
                jdPriority: document.getElementById('jdPriority').value,
                jdDifficulty: document.getElementById('jdDifficulty').value,
                jdGoal: document.getElementById('jdGoal').value,
                jdOutput: document.getElementById('jdOutput').value,
                jdKpi: document.getElementById('jdKpi').value,
                jdParties: document.getElementById('jdParties').value,
                jdApprover: document.getElementById('jdApprover').value,
                jdMedia: document.getElementById('jdMedia').value,
                jdDocLink: document.getElementById('jdDocLink').value,
                jdTemplateLink: document.getElementById('jdTemplateLink').value,
                image: document.getElementById('jdImage').value,
                subJobDesks: tempSubSops, // Menggunakan array step yang sama
                jdNotes: document.getElementById('jdNotes').value,
                jdIssues: document.getElementById('jdIssues').value,
                jdSolutions: document.getElementById('jdSolutions').value,
                jdEval: document.getElementById('jdEval').value,
                createdAt: idInput ? (projects.find(p=>p.id===idInput).createdAt) : now,
                updatedAt: now
            };
        } else if (cat === 'KPI') {
           const title = getVal('kpiTitle');
            if(!title) return alert("Judul KPI wajib diisi!");

            data = {
                id: idInput || generateId(),
                category: 'KPI',
                
                // Identitas
                kpiTitle: title,
                name: title, 
                kpiCode: getVal('kpiCode'),
                kpiDesc: getVal('kpiDesc'),
                kpiDivision: getVal('kpiDivision'),
                kpiPosition: getVal('kpiPosition'),
                kpiCategoryType: getVal('kpiCategoryType'),
                kpiType: getVal('kpiType'),
                kpiOwner: getVal('kpiOwner'),
                
                // Waktu
                kpiPeriod: getVal('kpiPeriod'),
                kpiStartDate: getVal('kpiStartDate'),
                kpiEndDate: getVal('kpiEndDate'),
                
                // Status (Menggunakan input manual atau default)
                status: getVal('kpiStatus'), 
                
                // Media
                kpiDocLink: getVal('kpiDocLink'),
                kpiProof: getVal('kpiProof'),
                image: getVal('kpiImage'),
                
                // Perhitungan (Hasil Kalkulasi Rata-rata)
                kpiWeight: getVal('kpiWeight'),
                kpiBaseline: getVal('kpiBaseline'),
                kpiTarget: getVal('kpiTarget'),
                kpiRealization: getVal('kpiRealization'),
                kpiValue: getVal('kpiValue'),   // Persentase
                kpiGap: getVal('kpiGap'),       // Gap
                kpiScore: getVal('kpiScore'),   // Skor Huruf
                kpiRisk: getVal('kpiRisk'),

kpiImpact: getVal('kpiImpact'),
                
                // Evaluasi
                kpiIssues: getVal('kpiIssues'),
                kpiActionPlan: getVal('kpiActionPlan'),
                kpiDecision: getVal('kpiDecision'),
                
                // Array Sub-KPI (Mengambil dari Variabel Global tempSubKpis)
                subKpis: typeof tempSubKpis !== 'undefined' ? tempSubKpis : [],
                
                createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
                updatedAt: now
            };
        }else if (cat === 'ProjectCharter') {
            const title = getVal('pcTitle');
            if(!title) return alert("Judul Project wajib diisi!");

            data = {
                id: idInput || generateId(),
                category: 'ProjectCharter',
                
                pcTitle: title,
                name: title,
                pcCode: getVal('pcCode'),
                pcCategoryType: getVal('pcCategoryType'),
                pcDesc: getVal('pcDesc'),
                
                pcSponsor: getVal('pcSponsor'),
                pcManager: getVal('pcManager'),
                pcOwner: getVal('pcOwner'),
                pcType: getVal('pcType'),
                
                pcStartDate: getVal('pcStartDate'),
                pcEndDate: getVal('pcEndDate'),
                pcStartTime: getVal('pcStartTime'),
                pcEndTime: getVal('pcEndTime'),
                
                status: getVal('pcStatus'), // Shared field
                pcPriority: getVal('pcPriority'),
                pcRisk: getVal('pcRisk'),
                pcBudget: getVal('pcBudget'),
                
                pcGoal: getVal('pcGoal'),
                pcBackground: getVal('pcBackground'),
                pcBenefits: getVal('pcBenefits'),
                pcScopeIn: getVal('pcScopeIn'),
                pcScopeOut: getVal('pcScopeOut'),
                
                pcResources: getVal('pcResources'),
                pcMethod: getVal('pcMethod'),
                pcDocLink: getVal('pcDocLink'),
                pcFiles: getVal('pcFiles'),
                image: getVal('pcImage'),
                
                pcAssumption: getVal('pcAssumption'),
                pcConstraint: getVal('pcConstraint'),
                pcRiskMitigation: getVal('pcRiskMitigation'),
                pcSuccessCriteria: getVal('pcSuccessCriteria'),
                
                pcApprovalStatus: getVal('pcApprovalStatus'),
                pcApprovalDate: getVal('pcApprovalDate'),
                pcManagementNotes: getVal('pcManagementNotes'),
                
                subPCs: typeof tempSubPCs !== 'undefined' ? tempSubPCs : [],
                
                createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
                updatedAt: now
            };
        }// ... (setelah blok Project Charter selesai) ...
        else if (cat === 'BSC') {
            const title = getVal('bscTitle');
            if(!title) return alert("Judul BSC wajib diisi!");

            data = {
                id: idInput || generateId(),
                category: 'BSC',
                
                // A. Identitas
                bscTitle: title,
                name: title,
                bscCode: getVal('bscCode'),
                bscDesc: getVal('bscDesc'),
                bscLevel: getVal('bscLevel'),
                bscPerspective: getVal('bscPerspective'),
                bscOwner: getVal('bscOwner'),
                bscSponsor: getVal('bscSponsor'),
                
                // B. Periode
                bscPeriod: getVal('bscPeriod'),
                bscStartDate: getVal('bscStartDate'),
                bscEndDate: getVal('bscEndDate'),
                bscStartTime: getVal('bscStartTime'),
                bscEndTime: getVal('bscEndTime'),
                
                // C. Strategi & KPI
                bscStrategicObj: getVal('bscStrategicObj'),
                bscInitiative: getVal('bscInitiative'),
                bscKpiName: getVal('bscKpiName'),
                bscKpiDef: getVal('bscKpiDef'),
                bscUnit: getVal('bscUnit'),
                bscBaseline: getVal('bscBaseline'),
                bscTarget: getVal('bscTarget'),
                bscRealization: getVal('bscRealization'),
                bscProgress: getVal('bscProgress'), // Hasil hitung otomatis
                
                // D. Status & Risiko
                status: getVal('bscStatus'),
                bscNature: getVal('bscNature'),
                bscWeight: getVal('bscWeight'),
                bscRisk: getVal('bscRisk'),
                
                // E. Media
                bscMethod: getVal('bscMethod'),
                bscTools: getVal('bscTools'),
                bscDocLink: getVal('bscDocLink'),
                bscProof: getVal('bscProof'),
                image: getVal('bscImage'),
                
                // G. Evaluasi
                bscNotes: getVal('bscNotes'),
                bscIssues: getVal('bscIssues'),
                bscActionPlan: getVal('bscActionPlan'),
                bscDecision: getVal('bscDecision'),
                bscEvaluation: getVal('bscEvaluation'),
                
                // Sub BSC Array
                subBSCs: typeof tempSubBSCs !== 'undefined' ? tempSubBSCs : [],
                
                createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
                updatedAt: now
            };
        }else if (cat === 'Agile') {
        const title = getVal('agTitle');
        if(!title) return alert("Judul Project wajib diisi!");
        data = {
            id: idInput || generateId(),
            category: 'Agile',
            agTitle: title, name: title, agCode: getVal('agCode'), agDesc: getVal('agDesc'),
            agCategory: getVal('agCategory'), agMethod: getVal('agMethod'),
            agPO: getVal('agPO'), agSM: getVal('agSM'), agTeam: getVal('agTeam'),
            agSprintNo: getVal('agSprintNo'), agDuration: getVal('agDuration'),
            agStartDate: getVal('agStartDate'), agEndDate: getVal('agEndDate'),
            agSprintGoal: getVal('agSprintGoal'),
            status: getVal('agStatus'), agSprintStatus: getVal('agSprintStatus'), agPriority: getVal('agPriority'), agTools: getVal('agTools'),
            agVelocity: getVal('agVelocity'), agTotalSP: getVal('agTotalSP'), agCompletedSP: getVal('agCompletedSP'), agProgress: getVal('agProgress'),
            agLinkBacklog: getVal('agLinkBacklog'), agLinkDoc: getVal('agLinkDoc'),
            agReview: getVal('agReview'), agBlocker: getVal('agBlocker'), agRetro: getVal('agRetro'), agDecision: getVal('agDecision'),
            subAgiles: typeof tempSubAgiles !== 'undefined' ? tempSubAgiles : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'BRD') {
        const title = getVal('brdTitle');
        if(!title) return alert("Judul BRD wajib diisi!");
        data = {
            id: idInput || generateId(),
            category: 'BRD',
            brdTitle: title, name: title, brdCode: getVal('brdCode'), brdDesc: getVal('brdDesc'),
            brdCategory: getVal('brdCategory'), brdType: getVal('brdType'),
            brdOwner: getVal('brdOwner'), brdPM: getVal('brdPM'), brdBA: getVal('brdBA'),
            brdStartDate: getVal('brdStartDate'), brdEndDate: getVal('brdEndDate'),
            brdStartTime: getVal('brdStartTime'), brdEndTime: getVal('brdEndTime'),
            
            status: getVal('brdStatus'), brdProjStatus: getVal('brdProjStatus'),
            brdNature: getVal('brdNature'), brdPriority: getVal('brdPriority'),
            
            brdBackground: getVal('brdBackground'), brdGoal: getVal('brdGoal'),
            brdAsIs: getVal('brdAsIs'), brdToBe: getVal('brdToBe'), brdBenefit: getVal('brdBenefit'),
            brdInScope: getVal('brdInScope'), brdOutScope: getVal('brdOutScope'),
            brdAssumptions: getVal('brdAssumptions'), brdRisks: getVal('brdRisks'),
            
            brdMethod: getVal('brdMethod'), brdTools: getVal('brdTools'),
            brdDocLink: getVal('brdDocLink'), brdFiles: getVal('brdFiles'), image: getVal('brdImage'),
            
            brdAnalysisNotes: getVal('brdAnalysisNotes'), brdReviewResult: getVal('brdReviewResult'),
            brdChangeRequest: getVal('brdChangeRequest'), brdFinalStatus: getVal('brdFinalStatus'),
            brdApprovalNotes: getVal('brdApprovalNotes'),
            
            subBRDs: typeof tempSubBRDs !== 'undefined' ? tempSubBRDs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'OKR') {
        const title = getVal('okrTitle');
        if(!title) return alert("Objective Title wajib diisi!");
        data = {
            id: idInput || generateId(),
            category: 'OKR',
            okrTitle: title, name: title, okrCode: getVal('okrCode'), okrType: getVal('okrType'),
            okrOwner: getVal('okrOwner'), okrTeam: getVal('okrTeam'), okrDesc: getVal('okrDesc'),
            okrPeriod: getVal('okrPeriod'), okrYear: getVal('okrYear'), status: getVal('okrStatus'),
            okrStartDate: getVal('okrStartDate'), okrEndDate: getVal('okrEndDate'),
            okrProgress: getVal('okrProgress'),
            okrDocLink: getVal('okrDocLink'), image: getVal('okrImage'),
            okrBlocker: getVal('okrBlocker'), okrNextStep: getVal('okrNextStep'),
            subOKRs: typeof tempSubOKRs !== 'undefined' ? tempSubOKRs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'Risk') {
        const title = getVal('rskTitle');
        if(!title) return alert("Judul Dokumen Risiko wajib diisi!");
        data = {
            id: idInput || generateId(),
            category: 'Risk',
            rskTitle: title, name: title, rskCode: getVal('rskCode'),
            rskCategory: getVal('rskCategory'), rskLevel: getVal('rskLevel'),
            rskOwner: getVal('rskOwner'), rskDept: getVal('rskDept'), rskDesc: getVal('rskDesc'),
            status: getVal('rskStatus'), rskProb: getVal('rskProb'),
            rskDate: getVal('rskDate'), rskReviewDate: getVal('rskReviewDate'),
            rskDocLink: getVal('rskDocLink'), image: getVal('rskImage'), rskNotes: getVal('rskNotes'),
            subRisks: typeof tempSubRisks !== 'undefined' ? tempSubRisks : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        }; 
    } else if (cat === 'Stakeholder') {
        const title = getVal('stkTitle');
        if(!title) return alert("Nama Proyek/Inisiatif wajib diisi!");
        data = {
            id: idInput || generateId(),
            category: 'Stakeholder',
            stkTitle: title, name: title, stkCode: getVal('stkCode'),
            stkCreator: getVal('stkCreator'), stkDate: getVal('stkDate'),
            status: getVal('stkStatus'), stkVersion: getVal('stkVersion'),
            stkDesc: getVal('stkDesc'),
            stkLinkMap: getVal('stkLinkMap'), stkLinkComm: getVal('stkLinkComm'),
            image: getVal('stkImage'), stkNotes: getVal('stkNotes'),
            subStakeholders: typeof tempSubStakeholders !== 'undefined' ? tempSubStakeholders : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'SWOT') {
        const object = getVal('swotObject');
        if(!object) return alert("Objek Analisis wajib diisi!");
        data = {
            id: idInput || generateId(),
            category: 'SWOT',
            swotObject: object, name: object, swotCode: getVal('swotCode'),
            swotCreator: getVal('swotCreator'), swotDate: getVal('swotDate'),
            status: getVal('swotStatus'), swotVersion: getVal('swotVersion'),
            swotGoal: getVal('swotGoal'), swotSummary: getVal('swotSummary'),
            swotDocLink: getVal('swotDocLink'), image: getVal('swotImage'),
            subSwots: typeof tempSubSwots !== 'undefined' ? tempSubSwots : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'QC') {
        const product = getVal('qcProduct');
        if(!product) return alert("Nama Produk wajib diisi!");
        data = {
            id: idInput || generateId(),
            category: 'QC',
            qcProduct: product, name: product, qcBatch: getVal('qcBatch'),
            qcInspector: getVal('qcInspector'), qcDate: getVal('qcDate'),
            status: getVal('qcStatus'), qcLocation: getVal('qcLocation'),
            qcDesc: getVal('qcDesc'),
            qcDocLink: getVal('qcDocLink'), image: getVal('qcImage'), qcAction: getVal('qcAction'),
            subQCs: typeof tempSubQCs !== 'undefined' ? tempSubQCs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'Procurement') {
        const title = getVal('prcTitle');
        if(!title) return alert("Judul Pengadaan wajib diisi!");
        
        // Hitung ulang total sebelum simpan
        let totalVal = 0;
        if(typeof tempSubProcs !== 'undefined') {
             tempSubProcs.forEach(s => totalVal += (parseFloat(s.qty) * parseFloat(s.price)));
        }

        data = {
            id: idInput || generateId(),
            category: 'Procurement',
            prcTitle: title, name: title, prcCode: getVal('prcCode'),
            prcDept: getVal('prcDept'), prcDate: getVal('prcDate'),
            status: getVal('prcStatus'), prcReason: getVal('prcReason'),
            prcTotal: totalVal, // Simpan angka murni
            prcDocLink: getVal('prcDocLink'), image: getVal('prcImage'),
            subProcs: typeof tempSubProcs !== 'undefined' ? tempSubProcs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'Training') {
        const title = getVal('trnTitle');
        if(!title) return alert("Judul Training wajib diisi!");
        
        let totalH = 0;
        if(typeof tempSubTrainings !== 'undefined') {
             tempSubTrainings.forEach(s => totalH += parseFloat(s.duration));
        }

        data = {
            id: idInput || generateId(),
            category: 'Training',
            trnTitle: title, name: title, trnCode: getVal('trnCode'),
            trnTrainer: getVal('trnTrainer'), trnLocation: getVal('trnLocation'),
            trnStartDate: getVal('trnStartDate'), trnEndDate: getVal('trnEndDate'),
            status: getVal('trnStatus'), trnBudget: getVal('trnBudget'),
            trnObjective: getVal('trnObjective'), trnTotalHours: totalH,
            trnDocLink: getVal('trnDocLink'), image: getVal('trnImage'),
            subTrainings: typeof tempSubTrainings !== 'undefined' ? tempSubTrainings : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'Recruitment') {
        const position = getVal('recPosition');
        if(!position) return alert("Posisi Jabatan wajib diisi!");
        
        const hiredCount = tempSubRecruits ? tempSubRecruits.filter(s => s.status === 'Lolos (Hired)').length : 0;

        data = {
            id: idInput || generateId(),
            category: 'Recruitment',
            recPosition: position, name: position, recCode: getVal('recCode'),
            recDept: getVal('recDept'), recManager: getVal('recManager'),
            recOpenDate: getVal('recOpenDate'), recCloseDate: getVal('recCloseDate'),
            status: getVal('recStatus'), recTarget: getVal('recTarget'),
            recQual: getVal('recQual'), recHiredCount: hiredCount,
            recDocLink: getVal('recDocLink'), image: getVal('recImage'),
            subRecruits: typeof tempSubRecruits !== 'undefined' ? tempSubRecruits : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'Appraisal') {
        const name = getVal('aprName');
        if(!name) return alert("Nama Karyawan wajib diisi!");
        
        let totalS = 0;
        if(typeof tempSubAppraisals !== 'undefined' && tempSubAppraisals.length > 0) {
             tempSubAppraisals.forEach(s => totalS += parseFloat(s.score));
             totalS = (totalS / tempSubAppraisals.length).toFixed(2);
        }

        data = {
            id: idInput || generateId(),
            category: 'Appraisal',
            aprName: name, name: name, aprId: getVal('aprId'),
            aprPosition: getVal('aprPosition'), aprDept: getVal('aprDept'),
            aprReviewer: getVal('aprReviewer'), aprPeriod: getVal('aprPeriod'),
            status: getVal('aprStatus'), aprDate: getVal('aprDate'),
            aprAvgScore: totalS, aprFinalComment: getVal('aprFinalComment'),
            aprDocLink: getVal('aprDocLink'), image: getVal('aprImage'),
            subAppraisals: typeof tempSubAppraisals !== 'undefined' ? tempSubAppraisals : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'ChangeRequest') {
        const title = getVal('crTitle');
        if(!title) return alert("Judul Perubahan wajib diisi!");
        
        let totalC = 0;
        if(typeof tempSubCRs !== 'undefined') {
             tempSubCRs.forEach(s => totalC += parseFloat(s.cost));
        }

        data = {
            id: idInput || generateId(),
            category: 'ChangeRequest',
            crTitle: title, name: title, crCode: getVal('crCode'),
            crRequestor: getVal('crRequestor'), crProject: getVal('crProject'),
            status: getVal('crStatus'), crDate: getVal('crDate'),
            crReason: getVal('crReason'), crTotalCost: totalC,
            crDocLink: getVal('crDocLink'), image: getVal('crImage'),
            crApproverNotes: getVal('crApproverNotes'),
            subCRs: typeof tempSubCRs !== 'undefined' ? tempSubCRs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }
    else if (cat === 'KPA') {
        const name = getVal('kpaName');
        if(!name) return alert("Nama Karyawan wajib diisi!");
        
        let finalScore = 0;
        if(typeof tempSubKPAs !== 'undefined') {
             tempSubKPAs.forEach(s => {
                 finalScore += (parseFloat(s.score) * parseFloat(s.weight)) / 100;
             });
        }

        data = {
            id: idInput || generateId(),
            category: 'KPA',
            kpaName: name, name: name, kpaJobTitle: getVal('kpaJobTitle'),
            kpaSupervisor: getVal('kpaSupervisor'), kpaPeriod: getVal('kpaPeriod'),
            status: getVal('kpaStatus'), kpaDesc: getVal('kpaDesc'),
            kpaFinalScore: finalScore.toFixed(2),
            kpaDocLink: getVal('kpaDocLink'), image: getVal('kpaImage'),
            kpaFeedback: getVal('kpaFeedback'),
            subKPAs: typeof tempSubKPAs !== 'undefined' ? tempSubKPAs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }
    else if (cat === 'PIP') {
        const empName = getVal('pipName');
        if(!empName) return alert("Nama Karyawan wajib diisi!");
        
        // Calculate Success Rate for saving
        let rate = 0;
        if(typeof tempSubPIPs !== 'undefined') {
             const valid = tempSubPIPs.filter(s => s.result !== 'Pending');
             if(valid.length > 0) {
                 const met = valid.filter(s => s.result === 'Met').length;
                 const partial = valid.filter(s => s.result === 'Partial').length;
                 rate = Math.round(((met + (partial * 0.5)) / valid.length) * 100);
             }
        }

        data = {
            id: idInput || generateId(),
            category: 'PIP',
            pipName: empName, name: empName, pipID: getVal('pipID'),
            pipManager: getVal('pipManager'), pipDuration: getVal('pipDuration'),
            pipStart: getVal('pipStart'), pipEnd: getVal('pipEnd'),
            status: getVal('pipStatus'), pipIssue: getVal('pipIssue'),
            pipSuccessRate: rate,
            pipDocLink: getVal('pipDocLink'), image: getVal('pipImage'),
            pipConclusion: getVal('pipConclusion'),
            subPIPs: typeof tempSubPIPs !== 'undefined' ? tempSubPIPs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'OGSM') {
        const obj = getVal('ogsmObj');
        if(!obj) return alert("Objective wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'OGSM',
            ogsmObj: obj, name: obj, ogsmGoals: getVal('ogsmGoals'),
            ogsmCode: getVal('ogsmCode'), ogsmYear: getVal('ogsmYear'),
            ogsmOwner: getVal('ogsmOwner'), status: getVal('ogsmStatus'),
            ogsmDocLink: getVal('ogsmDocLink'), image: getVal('ogsmImage'),
            ogsmNotes: getVal('ogsmNotes'),
            subOGSMs: typeof tempSubOGSMs !== 'undefined' ? tempSubOGSMs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'KRA') {
        const role = getVal('kraRole');
        if(!role) return alert("Nama Jabatan wajib diisi!");
        
        let calc = { totalWeight: 0, weightedScore: 0 };
        if(typeof tempSubKRAs !== 'undefined') {
             tempSubKRAs.forEach(s => {
                const w = parseFloat(s.weight) || 0;
                const r = parseFloat(s.rating) || 0;
                calc.totalWeight += w;
                calc.weightedScore += (w * (r/5));
             });
        }

        data = {
            id: idInput || generateId(),
            category: 'KRA',
            kraRole: role, name: role, kraCode: getVal('kraCode'),
            kraPic: getVal('kraPic'), kraManager: getVal('kraManager'),
            kraPeriod: getVal('kraPeriod'), status: getVal('kraStatus'),
            kraPurpose: getVal('kraPurpose'), kraTotalWeight: calc.totalWeight,
            kraFinalScore: calc.weightedScore.toFixed(1),
            kraDocLink: getVal('kraDocLink'), image: getVal('kraImage'),
            kraNotes: getVal('kraNotes'),
            subKRAs: typeof tempSubKRAs !== 'undefined' ? tempSubKRAs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'CSF') {
        const goal = getVal('csfGoal');
        if(!goal) return alert("Strategic Goal wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'CSF',
            csfGoal: goal, name: goal, csfMission: getVal('csfMission'),
            csfCode: getVal('csfCode'), csfUrgency: getVal('csfUrgency'),
            csfOwner: getVal('csfOwner'), status: getVal('csfStatus'),
            csfPeriod: getVal('csfPeriod'),
            csfDocLink: getVal('csfDocLink'), image: getVal('csfImage'),
            csfNotes: getVal('csfNotes'),
            subCSFs: typeof tempSubCSFs !== 'undefined' ? tempSubCSFs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'MBO') {
        const obj = getVal('mboCorpObj');
        if(!obj) return alert("Corporate Objective wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'MBO',
            mboCorpObj: obj, name: obj, mboYear: getVal('mboYear'),
            mboCode: getVal('mboCode'), mboReviewer: getVal('mboReviewer'),
            mboEmployee: getVal('mboEmployee'), status: getVal('mboStatus'),
            mboPeriod: getVal('mboPeriod'),
            mboDocLink: getVal('mboDocLink'), image: getVal('mboImage'),
            mboNotes: getVal('mboNotes'),
            subMBOs: typeof tempSubMBOs !== 'undefined' ? tempSubMBOs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'V2MOM') {
        const vision = getVal('v2Vision');
        if(!vision) return alert("Vision wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'V2MOM',
            v2Vision: vision, name: vision, v2Values: getVal('v2Values'),
            v2Year: getVal('v2Year'), status: getVal('v2Status'),
            v2Owner: getVal('v2Owner'), v2Dept: getVal('v2Dept'),
            v2DocLink: getVal('v2DocLink'), image: getVal('v2Image'),
            subV2MOMs: typeof tempSubV2MOMs !== 'undefined' ? tempSubV2MOMs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'WIG') {
        const title = getVal('wigTitle');
        if(!title) return alert("WIG Statement wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'WIG',
            wigTitle: title, name: title, wigCode: getVal('wigCode'),
            wigX: getVal('wigX'), wigY: getVal('wigY'), wigWhen: getVal('wigWhen'),
            status: getVal('wigStatus'), wigOwner: getVal('wigOwner'), wigTeam: getVal('wigTeam'),
            wigSession: getVal('wigSession'), image: getVal('wigImage'),
            wigCommitment: getVal('wigCommitment'),
            subWIGs: typeof tempSubWIGs !== 'undefined' ? tempSubWIGs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'MOST') {
        const mission = getVal('mostMission');
        if(!mission) return alert("Mission Statement wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'MOST',
            mostMission: mission, name: mission, mostUnit: getVal('mostUnit'),
            mostCode: getVal('mostCode'), mostAnalyst: getVal('mostAnalyst'),
            status: getVal('mostStatus'), mostObjectives: getVal('mostObjectives'),
            mostDocLink: getVal('mostDocLink'), image: getVal('mostImage'),
            mostNotes: getVal('mostNotes'),
            subMOSTs: typeof tempSubMOSTs !== 'undefined' ? tempSubMOSTs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'KRI') {
        const catName = getVal('kriCategory');
        if(!catName) return alert("Kategori Risiko wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'KRI',
            kriCategory: catName, name: catName, kriCode: getVal('kriCode'),
            kriTolerance: getVal('kriTolerance'), status: getVal('kriStatus'),
            kriOwner: getVal('kriOwner'), kriPeriod: getVal('kriPeriod'),
            kriDesc: getVal('kriDesc'),
            kriDocLink: getVal('kriDocLink'), image: getVal('kriImage'),
            kriAction: getVal('kriAction'),
            subKRIs: typeof tempSubKRIs !== 'undefined' ? tempSubKRIs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'KCI') {
        const proc = getVal('kciProcess');
        if(!proc) return alert("Proses Bisnis wajib diisi!");
        
        let passC = 0; let totalC = 0;
        if(typeof tempSubKCIs !== 'undefined') {
             const valid = tempSubKCIs.filter(s=>s.result !== 'N/A');
             totalC = valid.length;
             passC = valid.filter(s=>s.result === 'Pass').length;
        }
        const rate = totalC > 0 ? Math.round((passC / totalC) * 100) : 0;

        data = {
            id: idInput || generateId(),
            category: 'KCI',
            kciProcess: proc, name: proc, kciCode: getVal('kciCode'),
            kciAuditor: getVal('kciAuditor'), kciDate: getVal('kciDate'),
            status: getVal('kciStatus'), kciScope: getVal('kciScope'),
            kciComplianceRate: rate,
            kciDocLink: getVal('kciDocLink'), image: getVal('kciImage'),
            kciSummary: getVal('kciSummary'),
            subKCIs: typeof tempSubKCIs !== 'undefined' ? tempSubKCIs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'FMEA') {
        const proc = getVal('fmeaProcess');
        if(!proc) return alert("Nama Proses wajib diisi!");
        
        let maxR = 0;
        if(typeof tempSubFMEAs !== 'undefined') {
             tempSubFMEAs.forEach(s => { if(s.rpn > maxR) maxR = s.rpn; });
        }

        data = {
            id: idInput || generateId(),
            category: 'FMEA',
            fmeaProcess: proc, name: proc, fmeaCode: getVal('fmeaCode'),
            fmeaTeam: getVal('fmeaTeam'), fmeaDate: getVal('fmeaDate'),
            status: getVal('fmeaStatus'), fmeaScope: getVal('fmeaScope'),
            fmeaMaxRPN: maxR,
            fmeaDocLink: getVal('fmeaDocLink'), image: getVal('fmeaImage'),
            fmeaSummary: getVal('fmeaSummary'),
            subFMEAs: typeof tempSubFMEAs !== 'undefined' ? tempSubFMEAs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'SLA') {
        const client = getVal('slaClient');
        if(!client) return alert("Nama Klien wajib diisi!");
        
        let totalP = 0;
        if(typeof tempSubSLAs !== 'undefined') {
             tempSubSLAs.forEach(s => totalP += parseFloat(s.penalty));
        }

        data = {
            id: idInput || generateId(),
            category: 'SLA',
            slaClient: client, name: client, slaService: getVal('slaService'),
            slaPeriod: getVal('slaPeriod'), slaDate: getVal('slaDate'),
            status: getVal('slaStatus'), slaUptime: getVal('slaUptime'),
            slaDesc: getVal('slaDesc'), slaTotalPenalty: totalP,
            slaDocLink: getVal('slaDocLink'), image: getVal('slaImage'),
            slaNotes: getVal('slaNotes'),
            subSLAs: typeof tempSubSLAs !== 'undefined' ? tempSubSLAs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === '5S') {
        const loc = getVal('fsLocation');
        if(!loc) return alert("Lokasi Audit wajib diisi!");
        
        let totalScore = 0;
        let maxScore = tempSub5S.length * 5;
        if(typeof tempSub5S !== 'undefined') {
             tempSub5S.forEach(s => totalScore += parseInt(s.score));
        }
        const pct = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
        
        // Determine Predicate for saving
        let predicate = 'Poor';
        if (pct >= 90) predicate = 'Excellent';
        else if (pct >= 75) predicate = 'Good';
        else if (pct >= 60) predicate = 'Average';

        data = {
            id: idInput || generateId(),
            category: '5S',
            fsLocation: loc, name: loc, fsCode: getVal('fsCode'),
            fsAuditor: getVal('fsAuditor'), fsDate: getVal('fsDate'),
            status: predicate, fsScore: pct,
            fsNotes: getVal('fsNotes'),
            fsDocLink: getVal('fsDocLink'), image: getVal('fsImage'),
            fsFindings: getVal('fsFindings'),
            sub5S: typeof tempSub5S !== 'undefined' ? tempSub5S : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'SIPOC') {
        const name = getVal('spcName');
        if(!name) return alert("Nama Proses wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'SIPOC',
            spcName: name, name: name, spcCode: getVal('spcCode'),
            spcOwner: getVal('spcOwner'), spcDate: getVal('spcDate'),
            status: getVal('spcStatus'), spcScope: getVal('spcScope'),
            spcDocLink: getVal('spcDocLink'), image: getVal('spcImage'),
            spcNotes: getVal('spcNotes'),
            subSIPOCs: typeof tempSubSIPOCs !== 'undefined' ? tempSubSIPOCs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'GapAnalysis') {
        const focus = getVal('gapFocus');
        if(!focus) return alert("Fokus Area wajib diisi!");
        
        let doneC = 0;
        if(typeof tempSubGaps !== 'undefined') {
             doneC = tempSubGaps.filter(s => s.status === 'Done').length;
        }
        const prog = tempSubGaps.length > 0 ? Math.round((doneC / tempSubGaps.length) * 100) : 0;

        data = {
            id: idInput || generateId(),
            category: 'GapAnalysis',
            gapFocus: focus, name: focus, gapCode: getVal('gapCode'),
            gapTarget: getVal('gapTarget'), gapLead: getVal('gapLead'),
            status: getVal('gapStatus'), gapGoal: getVal('gapGoal'),
            gapProgressRate: prog,
            gapDocLink: getVal('gapDocLink'), image: getVal('gapImage'),
            gapSummary: getVal('gapSummary'),
            subGaps: typeof tempSubGaps !== 'undefined' ? tempSubGaps : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'RICE') {
        const name = getVal('riceName');
        if(!name) return alert("Nama Project wajib diisi!");
        
        let maxS = 0;
        if(typeof tempSubRICEs !== 'undefined') {
             tempSubRICEs.forEach(s => { if(parseFloat(s.score) > maxS) maxS = parseFloat(s.score); });
        }

        data = {
            id: idInput || generateId(),
            category: 'RICE',
            riceName: name, name: name, riceCode: getVal('riceCode'),
            ricePM: getVal('ricePM'), ricePeriod: getVal('ricePeriod'),
            status: getVal('riceStatus'), riceGoal: getVal('riceGoal'),
            riceTopScore: maxS.toFixed(2),
            riceDocLink: getVal('riceDocLink'), image: getVal('riceImage'),
            riceNotes: getVal('riceNotes'),
            subRICEs: typeof tempSubRICEs !== 'undefined' ? tempSubRICEs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'PostMortem') {
        const title = getVal('pmTitle');
        if(!title) return alert("Judul Insiden wajib diisi!");
        
        data = {
            id: idInput || generateId(),
            category: 'PostMortem',
            pmTitle: title, name: title, pmCode: getVal('pmCode'),
            pmDuration: getVal('pmDuration'), pmSeverity: getVal('pmSeverity'),
            status: getVal('pmStatus'), pmDate: getVal('pmDate'),
            pmImpact: getVal('pmImpact'),
            pmDocLink: getVal('pmDocLink'), image: getVal('pmImage'),
            pmLessons: getVal('pmLessons'),
            subPostMortems: typeof tempSubPostMortems !== 'undefined' ? tempSubPostMortems : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }else if (cat === 'IDP') {
        const empName = getVal('idpName');
        if(!empName) return alert("Nama Karyawan wajib diisi!");
        
        let doneC = 0;
        if(typeof tempSubIDPs !== 'undefined') {
             doneC = tempSubIDPs.filter(s => s.status === 'Done').length;
        }
        const prog = tempSubIDPs.length > 0 ? Math.round((doneC / tempSubIDPs.length) * 100) : 0;

        data = {
            id: idInput || generateId(),
            category: 'IDP',
            idpName: empName, name: empName, idpCurrentRole: getVal('idpCurrentRole'),
            idpGoal: getVal('idpGoal'), idpMentor: getVal('idpMentor'),
            idpPeriod: getVal('idpPeriod'), status: getVal('idpStatus'),
            idpProgressRate: prog,
            idpSupport: getVal('idpSupport'), image: getVal('idpImage'),
            idpNotes: getVal('idpNotes'),
            subIDPs: typeof tempSubIDPs !== 'undefined' ? tempSubIDPs : [],
            createdAt: idInput ? (projects.find(p=>p.id===idInput)?.createdAt || now) : now,
            updatedAt: now
        };
    }

        // ... (lanjut ke else JobDesk) ...
        
        if(idInput) {
            const idx = projects.findIndex(p => p.id === idInput);
            projects[idx] = data;
            if(currentDetailId === idInput) openDetail(idInput);
        } else {
            projects.push(data);
        }

        localStorage.setItem('nexusProjectsV3', JSON.stringify(projects));
        renderProjects();
        closeFormModal();
    }

    // --- 1. FUNGSI BARU: UPDATE OPSI FILTER ---
  function updateFilterOptions(category) {
        const select = document.getElementById('filterInput');
        select.innerHTML = ''; // Hapus opsi lama

        // Helper untuk membuat option biasa
        const addOption = (val, text) => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.innerText = text;
            opt.className = "bg-slate-800 text-slate-200";
            select.appendChild(opt);
        };

        // Helper untuk membuat grup (Optgroup)
        const addGroup = (label, items, colorClass) => {
            const group = document.createElement('optgroup');
            group.label = label;
            group.className = `bg-slate-800 font-bold ${colorClass}`;
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.innerText = item;
                opt.className = "bg-slate-800 text-slate-200 font-normal";
                group.appendChild(opt);
            });
            select.appendChild(group);
        };

        // 1. Opsi Default (Selalu ada)
        addOption('all', 'Semua Status');

        // 2. Logika Filter Berdasarkan Kategori
        if (category === 'SOP') {
            ['Draft', 'Aktif', 'Revisi', 'Tidak Berlaku'].forEach(s => addOption(s, s));
        } 
        else if (category === 'JobDesk') {
            ['Planning', 'In Progress', 'Completed', 'On Hold'].forEach(s => addOption(s, s));
        } 
        else if (category === 'KPI') {
            ['Belum Dimulai', 'On Track', 'At Risk', 'Tercapai'].forEach(s => addOption(s, s));
        } 
        else if (category === 'ProjectCharter') {
            // Menu Project Charter: Tampilkan Status Project Saja
            ['Belum Dimulai', 'Berjalan', 'Selesai', 'Dihentikan'].forEach(s => addOption(s, s));
        } 
        else if (category === 'BSC') {
            ['Belum Dimulai', 'On Track', 'At Risk', 'Tercapai'].forEach(s => addOption(s, s));
        }
        else if (category === 'Agile') {
            ['Belum Dimulai', 'Berjalan', 'Selesai', 'Dihentikan'].forEach(s => addOption(s, s));
        }
        else if (category === 'BRD') {
            ['Draft', 'Review', 'Approved', 'Revisi'].forEach(s => addOption(s, s));
        }
        else if (category === 'OKR') {
            ['Draft', 'On Track', 'At Risk', 'Completed'].forEach(s => addOption(s, s));
        }
        if (category === 'Risk') {
            ['Identified', 'Mitigated', 'Occurred', 'Closed'].forEach(s => addOption(s, s));
        }
        if (category === 'Stakeholder') {
            ['Draft', 'Active', 'Review', 'Final'].forEach(s => addOption(s, s));
        }if (category === 'SWOT') {
            ['Draft', 'Final', 'Archived'].forEach(s => addOption(s, s));
        }
        if (category === 'QC') {
            ['Passed', 'Failed', 'On Hold', 'Inspection'].forEach(s => addOption(s, s));
        }
        if (category === 'Procurement') {
            ['Draft', 'Pending Approval', 'Approved', 'Ordered', 'Received'].forEach(s => addOption(s, s));
        }
        if (category === 'Training') {
            ['Planned', 'In Progress', 'Completed', 'Canceled'].forEach(s => addOption(s, s));
        }if (category === 'Recruitment') {
            ['Open', 'Closed', 'On Hold', 'Draft'].forEach(s => addOption(s, s));
        }if (category === 'Appraisal') {
            ['Draft', 'In Review', 'Discussed', 'Finalized'].forEach(s => addOption(s, s));
        }
        if (category === 'ChangeRequest') {
            ['Draft', 'Submitted', 'Approved', 'Rejected'].forEach(s => addOption(s, s));
        }if (category === 'KPA') {
            ['Draft', 'Submitted', 'Reviewed', 'Finalized'].forEach(s => addOption(s, s));
        }
        if (category === 'PIP') {
            ['Active', 'Reviewing', 'Passed', 'Failed/Terminated'].forEach(s => addOption(s, s));
        }if (category === 'OGSM') {
            ['On Track', 'Off Track', 'At Risk', 'Completed'].forEach(s => addOption(s, s));
        }
        if (category === 'KRA') {
            ['Draft', 'Active', 'Under Review', 'Closed'].forEach(s => addOption(s, s));
        }
        if (category === 'CSF') {
            ['Safe', 'Watchlist', 'Critical'].forEach(s => addOption(s, s));
        }if (category === 'MBO') {
            ['Draft', 'Active', 'Reviewed', 'Closed'].forEach(s => addOption(s, s));
        }
        if (category === 'V2MOM') {
            ['Draft', 'Aligned', 'In Progress', 'Achieved'].forEach(s => addOption(s, s));
        }
        if (category === 'IDP') {
            ['Draft', 'Active', 'Review', 'Completed'].forEach(s => addOption(s, s));
        }
        if (category === 'WIG') {
            ['On Track', 'Off Track', 'WIG Achieved'].forEach(s => addOption(s, s));
        }
        if (category === 'MOST') {
            ['Draft', 'Active', 'Completed', 'Archived'].forEach(s => addOption(s, s));
        }
        if (category === 'KRI') {
            ['Safe', 'Warning', 'Danger'].forEach(s => addOption(s, s));
        }if (category === 'KCI') {
            ['Compliant', 'Non-Compliant', 'On Review', 'Draft'].forEach(s => addOption(s, s));
        }if (category === 'FMEA') {
            ['Open', 'Mitigated', 'Closed', 'Draft'].forEach(s => addOption(s, s));
        }if (category === 'SLA') {
            ['Compliant', 'Breached', 'At Risk', 'Review'].forEach(s => addOption(s, s));
        }if (category === '5S') {
            ['Excellent', 'Good', 'Average', 'Poor'].forEach(s => addOption(s, s));
        }if (category === 'SIPOC') {
            ['Draft', 'Mapped', 'Optimized', 'Approved'].forEach(s => addOption(s, s));
        }
        if (category === 'GapAnalysis') {
            ['Draft', 'In Progress', 'Bridged', 'Closed'].forEach(s => addOption(s, s));
        }if (category === 'RICE') {
            ['Draft', 'Prioritized', 'Approved', 'Backlog'].forEach(s => addOption(s, s));
        }if (category === 'PostMortem') {
            ['Draft', 'Investigating', 'Resolved', 'Closed'].forEach(s => addOption(s, s));
        }

        else {
            // Dashboard Utama (Gabungan Semua Grup)
            addGroup('Status SOP', ['Draft', 'Aktif', 'Revisi', 'Tidak Berlaku'], 'text-cyan-400');
            addGroup('Status Job Desk', ['Planning', 'In Progress', 'Completed', 'On Hold'], 'text-emerald-400');
            addGroup('Status KPI', ['On Track', 'At Risk', 'Tercapai'], 'text-rose-400');
            // Tambahkan Grup Project Charter (Syntax Fixed)
            addGroup('Status Project', ['Belum Dimulai', 'Berjalan', 'Selesai', 'Dihentikan'], 'text-violet-400');
            addGroup('Status BSC', ['On Track', 'At Risk', 'Tercapai'], 'text-amber-400');
            addGroup('Status Agile', ['Belum Dimulai', 'Berjalan', 'Selesai', 'Dihentikan'], `text-sky-400`);
            addGroup('Status BRD', ['Draft', 'Review', 'Approved', 'Revisi'], 'text-fuchsia-400');
            addGroup('Status OKR', ['Draft', 'On Track', 'At Risk', 'Completed'], 'text-lime-400');
            addGroup('Status Risiko', ['Identified', 'Mitigated', 'Occurred', 'Closed'], 'text-red-400');
            addGroup('Status Stakeholder', ['Draft', 'Active', 'Review', 'Final'], 'text-teal-400');
            addGroup('Status SWOT', ['Draft', 'Final', 'Archived'], 'text-orange-400');
            addGroup('Status QC', ['Passed', 'Failed', 'On Hold', 'Inspection'], 'text-emerald-400');
            addGroup('Status Pengadaan', ['Draft', 'Approved', 'Ordered', 'Received'], 'text-slate-400');
            addGroup('Status Training', ['Planned', 'In Progress', 'Completed', 'Canceled'], 'text-cyan-400');
            addGroup('Status Lowongan', ['Open', 'Closed', 'On Hold'], 'text-pink-400');
            addGroup('Status Process', ['Mapped', 'Optimized', 'Approved'], 'text-teal-400');
            addGroup('Status Penilaian', ['Draft', 'In Review', 'Finalized'], 'text-indigo-400');
            addGroup('Status CR', ['Draft', 'Submitted', 'Approved', 'Rejected'], 'text-fuchsia-400');
            addGroup('Status Penilaian', ['Submitted', 'Reviewed', 'Finalized'], 'text-purple-400');
            addGroup('Status PIP', ['Active', 'Passed', 'Failed'], 'text-red-400');
            addGroup('Status Strategi', ['On Track', 'Off Track', 'At Risk'], 'text-emerald-400');
            addGroup('Status KRA', ['Draft', 'Active', 'Under Review'], 'text-blue-400');
            addGroup('Status CSF', ['Safe', 'Watchlist', 'Critical'], 'text-amber-400');
            addGroup('Status MBO', ['Draft', 'Active', 'Reviewed'], 'text-slate-400');
            addGroup('Status V2MOM', ['Draft', 'Aligned', 'Achieved'], 'text-sky-400');
            addGroup('Status WIG', ['On Track', 'Off Track', 'WIG Achieved'], 'text-rose-400');
            addGroup('Status MOST', ['Draft', 'Active', 'Completed'], 'text-indigo-400');
            addGroup('Status Risiko KRI', ['Safe', 'Warning', 'Danger'], 'text-red-400');
            addGroup('Status Audit', ['Compliant', 'Non-Compliant', 'On Review'], 'text-zinc-400');
            addGroup('Status FMEA', ['Open', 'Mitigated', 'Closed'], 'text-orange-400');
            addGroup('Status SLA', ['Compliant', 'Breached', 'At Risk'], 'text-cyan-400');
            addGroup('Hasil Audit', ['Excellent', 'Good', 'Poor'], 'text-lime-400');
            addGroup('Status Gap', ['In Progress', 'Bridged'], 'text-fuchsia-400');
            addGroup('Status Prioritas', ['Prioritized', 'Approved'], 'text-pink-400');
            addGroup('Status Insiden', ['Investigating', 'Resolved', 'Closed'], 'text-stone-400');
            addGroup('Status IDP', ['Active', 'Review', 'Completed'], 'text-green-400');
        
        
    
        }

        
        
        
        
        
    }
    // --- 2. UPDATE FUNGSI SWITCH CATEGORY (Agar memanggil filter baru) ---
   function switchCategory(category) {
        currentCategory = category;
        const theme = themes[category];
        
        // 1. Update Background & Titles
        bgLayer.style.background = theme.bgGradient;
        document.getElementById('page-title').innerText = theme.title;
        document.getElementById('page-subtitle').innerText = theme.subtitle;

        // 2. Update Navigasi Active State
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.remove('active');
            el.style.borderLeftColor = 'transparent';
        });
        const activeNav = document.getElementById(`nav-${category}`);
        if(activeNav) {
            activeNav.classList.add('active');
            let colorHex = category === 'SOP' ? '#06b6d4' : (category === 'JobDesk' ? '#10b981' : '#6366f1');
            activeNav.style.borderLeftColor = colorHex;
        }

        // 3. LOGIC SHOW/HIDE BUTTON vs TIME WIDGET (REVISI DISINI)
        const timeWidget = document.getElementById('timeWidget');
        const createBtn = document.getElementById('createActionBtn');

        if (category === 'Dashboard') {
            // Jika di Dashboard: Sembunyikan Tombol, Tampilkan Jam
            createBtn.classList.add('hidden');
            createBtn.classList.remove('flex');
            
            timeWidget.classList.remove('hidden');
            timeWidget.classList.add('flex');
        } else {
            // Jika di SOP/JobDesk: Tampilkan Tombol, Sembunyikan Jam
            createBtn.classList.remove('hidden');
            createBtn.classList.add('flex');
            
            timeWidget.classList.add('hidden');
            timeWidget.classList.remove('flex');

            // Update warna tombol sesuai tema
            const btnClass = `bg-${theme.color}-600 hover:bg-${theme.color}-500 text-white px-6 py-2.5 rounded-xl font-semibold shadow-lg shadow-${theme.color}-500/30 transition-all active:scale-95 flex items-center gap-2 text-sm`;
            createBtn.className = btnClass;
        }

        // 4. Update Filter
        updateFilterOptions(category);
        document.getElementById('filterInput').value = 'all';

        renderProjects();
    }
    function populateSopForm(p) {
        document.getElementById('sopTitle').value = p.sopTitle;
        document.getElementById('sopCode').value = p.sopCode;
        document.getElementById('sopDesc').value = p.sopDesc;
        document.getElementById('sopDivision').value = p.sopDivision;
        document.getElementById('sopCategoryType').value = p.sopCategoryType;
        document.getElementById('sopOwner').value = p.sopOwner;
        document.getElementById('sopCreator').value = p.sopCreator;
        document.getElementById('sopStatus').value = p.status;
        document.getElementById('sopVersion').value = p.sopVersion;
        document.getElementById('sopDateValid').value = p.sopDateValid;
        document.getElementById('sopDateLastReview').value = p.sopDateLastReview;
        document.getElementById('sopDateNextReview').value = p.sopDateNextReview;
        document.getElementById('sopUrgency').value = p.sopUrgency;
        document.getElementById('sopRisk').value = p.sopRisk;
        document.getElementById('sopScope').value = p.sopScope;
        document.getElementById('sopRef').value = p.sopRef;
        document.getElementById('sopKpi').value = p.sopKpi;
        document.getElementById('sopParties').value = p.sopParties;
        document.getElementById('sopMedia').value = p.sopMedia;
        document.getElementById('sopLinkDoc').value = p.sopLinkDoc;
        document.getElementById('sopLinkTemplate').value = p.sopLinkTemplate;
        document.getElementById('sopImage').value = p.sopImage;
        document.getElementById('sopIssues').value = p.sopIssues;
        document.getElementById('sopSolutions').value = p.sopSolutions;
        document.getElementById('sopImplStatus').value = p.sopImplStatus;
        document.getElementById('sopAudit').value = p.sopAudit;
        
        tempSubSops = p.subSops || [];
        renderSubSopTable();
    }
// --- TIME WIDGET LOGIC ---
    function startTimeWidget() {
        const updateTime = () => {
            const now = new Date();
            const hour = now.getHours();
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');
            
            // Elemen
            const clockEl = document.getElementById('timeClock');
            const greetingEl = document.getElementById('timeGreeting');
            const iconEl = document.getElementById('timeIcon');
            const iconBg = document.getElementById('timeIconBg');

            // Set Jam
            if(clockEl) clockEl.innerText = `${hour}:${minute}:${second} WIB`;

            // Logika Sapaan & Ikon
            let greeting = "Selamat Pagi";
            let iconClass = "fa-sun";
            let colorClass = "amber"; // Default (Orange/Yellow)

            if (hour >= 3 && hour < 5) {
                greeting = "Selamat Subuh";
                iconClass = "fa-cloud-moon";
                colorClass = "indigo"; // Biru gelap/Ungu
            } else if (hour >= 5 && hour < 10) {
                greeting = "Selamat Pagi";
                iconClass = "fa-mug-hot"; // Atau fa-sun
                colorClass = "amber"; // Kuning cerah
            } else if (hour >= 10 && hour < 15) {
                greeting = "Selamat Siang";
                iconClass = "fa-sun";
                colorClass = "orange"; // Oranye terik
            } else if (hour >= 15 && hour < 18) {
                greeting = "Selamat Sore";
                iconClass = "fa-cloud-sun";
                colorClass = "teal"; // Senja/Teal
            } else {
                greeting = "Selamat Malam";
                iconClass = "fa-moon";
                colorClass = "purple"; // Ungu malam
            }

            // Update UI
            if(greetingEl) greetingEl.innerText = greeting;
            if(iconEl) iconEl.className = `fa-solid ${iconClass} text-xs`;
            
            // Update warna background icon secara dinamis
            // Catatan: Tailwind mungkin perlu safelist warna full, tapi ini pendekatan inline style utk JS
            if(iconBg) {
                // Mapping manual warna untuk Tailwind
                let bgMap = {
                    'indigo': 'bg-indigo-500/20 text-indigo-400 border-indigo-500/20 shadow-[0_0_10px_rgba(99,102,241,0.2)]',
                    'amber': 'bg-amber-500/20 text-amber-400 border-amber-500/20 shadow-[0_0_10px_rgba(245,158,11,0.2)]',
                    'orange': 'bg-orange-500/20 text-orange-400 border-orange-500/20 shadow-[0_0_10px_rgba(249,115,22,0.2)]',
                    'teal': 'bg-teal-500/20 text-teal-400 border-teal-500/20 shadow-[0_0_10px_rgba(20,184,166,0.2)]',
                    'purple': 'bg-purple-500/20 text-purple-400 border-purple-500/20 shadow-[0_0_10px_rgba(168,85,247,0.2)]'
                };
                iconBg.className = `w-8 h-8 rounded-full flex items-center justify-center border ${bgMap[colorClass]}`;
            }
        };

        updateTime(); // Run immediately
        setInterval(updateTime, 1000); // Update every second
    }
    function populateJobDeskForm(p) {
        document.getElementById('jdTitle').value = p.jdTitle;
        document.getElementById('jdCode').value = p.jdCode;
        document.getElementById('jdDesc').value = p.jdDesc;
        document.getElementById('jdPosition').value = p.jdPosition;
        document.getElementById('jdDivision').value = p.jdDivision;
        document.getElementById('jdCategory').value = p.jdCategory;
        document.getElementById('jdType').value = p.jdType;
        document.getElementById('jdPic').value = p.jdPic;
        document.getElementById('jdStartDate').value = p.jdStartDate;
        document.getElementById('jdEndDate').value = p.jdEndDate;
        document.getElementById('jdStartTime').value = p.jdStartTime;
        document.getElementById('jdEndTime').value = p.jdEndTime;
        document.getElementById('jdDuration').value = p.jdDuration;
        document.getElementById('jdStatus').value = p.status; // Shared field
        document.getElementById('jdNature').value = p.jdNature;
        document.getElementById('jdPriority').value = p.jdPriority;
        document.getElementById('jdDifficulty').value = p.jdDifficulty;
        document.getElementById('jdGoal').value = p.jdGoal;
        document.getElementById('jdOutput').value = p.jdOutput;
        document.getElementById('jdKpi').value = p.jdKpi;
        document.getElementById('jdParties').value = p.jdParties;
        document.getElementById('jdApprover').value = p.jdApprover;
        document.getElementById('jdMedia').value = p.jdMedia;
        document.getElementById('jdDocLink').value = p.jdDocLink;
        document.getElementById('jdTemplateLink').value = p.jdTemplateLink;
        document.getElementById('jdImage').value = p.image;
        document.getElementById('jdNotes').value = p.jdNotes;
        document.getElementById('jdIssues').value = p.jdIssues;
        document.getElementById('jdSolutions').value = p.jdSolutions;
        document.getElementById('jdEval').value = p.jdEval;

        tempSubSops = p.subJobDesks || [];
        renderSubJobDeskTable(); // GANTI JADI INI
    }
    function closeFormModal() {
        document.getElementById('formModal').classList.remove('active');
    }
// --- 2. FUNGSI HTML DETAIL KHUSUS KPI ---
    function getKpiDetailHtml(p) {
        // 1. Format Tanggal Helper
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';

        // 2. Render Baris Sub-KPI (Rincian Aktivitas)
        const subKpiRows = (p.subKpis || []).map((s, i) => {
            // Warna Indikator untuk Tabel Detail
            const gapColor = parseFloat(s.gap) >= 0 ? 'text-emerald-400' : 'text-red-400';
            const scoreColor = s.score === 'A' ? 'text-emerald-400' : (s.score === 'B' ? 'text-blue-400' : 'text-rose-400');
            
            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-center text-slate-400">${s.order}</td>
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-slate-400 text-xs">${s.date || '-'}</td>
                <td class="p-3 text-xs">${s.pic || '-'}</td>
                <td class="p-3 text-xs italic text-slate-500">${s.output || '-'}</td>
                
                <td class="p-3 text-center text-xs bg-white/5">${s.unit || '-'}</td>
                <td class="p-3 text-center text-xs bg-white/5">${s.weight || 0}%</td>
                <td class="p-3 text-center text-xs bg-white/5">${s.baseline || 0}</td>
                
                <td class="p-3 text-center font-bold text-white bg-rose-500/10">${s.target || 0}</td>
                <td class="p-3 text-center font-bold text-white bg-emerald-500/10">${s.realization || 0}</td>
                
                <td class="p-3 text-center font-bold text-xs">${s.value}%</td>
                <td class="p-3 text-center font-bold text-xs ${gapColor}">${s.gap > 0 ? '+' : ''}${s.gap}%</td>
                <td class="p-3 text-center font-bold ${scoreColor}">${s.score}</td>
            </tr>
            `;
        }).join('');

        // 3. Tentukan Warna Header Utama
        const mainGap = parseFloat(p.kpiGap) || 0;
        const mainGapColor = mainGap >= 0 ? 'text-emerald-400' : 'text-red-400';
        const mainScoreColor = p.kpiScore === 'A' ? 'text-emerald-400' : (p.kpiScore === 'B' ? 'text-blue-400' : 'text-rose-400');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${p.image || `https://picsum.photos/seed/${p.id}/1200/600`}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-rose-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-rose-500/20">${p.status || 'Draft'}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-rose-200 text-[10px] uppercase tracking-widest border border-rose-500/30">KPI</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.kpiPeriod || '-'}</span>
                    </div>
                    
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.kpiTitle || 'Tanpa Judul'}</h1>
                    
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-barcode text-rose-500"></i> ${p.kpiCode || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-rose-500"></i> ${p.kpiOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-building text-rose-500"></i> ${p.kpiDivision || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                
                <div class="lg:col-span-2 space-y-8">
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-crosshairs text-4xl text-white"></i></div>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold block mb-1">Target Total</span>
                            <span class="text-2xl font-bold text-white">${p.kpiTarget || 0}</span>
                            <span class="text-[10px] text-rose-400 ml-1">${p.kpiUnit || ''}</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-chart-line text-4xl text-emerald-400"></i></div>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold block mb-1">Realisasi</span>
                            <span class="text-2xl font-bold text-emerald-300">${p.kpiRealization || 0}</span>
                        </div>
                         <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                             <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-percent text-4xl text-blue-400"></i></div>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold block mb-1">Capaian</span>
                            <span class="text-2xl font-bold text-blue-300">${p.kpiValue || 0}</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                             <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-star text-4xl text-amber-400"></i></div>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold block mb-1">Skor Akhir</span>
                            <span class="text-3xl font-bold ${mainScoreColor}">${p.kpiScore || '-'}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-align-left"></i> Deskripsi KPI
                        </h3>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.kpiDesc || 'Tidak ada deskripsi detail.'}</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                                <i class="fa-solid fa-list-check"></i> Rincian Aktivitas
                            </h3>
                            <span class="text-[10px] text-slate-500 italic">Scroll ke samping untuk detail</span>
                        </div>
                        
                        <div class="overflow-x-auto rounded-xl border border-white/10 pb-2 custom-scrollbar">
                             <table class="w-full text-left text-sm min-w-[1000px]">
                                <thead class="bg-rose-900/20 text-rose-200 uppercase tracking-wider font-bold text-[10px]">
                                    <tr>
                                        <th class="p-3">No</th>
                                        <th class="p-3">Aktivitas</th>
                                        <th class="p-3">Tgl</th>
                                        <th class="p-3">PIC</th>
                                        <th class="p-3">Output</th>
                                        <th class="p-3 text-center">Satuan</th>
                                        <th class="p-3 text-center">Bobot</th>
                                        <th class="p-3 text-center">Base</th>
                                        <th class="p-3 text-center bg-rose-500/10">Target</th>
                                        <th class="p-3 text-center bg-emerald-500/10">Real</th>
                                        <th class="p-3 text-center">Nilai</th>
                                        <th class="p-3 text-center">Gap</th>
                                        <th class="p-3 text-center">Skor</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/5 bg-[#161b2e]">
                                    ${subKpiRows || '<tr><td colspan="13" class="p-6 text-center italic text-slate-500 text-xs">Belum ada rincian aktivitas.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-5 rounded-2xl bg-rose-500/5 border border-rose-500/10">
                            <h4 class="text-rose-300 font-bold text-xs mb-2 uppercase tracking-wide">Hambatan / Isu</h4>
                            <p class="text-slate-400 text-sm leading-relaxed">${p.kpiIssues || '-'}</p>
                        </div>
                        <div class="p-5 rounded-2xl bg-indigo-500/5 border border-indigo-500/10">
                            <h4 class="text-indigo-300 font-bold text-xs mb-2 uppercase tracking-wide">Rencana Perbaikan</h4>
                            <p class="text-slate-400 text-sm leading-relaxed">${p.kpiActionPlan || '-'}</p>
                        </div>
                        <div class="col-span-1 md:col-span-2 p-5 rounded-2xl bg-blue-500/5 border border-blue-500/10 flex flex-col md:flex-row gap-4 items-start">
                             <div class="flex-1">
                                <h4 class="text-blue-300 font-bold text-xs mb-2 uppercase tracking-wide">Evaluasi Akhir</h4>
                                <p class="text-slate-400 text-sm leading-relaxed">${p.kpiEvaluation || '-'}</p>
                             </div>
                             <div class="shrink-0">
                                <span class="block text-[10px] text-slate-500 uppercase mb-1">Keputusan</span>
                                <span class="px-3 py-1.5 rounded-lg bg-blue-500/20 text-blue-300 text-xs font-bold border border-blue-500/30">${p.kpiDecision || '-'}</span>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
    <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Detail</h3>
    <ul class="space-y-4">
        <li class="flex justify-between text-xs"><span class="text-slate-500">Posisi</span><span class="text-slate-200 text-right">${p.kpiPosition || '-'}</span></li>
        <li class="flex justify-between text-xs"><span class="text-slate-500">Kategori</span><span class="text-slate-200 text-right">${p.kpiCategoryType || '-'}</span></li>
        <li class="flex justify-between text-xs"><span class="text-slate-500">Jenis</span><span class="text-slate-200 text-right">${p.kpiType || '-'}</span></li>
        
        <li class="flex justify-between text-xs"><span class="text-slate-500">Risiko</span><span class="text-rose-400 font-bold text-right">${p.kpiRisk || '-'}</span></li>
        <li class="flex justify-between text-xs"><span class="text-slate-500">Dampak</span><span class="text-slate-200 text-right">${p.kpiImpact || '-'}</span></li>
        <li class="flex justify-between text-xs pt-2 border-t border-white/5">
            <span class="text-slate-500">Gap Target</span>
            <span class="font-bold ${mainGapColor}">${p.kpiGap || '0%'}</span>
        </li>
    </ul>
</div>

                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Waktu Monitoring</h3>
                         <ul class="space-y-4">
                            <li class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">Mulai</span>
                                <div class="text-right">
                                    <div class="text-slate-200">${formatDate(p.kpiStartDate)}</div>
                                    <div class="text-[10px] text-slate-500">${p.kpiStartTime || ''}</div>
                                </div>
                            </li>
                            <li class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">Akhir</span>
                                <div class="text-right">
                                    <div class="text-slate-200">${formatDate(p.kpiEndDate)}</div>
                                    <div class="text-[10px] text-slate-500">${p.kpiEndTime || ''}</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="space-y-3">
                         <a href="${p.kpiDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-rose-500/50 hover:bg-rose-500/10 transition text-xs text-rose-300 group">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-file group-hover:scale-110 transition"></i> Dokumentasi</span>
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                         <a href="${p.kpiProof || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-rose-500/50 hover:bg-rose-500/10 transition text-xs text-rose-300 group">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-paperclip group-hover:scale-110 transition"></i> Bukti Pendukung</span>
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-rose-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
    // --- DETAIL VIEW LOGIC ---
    function openDetail(id) {
        currentDetailId = id;
        const p = projects.find(x => x.id === id);
        const container = document.getElementById('detailContainer');
        const modal = document.getElementById('detailModal');

        // Render Timestamps Footer
        document.getElementById('lblCreated').innerText = formatDate(p.createdAt) + ' ' + formatTime(p.createdAt);
        document.getElementById('lblUpdated').innerText = formatDate(p.updatedAt) + ' ' + formatTime(p.updatedAt);

       if (p.category === 'SOP') container.innerHTML = getSopDetailHtml(p);
        else if (p.category === 'KPI') container.innerHTML = getKpiDetailHtml(p);
        else if (p.category === 'ProjectCharter') container.innerHTML = getProjectCharterDetailHtml(p); // <--- INI
        else if (p.category === 'BSC') container.innerHTML = getBSCDetailHtml(p); // <--- TAMBAHAN
        else if (p.category === 'Agile') container.innerHTML = getAgileDetailHtml(p);
        else if (p.category === 'BRD') container.innerHTML = getBRDDetailHtml(p);
        else if (p.category === 'OKR') container.innerHTML = getOKRDetailHtml(p);
        else if (p.category === 'Risk') container.innerHTML = getRiskDetailHtml(p);
        else if (p.category === 'Stakeholder') container.innerHTML = getStakeholderDetailHtml(p);
        else if (p.category === 'QC') container.innerHTML = getQCDetailHtml(p);
        else if (p.category === 'SWOT') container.innerHTML = getSWOTDetailHtml(p);
        else if (p.category === 'Procurement') container.innerHTML = getProcurementDetailHtml(p);
        else if (p.category === 'Training') container.innerHTML = getTrainingDetailHtml(p);
        else if (p.category === 'Recruitment') container.innerHTML = getRecruitmentDetailHtml(p);
        else if (p.category === 'Appraisal') container.innerHTML = getAppraisalDetailHtml(p);
else if (p.category === 'IDP') container.innerHTML = getIDPDetailHtml(p);
        else if (p.category === 'ChangeRequest') container.innerHTML = getChangeRequestDetailHtml(p);
        else if (p.category === 'KPA') container.innerHTML = getKPADetailHtml(p);
        else if (p.category === 'PIP') container.innerHTML = getPIPDetailHtml(p);
        else if (p.category === 'OGSM') container.innerHTML = getOGSMDetailHtml(p);
        else if (p.category === 'KRA') container.innerHTML = getKRADetailHtml(p);
        else if (p.category === 'PostMortem') container.innerHTML = getPostMortemDetailHtml(p);
        else if (p.category === 'CSF') container.innerHTML = getCSFDetailHtml(p);
        else if (p.category === 'MBO') container.innerHTML = getMBODetailHtml(p);
        else if (p.category === 'V2MOM') container.innerHTML = getV2MOMDetailHtml(p);
        else if (p.category === 'WIG') container.innerHTML = getWIGDetailHtml(p);
        else if (p.category === 'MOST') container.innerHTML = getMOSTDetailHtml(p);
        else if (p.category === 'KRI') container.innerHTML = getKRIDetailHtml(p);
        else if (p.category === 'KCI') container.innerHTML = getKCIDetailHtml(p);
        else if (p.category === 'FMEA') container.innerHTML = getFMEADetailHtml(p);
        else if (p.category === 'SLA') container.innerHTML = getSLADetailHtml(p);
        else if (p.category === '5S') container.innerHTML = get5SDetailHtml(p);
        else if (p.category === 'SIPOC') container.innerHTML = getSIPOCDetailHtml(p);
        else if (p.category === 'GapAnalysis') container.innerHTML = getGapAnalysisDetailHtml(p);
        else if (p.category === 'RICE') container.innerHTML = getRICEDetailHtml(p);
        else container.innerHTML = getJobDeskDetailHtml(p);

        modal.classList.add('active');
    }

     function getSopDetailHtml(p) {
        // Safety Check untuk data Array Sub SOP
        const steps = p.subSops || [];
        
        // Generator HTML untuk Timeline Langkah Kerja (Pengganti Tabel)
       // Generator HTML untuk Timeline Langkah Kerja (Revisi: PIC geser ke kiri dekat Waktu)
        const timelineHtml = steps.length > 0 ? steps.map((s, index) => `
            <div class="relative pl-8 pb-8 last:pb-0 border-l border-white/10 last:border-transparent">
                <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-cyan-400 shadow-[0_0_10px_rgba(34,211,238,0.5)]"></div>
                
                <div class="bg-white/5 border border-white/5 rounded-xl p-4 hover:bg-white/10 transition group">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-sm font-bold text-white group-hover:text-cyan-300 transition">${s.name}</h4>
                        <span class="text-[10px] px-2 py-0.5 rounded bg-black/30 text-slate-400 border border-white/5">${s.order}</span>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-6 mb-3">
                        <div class="text-xs text-slate-400 flex items-center gap-2">
                            <i class="fa-regular fa-clock text-cyan-500/70"></i> 
                            ${s.date || '-'} <span class="text-[10px] opacity-70">(${s.time || ''})</span>
                        </div>
                        <div class="text-xs text-slate-400 flex items-center gap-2">
                            <i class="fa-regular fa-user text-purple-500/70"></i> 
                            <span>${s.pic || '-'}</span>
                        </div>
                    </div>
                    
                    <p class="text-xs text-slate-300 leading-relaxed text-justify">${s.desc || 'Tidak ada deskripsi langkah.'}</p>
                </div>
            </div>
        `).join('') : `<div class="p-6 text-center text-slate-500 italic text-sm bg-white/5 rounded-xl border border-dashed border-white/10">Belum ada langkah kerja yang ditambahkan.</div>`;
        return `
            <div class="relative w-full h-72 md:h-80 overflow-hidden shrink-0">
                <img src="${p.sopImage || `https://picsum.photos/seed/${p.id}/1200/600`}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/80 to-transparent"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-[#0f172a]/90 via-transparent to-transparent"></div>

                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4 animate-fade-in-up">
                        <span class="px-3 py-1 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-cyan-500/20">
                            ${p.status}
                        </span>
                        <span class="px-3 py-1 rounded-lg bg-white/10 backdrop-blur-md border border-white/10 text-slate-200 text-[10px] font-bold uppercase tracking-widest">
                            ${p.sopCode || 'No Code'}
                        </span>
                        <span class="px-3 py-1 rounded-lg bg-white/10 backdrop-blur-md border border-white/10 text-slate-200 text-[10px] font-bold uppercase tracking-widest">
                            Ver. ${p.sopVersion || '1.0'}
                        </span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-3 drop-shadow-lg max-w-4xl">
                        ${p.sopTitle}
                    </h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300 font-medium">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-layer-group text-cyan-400"></i> ${p.sopDivision}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-crown text-amber-400"></i> ${p.sopOwner || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 md:gap-12 bg-[#0f172a]">
                
                <div class="lg:col-span-2 space-y-10">
                    
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-cyan-500/20 to-purple-500/20 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                        <div class="relative bg-[#1e293b]/50 border border-white/10 p-6 rounded-2xl backdrop-blur-sm">
                            <h3 class="text-cyan-300 font-bold uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-align-left"></i> Deskripsi & Tujuan
                            </h3>
                            <p class="text-slate-300 text-sm md:text-base leading-loose text-justify font-light">
                                ${p.sopDesc || 'Belum ada deskripsi.'}
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white/5 border border-white/5 p-6 rounded-2xl hover:border-white/10 transition">
                            <h4 class="text-slate-400 text-xs uppercase tracking-wider font-bold mb-3">Ruang Lingkup</h4>
                            <p class="text-slate-200 text-sm leading-relaxed text-justify">
                                ${p.sopScope || '-'}
                            </p>
                        </div>
                        <div class="bg-white/5 border border-white/5 p-6 rounded-2xl hover:border-white/10 transition">
                            <h4 class="text-slate-400 text-xs uppercase tracking-wider font-bold mb-3">Dasar Referensi</h4>
                            <p class="text-slate-200 text-sm leading-relaxed text-justify">
                                ${p.sopRef || '-'}
                            </p>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-cyan-300 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                                <i class="fa-solid fa-list-check"></i> Langkah Kerja (Sub-SOP)
                            </h3>
                            <span class="text-[10px] bg-white/5 px-2 py-1 rounded text-slate-400 border border-white/5">${steps.length} Aktivitas</span>
                        </div>
                        
                        <div class="bg-[#111827]/50 p-6 rounded-2xl border border-white/5 shadow-inner">
                            ${timelineHtml}
                        </div>
                    </div>

                    <div>
                        <h3 class="text-cyan-300 font-bold uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-clipboard-check"></i> Catatan Evaluasi
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-5 rounded-2xl bg-gradient-to-br from-red-500/10 to-transparent border border-red-500/20">
                                <h4 class="text-red-300 font-bold text-xs mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-triangle-exclamation"></i> Kendala Umum
                                </h4>
                                <p class="text-slate-300 text-sm text-justify leading-relaxed">${p.sopIssues || '-'}</p>
                            </div>
                            <div class="p-5 rounded-2xl bg-gradient-to-br from-emerald-500/10 to-transparent border border-emerald-500/20">
                                <h4 class="text-emerald-300 font-bold text-xs mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-lightbulb"></i> Solusi & Best Practice
                                </h4>
                                <p class="text-slate-300 text-sm text-justify leading-relaxed">${p.sopSolutions || '-'}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    
                    <div class="bg-gradient-to-br from-[#1e293b] to-[#0f172a] border border-white/10 p-6 rounded-2xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-cyan-500/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                        <h3 class="text-white font-bold text-sm mb-4">Target KPI</h3>
                        <p class="text-cyan-200 text-sm italic font-medium leading-relaxed">
                            "${p.sopKpi || 'Belum ada indikator KPI.'}"
                        </p>
                    </div>

                    <div class="bg-white/5 border border-white/5 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-white/5 border-b border-white/5 font-bold text-sm text-slate-200">
                            Informasi Detail
                        </div>
                        <div class="p-4 space-y-4">
                            <div class="flex justify-between items-center border-b border-white/5 pb-3 last:border-0 last:pb-0">
                                <span class="text-xs text-slate-500">Kategori</span>
                                <span class="text-xs text-slate-200 font-medium px-2 py-1 rounded bg-white/5">${p.sopCategoryType || '-'}</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-white/5 pb-3 last:border-0 last:pb-0">
                                <span class="text-xs text-slate-500">Sifat</span>
                                <span class="text-xs font-medium ${p.sopUrgency === 'Sangat Penting' ? 'text-red-300' : 'text-slate-200'}">${p.sopUrgency || '-'}</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-white/5 pb-3 last:border-0 last:pb-0">
                                <span class="text-xs text-slate-500">Risiko</span>
                                <span class="text-xs font-medium ${p.sopRisk === 'Tinggi' ? 'text-red-400' : 'text-emerald-400'}">${p.sopRisk || '-'}</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-white/5 pb-3 last:border-0 last:pb-0">
                                <span class="text-xs text-slate-500">Penyusun</span>
                                <span class="text-xs text-slate-200">${p.sopCreator || '-'}</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-white/5 pb-3 last:border-0 last:pb-0">
                                <span class="text-xs text-slate-500">Review Berikutnya</span>
                                <span class="text-xs text-indigo-300">${formatDate(p.sopDateNextReview)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <a href="${p.sopLinkDoc || '#'}" target="_blank" class="flex items-center justify-between w-full p-4 bg-[#1e293b] hover:bg-[#334155] border border-white/10 hover:border-cyan-500/50 rounded-xl transition group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-cyan-500/20 flex items-center justify-center text-cyan-400">
                                    <i class="fa-solid fa-file-lines"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-xs font-bold text-white group-hover:text-cyan-300 transition">Dokumen Utama</div>
                                    <div class="text-[10px] text-slate-500">Google Drive / PDF</div>
                                </div>
                            </div>
                            <i class="fa-solid fa-arrow-up-right-from-square text-slate-500 text-xs"></i>
                        </a>

                        <a href="${p.sopLinkTemplate || '#'}" target="_blank" class="flex items-center justify-between w-full p-4 bg-[#1e293b] hover:bg-[#334155] border border-white/10 hover:border-emerald-500/50 rounded-xl transition group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                                    <i class="fa-solid fa-table"></i>
                                </div>
                                <div class="text-left">
                                    <div class="text-xs font-bold text-white group-hover:text-emerald-300 transition">Form Template</div>
                                    <div class="text-[10px] text-slate-500">XLS / Doc / Form</div>
                                </div>
                            </div>
                            <i class="fa-solid fa-arrow-up-right-from-square text-slate-500 text-xs"></i>
                        </a>
                    </div>

                </div>
            </div>
        `;
    }
function getJobDeskDetailHtml(p) {
        // Timeline Generator (Untuk Sub Job Desk)
        const steps = p.subJobDesks || [];
        const timelineHtml = steps.length > 0 ? steps.map((s, index) => `
            <div class="relative pl-8 pb-8 last:pb-0 border-l border-white/10 last:border-transparent">
                <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_10px_rgba(52,211,153,0.5)]"></div>
                
                <div class="bg-white/5 border border-white/5 rounded-xl p-4 hover:bg-white/10 transition group">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-sm font-bold text-white group-hover:text-emerald-300 transition">${s.name}</h4>
                        <span class="text-[10px] px-2 py-0.5 rounded bg-black/30 text-slate-400 border border-white/5">Step ${s.order}</span>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-6 mb-3">
                        <div class="text-xs text-slate-400 flex items-center gap-2">
                            <i class="fa-regular fa-clock text-emerald-500/70"></i> 
                            ${s.date || '-'} <span class="text-[10px] opacity-70">(${s.time || ''})</span>
                        </div>
                        <div class="text-xs text-slate-400 flex items-center gap-2">
                            <i class="fa-regular fa-user text-purple-500/70"></i> 
                            <span>${s.pic || '-'}</span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-300 leading-relaxed text-justify">${s.desc || '-'}</p>
                </div>
            </div>
        `).join('') : `<div class="p-6 text-center text-slate-500 italic text-sm bg-white/5 rounded-xl border border-dashed border-white/10">Belum ada aktivitas.</div>`;

        return `
            <div class="relative w-full h-72 md:h-80 overflow-hidden shrink-0">
                <img src="${p.image || `https://picsum.photos/seed/${p.id}/1200/600`}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/80 to-transparent"></div>
                
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                        <span class="px-3 py-1 rounded-lg bg-emerald-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">
                            ${p.status}
                        </span>
                        <span class="px-3 py-1 rounded-lg bg-white/10 backdrop-blur border border-white/10 text-slate-200 text-[10px] font-bold uppercase tracking-widest">
                            ${p.jdCode || 'NO-CODE'}
                        </span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 backdrop-blur border border-white/10 text-slate-200 text-[10px] font-bold uppercase tracking-widest">
                            ${p.jdType || 'Individu'}
                        </span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-3 drop-shadow-lg max-w-4xl">
                        ${p.jdTitle}
                    </h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300 font-medium">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-briefcase text-emerald-400"></i> ${p.jdPosition}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tag text-amber-400"></i> ${p.jdPic || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 md:gap-12 bg-[#0f172a]">
                
                <div class="lg:col-span-2 space-y-10">
                    
                    <div class="bg-[#1e293b]/50 border border-white/10 p-6 rounded-2xl backdrop-blur-sm">
                        <h3 class="text-emerald-300 font-bold uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-align-left"></i> Deskripsi Tugas
                        </h3>
                        <p class="text-slate-300 text-sm leading-loose text-justify font-light">
                            ${p.jdDesc || 'Belum ada deskripsi.'}
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white/5 border border-white/5 p-6 rounded-2xl">
                            <h4 class="text-slate-400 text-xs uppercase tracking-wider font-bold mb-3">Tujuan</h4>
                            <p class="text-slate-200 text-sm leading-relaxed text-justify">${p.jdGoal || '-'}</p>
                        </div>
                        <div class="bg-white/5 border border-white/5 p-6 rounded-2xl">
                            <h4 class="text-slate-400 text-xs uppercase tracking-wider font-bold mb-3">Output</h4>
                            <p class="text-slate-200 text-sm leading-relaxed text-justify">${p.jdOutput || '-'}</p>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-emerald-300 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                                <i class="fa-solid fa-list-check"></i> Sub Job Desk (Langkah Kerja)
                            </h3>
                            <span class="text-[10px] bg-white/5 px-2 py-1 rounded text-slate-400 border border-white/5">${steps.length} Steps</span>
                        </div>
                        <div class="bg-[#111827]/50 p-6 rounded-2xl border border-white/5 shadow-inner">
                            ${timelineHtml}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-5 rounded-2xl bg-red-500/5 border border-red-500/20">
                            <h4 class="text-red-300 font-bold text-xs mb-2"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Hambatan</h4>
                            <p class="text-slate-400 text-sm text-justify">${p.jdIssues || '-'}</p>
                        </div>
                        <div class="p-5 rounded-2xl bg-emerald-500/5 border border-emerald-500/20">
                            <h4 class="text-emerald-300 font-bold text-xs mb-2"><i class="fa-solid fa-check-circle mr-1"></i> Solusi</h4>
                            <p class="text-slate-400 text-sm text-justify">${p.jdSolutions || '-'}</p>
                        </div>
                        <div class="col-span-1 md:col-span-2 p-5 rounded-2xl bg-blue-500/5 border border-blue-500/20">
                             <h4 class="text-blue-300 font-bold text-xs mb-2">Evaluasi Akhir</h4>
                            <p class="text-slate-400 text-sm text-justify">${p.jdEval || '-'}</p>
                        </div>
                    </div>

                </div>

                <div class="space-y-6">
                    
                    <div class="bg-gradient-to-br from-[#1e293b] to-[#0f172a] border border-white/10 p-6 rounded-2xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-500/10 rounded-full blur-2xl -mr-10 -mt-10"></div>
                        <h3 class="text-white font-bold text-sm mb-4">Indikator KPI</h3>
                        <p class="text-emerald-200 text-sm italic font-medium leading-relaxed">"${p.jdKpi || '-'}"</p>
                    </div>

                    <div class="bg-white/5 border border-white/5 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-white/5 border-b border-white/5 font-bold text-sm text-slate-200">Rincian Teknis</div>
                        <div class="p-4 space-y-4">
                            <div class="flex justify-between items-center border-b border-white/5 pb-2">
                                <span class="text-xs text-slate-500">Kategori</span>
                                <span class="text-xs text-slate-200">${p.jdCategory}</span>
                            </div>
                             <div class="flex justify-between items-center border-b border-white/5 pb-2">
                                <span class="text-xs text-slate-500">Divisi</span>
                                <span class="text-xs text-slate-200">${p.jdDivision}</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-white/5 pb-2">
                                <span class="text-xs text-slate-500">Prioritas</span>
                                <span class="text-xs font-bold text-indigo-300">${p.jdPriority}</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-white/5 pb-2">
                                <span class="text-xs text-slate-500">Kesulitan</span>
                                <span class="text-xs text-slate-200">${p.jdDifficulty}</span>
                            </div>
                             <div class="flex justify-between items-center border-b border-white/5 pb-2">
                                <span class="text-xs text-slate-500">Durasi Est.</span>
                                <span class="text-xs text-slate-200">${p.jdDuration || 0} Menit</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white/5 border border-white/5 rounded-2xl p-4">
                         <h4 class="text-xs text-slate-400 uppercase tracking-wide font-bold mb-3">Target Waktu</h4>
                         <div class="space-y-2">
                            <div class="flex justify-between text-xs text-slate-300">
                                <span>Mulai:</span>
                                <span>${formatDate(p.jdStartDate)} ${p.jdStartTime || ''}</span>
                            </div>
                            <div class="flex justify-between text-xs text-slate-300">
                                <span>Selesai:</span>
                                <span>${formatDate(p.jdEndDate)} ${p.jdEndTime || ''}</span>
                            </div>
                         </div>
                    </div>

                    <div class="bg-white/5 border border-white/5 rounded-2xl p-4 space-y-3">
                         <h4 class="text-xs text-slate-400 uppercase tracking-wide font-bold mb-1">Koordinasi</h4>
                         <div>
                            <span class="text-[10px] text-slate-500 block">Pihak Terlibat</span>
                            <span class="text-xs text-white">${p.jdParties || '-'}</span>
                         </div>
                          <div>
                            <span class="text-[10px] text-slate-500 block">Approver</span>
                            <span class="text-xs text-white">${p.jdApprover || '-'}</span>
                         </div>
                    </div>

                    <div class="space-y-3">
                        <a href="${p.jdDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] hover:bg-emerald-900/20 border border-white/10 rounded-xl transition text-xs text-slate-300 hover:text-emerald-300">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-folder-open"></i> Dokumentasi</span>
                            <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i>
                        </a>
                        <a href="${p.jdTemplateLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] hover:bg-emerald-900/20 border border-white/10 rounded-xl transition text-xs text-slate-300 hover:text-emerald-300">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-file"></i> Template File</span>
                            <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i>
                        </a>
                    </div>

                </div>
            </div>
        `;
    }
  function populateBSCForm(p) {
        // Helper aman
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };

        setVal('bscTitle', p.bscTitle);
        setVal('bscCode', p.bscCode);
        setVal('bscDesc', p.bscDesc);
        setVal('bscLevel', p.bscLevel);
        setVal('bscPerspective', p.bscPerspective);
        setVal('bscOwner', p.bscOwner);
        setVal('bscSponsor', p.bscSponsor);
        
        setVal('bscPeriod', p.bscPeriod);
        setVal('bscStartDate', p.bscStartDate);
        setVal('bscEndDate', p.bscEndDate);
        setVal('bscStartTime', p.bscStartTime);
        setVal('bscEndTime', p.bscEndTime);
        
        setVal('bscStrategicObj', p.bscStrategicObj);
        setVal('bscInitiative', p.bscInitiative);
        setVal('bscKpiName', p.bscKpiName);
        setVal('bscKpiDef', p.bscKpiDef);
        setVal('bscUnit', p.bscUnit);
        setVal('bscBaseline', p.bscBaseline);
        setVal('bscTarget', p.bscTarget);
        setVal('bscRealization', p.bscRealization);
        setVal('bscProgress', p.bscProgress);
        
        setVal('bscStatus', p.status);
        setVal('bscNature', p.bscNature);
        setVal('bscWeight', p.bscWeight);
        setVal('bscRisk', p.bscRisk);
        
        setVal('bscMethod', p.bscMethod);
        setVal('bscTools', p.bscTools);
        setVal('bscDocLink', p.bscDocLink);
        setVal('bscProof', p.bscProof);
        setVal('bscImage', p.image);
        
        setVal('bscNotes', p.bscNotes);
        setVal('bscIssues', p.bscIssues);
        setVal('bscActionPlan', p.bscActionPlan);
        setVal('bscDecision', p.bscDecision);
        setVal('bscEvaluation', p.bscEvaluation);

        // Load Sub Items & Recalculate
        tempSubBSCs = p.subBSCs || [];
        renderSubBSCTable();
        calculateBSCProgress(); // Pastikan angka progress muncul saat edit
    }  
    
    
    function closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); }
    function editCurrentTask() { closeDetailModal(); openFormModal(true, currentDetailId); }
    function duplicateCurrentTask() {
        const p = projects.find(x => x.id === currentDetailId);
        const newP = {...p, id: generateId(), name: p.name + " (Copy)", sopTitle: p.sopTitle ? p.sopTitle + " (Copy)" : undefined, createdAt: new Date().toISOString()};
        projects.push(newP);
        localStorage.setItem('nexusProjectsV3', JSON.stringify(projects));
        renderProjects();
        closeDetailModal();
    }
    function deleteCurrentTask() {
        if(confirm('Hapus?')) {
            projects = projects.filter(p => p.id !== currentDetailId);
            localStorage.setItem('nexusProjectsV3', JSON.stringify(projects));
            renderProjects();
            closeDetailModal();
        }
    }
function getKpiFormHtml() {
        const divisions = ["HR", "Marketing", "Finance", "Operasional", "IT", "Sales", "Legal", "Procurement", "R&D"];
        const divOptions = divisions.map(d => `<option value="${d}">${d}</option>`).join('');
        const positions = ["Staff", "Supervisor", "Manager", "Intern", "Head", "Director"];
        const posOptions = positions.map(p => `<option value="${p}">${p}</option>`).join('');

        return `
 <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="KPI">

            <div class="space-y-4">
                <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Identitas KPI</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1"><label class="block text-xs text-slate-400 mb-1">Judul KPI *</label><input type="text" id="kpiTitle" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode KPI</label><input type="text" id="kpiCode" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Deskripsi</label><textarea id="kpiDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Divisi</label><select id="kpiDivision" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">${divOptions}</select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Posisi</label><select id="kpiPosition" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">${posOptions}</select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kategori</label><select id="kpiCategoryType" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Output">Output</option><option value="Outcome">Outcome</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Jenis</label><select id="kpiType" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Individu">Individu</option><option value="Tim">Tim</option></select></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Pemilik KPI</label><input type="text" id="kpiOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Waktu & Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Periode</label><select id="kpiPeriod" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Bulanan">Bulanan</option><option value="Tahunan">Tahunan</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Mulai</label><input type="date" id="kpiStartDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Selesai</label><input type="date" id="kpiEndDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Status</label><select id="kpiStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="On Track">On Track</option><option value="At Risk">At Risk</option></select></div>
                </div>
            </div>
            
            <div class="space-y-4">
                <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Media</h3>
                <div class="grid grid-cols-2 gap-4">
                     <div><label class="block text-xs text-slate-400 mb-1">Dokumen</label><input type="text" id="kpiDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                     <div><label class="block text-xs text-slate-400 mb-1">Bukti</label><input type="text" id="kpiProof" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                     <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="kpiImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest">
                        D. Rincian Aktivitas (Input Data)
                    </h3>
                    <span class="text-[10px] text-slate-500 italic">*Data ini akan otomatis menghitung Total KPI</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-x-3 gap-y-4 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    
                    <div class="md:col-span-1"><label class="block text-[10px] text-slate-400 mb-1">No</label><input type="number" id="kpiSubOrder" placeholder="1" class="glass-input w-full px-3 py-2 rounded text-xs text-center"></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Nama Aktivitas</label><input type="text" id="kpiSubName" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Tgl</label><input type="date" id="kpiSubDate" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">PIC</label><input type="text" id="kpiSubPic" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Output</label><input type="text" id="kpiSubOutput" class="glass-input w-full px-3 py-2 rounded text-xs"></div>

                    <div class="md:col-span-2"><label class="block text-[10px] text-rose-300/80 mb-1">Satuan</label><input type="text" id="kpiSubUnit" placeholder="%" class="glass-input w-full px-3 py-2 rounded text-xs border-rose-500/30"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-rose-300/80 mb-1">Bobot (%)</label><input type="number" id="kpiSubWeight" placeholder="0" class="glass-input w-full px-3 py-2 rounded text-xs border-rose-500/30"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-rose-300/80 mb-1">Baseline</label><input type="number" id="kpiSubBaseline" placeholder="0" class="glass-input w-full px-3 py-2 rounded text-xs border-rose-500/30"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-rose-400 font-bold mb-1">Target</label><input type="number" id="kpiSubTarget" placeholder="0" class="glass-input w-full px-3 py-2 rounded text-xs font-bold text-white bg-rose-900/20 border-rose-500/50"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-emerald-400 font-bold mb-1">Realisasi</label><input type="number" id="kpiSubRealization" placeholder="0" class="glass-input w-full px-3 py-2 rounded text-xs font-bold text-white bg-emerald-900/20 border-emerald-500/50"></div>

                    <div class="md:col-span-6 bg-white/5 p-2 rounded-lg border border-white/5">
                        <label class="block text-[10px] text-amber-400 mb-1 font-bold">Risiko</label>
                        <select id="kpiSubRisk" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300 border-amber-500/30">
                            <option value="Rendah">Rendah</option><option value="Sedang">Sedang</option><option value="Tinggi">Tinggi</option>
                        </select>
                    </div>
                     <div class="md:col-span-6 bg-white/5 p-2 rounded-lg border border-white/5">
                        <label class="block text-[10px] text-amber-400 mb-1 font-bold">Dampak</label>
                        <select id="kpiSubImpact" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300 border-amber-500/30">
                            <option value="Rendah">Rendah</option><option value="Sedang">Sedang</option><option value="Tinggi">Tinggi</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubKpi()" class="md:col-span-12 bg-rose-600 hover:bg-rose-500 text-white py-3 rounded-lg text-sm font-bold shadow-lg shadow-rose-500/20 mt-2">
                        <i class="fa-solid fa-calculator mr-1"></i> Hitung & Tambahkan Ke Tabel
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[1400px]">
                        <thead class="bg-rose-900/30 text-rose-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">No</th>
                                <th class="p-3 border-b border-white/10">Aktivitas</th>
                                <th class="p-3 bg-white/5 border-b border-white/10 text-center">Satuan</th>
                                <th class="p-3 bg-white/5 border-b border-white/10 text-center">Bobot</th>
                                <th class="p-3 bg-white/5 border-b border-white/10 text-center">Baseline</th>
                                <th class="p-3 bg-rose-500/20 text-white border-b border-rose-500/30 text-center">Target</th>
                                <th class="p-3 bg-emerald-500/20 text-white border-b border-emerald-500/30 text-center">Real</th>
                                <th class="p-3 border-b border-white/10 text-center">Nilai</th>
                                <th class="p-3 border-b border-white/10 text-center">Gap</th>
                                <th class="p-3 border-b border-white/10 text-center text-amber-400">Risiko</th>
                                <th class="p-3 border-b border-white/10 text-center text-amber-400">Dampak</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="kpiSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="kpiSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada rincian.</div>
                </div>
            </div>

            <div class="space-y-4 bg-black/40 p-5 rounded-2xl border border-white/10">
                <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">
                    E. Total KPI (Otomatis Rata-Rata)
                </h3>
                
                <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Rata2 Bobot (%)</label>
                        <input type="text" id="kpiWeight" readonly class="glass-input w-full p-3 rounded-lg text-sm bg-black/50 text-slate-400 cursor-not-allowed">
                    </div>
                    <div>
                         <label class="block text-xs text-slate-400 mb-1">Rata2 Baseline</label>
                        <input type="text" id="kpiBaseline" readonly class="glass-input w-full p-3 rounded-lg text-sm bg-black/50 text-slate-400 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-xs text-rose-300 font-bold mb-1">Rata2 Target</label>
                        <input type="text" id="kpiTarget" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-black/50 text-white cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-xs text-emerald-300 font-bold mb-1">Rata2 Realisasi</label>
                        <input type="text" id="kpiRealization" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-black/50 text-white cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-xs text-blue-400 mb-1">Total Nilai (%)</label>
                        <input type="text" id="kpiValue" readonly class="glass-input w-full p-3 rounded-lg text-sm text-blue-400 font-bold bg-black/50 cursor-not-allowed">
                    </div>
                     <div>
                        <label class="block text-xs text-red-400 mb-1">Rata2 Gap (%)</label>
                        <input type="text" id="kpiGap" readonly class="glass-input w-full p-3 rounded-lg text-sm text-red-400 font-bold bg-black/50 cursor-not-allowed">
                    </div>
                     <div class="col-span-2 md:col-span-3">
                        <label class="block text-xs text-amber-400 mb-1">Skor Akhir</label>
                        <input type="text" id="kpiScore" readonly class="glass-input w-full p-3 rounded-lg text-sm text-amber-400 font-bold bg-black/50 cursor-not-allowed text-center text-lg">
                    </div>
                    <div>
                        <label class="block text-xs text-amber-400 mb-1 font-bold">Total Resiko (Max)</label>
                        <input type="text" id="kpiRisk" readonly class="glass-input w-full p-3 rounded-lg text-sm text-amber-300 font-bold bg-black/50 cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-xs text-amber-400 mb-1 font-bold">Total Dampak (Max)</label>
                        <input type="text" id="kpiImpact" readonly class="glass-input w-full p-3 rounded-lg text-sm text-amber-300 font-bold bg-black/50 cursor-not-allowed">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-xs text-slate-400 mb-1">Hambatan</label><textarea id="kpiIssues" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Rencana Perbaikan</label><textarea id="kpiActionPlan" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Keputusan</label><select id="kpiDecision" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Lanjut">Lanjut</option><option value="Revisi">Revisi</option></select></div>
                </div>
            </div>
        </form>
        `;
    }    // 1. Kalkulator Otomatis
    // --- LOGIKA KHUSUS KPI (REVISI) ---

    // --- FUNGSI HITUNG RATA-RATA GLOBAL KPI ---
    // --- FUNGSI HITUNG RATA-RATA GLOBAL KPI (FIX NaN) ---
    // --- FUNGSI HITUNG RATA-RATA GLOBAL KPI (FIXED: Added levels definition) ---
    function recalculateKpiAverages() {
        // 1. DEFINISI LEVEL (Ini yang sebelumnya hilang)
        const levels = { 'Rendah': 1, 'Sedang': 2, 'Tinggi': 3 };
        const levelNames = { 1: 'Rendah', 2: 'Sedang', 3: 'Tinggi' };

        // 2. Cek Data Kosong
        if (typeof tempSubKpis === 'undefined' || tempSubKpis.length === 0) {
            ['kpiWeight', 'kpiBaseline', 'kpiTarget', 'kpiRealization', 'kpiValue', 'kpiGap'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '0';
            });
            const scoreEl = document.getElementById('kpiScore');
            if(scoreEl) scoreEl.value = '-';
            
            // Reset Risk/Impact display
            const elRisk = document.getElementById('kpiRisk'); if(elRisk) elRisk.value = '-';
            const elImpact = document.getElementById('kpiImpact'); if(elImpact) elImpact.value = '-';
            return;
        }

        let totalWeight = 0;
        let totalBaseline = 0;
        let totalTarget = 0;
        let totalReal = 0;
        let totalValue = 0;
        let totalGap = 0;
        
        // Variabel untuk mencari nilai max
        let maxRiskVal = 0;
        let maxImpactVal = 0;

        // 3. Loop Kalkulasi
        tempSubKpis.forEach(s => {
            totalWeight += (parseFloat(s.weight) || 0);
            totalBaseline += (parseFloat(s.baseline) || 0);
            totalTarget += (parseFloat(s.target) || 0);
            totalReal += (parseFloat(s.realization) || 0);
            totalValue += (parseFloat(s.value) || 0);
            totalGap += (parseFloat(s.gap) || 0);

            // Cek Risiko Tertinggi (Sekarang variabel 'levels' sudah ada)
            // Menggunakan fallback 'Rendah' (1) jika s.risk undefined
            const currentRiskStr = s.risk || 'Rendah';
            const rVal = levels[currentRiskStr] || 1; 
            if (rVal > maxRiskVal) maxRiskVal = rVal;

            // Cek Dampak Tertinggi
            const currentImpactStr = s.impact || 'Rendah';
            const iVal = levels[currentImpactStr] || 1;
            if (iVal > maxImpactVal) maxImpactVal = iVal;
        });

        const count = tempSubKpis.length;

        // 4. Hitung Rata-rata
        const avgWeight = count > 0 ? (totalWeight / count).toFixed(1) : 0;
        const avgBaseline = count > 0 ? (totalBaseline / count).toFixed(1) : 0;
        const avgTarget = count > 0 ? (totalTarget / count).toFixed(1) : 0;
        const avgReal = count > 0 ? (totalReal / count).toFixed(1) : 0;
        const avgValue = count > 0 ? (totalValue / count).toFixed(1) : 0;
        const avgGap = count > 0 ? (totalGap / count).toFixed(1) : 0;

        // 5. Hitung Skor Global
        let avgScore = 'D';
        if (avgValue >= 100) avgScore = 'A';
        else if (avgValue >= 85) avgScore = 'B';
        else if (avgValue >= 70) avgScore = 'C';

        // 6. Update UI
        const elWeight = document.getElementById('kpiWeight'); if(elWeight) elWeight.value = avgWeight;
        const elBase = document.getElementById('kpiBaseline'); if(elBase) elBase.value = avgBaseline;
        const elTarget = document.getElementById('kpiTarget'); if(elTarget) elTarget.value = avgTarget;
        const elReal = document.getElementById('kpiRealization'); if(elReal) elReal.value = avgReal;
        const elValue = document.getElementById('kpiValue'); if(elValue) elValue.value = avgValue + '%';
        
        const gapSign = avgGap > 0 ? '+' : '';
        const elGap = document.getElementById('kpiGap'); if(elGap) elGap.value = gapSign + avgGap + '%';
        
        const elScore = document.getElementById('kpiScore'); if(elScore) elScore.value = avgScore;
        
        // Update Risiko & Dampak (Mengambil teks dari 'levelNames')
        const elRisk = document.getElementById('kpiRisk'); 
        if(elRisk) elRisk.value = maxRiskVal > 0 ? levelNames[maxRiskVal] : 'Rendah';
        
        const elImpact = document.getElementById('kpiImpact'); 
        if(elImpact) elImpact.value = maxImpactVal > 0 ? levelNames[maxImpactVal] : 'Rendah';
    }     // 2. Sub KPI Logic (Aktivitas)
    // --- LOGIKA KHUSUS KPI (REVISI HORIZONTAL TABLE) ---

   
    // 2. Sub KPI Logic
function addSubKpi() {
        // --- 1. AMBIL ELEMEN INPUT DENGAN ID YANG BENAR ---
        // Kita gunakan getElementById untuk memastikan ID-nya sesuai dengan HTML revisi
        const elName = document.getElementById('kpiSubName');
        const elOrder = document.getElementById('kpiSubOrder');
        
        // Input Angka & Hitungan
        const elUnit = document.getElementById('kpiSubUnit');
        const elWeight = document.getElementById('kpiSubWeight');
        const elBaseline = document.getElementById('kpiSubBaseline');
        const elTarget = document.getElementById('kpiSubTarget');
        const elReal = document.getElementById('kpiSubRealization');
        
        // Input Tambahan
        const elDate = document.getElementById('kpiSubDate');
        const elPic = document.getElementById('kpiSubPic');
        const elOutput = document.getElementById('kpiSubOutput');
        const risk = document.getElementById('kpiSubRisk').value || 'Rendah';
        const impact = document.getElementById('kpiSubImpact').value || 'Rendah';

        // --- 2. VALIDASI DASAR ---
        // Pastikan elemen ditemukan dulu sebelum ambil .value agar tidak error
        if (!elName || !elOrder) {
            console.error("Elemen Input HTML tidak ditemukan! Pastikan kode HTML sudah direvisi.");
            return;
        }

        const name = elName.value;
        const order = elOrder.value;

        if(!name || !order) return alert("Nama Aktivitas dan Urutan wajib diisi!");

        // --- 3. AMBIL NILAI (DENGAN FALLBACK AGAR TIDAK UNDEFINED) ---
        // Jika input kosong atau elemen tidak ada, isi dengan '-' atau '0'
        const unit = elUnit ? (elUnit.value || '-') : '-';
        const weight = elWeight ? (elWeight.value || '0') : '0';
        const baseline = elBaseline ? (elBaseline.value || '0') : '0';
        const date = elDate ? (elDate.value || '-') : '-';
        const pic = elPic ? (elPic.value || '-') : '-';
        const output = elOutput ? (elOutput.value || '-') : '-';

        // Parsing angka untuk kalkulasi (Target & Realisasi)
        const targetVal = elTarget ? (parseFloat(elTarget.value) || 0) : 0;
        const realVal = elReal ? (parseFloat(elReal.value) || 0) : 0;

        // --- 4. HITUNG RUMUS OTOMATIS ---
        // Nilai (%) = (Realisasi / Target) * 100
        let nilaiPercent = targetVal !== 0 ? ((realVal / targetVal) * 100).toFixed(1) : 0;
        
        // Gap (%) = ((Realisasi - Target) / Target) * 100
        let gapPercent = targetVal !== 0 ? (((realVal - targetVal) / targetVal) * 100).toFixed(1) : 0;

        // Skor (Logika Sederhana)
        let skor = 'D';
        if (nilaiPercent >= 100) skor = 'A';
        else if (nilaiPercent >= 85) skor = 'B';
        else if (nilaiPercent >= 70) skor = 'C';

        // --- 5. BUAT OBJECT DATA ---
        const newSub = {
            id: generateId(),
            name: name,
            order: order,
            date: date,
            pic: pic,
            output: output,
            // Simpan data perhitungan
            unit: unit,
            weight: weight,
            baseline: baseline,
            target: targetVal,
            realization: realVal,
            value: nilaiPercent,
            gap: gapPercent,
            score: skor,
            risk: risk,      // Simpan
            impact: impact   // Simpan
        };

        // Debugging di Console (Tekan F12 untuk cek jika masih error)
        console.log("Data Sub KPI Baru:", newSub);

        // --- 6. SIMPAN & RENDER ---
        tempSubKpis.push(newSub);
        tempSubKpis.sort((a,b) => a.order - b.order);
        renderSubKpiTable();
        renderSubKpiTable();      // Gambar Tabel
        recalculateKpiAverages(); // HITUNG RATA-RATA GLOBAL
        
        // --- 7. RESET INPUT (KOSONGKAN FORM) ---
        elName.value = '';
        if(elOutput) elOutput.value = '';
        if(elTarget) elTarget.value = '';
        if(elReal) elReal.value = '';
        // Increment nomor urut
        elOrder.value = parseInt(order) + 1;
    }
    
   function removeSubKpi(id) {
        tempSubKpis = tempSubKpis.filter(s => s.id !== id);
        renderSubKpiTable();
        recalculateKpiAverages(); // Hitung ulang setelah hapus
    }
function renderSubKpiTable() {
        const tbody = document.getElementById('kpiSubListBody');
        const emptyDiv = document.getElementById('kpiSubEmpty');
        
        if(!tbody) return;

        tbody.innerHTML = '';
        
        if(tempSubKpis.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            
            tempSubKpis.forEach(s => {
                const gapColor = parseFloat(s.gap) >= 0 ? 'text-emerald-400' : 'text-red-400';
                
                // Warna Risiko
                const riskColor = s.risk === 'Tinggi' ? 'text-red-400' : (s.risk === 'Sedang' ? 'text-amber-400' : 'text-emerald-400');
                
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition-colors group';
                tr.innerHTML = `
                    <td class="p-3 border-b border-white/10 text-center text-slate-400">${s.order}</td>
                    <td class="p-3 border-b border-white/10 font-medium text-white whitespace-nowrap">${s.name}</td>
                    
                    <td class="p-3 bg-white/5 border-b border-white/10 text-center whitespace-nowrap text-xs">${s.unit}</td>
                    <td class="p-3 bg-white/5 border-b border-white/10 text-center whitespace-nowrap text-xs">${s.weight}%</td>
                    <td class="p-3 bg-white/5 border-b border-white/10 text-center whitespace-nowrap text-xs">${s.baseline}</td>
                    
                    <td class="p-3 bg-rose-500/10 border-b border-white/10 text-white font-bold text-center whitespace-nowrap text-xs">${s.target}</td>
                    <td class="p-3 bg-emerald-500/10 border-b border-white/10 text-white font-bold text-center whitespace-nowrap text-xs">${s.realization}</td>
                    
                    <td class="p-3 border-b border-white/10 text-center font-bold text-xs">${s.value}%</td>
                    <td class="p-3 border-b border-white/10 text-center font-bold ${gapColor} text-xs">${s.gap}%</td>
                    
                    <td class="p-3 border-b border-white/10 text-center font-bold ${riskColor} text-xs">${s.risk}</td>
                    <td class="p-3 border-b border-white/10 text-center text-xs text-slate-400">${s.impact}</td>

                    <td class="p-3 text-right sticky right-0 bg-[#1e2336] border-b border-white/10">
                        <button onclick="removeSubKpi('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto">
                            <i class="fa-solid fa-trash text-[10px]"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }   
    // --- POPULATE FORM (EDIT) ---
   function populateKpiForm(p) {
        // Helper Aman: Cek dulu elemennya ada atau tidak sebelum diisi
        const setVal = (id, val) => {
            const el = document.getElementById(id);
            if(el) {
                // Jika value null/undefined, isi string kosong agar tidak error
                el.value = (val !== undefined && val !== null) ? val : '';
            }
        };

        // A. Identitas
        setVal('kpiTitle', p.kpiTitle);
        setVal('kpiCode', p.kpiCode);
        setVal('kpiDesc', p.kpiDesc);
        setVal('kpiDivision', p.kpiDivision);
        setVal('kpiPosition', p.kpiPosition);
        setVal('kpiCategoryType', p.kpiCategoryType);
        setVal('kpiType', p.kpiType);
        setVal('kpiOwner', p.kpiOwner);
        
        
        // B. Waktu & Status
        setVal('kpiPeriod', p.kpiPeriod);
        setVal('kpiStartDate', p.kpiStartDate);
        setVal('kpiEndDate', p.kpiEndDate);
        // Note: kpiStartTime & kpiEndTime mungkin sudah dihapus di form terbaru, tapi tetap aman pakai setVal
        setVal('kpiStartTime', p.kpiStartTime); 
        setVal('kpiEndTime', p.kpiEndTime);
        setVal('kpiStatus', p.status); // Menggunakan p.status (shared field)

        // C. Media
        // Note: ID di form baru mungkin hanya 'kpiDocLink' dan 'kpiProof', 
        // tapi kita masukkan semua variasi nama lama/baru biar aman.
        setVal('kpiMethod', p.kpiMethod); 
        setVal('kpiTools', p.kpiTools);
        setVal('kpiDocLink', p.kpiDocLink);
        setVal('kpiProof', p.kpiProof);
        setVal('kpiImage', p.image); // Shared field image
        
        // E. Hasil Kalkulasi (Total KPI - Readonly)
        setVal('kpiWeight', p.kpiWeight);
        setVal('kpiBaseline', p.kpiBaseline);
        setVal('kpiTarget', p.kpiTarget);
        setVal('kpiRealization', p.kpiRealization);
        setVal('kpiValue', p.kpiValue);
        setVal('kpiGap', p.kpiGap);
        setVal('kpiScore', p.kpiScore);
        
        // F. Evaluasi
        setVal('kpiNotes', p.kpiNotes); // Jika ada
        setVal('kpiIssues', p.kpiIssues);
        setVal('kpiActionPlan', p.kpiActionPlan);
        setVal('kpiEvaluation', p.kpiEvaluation);
        setVal('kpiDecision', p.kpiDecision);
        setVal('kpiRisk', p.kpiRisk);
        setVal('kpiImpact', p.kpiImpact);
        // Load Tabel Rincian Aktivitas
        tempSubKpis = p.subKpis || [];
        
        // Render ulang tabel dan hitung rata-rata ulang untuk memastikan data sinkron
        renderSubKpiTable();
        if(typeof recalculateKpiAverages === 'function') {
            recalculateKpiAverages();
        }
    } 
    // --- CARD KPI (ROSE THEME) ---
    // --- FUNCTION KHUSUS MEMBUAT KARTU KPI (REVISI: ADA TOMBOL & DESKRIPSI) ---
    function createKpiCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        
        div.onclick = () => openDetail(p.id);

        const img = p.image || `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const ownerInitial = p.kpiOwner ? p.kpiOwner.charAt(0).toUpperCase() : '?';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>

                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105" title="Duplikat"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105" title="Hapus"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-rose-600 shadow-lg tracking-wider border border-white/10 shadow-rose-500/20">KPI</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-rose-300 transition-colors tracking-tight">${p.kpiTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.kpiDesc || 'Tidak ada deskripsi detail untuk KPI ini.'}
                </p>
                
                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-xs text-white border border-white/10 shadow-inner">
                            ${ownerInitial}
                        </div>
                        
                        <div class="flex flex-col -mt-1">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Owner</span>
                            <span class="text-xs text-slate-200 truncate w-24 font-medium leading-none">${p.kpiOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-rose-200 bg-rose-500/10 px-3 py-1.5 rounded-lg border border-rose-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1">
                        <i class="fa-solid fa-calendar-check text-[9px]"></i> ${p.kpiPeriod || '-'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- DETAIL VIEW KPI ---
    // --- 2. FUNGSI HTML DETAIL KHUSUS KPI (REVISI FINAL SESUAI FORM) ---
    function getKpiDetailHtml(p) {
        // 1. Helper Format Tanggal
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';

        // 2. Render Baris Sub-KPI (Rincian Aktivitas)
        const subKpiRows = (p.subKpis || []).map((s, i) => {
            // Warna Indikator
            const gapColor = parseFloat(s.gap) >= 0 ? 'text-emerald-400' : 'text-red-400';
            const scoreColor = s.score === 'A' ? 'text-emerald-400' : (s.score === 'B' ? 'text-blue-400' : 'text-rose-400');
            
            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition group">
                <td class="p-3 text-center text-slate-400 font-bold bg-black/10">${s.order}</td>
                <td class="p-3 text-white font-medium whitespace-nowrap">${s.name}</td>
                <td class="p-3 text-slate-400 text-xs whitespace-nowrap">${formatDate(s.date)}</td>
                <td class="p-3 text-xs whitespace-nowrap">${s.pic || '-'}</td>
                <td class="p-3 text-xs italic text-slate-500 whitespace-nowrap max-w-[150px] truncate" title="${s.output}">${s.output || '-'}</td>
                
                <td class="p-3 text-center text-xs bg-white/5 whitespace-nowrap">${s.unit || '-'}</td>
                <td class="p-3 text-center text-xs bg-white/5 whitespace-nowrap">${s.weight || 0}%</td>
                <td class="p-3 text-center text-xs bg-white/5 whitespace-nowrap">${s.baseline || 0}</td>
                
                <td class="p-3 text-center font-bold text-white bg-rose-500/10 border-l border-white/5 whitespace-nowrap">${s.target || 0}</td>
                <td class="p-3 text-center font-bold text-white bg-emerald-500/10 border-l border-white/5 whitespace-nowrap">${s.realization || 0}</td>
                
                <td class="p-3 text-center font-bold text-xs border-l border-white/5 whitespace-nowrap">${s.value}%</td>
                <td class="p-3 text-center font-bold text-xs ${gapColor} whitespace-nowrap">${s.gap > 0 ? '+' : ''}${s.gap}%</td>
                <td class="p-3 text-center font-bold ${scoreColor} whitespace-nowrap text-sm">${s.score}</td>
            </tr>
            `;
        }).join('');

        // 3. Tentukan Warna Header Utama
        const mainGap = parseFloat(p.kpiGap) || 0;
        const mainGapColor = mainGap >= 0 ? 'text-emerald-400' : 'text-red-400';
        const mainScoreColor = p.kpiScore === 'A' ? 'text-emerald-400' : (p.kpiScore === 'B' ? 'text-blue-400' : 'text-rose-400');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${p.image || `https://picsum.photos/seed/${p.id}/1200/600`}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-rose-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg shadow-rose-500/20">${p.status || 'Draft'}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-rose-200 text-[10px] uppercase tracking-widest border border-rose-500/30">KPI</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.kpiPeriod || '-'}</span>
                    </div>
                    
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.kpiTitle || 'Tanpa Judul'}</h1>
                    
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-barcode text-rose-500"></i> ${p.kpiCode || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-rose-500"></i> ${p.kpiOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-building text-rose-500"></i> ${p.kpiDivision || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                
                <div class="lg:col-span-2 space-y-8">
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-crosshairs text-4xl text-white"></i></div>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold block mb-1">Target Total</span>
                            <span class="text-2xl font-bold text-white">${p.kpiTarget || 0}</span>
                            <span class="text-[10px] text-rose-400 ml-1">${p.kpiUnit || ''}</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-chart-line text-4xl text-emerald-400"></i></div>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold block mb-1">Realisasi</span>
                            <span class="text-2xl font-bold text-emerald-300">${p.kpiRealization || 0}</span>
                        </div>
                         <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                             <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-percent text-4xl text-blue-400"></i></div>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold block mb-1">Capaian</span>
                            <span class="text-2xl font-bold text-blue-300">${p.kpiValue || 0}</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                             <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-star text-4xl text-amber-400"></i></div>
                            <span class="text-[10px] text-slate-500 uppercase tracking-wider font-bold block mb-1">Skor Akhir</span>
                            <span class="text-3xl font-bold ${mainScoreColor}">${p.kpiScore || '-'}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-align-left"></i> Deskripsi KPI
                        </h3>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.kpiDesc || 'Tidak ada deskripsi detail.'}</p>
                    </div>

                    <div>
                        <div class="flex justify-between items-end mb-4">
                            <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest flex items-center gap-2">
                                <i class="fa-solid fa-list-check"></i> Rincian Aktivitas
                            </h3>
                            <span class="text-[10px] text-slate-500 italic">Scroll ke samping untuk detail lengkap</span>
                        </div>
                        
                        <div class="overflow-x-auto rounded-xl border border-white/10 pb-2 custom-scrollbar bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[1200px]">
                                <thead class="bg-rose-900/20 text-rose-200 uppercase tracking-wider font-bold text-[10px]">
                                    <tr>
                                        <th class="p-3">No</th>
                                        <th class="p-3">Aktivitas</th>
                                        <th class="p-3">Tgl</th>
                                        <th class="p-3">PIC</th>
                                        <th class="p-3">Output</th>
                                        <th class="p-3 text-center bg-white/5">Satuan</th>
                                        <th class="p-3 text-center bg-white/5">Bobot</th>
                                        <th class="p-3 text-center bg-white/5">Base</th>
                                        <th class="p-3 text-center bg-rose-500/10">Target</th>
                                        <th class="p-3 text-center bg-emerald-500/10">Real</th>
                                        <th class="p-3 text-center">Nilai</th>
                                        <th class="p-3 text-center">Gap</th>
                                        <th class="p-3 text-center">Skor</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/5">
                                    ${subKpiRows || '<tr><td colspan="13" class="p-8 text-center italic text-slate-500 text-xs">Belum ada rincian aktivitas.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-5 rounded-2xl bg-rose-500/5 border border-rose-500/10">
                            <h4 class="text-rose-300 font-bold text-xs mb-2 uppercase tracking-wide">Hambatan / Isu</h4>
                            <p class="text-slate-400 text-sm leading-relaxed">${p.kpiIssues || '-'}</p>
                        </div>
                        <div class="p-5 rounded-2xl bg-indigo-500/5 border border-indigo-500/10">
                            <h4 class="text-indigo-300 font-bold text-xs mb-2 uppercase tracking-wide">Rencana Perbaikan</h4>
                            <p class="text-slate-400 text-sm leading-relaxed">${p.kpiActionPlan || '-'}</p>
                        </div>
                        <div class="col-span-1 md:col-span-2 p-5 rounded-2xl bg-blue-500/5 border border-blue-500/10 flex flex-col md:flex-row gap-4 items-start">
                             <div class="flex-1">
                                <h4 class="text-blue-300 font-bold text-xs mb-2 uppercase tracking-wide">Evaluasi Akhir</h4>
                                <p class="text-slate-400 text-sm leading-relaxed">${p.kpiEvaluation || '-'}</p>
                             </div>
                             <div class="shrink-0">
                                <span class="block text-[10px] text-slate-500 uppercase mb-1">Keputusan</span>
                                <span class="px-3 py-1.5 rounded-lg bg-blue-500/20 text-blue-300 text-xs font-bold border border-blue-500/30">${p.kpiDecision || '-'}</span>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi KPI</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Posisi</span><span class="text-slate-200 text-right">${p.kpiPosition || '-'}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Kategori</span><span class="text-slate-200 text-right">${p.kpiCategoryType || '-'}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Jenis</span><span class="text-slate-200 text-right">${p.kpiType || '-'}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Risiko</span><span class="text-rose-400 font-bold text-right">${p.kpiRisk || '-'}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Dampak</span><span class="text-slate-200 text-right">${p.kpiImpact || '-'}</span></li>
                            
                            <li class="flex justify-between text-xs pt-2 border-t border-white/5">
                                <span class="text-slate-500">Bobot KPI</span>
                                <span class="text-slate-200 font-bold">${p.kpiWeight || 0}%</span>
                            </li>
                            <li class="flex justify-between text-xs">
                                <span class="text-slate-500">Baseline Awal</span>
                                <span class="text-slate-200 font-bold">${p.kpiBaseline || 0}</span>
                            </li>
                            
                            <li class="flex justify-between text-xs pt-2 border-t border-white/5">
                                <span class="text-slate-500">Gap Target</span>
                                <span class="font-bold ${mainGapColor}">${p.kpiGap || '0%'}</span>
                            </li>
                        </ul>
                    </div>

                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Waktu Monitoring</h3>
                         <ul class="space-y-4">
                            <li class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">Mulai</span>
                                <div class="text-right">
                                    <div class="text-slate-200">${formatDate(p.kpiStartDate)}</div>
                                    <div class="text-[10px] text-slate-500">${p.kpiStartTime || ''}</div>
                                </div>
                            </li>
                            <li class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">Akhir</span>
                                <div class="text-right">
                                    <div class="text-slate-200">${formatDate(p.kpiEndDate)}</div>
                                    <div class="text-[10px] text-slate-500">${p.kpiEndTime || ''}</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="space-y-3">
                         <a href="${p.kpiDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-rose-500/50 hover:bg-rose-500/10 transition text-xs text-rose-300 group">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-file group-hover:scale-110 transition"></i> Dokumentasi</span>
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                         <a href="${p.kpiProof || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-rose-500/50 hover:bg-rose-500/10 transition text-xs text-rose-300 group">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-paperclip group-hover:scale-110 transition"></i> Bukti Pendukung</span>
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-rose-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
    
function getSWOTFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="SWOT">

            <div class="space-y-4">
                <h3 class="text-orange-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Konteks Analisis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Objek Analisis (Produk/Divisi) *</label>
                        <input type="text" id="swotObject" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Peluncuran Produk Baru 2026">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Dokumen</label><input type="text" id="swotCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="SWOT-2026-001"></div>
                    
                    <div><label class="block text-xs text-orange-300 mb-1">Pembuat (Analyst)</label><input type="text" id="swotCreator" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Analisis</label><input type="date" id="swotDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="swotStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Final">Final</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Versi</label><input type="text" id="swotVersion" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="v1.0"></div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Tujuan Analisis</label><textarea id="swotGoal" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Apa yang ingin dicapai dari analisis ini?"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-orange-400 font-bold uppercase text-xs tracking-widest">B. Poin Analisis (Matrix)</h3>
                    <span class="text-[10px] text-slate-500 italic">Input S, W, O, atau T</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-orange-300 mb-1">Tipe (Kuadran)</label>
                        <select id="swotSubType" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Strength">Strength (S)</option>
                            <option value="Weakness">Weakness (W)</option>
                            <option value="Opportunity">Opportunity (O)</option>
                            <option value="Threat">Threat (T)</option>
                        </select>
                    </div>
                    <div class="md:col-span-8"><label class="block text-[10px] text-slate-400 mb-1">Deskripsi Poin</label><input type="text" id="swotSubDesc" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Poin analisis..."></div>
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Bobot Dampak</label>
                        <select id="swotSubWeight" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-[10px] text-slate-400 mb-1">Strategi Respon</label>
                        <input type="text" id="swotSubStrategy" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Bagaimana memanfaatkan/mengatasi poin ini?">
                    </div>

                    <button type="button" onclick="addSubSwot()" class="md:col-span-12 bg-orange-600 hover:bg-orange-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-orange-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Poin
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-orange-900/30 text-orange-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 text-center">Tipe</th>
                                <th class="p-3 border-b border-white/10">Deskripsi</th>
                                <th class="p-3 border-b border-white/10 text-center">Dampak</th>
                                <th class="p-3 border-b border-white/10">Strategi Respon</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="swotSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="swotSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada poin analisis.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-orange-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi Tambahan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen Referensi</label><input type="text" id="swotDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="swotImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Kesimpulan Utama (Executive Summary)</label><textarea id="swotSummary" rows="3" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
// --- LOGIKA SWOT ANALYSIS ---
    
    function addSubSwot() {
        const desc = document.getElementById('swotSubDesc').value;
        const type = document.getElementById('swotSubType').value;
        
        if(!desc) return alert("Deskripsi Poin wajib diisi!");

        const newSub = {
            id: generateId(),
            type: type,
            desc: desc,
            weight: document.getElementById('swotSubWeight').value,
            strategy: document.getElementById('swotSubStrategy').value || '-'
        };

        tempSubSwots.push(newSub);
        renderSubSwotTable();
        
        // Reset Inputs
        document.getElementById('swotSubDesc').value = '';
        document.getElementById('swotSubStrategy').value = '';
    }
function createSWOTCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.swotImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Hitung Summary
        const sCount = (p.subSwots || []).filter(x => x.type === 'Strength').length;
        const wCount = (p.subSwots || []).filter(x => x.type === 'Weakness').length;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-orange-400 shadow-lg tracking-wider border border-orange-300 shadow-orange-500/20">SWOT</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-orange-400 font-bold uppercase tracking-wider border border-orange-500/30 px-2 py-0.5 rounded bg-orange-500/10">
                        ${p.swotVersion || 'v1.0'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-orange-300 transition-colors tracking-tight">${p.swotObject}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.swotGoal || 'Tidak ada tujuan analisis.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.swotCreator ? p.swotCreator.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Analyst</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.swotCreator || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-orange-200 bg-orange-500/10 px-3 py-1.5 rounded-lg border border-orange-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        S: ${sCount} | W: ${wCount}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function removeSubSwot(id) {
        tempSubSwots = tempSubSwots.filter(s => s.id !== id);
        renderSubSwotTable();
    }

    function renderSubSwotTable() {
        const tbody = document.getElementById('swotSubListBody');
        const emptyDiv = document.getElementById('swotSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubSwots.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubSwots.forEach(s => {
                // Warna Badge Tipe
                let badgeClass = 'bg-slate-700 text-slate-300';
                if(s.type === 'Strength') badgeClass = 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30';
                else if(s.type === 'Weakness') badgeClass = 'bg-orange-500/20 text-orange-300 border border-orange-500/30';
                else if(s.type === 'Opportunity') badgeClass = 'bg-blue-500/20 text-blue-300 border border-blue-500/30';
                else if(s.type === 'Threat') badgeClass = 'bg-red-500/20 text-red-300 border border-red-500/30';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-center"><span class="text-[10px] font-bold px-2 py-1 rounded uppercase ${badgeClass}">${s.type.substring(0,1)}</span></td>
                    <td class="p-3 text-white font-medium text-xs">${s.desc}</td>
                    <td class="p-3 text-center text-xs font-bold text-slate-400">${s.weight}</td>
                    <td class="p-3 text-xs text-orange-200/80 italic">${s.strategy}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubSwot('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateSWOTForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('swotObject', p.swotObject); setVal('swotCode', p.swotCode); 
        setVal('swotCreator', p.swotCreator); setVal('swotDate', p.swotDate); 
        setVal('swotStatus', p.status); setVal('swotVersion', p.swotVersion);
        setVal('swotGoal', p.swotGoal); setVal('swotSummary', p.swotSummary);
        setVal('swotDocLink', p.swotDocLink); setVal('swotImage', p.image);

        tempSubSwots = p.subSwots || [];
        renderSubSwotTable();
    }

   function getSWOTDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.swotImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        // Pisahkan Data per Kuadran
        const sList = (p.subSwots || []).filter(x => x.type === 'Strength');
        const wList = (p.subSwots || []).filter(x => x.type === 'Weakness');
        const oList = (p.subSwots || []).filter(x => x.type === 'Opportunity');
        const tList = (p.subSwots || []).filter(x => x.type === 'Threat');

        // Helper render list
        const renderList = (list, color) => {
            if(list.length === 0) return `<div class="text-slate-500 text-xs italic">Tidak ada poin.</div>`;
            return list.map(item => `
                <div class="mb-3 pb-3 border-b border-white/5 last:border-0 last:mb-0 last:pb-0">
                    <div class="flex justify-between items-start">
                        <p class="text-slate-200 text-sm font-medium leading-snug">${item.desc}</p>
                        <span class="text-[9px] ${color} border border-current px-1.5 py-0.5 rounded opacity-70">${item.weight}</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1 italic">Strat: ${item.strategy}</p>
                </div>
            `).join('');
        };

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-orange-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-orange-200 text-[10px] uppercase tracking-widest border border-orange-500/30">SWOT</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.swotCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.swotObject}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-pen text-orange-500"></i> Analyst: ${p.swotCreator || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-orange-500"></i> Tgl: ${formatDate(p.swotDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-1 gap-8 bg-[#0f172a]">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-orange-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> Tujuan Analisis</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.swotGoal || '-'}</p>
                    </div>
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-white font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-file-lines"></i> Executive Summary</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.swotSummary || '-'}</p>
                    </div>
                </div>

                <h3 class="text-orange-400 font-bold uppercase text-xs tracking-widest mt-4 mb-2 flex items-center gap-2"><i class="fa-solid fa-table-cells-large"></i> SWOT Matrix</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <div class="bg-emerald-900/10 border border-emerald-500/20 p-5 rounded-2xl relative overflow-hidden group hover:bg-emerald-900/20 transition">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-emerald-500/20">
                            <h4 class="text-emerald-400 font-bold uppercase tracking-widest text-sm"><i class="fa-solid fa-arrow-trend-up mr-2"></i> Strengths</h4>
                            <span class="bg-emerald-500 text-black text-[10px] font-bold px-2 py-0.5 rounded-full">${sList.length}</span>
                        </div>
                        <div class="max-h-60 overflow-y-auto custom-scrollbar pr-2">
                            ${renderList(sList, 'text-emerald-400 border-emerald-500/30')}
                        </div>
                    </div>

                    <div class="bg-orange-900/10 border border-orange-500/20 p-5 rounded-2xl relative overflow-hidden group hover:bg-orange-900/20 transition">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-orange-500/20">
                            <h4 class="text-orange-400 font-bold uppercase tracking-widest text-sm"><i class="fa-solid fa-arrow-trend-down mr-2"></i> Weaknesses</h4>
                            <span class="bg-orange-500 text-black text-[10px] font-bold px-2 py-0.5 rounded-full">${wList.length}</span>
                        </div>
                        <div class="max-h-60 overflow-y-auto custom-scrollbar pr-2">
                            ${renderList(wList, 'text-orange-400 border-orange-500/30')}
                        </div>
                    </div>

                    <div class="bg-blue-900/10 border border-blue-500/20 p-5 rounded-2xl relative overflow-hidden group hover:bg-blue-900/20 transition">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-blue-500/20">
                            <h4 class="text-blue-400 font-bold uppercase tracking-widest text-sm"><i class="fa-solid fa-lightbulb mr-2"></i> Opportunities</h4>
                            <span class="bg-blue-500 text-black text-[10px] font-bold px-2 py-0.5 rounded-full">${oList.length}</span>
                        </div>
                        <div class="max-h-60 overflow-y-auto custom-scrollbar pr-2">
                            ${renderList(oList, 'text-blue-400 border-blue-500/30')}
                        </div>
                    </div>

                    <div class="bg-red-900/10 border border-red-500/20 p-5 rounded-2xl relative overflow-hidden group hover:bg-red-900/20 transition">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-red-500/20">
                            <h4 class="text-red-400 font-bold uppercase tracking-widest text-sm"><i class="fa-solid fa-shield-halved mr-2"></i> Threats</h4>
                            <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">${tList.length}</span>
                        </div>
                        <div class="max-h-60 overflow-y-auto custom-scrollbar pr-2">
                            ${renderList(tList, 'text-red-400 border-red-500/30')}
                        </div>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-white/5 flex flex-wrap gap-6 text-xs text-slate-500 justify-between items-center">
                    <div>
                        <span class="block">Link Dokumen: <a href="${p.swotDocLink}" target="_blank" class="text-orange-400 hover:underline">${p.swotDocLink || '-'}</a></span>
                    </div>
                    <div class="text-right">
                        <div>Dibuat: ${formatDate(p.createdAt)}</div>
                        <div>Update: ${formatDate(p.updatedAt)}</div>
                    </div>
                </div>
            </div>
        `;
    }






function getProjectCharterFormHtml() {
        const categories = ["IT", "Marketing", "HR", "Operasional", "Finance", "Sales", "Legal", "Procurement", "R&D", "Logistics", "Production", "Audit", "Creative", "Construction", "Event", "Strategic", "Compliance", "General Affair", "Customer Service", "Training"];
        const catOptions = categories.map(c => `<option value="${c}">${c}</option>`).join('');

        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="ProjectCharter">

            <div class="space-y-4">
                <h3 class="text-violet-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Identitas Project</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Judul Project (Resmi) *</label>
                        <input type="text" id="pcTitle" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: Digital Transformation Phase 1">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kode Project</label>
                        <input type="text" id="pcCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="PC-IT-2026-001">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kategori</label>
                        <select id="pcCategoryType" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">${catOptions}</select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Deskripsi Umum</label>
                        <textarea id="pcDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Gambaran singkat proyek..."></textarea>
                    </div>
                    <div><label class="block text-xs text-violet-300 mb-1">Sponsor Project (Pemberi Mandat)</label><input type="text" id="pcSponsor" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-violet-300 mb-1">Project Manager (PM)</label><input type="text" id="pcManager" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-violet-300 mb-1">Pemilik Project (Owner)</label><input type="text" id="pcOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Jenis Project</label>
                        <select id="pcType" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Tim">Tim</option><option value="Individu">Individu</option></select>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-violet-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Waktu, Biaya & Status</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Mulai</label><input type="date" id="pcStartDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Selesai</label><input type="date" id="pcEndDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Jam Mulai</label><input type="time" id="pcStartTime" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Jam Selesai</label><input type="time" id="pcEndTime" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Status</label><select id="pcStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Belum Dimulai">Belum Dimulai</option><option value="Berjalan">Berjalan</option><option value="Selesai">Selesai</option><option value="Dihentikan">Dihentikan</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Prioritas</label><select id="pcPriority" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Tinggi">Tinggi</option><option value="Sedang">Sedang</option><option value="Rendah">Rendah</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Risiko Awal</label><select id="pcRisk" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Tinggi">Tinggi</option><option value="Sedang">Sedang</option><option value="Rendah">Rendah</option></select></div>
                    <div class="col-span-3">
                        <label class="block text-xs text-emerald-400 font-bold mb-1">Estimasi Anggaran (Budget)</label>
                        <input type="number" id="pcBudget" class="glass-input w-full p-3 rounded-lg text-sm font-mono" placeholder="Rp 0">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-violet-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Detail Strategis</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Tujuan Project (Goal)</label><textarea id="pcGoal" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Business Case / Latar Belakang</label><textarea id="pcBackground" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Manfaat (Benefits)</label><textarea id="pcBenefits" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs text-slate-400 mb-1">Ruang Lingkup (Scope In)</label><textarea id="pcScopeIn" rows="3" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                        <div><label class="block text-xs text-slate-400 mb-1">Batasan (Scope Out)</label><textarea id="pcScopeOut" rows="3" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-violet-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">D. Sumber Daya & Dokumen</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Sumber Daya Utama</label><input type="text" id="pcResources" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Tim, Vendor, Alat..."></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Metodologi</label><input type="text" id="pcMethod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Agile, Waterfall..."></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumentasi</label><input type="text" id="pcDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Dokumen Pendukung</label><input type="text" id="pcFiles" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="pcImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-violet-400 font-bold uppercase text-xs tracking-widest">E. Milestone / Sub Project</h3>
                    <span class="text-[10px] text-slate-500 italic">Tahapan utama proyek</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-1"><input type="number" id="pcSubOrder" placeholder="No" class="glass-input w-full px-3 py-2 rounded text-xs text-center"></div>
                    <div class="md:col-span-5"><input type="text" id="pcSubName" placeholder="Nama Milestone" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-3"><input type="date" id="pcSubDate" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    <div class="md:col-span-3"><input type="time" id="pcSubTime" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    
                    <div class="md:col-span-4"><input type="text" id="pcSubPic" placeholder="PIC" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-8"><input type="text" id="pcSubOutput" placeholder="Output Milestone" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-12"><input type="text" id="pcSubDesc" placeholder="Deskripsi Aktivitas" class="glass-input w-full px-3 py-2 rounded text-xs"></div>

                    <button type="button" onclick="addSubPC()" class="md:col-span-12 bg-violet-600 hover:bg-violet-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-violet-500/20 mt-2">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Milestone
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[800px]">
                        <thead class="bg-violet-900/30 text-violet-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 text-center">No</th>
                                <th class="p-3 border-b border-white/10">Milestone</th>
                                <th class="p-3 border-b border-white/10">Waktu</th>
                                <th class="p-3 border-b border-white/10">PIC</th>
                                <th class="p-3 border-b border-white/10">Output</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e1b2e]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="pcSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="pcSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada milestone.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-violet-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">F. Risiko & Persetujuan</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs text-slate-400 mb-1">Asumsi Project</label><textarea id="pcAssumption" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                        <div><label class="block text-xs text-slate-400 mb-1">Kendala (Constraints)</label><textarea id="pcConstraint" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Risiko Utama & Mitigasi</label><textarea id="pcRiskMitigation" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kriteria Keberhasilan</label><textarea id="pcSuccessCriteria" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-violet-900/10 p-4 rounded-xl border border-violet-500/20">
                        <div>
                            <label class="block text-xs text-violet-300 mb-1 font-bold">Status Persetujuan</label>
                            <select id="pcApprovalStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                                <option value="Draft">Draft</option><option value="Disetujui">Disetujui</option><option value="Revisi">Revisi</option>
                            </select>
                        </div>
                        <div><label class="block text-xs text-violet-300 mb-1 font-bold">Tgl Persetujuan</label><input type="date" id="pcApprovalDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                        <div class="col-span-3"><label class="block text-xs text-slate-400 mb-1">Catatan Sponsor / Manajemen</label><textarea id="pcManagementNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    </div>
                </div>
            </div>
        </form>
        `;
    }
// --- LOGIKA PROJECT CHARTER ---
    function addSubPC() {
        const name = document.getElementById('pcSubName').value;
        const order = document.getElementById('pcSubOrder').value;
        if(!name || !order) return alert("Nama Milestone dan Urutan wajib diisi!");

        const newSub = {
            id: generateId(),
            name: name,
            order: order,
            date: document.getElementById('pcSubDate').value || '-',
            time: document.getElementById('pcSubTime').value || '-',
            pic: document.getElementById('pcSubPic').value || '-',
            output: document.getElementById('pcSubOutput').value || '-',
            desc: document.getElementById('pcSubDesc').value || '-'
        };

        tempSubPCs.push(newSub);
        tempSubPCs.sort((a,b) => a.order - b.order);
        renderSubPCTable();
        
        document.getElementById('pcSubName').value = '';
        document.getElementById('pcSubOutput').value = '';
        document.getElementById('pcSubDesc').value = '';
        document.getElementById('pcSubOrder').value = parseInt(order) + 1;
    }

    function removeSubPC(id) {
        tempSubPCs = tempSubPCs.filter(s => s.id !== id);
        renderSubPCTable();
    }

    function renderSubPCTable() {
        const tbody = document.getElementById('pcSubListBody');
        const emptyDiv = document.getElementById('pcSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubPCs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubPCs.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-center text-slate-400">${s.order}</td>
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-xs text-slate-400">${s.date} ${s.time !== '-' ? s.time : ''}</td>
                    <td class="p-3 text-xs">${s.pic}</td>
                    <td class="p-3 text-xs italic text-slate-500">${s.output}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubPC('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
function populateProjectCharterForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };

        setVal('pcTitle', p.pcTitle);
        setVal('pcCode', p.pcCode);
        setVal('pcCategoryType', p.pcCategoryType);
        setVal('pcDesc', p.pcDesc);
        setVal('pcSponsor', p.pcSponsor);
        setVal('pcManager', p.pcManager);
        setVal('pcOwner', p.pcOwner);
        setVal('pcType', p.pcType);
        
        setVal('pcStartDate', p.pcStartDate);
        setVal('pcEndDate', p.pcEndDate);
        setVal('pcStartTime', p.pcStartTime);
        setVal('pcEndTime', p.pcEndTime);
        
        setVal('pcStatus', p.status);
        setVal('pcPriority', p.pcPriority);
        setVal('pcRisk', p.pcRisk);
        setVal('pcBudget', p.pcBudget);
        
        setVal('pcGoal', p.pcGoal);
        setVal('pcBackground', p.pcBackground);
        setVal('pcBenefits', p.pcBenefits);
        setVal('pcScopeIn', p.pcScopeIn);
        setVal('pcScopeOut', p.pcScopeOut);
        
        setVal('pcResources', p.pcResources);
        setVal('pcMethod', p.pcMethod);
        setVal('pcDocLink', p.pcDocLink);
        setVal('pcFiles', p.pcFiles);
        setVal('pcImage', p.image);
        
        setVal('pcAssumption', p.pcAssumption);
        setVal('pcConstraint', p.pcConstraint);
        setVal('pcRiskMitigation', p.pcRiskMitigation);
        setVal('pcSuccessCriteria', p.pcSuccessCriteria);
        
        setVal('pcApprovalStatus', p.pcApprovalStatus);
        setVal('pcApprovalDate', p.pcApprovalDate);
        setVal('pcManagementNotes', p.pcManagementNotes);

        tempSubPCs = p.subPCs || [];
        renderSubPCTable();
    }
function createProjectCharterCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const img = p.image || `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const ownerInitial = p.pcManager ? p.pcManager.charAt(0).toUpperCase() : '?';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105" title="Duplikat"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105" title="Hapus"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>
                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-violet-600 shadow-lg tracking-wider border border-white/10 shadow-violet-500/20">CHARTER</div>
            </div>
            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-violet-300 transition-colors tracking-tight">${p.pcTitle}</h3>
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">${p.pcDesc || 'Tidak ada deskripsi.'}</p>
                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-xs text-white border border-white/10 shadow-inner">${ownerInitial}</div>
                        <div class="flex flex-col -mt-1">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">PM</span>
                            <span class="text-xs text-slate-200 truncate w-32 font-medium leading-none">${p.pcManager || '-'}</span>
                        </div>
                    </div>
                    <div class="text-[10px] font-bold text-violet-200 bg-violet-500/10 px-3 py-1.5 rounded-lg border border-violet-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1">
                        <i class="fa-solid fa-layer-group text-[9px]"></i> ${p.pcCategoryType || '-'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
   
   function getProjectCharterDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.pcImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        // Helper untuk render baris milestone
        const mileRows = (p.subPCs || []).map(s => `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-center text-slate-400 font-bold bg-black/10">${s.order}</td>
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-slate-400 text-xs">${formatDate(s.date)} <span class="text-violet-400 ml-1">${s.time !== '-' ? s.time : ''}</span></td>
                <td class="p-3 text-xs">${s.pic}</td>
                <td class="p-3 text-xs italic text-slate-500">${s.output}</td>
            </tr>
        `).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${p.image || `https://picsum.photos/seed/${p.id}/1200/600`}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-violet-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-violet-200 text-[10px] uppercase tracking-widest border border-violet-500/30">PROJECT CHARTER</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.pcCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.pcTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-crown text-violet-500"></i> Sponsor: ${p.pcSponsor || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-gear text-violet-500"></i> PM: ${p.pcManager || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-building-user text-violet-500"></i> Owner: ${p.pcOwner || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                
                <div class="lg:col-span-2 space-y-8">
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden group">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1 font-bold">Anggaran</span>
                            <span class="text-xl font-bold text-white font-mono tracking-tight">Rp ${parseInt(p.pcBudget || 0).toLocaleString('id-ID')}</span>
                            <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-money-bill-wave text-3xl text-emerald-500"></i></div>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1 font-bold">Prioritas</span>
                            <span class="text-xl font-bold text-violet-300">${p.pcPriority || '-'}</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1 font-bold">Risiko Awal</span>
                            <span class="text-xl font-bold text-rose-400">${p.pcRisk || '-'}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl space-y-6">
                        <div>
                            <h4 class="text-violet-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Deskripsi Project</h4>
                            <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.pcDesc || '-'}</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-white/5">
                            <div>
                                <h4 class="text-violet-400 font-bold text-xs uppercase mb-2">Tujuan (Goal)</h4>
                                <p class="text-slate-400 text-xs leading-relaxed">${p.pcGoal || '-'}</p>
                            </div>
                            <div>
                                <h4 class="text-violet-400 font-bold text-xs uppercase mb-2">Business Case</h4>
                                <p class="text-slate-400 text-xs leading-relaxed">${p.pcBackground || '-'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <h4 class="text-emerald-400 font-bold text-xs uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-gift"></i> Manfaat (Benefits)</h4>
                            <p class="text-slate-400 text-xs leading-relaxed">${p.pcBenefits || '-'}</p>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <h4 class="text-amber-400 font-bold text-xs uppercase mb-2 flex items-center gap-2"><i class="fa-solid fa-flag-checkered"></i> Kriteria Keberhasilan</h4>
                            <p class="text-slate-400 text-xs leading-relaxed">${p.pcSuccessCriteria || '-'}</p>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <h4 class="text-blue-400 font-bold text-xs uppercase mb-2">Asumsi Project</h4>
                            <p class="text-slate-400 text-xs leading-relaxed italic">"${p.pcAssumption || '-'}"</p>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <h4 class="text-rose-400 font-bold text-xs uppercase mb-2">Kendala (Constraints)</h4>
                            <p class="text-slate-400 text-xs leading-relaxed">${p.pcConstraint || '-'}</p>
                        </div>
                    </div>

                    <div class="p-6 bg-rose-900/10 border border-rose-500/20 rounded-2xl">
                        <h4 class="text-rose-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Risiko Utama & Mitigasi</h4>
                        <p class="text-slate-300 text-sm leading-relaxed">${p.pcRiskMitigation || 'Tidak ada risiko mayor teridentifikasi.'}</p>
                    </div>

                    <div>
                        <h3 class="text-violet-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Milestones Project</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[600px]">
                                <thead class="bg-violet-900/20 text-violet-200 text-[10px] uppercase font-bold">
                                    <tr>
                                        <th class="p-3 text-center">No</th>
                                        <th class="p-3">Milestone</th>
                                        <th class="p-3">Waktu</th>
                                        <th class="p-3">PIC</th>
                                        <th class="p-3">Output</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/5">
                                    ${mileRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada milestone.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-violet-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-violet-300 font-bold text-xs uppercase mb-2">Catatan Sponsor / Manajemen</h4>
                        <p class="text-slate-400 text-sm italic mb-4">"${p.pcManagementNotes || 'Tidak ada catatan khusus.'}"</p>
                        
                        <div class="flex items-center justify-between pt-4 border-t border-white/5">
                            <div>
                                <span class="text-[10px] text-slate-500 uppercase block">Status Persetujuan</span>
                                <span class="text-sm font-bold text-white px-2 py-1 rounded bg-white/10 border border-white/10 inline-block mt-1">${p.pcApprovalStatus || 'Draft'}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-slate-500 uppercase block">Tanggal Disetujui</span>
                                <span class="text-sm text-violet-300">${formatDate(p.pcApprovalDate)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Tambahan</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Kategori</span><span class="text-slate-200 text-right">${p.pcCategoryType}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Jenis</span><span class="text-slate-200 text-right">${p.pcType}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Metodologi</span><span class="text-slate-200 text-right">${p.pcMethod || '-'}</span></li>
                            
                            <li class="flex flex-col gap-1 text-xs pt-2 border-t border-white/5">
                                <span class="text-slate-500">Sumber Daya Utama</span>
                                <span class="text-slate-200 leading-relaxed">${p.pcResources || '-'}</span>
                            </li>

                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5">
                                <span class="text-slate-500 mt-1">Mulai</span>
                                <div class="text-right">
                                    <div class="text-white">${formatDate(p.pcStartDate)}</div>
                                    <div class="text-[10px] text-violet-400 font-mono">${p.pcStartTime || ''}</div>
                                </div>
                            </li>
                            <li class="flex justify-between items-start text-xs">
                                <span class="text-slate-500 mt-1">Selesai</span>
                                <div class="text-right">
                                    <div class="text-white">${formatDate(p.pcEndDate)}</div>
                                    <div class="text-[10px] text-violet-400 font-mono">${p.pcEndTime || ''}</div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Ruang Lingkup</h3>
                        <div class="space-y-4">
                            <div>
                                <span class="text-[10px] text-emerald-400 font-bold uppercase mb-1 block">Scope In (Termasuk)</span>
                                <p class="text-xs text-slate-400 leading-relaxed">${p.pcScopeIn || '-'}</p>
                            </div>
                            <div>
                                <span class="text-[10px] text-rose-400 font-bold uppercase mb-1 block">Scope Out (Tidak Termasuk)</span>
                                <p class="text-xs text-slate-400 leading-relaxed">${p.pcScopeOut || '-'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.pcDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-violet-500/50 hover:bg-violet-500/10 transition text-xs text-violet-300 group">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-book group-hover:scale-110 transition"></i> Link Dokumentasi</span>
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                         <a href="${p.pcFiles || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-violet-500/50 hover:bg-violet-500/10 transition text-xs text-violet-300 group">
                            <span class="flex items-center gap-2"><i class="fa-solid fa-folder-open group-hover:scale-110 transition"></i> Dokumen Pendukung</span>
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                        <a href="${p.image || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-violet-500/50 hover:bg-violet-500/10 transition text-xs text-slate-400 group">
                            <span class="flex items-center gap-2"><i class="fa-regular fa-image group-hover:scale-110 transition"></i> Link Cover Image</span>
                            <i class="fa-solid fa-link"></i>
                        </a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center border-t border-white/5">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-violet-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
    







function getBSCDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.bscImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subBSCs || []).map(s => `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-center text-slate-400 font-bold bg-black/10">${s.order}</td>
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-slate-400 text-xs">${formatDate(s.date)} <span class="text-amber-400 ml-1">${s.time !== '-' ? s.time : ''}</span></td>
                <td class="p-3 text-xs">${s.pic}</td>
                <td class="p-3 text-xs italic text-slate-500">${s.output}</td>
            </tr>
        `).join('');

        // Warna Gap berdasarkan progress
        const progVal = parseFloat(p.bscProgress) || 0;
        const progColor = progVal >= 100 ? 'text-emerald-400' : (progVal >= 80 ? 'text-blue-400' : 'text-amber-400');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-amber-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-amber-200 text-[10px] uppercase tracking-widest border border-amber-500/30">BALANCED SCORECARD</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.bscCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.bscTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-amber-500"></i> Owner: ${p.bscOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-check-double text-amber-500"></i> Sponsor: ${p.bscSponsor || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Target</span><span class="text-xl font-bold text-white">${p.bscTarget || 0}</span><span class="text-[10px] text-amber-400 ml-1">${p.bscUnit || ''}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Realisasi</span><span class="text-xl font-bold text-emerald-300">${p.bscRealization || 0}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Progress</span><span class="text-2xl font-bold ${progColor}">${p.bscProgress || '0%'}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Bobot Strategi</span><span class="text-xl font-bold text-white">${p.bscWeight || '0'}%</span></div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl space-y-6">
                        <div><h4 class="text-amber-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Deskripsi Strategi</h4><p class="text-slate-300 text-sm leading-relaxed text-justify">${p.bscDesc || '-'}</p></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-white/5">
                            <div><h4 class="text-amber-400 font-bold text-xs uppercase mb-2">Tujuan Strategis</h4><p class="text-slate-400 text-xs leading-relaxed">${p.bscStrategicObj || '-'}</p></div>
                            <div><h4 class="text-amber-400 font-bold text-xs uppercase mb-2">Inisiatif Strategis</h4><p class="text-slate-400 text-xs leading-relaxed">${p.bscInitiative || '-'}</p></div>
                        </div>
                    </div>

                    <div class="p-5 bg-amber-900/10 border border-amber-500/20 rounded-2xl">
                        <h4 class="text-amber-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-chart-pie"></i> Indikator Kinerja (KPI)</h4>
                        <p class="text-white font-bold text-lg mb-1">${p.bscKpiName || '-'}</p>
                        <p class="text-slate-400 text-sm italic">${p.bscKpiDef || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Aktivitas Strategis</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[600px]"><thead class="bg-amber-900/20 text-amber-200 text-[10px] uppercase font-bold"><tr><th class="p-3 text-center">No</th><th class="p-3">Aktivitas</th><th class="p-3">Waktu</th><th class="p-3">PIC</th><th class="p-3">Output</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada aktivitas.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-amber-500 border-white/5 p-6 rounded-r-2xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><h4 class="text-amber-300 font-bold text-xs uppercase mb-1">Hambatan / Isu</h4><p class="text-slate-400 text-xs">${p.bscIssues || '-'}</p></div>
                            <div><h4 class="text-emerald-300 font-bold text-xs uppercase mb-1">Action Plan</h4><p class="text-slate-400 text-xs">${p.bscActionPlan || '-'}</p></div>
                        </div>
                        <div class="pt-4 border-t border-white/5">
                            <h4 class="text-blue-300 font-bold text-xs uppercase mb-1">Hasil Evaluasi Akhir</h4>
                            <p class="text-slate-300 text-sm leading-relaxed">${p.bscEvaluation || '-'}</p>
                            <span class="text-[10px] text-slate-500 uppercase block mt-3">Keputusan Strategis: <span class="text-white font-bold bg-white/10 px-2 py-0.5 rounded ml-1">${p.bscDecision || '-'}</span></span>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Tambahan</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Level</span><span class="text-slate-200 text-right">${p.bscLevel}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Periode</span><span class="text-slate-200 text-right">${p.bscPeriod}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Perspektif</span><span class="text-amber-400 font-bold text-right">${p.bscPerspective}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Sifat</span><span class="text-slate-200 text-right">${p.bscNature}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Risiko</span><span class="text-rose-400 font-bold text-right">${p.bscRisk}</span></li>
                            <li class="flex flex-col gap-1 text-xs pt-2 border-t border-white/5"><span class="text-slate-500">Metode Ukur</span><span class="text-slate-200 leading-relaxed">${p.bscMethod || '-'}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Mulai</span><div class="text-right"><div class="text-white">${formatDate(p.bscStartDate)}</div><div class="text-[10px] text-amber-400 font-mono">${p.bscStartTime || ''}</div></div></li>
                            <li class="flex justify-between items-start text-xs"><span class="text-slate-500 mt-1">Akhir</span><div class="text-right"><div class="text-white">${formatDate(p.bscEndDate)}</div><div class="text-[10px] text-amber-400 font-mono">${p.bscEndTime || ''}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.bscDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-amber-500/50 hover:bg-amber-500/10 transition text-xs text-amber-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-book group-hover:scale-110 transition"></i> Link Dokumentasi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                         <a href="${p.bscProof || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-amber-500/50 hover:bg-amber-500/10 transition text-xs text-amber-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-folder-open group-hover:scale-110 transition"></i> Bukti Pendukung</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                         <a href="${p.bscTools || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-amber-500/50 hover:bg-amber-500/10 transition text-xs text-amber-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-laptop-code group-hover:scale-110 transition"></i> Tools Monitoring</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center border-t border-white/5">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-amber-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
function createBSCCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        // Logika Gambar (Safe Fallback)
        const rawImg = p.image || p.bscImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        
        const statusClass = getStatusColor(p.status);
        const ownerInitial = p.bscOwner ? p.bscOwner.charAt(0).toUpperCase() : '?';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-amber-600 shadow-lg tracking-wider border border-white/10 shadow-amber-500/20">SCORECARD</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-amber-300 font-bold uppercase tracking-wider border border-amber-500/30 px-2 py-0.5 rounded bg-amber-500/10">
                        ${p.bscPerspective || 'Strategic'}
                    </span>
                </div>

                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-amber-300 transition-colors tracking-tight">${p.bscTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.bscDesc || 'Tidak ada deskripsi strategi.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${ownerInitial}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Owner</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.bscOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-amber-200 bg-amber-500/10 px-3 py-1.5 rounded-lg border border-amber-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-bullseye text-[9px]"></i> ${p.bscPeriod || '-'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- LOGIKA BSC ---
    function calculateBSCProgress() {
        const target = parseFloat(document.getElementById('bscTarget').value) || 0;
        const real = parseFloat(document.getElementById('bscRealization').value) || 0;
        let prog = 0;
        
        if(target !== 0) {
            prog = (real / target) * 100;
        }
        
        document.getElementById('bscProgress').value = prog.toFixed(2) + '%';
    }

    function addSubBSC() {
        const name = document.getElementById('bscSubName').value;
        const order = document.getElementById('bscSubOrder').value;
        if(!name || !order) return alert("Nama Aktivitas dan Urutan wajib diisi!");

        const newSub = {
            id: generateId(),
            name: name,
            order: order,
            date: document.getElementById('bscSubDate').value || '-',
            time: document.getElementById('bscSubTime').value || '-',
            pic: document.getElementById('bscSubPic').value || '-',
            output: document.getElementById('bscSubOutput').value || '-',
            desc: document.getElementById('bscSubDesc').value || '-'
        };

        tempSubBSCs.push(newSub);
        tempSubBSCs.sort((a,b) => a.order - b.order);
        renderSubBSCTable();
        
        document.getElementById('bscSubName').value = '';
        document.getElementById('bscSubOutput').value = '';
        document.getElementById('bscSubDesc').value = '';
        document.getElementById('bscSubOrder').value = parseInt(order) + 1;
    }

    function removeSubBSC(id) {
        tempSubBSCs = tempSubBSCs.filter(s => s.id !== id);
        renderSubBSCTable();
    }

    function renderSubBSCTable() {
        const tbody = document.getElementById('bscSubListBody');
        const emptyDiv = document.getElementById('bscSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubBSCs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubBSCs.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-center text-slate-400">${s.order}</td>
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-xs text-slate-400">${s.date} ${s.time !== '-' ? s.time : ''}</td>
                    <td class="p-3 text-xs">${s.pic}</td>
                    <td class="p-3 text-xs italic text-slate-500">${s.output}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubBSC('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
    function getBSCFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="BSC">

            <div class="space-y-4">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Identitas Strategis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul BSC (Strategic Objective) *</label>
                        <input type="text" id="bscTitle" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: Meningkatkan Profitabilitas Q1">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kode BSC</label>
                        <input type="text" id="bscCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="BSC-FIN-001">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Deskripsi Strategi</label>
                        <textarea id="bscDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Penjelasan strategi..."></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Level BSC</label>
                        <select id="bscLevel" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Company">Company</option><option value="Divisi">Divisi</option><option value="Tim">Tim</option><option value="Individu">Individu</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Perspektif BSC</label>
                        <select id="bscPerspective" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Financial">Financial</option>
                            <option value="Customer">Customer</option>
                            <option value="Internal Process">Internal Process</option>
                            <option value="Learning & Growth">Learning & Growth</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-amber-300 mb-1">Pemilik (Owner)</label><input type="text" id="bscOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-amber-300 mb-1">Sponsor / Approver</label><input type="text" id="bscSponsor" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Periode Pelaksanaan</h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Periode</label>
                        <select id="bscPeriod" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Bulanan">Bulanan</option><option value="Kuartalan">Kuartalan</option><option value="Tahunan">Tahunan</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Mulai</label><input type="date" id="bscStartDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Akhir</label><input type="date" id="bscEndDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Jam Mulai</label><input type="time" id="bscStartTime" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Jam Akhir</label><input type="time" id="bscEndTime" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Peta Strategi & KPI</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Tujuan Strategis</label><input type="text" id="bscStrategicObj" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Inisiatif Strategis</label><input type="text" id="bscInitiative" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 bg-amber-900/10 p-4 rounded-xl border border-amber-500/20">
                        <div><label class="block text-xs text-slate-400 mb-1 font-bold">Indikator Kinerja (KPI)</label><input type="text" id="bscKpiName" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                        <div><label class="block text-xs text-slate-400 mb-1">Definisi KPI</label><input type="text" id="bscKpiDef" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                        
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Satuan</label>
                            <select id="bscUnit" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="%">%</option><option value="Angka">Angka</option><option value="Rupiah">Rupiah</option></select>
                        </div>
                        <div><label class="block text-xs text-slate-400 mb-1">Baseline Awal</label><input type="number" id="bscBaseline" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="0"></div>
                        
                        <div><label class="block text-xs text-amber-400 mb-1 font-bold">Target</label><input type="number" id="bscTarget" oninput="calculateBSCProgress()" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white bg-amber-900/20"></div>
                        <div><label class="block text-xs text-emerald-400 mb-1 font-bold">Realisasi</label><input type="number" id="bscRealization" oninput="calculateBSCProgress()" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white bg-emerald-900/20"></div>
                        
                        <div class="col-span-2"><label class="block text-xs text-blue-400 mb-1 font-bold">Progress (%)</label><input type="text" id="bscProgress" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold text-blue-300 bg-black/40 text-center"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">D. Status & Risiko</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Status</label><select id="bscStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Belum Dimulai">Belum Dimulai</option><option value="On Track">On Track</option><option value="At Risk">At Risk</option><option value="Tercapai">Tercapai</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Sifat</label><select id="bscNature" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Penting">Penting</option><option value="Sangat Penting">Sangat Penting</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Bobot (%)</label><input type="number" id="bscWeight" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Risiko</label><select id="bscRisk" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Rendah">Rendah</option><option value="Sedang">Sedang</option><option value="Tinggi">Tinggi</option></select></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">E. Monitoring Tools</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Metode Ukur</label><input type="text" id="bscMethod" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tools / Dashboard</label><input type="text" id="bscTools" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen</label><input type="text" id="bscDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Bukti Pendukung</label><input type="text" id="bscProof" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="bscImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest">F. Sub BSC / Aktivitas Strategis</h3>
                    <span class="text-[10px] text-slate-500 italic">Action Plan breakdown</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-1"><input type="number" id="bscSubOrder" placeholder="No" class="glass-input w-full px-3 py-2 rounded text-xs text-center"></div>
                    <div class="md:col-span-5"><input type="text" id="bscSubName" placeholder="Nama Aktivitas" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-3"><input type="date" id="bscSubDate" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    <div class="md:col-span-3"><input type="time" id="bscSubTime" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    
                    <div class="md:col-span-4"><input type="text" id="bscSubPic" placeholder="PIC" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-8"><input type="text" id="bscSubOutput" placeholder="Output" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-12"><input type="text" id="bscSubDesc" placeholder="Deskripsi Aktivitas" class="glass-input w-full px-3 py-2 rounded text-xs"></div>

                    <button type="button" onclick="addSubBSC()" class="md:col-span-12 bg-amber-600 hover:bg-amber-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-amber-500/20 mt-2">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Aktivitas
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[800px]">
                        <thead class="bg-amber-900/30 text-amber-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 text-center">No</th>
                                <th class="p-3 border-b border-white/10">Aktivitas</th>
                                <th class="p-3 border-b border-white/10">Waktu</th>
                                <th class="p-3 border-b border-white/10">PIC</th>
                                <th class="p-3 border-b border-white/10">Output</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e1b2e]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="bscSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="bscSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada aktivitas.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">G. Evaluasi & Keputusan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Monitoring</label><textarea id="bscNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Hambatan / Isu</label><textarea id="bscIssues" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Action Plan Perbaikan</label><textarea id="bscActionPlan" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div class="col-span-2 bg-amber-900/10 p-4 rounded-xl border border-amber-500/20">
                        <label class="block text-xs text-amber-300 mb-1 font-bold">Keputusan Strategis</label>
                        <select id="bscDecision" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Lanjut">Lanjut</option><option value="Revisi">Revisi</option><option value="Hentikan">Hentikan</option>
                        </select>
                        <label class="block text-xs text-slate-400 mt-3 mb-1">Hasil Evaluasi Akhir</label>
                        <textarea id="bscEvaluation" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                </div>
            </div>
        </form>
        `;
    }
    
    




    // --- LOGIKA AGILE PROJECT ---
    function populateAgileForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('agTitle', p.agTitle); setVal('agCode', p.agCode); setVal('agDesc', p.agDesc);
        setVal('agCategory', p.agCategory); setVal('agMethod', p.agMethod);
        setVal('agPO', p.agPO); setVal('agSM', p.agSM); setVal('agTeam', p.agTeam);
        setVal('agSprintNo', p.agSprintNo); setVal('agDuration', p.agDuration);
        setVal('agStartDate', p.agStartDate); setVal('agEndDate', p.agEndDate);
        setVal('agSprintGoal', p.agSprintGoal);
        setVal('agStatus', p.status); setVal('agSprintStatus', p.agSprintStatus); setVal('agPriority', p.agPriority); setVal('agTools', p.agTools);
        setVal('agVelocity', p.agVelocity); setVal('agTotalSP', p.agTotalSP); setVal('agCompletedSP', p.agCompletedSP); setVal('agProgress', p.agProgress);
        setVal('agLinkBacklog', p.agLinkBacklog); setVal('agLinkDoc', p.agLinkDoc);
        setVal('agReview', p.agReview); setVal('agBlocker', p.agBlocker); setVal('agRetro', p.agRetro); setVal('agDecision', p.agDecision);

        tempSubAgiles = p.subAgiles || [];
        renderSubAgileTable();
        recalculateAgileMetrics();
    }
    function getAgileDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const img = `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subAgiles || []).map(s => {
            const statusColor = s.status === 'Done' ? 'text-emerald-400' : (s.status === 'In Progress' ? 'text-blue-400' : 'text-slate-400');
            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-center text-xs bg-white/5">${s.type}</td>
                <td class="p-3 text-center text-xs font-bold ${statusColor}">${s.status}</td>
                <td class="p-3 text-center text-xs text-slate-400">${s.priority}</td>
                <td class="p-3 text-center text-xs font-bold text-sky-300 bg-sky-500/10">${s.sp}</td>
                <td class="p-3 text-xs text-slate-400">${s.pic}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-sky-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-sky-200 text-[10px] uppercase tracking-widest border border-sky-500/30">AGILE</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.agCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.agTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-crown text-sky-500"></i> PO: ${p.agPO || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-gear text-sky-500"></i> Scrum Master: ${p.agSM || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Sprint</span><span class="text-xl font-bold text-white">#${p.agSprintNo || 1}</span><span class="text-[10px] text-sky-400 ml-2">${p.agDuration || 0} Minggu</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Total SP</span><span class="text-xl font-bold text-white">${p.agTotalSP || 0}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Completed</span><span class="text-xl font-bold text-emerald-400">${p.agCompletedSP || 0}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Progress</span><span class="text-xl font-bold text-blue-400">${p.agProgress || '0%'}</span></div>
                    </div>

                    <div class="bg-[#161b2e]/50 border border-white/5 p-6 rounded-2xl space-y-4">
                        <div><h4 class="text-sky-400 font-bold text-xs uppercase mb-2">Deskripsi Project</h4><p class="text-slate-300 text-sm leading-relaxed">${p.agDesc || '-'}</p></div>
                        <div class="pt-4 border-t border-white/5">
                            <h4 class="text-sky-400 font-bold text-xs uppercase mb-2">Sprint Goal</h4>
                            <p class="text-white text-lg font-bold leading-relaxed">"${p.agSprintGoal || '-'}"</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> User Stories / Tasks</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[600px]"><thead class="bg-sky-900/20 text-sky-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Item</th><th class="p-3 text-center">Jenis</th><th class="p-3 text-center">Status</th><th class="p-3 text-center">Prioritas</th><th class="p-3 text-center">SP</th><th class="p-3">PIC</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="6" class="p-4 text-center italic text-slate-500 text-xs">Kosong</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><h4 class="text-sky-300 font-bold text-xs uppercase mb-2">Review / Feedback</h4><p class="text-slate-400 text-xs leading-relaxed">${p.agReview || '-'}</p></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><h4 class="text-rose-400 font-bold text-xs uppercase mb-2">Blockers</h4><p class="text-slate-400 text-xs leading-relaxed">${p.agBlocker || '-'}</p></div>
                        <div class="col-span-1 md:col-span-2 p-5 bg-[#161b2e] rounded-2xl border border-white/5"><h4 class="text-blue-300 font-bold text-xs uppercase mb-2">Retrospective</h4><p class="text-slate-400 text-xs leading-relaxed">${p.agRetro || '-'}</p><span class="block mt-2 text-[10px] text-sky-500 uppercase font-bold">Keputusan: ${p.agDecision}</span></div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Tambahan</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Kategori</span><span class="text-slate-200 text-right">${p.agCategory}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Metodologi</span><span class="text-slate-200 text-right">${p.agMethod}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status Sprint</span><span class="text-sky-400 font-bold text-right">${p.agSprintStatus}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Prioritas</span><span class="text-slate-200 text-right">${p.agPriority}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Velocity Target</span><span class="text-slate-200 text-right font-bold">${p.agVelocity || 0} SP</span></li>
                            <li class="flex justify-between text-xs">
                                <span class="text-slate-500">Tim Agile</span>
                                <span class="text-slate-200  text-right">${p.agTeam || '-'}</span>
                            </li>
                            <li class="flex justify-between text-xs">
                                <span class="text-slate-500">Tools</span>
                                <span class="text-slate-200 text-right">${p.agTools || '-'}</span>
                            </li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Mulai Project</span><div class="text-right"><div class="text-white">${formatDate(p.agStartDate)}</div></div></li>
                            <li class="flex justify-between items-start text-xs"><span class="text-slate-500 mt-1">Target Selesai</span><div class="text-right"><div class="text-white">${formatDate(p.agEndDate)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.agLinkBacklog || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-sky-500/50 hover:bg-sky-500/10 transition text-xs text-sky-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-list-ol group-hover:scale-110 transition"></i> Product Backlog</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                         <a href="${p.agLinkDoc || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-sky-500/50 hover:bg-sky-500/10 transition text-xs text-sky-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-folder-open group-hover:scale-110 transition"></i> Dokumentasi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center border-t border-white/5">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-sky-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
    function recalculateAgileMetrics() {
        if (tempSubAgiles.length === 0) {
            document.getElementById('agTotalSP').value = '0';
            document.getElementById('agCompletedSP').value = '0';
            document.getElementById('agProgress').value = '0%';
            return;
        }

        let totalSP = 0;
        let completedSP = 0;

        tempSubAgiles.forEach(s => {
            const sp = parseFloat(s.sp) || 0;
            totalSP += sp;
            if(s.status === 'Done') {
                completedSP += sp;
            }
        });

        const progress = totalSP > 0 ? ((completedSP / totalSP) * 100).toFixed(1) : 0;

        const elTotal = document.getElementById('agTotalSP'); if(elTotal) elTotal.value = totalSP;
        const elComp = document.getElementById('agCompletedSP'); if(elComp) elComp.value = completedSP;
        const elProg = document.getElementById('agProgress'); if(elProg) elProg.value = progress + '%';
    }
function createAgileCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const img = `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-sky-600 shadow-lg tracking-wider border border-white/10 shadow-sky-500/20">SPRINT ${p.agSprintNo || '1'}</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2 flex gap-2">
                    <span class="text-[9px] text-sky-300 font-bold uppercase tracking-wider border border-sky-500/30 px-2 py-0.5 rounded bg-sky-500/10">${p.agMethod || 'Scrum'}</span>
                    <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider border border-white/10 px-2 py-0.5 rounded bg-white/5">${p.agSprintStatus || 'Backlog'}</span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-sky-300 transition-colors tracking-tight">${p.agTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.agDesc || 'Tidak ada deskripsi project.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">${p.agPO ? p.agPO.charAt(0).toUpperCase() : '?'}</div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">PO</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.agPO || '-'}</span>
                        </div>
                    </div>
                    <div class="text-[10px] font-bold text-sky-200 bg-sky-500/10 px-3 py-1.5 rounded-lg border border-sky-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-bolt text-[9px]"></i> ${p.agTotalSP || 0} SP
                    </div>
                </div>
            </div>
        `;
        return div;
    }  
    function addSubAgile() {
        const name = document.getElementById('agSubName').value;
        const type = document.getElementById('agSubType').value;
        if(!name) return alert("Judul Item wajib diisi!");

        const newSub = {
            id: generateId(),
            name: name,
            type: type,
            status: document.getElementById('agSubStatus').value,
            priority: document.getElementById('agSubPriority').value,
            sp: parseFloat(document.getElementById('agSubSP').value) || 0,
            pic: document.getElementById('agSubPic').value || '-',
            desc: document.getElementById('agSubDesc').value || '-'
        };

        tempSubAgiles.push(newSub);
        renderSubAgileTable();
        recalculateAgileMetrics();
        
        // Reset
        document.getElementById('agSubName').value = '';
        document.getElementById('agSubSP').value = '';
        document.getElementById('agSubDesc').value = '';
    }
    function removeSubAgile(id) {
        tempSubAgiles = tempSubAgiles.filter(s => s.id !== id);
        renderSubAgileTable();
        recalculateAgileMetrics();
    }

    function renderSubAgileTable() {
        const tbody = document.getElementById('agSubListBody');
        const emptyDiv = document.getElementById('agSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubAgiles.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubAgiles.forEach(s => {
                // Warna Status
                let statusColor = 'text-slate-400';
                if(s.status === 'Done') statusColor = 'text-emerald-400 font-bold';
                else if(s.status === 'In Progress') statusColor = 'text-blue-400 font-bold';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-center text-xs text-slate-400 bg-white/5">${s.type}</td>
                    <td class="p-3 text-center text-xs ${statusColor}">${s.status}</td>
                    <td class="p-3 text-center text-xs text-slate-400">${s.priority}</td>
                    <td class="p-3 text-center text-xs text-sky-300 font-bold bg-sky-500/10">${s.sp}</td>
                    <td class="p-3 text-xs text-slate-400">${s.pic}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubAgile('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
    function getAgileFormHtml() {
        const cats = ["IT", "Product", "Marketing", "Ops", "HR", "Finance", "R&D", "Design", "Data", "Security"];
        const catOpts = cats.map(c => `<option value="${c}">${c}</option>`).join('');

        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="Agile">

            <div class="space-y-4">
                <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Identitas Agile</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul Project *</label>
                        <input type="text" id="agTitle" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: Mobile App Revamp v2.0">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kode Project</label>
                        <input type="text" id="agCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="AG-APP-001">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Deskripsi Project</label>
                        <textarea id="agDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kategori</label>
                        <select id="agCategory" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">${catOpts}</select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Metodologi</label>
                        <select id="agMethod" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Scrum">Scrum</option><option value="Kanban">Kanban</option><option value="Scrumban">Scrumban</option><option value="Hybrid">Hybrid</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-sky-300 mb-1">Product Owner (PO)</label><input type="text" id="agPO" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-sky-300 mb-1">Scrum Master / Lead</label><input type="text" id="agSM" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Tim Agile (Member)</label><input type="text" id="agTeam" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Nama anggota tim..."></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Konfigurasi Sprint</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Nomor Sprint</label><input type="number" id="agSprintNo" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="1"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Durasi (Minggu)</label><input type="number" id="agDuration" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="2"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Mulai Project</label><input type="date" id="agStartDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Target Selesai</label><input type="date" id="agEndDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div class="col-span-2 md:col-span-4"><label class="block text-xs text-sky-300 mb-1 font-bold">Sprint Goal</label><input type="text" id="agSprintGoal" class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-sky-900/20" placeholder="Tujuan utama sprint ini..."></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Status & Metrics</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Status Project</label><select id="agStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Berjalan">Berjalan</option><option value="Belum Dimulai">Belum Dimulai</option><option value="Selesai">Selesai</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Status Sprint</label><select id="agSprintStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Sprint">Sprint (Active)</option><option value="Backlog">Backlog</option><option value="Review">Review</option><option value="Done">Done</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Prioritas</label><select id="agPriority" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Tinggi">Tinggi</option><option value="Sedang">Sedang</option><option value="Rendah">Rendah</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tools</label><input type="text" id="agTools" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Jira, Trello..."></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest">D. User Stories / Tasks</h3>
                    <span class="text-[10px] text-slate-500 italic">*Story Point otomatis dihitung</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Judul User Story / Task</label><input type="text" id="agSubName" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Jenis</label><select id="agSubType" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300"><option value="Story">Story</option><option value="Task">Task</option><option value="Bug">Bug</option></select></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Status</label><select id="agSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300"><option value="To Do">To Do</option><option value="In Progress">In Progress</option><option value="Done">Done</option></select></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Prioritas</label><select id="agSubPriority" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300"><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
                    
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Story Point</label><input type="number" id="agSubSP" class="glass-input w-full px-3 py-2 rounded text-xs border-sky-500/30" placeholder="0"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">PIC</label><input type="text" id="agSubPic" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-7"><label class="block text-[10px] text-slate-400 mb-1">Deskripsi Singkat</label><input type="text" id="agSubDesc" class="glass-input w-full px-3 py-2 rounded text-xs"></div>

                    <button type="button" onclick="addSubAgile()" class="md:col-span-12 bg-sky-600 hover:bg-sky-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-sky-500/20 mt-2">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Item
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[1000px]">
                        <thead class="bg-sky-900/30 text-sky-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Item</th>
                                <th class="p-3 border-b border-white/10 text-center">Jenis</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-center">Prioritas</th>
                                <th class="p-3 border-b border-white/10 text-center text-sky-300 font-bold">SP</th>
                                <th class="p-3 border-b border-white/10">PIC</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="agSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="agSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada user story.</div>
                </div>
            </div>

            <div class="space-y-4 bg-black/40 p-5 rounded-2xl border border-white/10">
                <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">E. Sprint Metrics (Otomatis)</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Velocity Target</label>
                        <input type="number" id="agVelocity" oninput="recalculateAgileMetrics()" class="glass-input w-full p-3 rounded-lg text-sm bg-black/20" placeholder="Target SP">
                    </div>
                    <div>
                        <label class="block text-xs text-sky-300 font-bold mb-1">Total Story Point</label>
                        <input type="text" id="agTotalSP" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-black/50 text-white cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-xs text-emerald-300 font-bold mb-1">Completed SP</label>
                        <input type="text" id="agCompletedSP" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-black/50 text-white cursor-not-allowed">
                    </div>
                    <div>
                        <label class="block text-xs text-blue-400 font-bold mb-1">Progress Sprint</label>
                        <input type="text" id="agProgress" readonly class="glass-input w-full p-3 rounded-lg text-sm text-blue-400 font-bold bg-black/50 cursor-not-allowed">
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">F. Review & Retrospective</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Product Backlog</label><input type="text" id="agLinkBacklog" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumentasi</label><input type="text" id="agLinkDoc" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Hasil Sprint Review / Feedback</label><textarea id="agReview" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Hambatan (Blocker)</label><textarea id="agBlocker" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Retrospective & Action Plan</label><textarea id="agRetro" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div class="col-span-2">
                        <label class="block text-xs text-sky-300 mb-1 font-bold">Keputusan Sprint</label>
                        <select id="agDecision" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Lanjut">Lanjut Sprint Berikutnya</option><option value="Re-planning">Re-planning</option><option value="Stop">Stop Project</option></select>
                    </div>
                </div>
            </div>
        </form>
        `;
    }
   
   
   
   function getBRDFormHtml() {
        const cats = ["IT", "Product", "Finance", "HR", "Ops", "Marketing", "Sales", "Legal", "Procurement", "R&D", "Data", "Security", "Strategy", "Customer Service"];
        const catOpts = cats.map(c => `<option value="${c}">${c}</option>`).join('');

        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="BRD">

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Identitas Dokumen BRD</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul BRD Project *</label>
                        <input type="text" id="brdTitle" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: Implementasi CRM Sales v2">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kode BRD</label>
                        <input type="text" id="brdCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="BRD-IT-001">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Deskripsi Project (Ringkasan)</label>
                        <textarea id="brdDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kategori</label>
                        <select id="brdCategory" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">${catOpts}</select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Jenis Project</label>
                        <select id="brdType" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Tim">Tim</option><option value="Individu">Individu</option></select>
                    </div>
                    <div><label class="block text-xs text-fuchsia-300 mb-1">Business Owner</label><input type="text" id="brdOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-fuchsia-300 mb-1">Project Manager</label><input type="text" id="brdPM" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2 md:col-span-2"><label class="block text-xs text-fuchsia-300 mb-1">Business Analyst (BA)</label><input type="text" id="brdBA" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Waktu & Status</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Mulai</label><input type="date" id="brdStartDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Target Selesai</label><input type="date" id="brdEndDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Jam Mulai</label><input type="time" id="brdStartTime" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Jam Selesai</label><input type="time" id="brdEndTime" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Status BRD</label><select id="brdStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Draft">Draft</option><option value="Review">Review</option><option value="Approved">Approved</option><option value="Revisi">Revisi</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Status Project</label><select id="brdProjStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Belum Dimulai">Belum Dimulai</option><option value="Berjalan">Berjalan</option><option value="Selesai">Selesai</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Sifat Kebutuhan</label><select id="brdNature" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Sangat Penting">Sangat Penting</option><option value="Penting">Penting</option><option value="Tidak Mendesak">Tidak Mendesak</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Prioritas</label><select id="brdPriority" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Tinggi">Tinggi</option><option value="Sedang">Sedang</option><option value="Rendah">Rendah</option></select></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Konteks Bisnis</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Latar Belakang Bisnis</label><textarea id="brdBackground" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tujuan Bisnis</label><textarea id="brdGoal" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs text-rose-300/80 mb-1 font-bold">Permasalahan Saat Ini (As-Is)</label><textarea id="brdAsIs" rows="3" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                        <div><label class="block text-xs text-emerald-300/80 mb-1 font-bold">Kondisi Diharapkan (To-Be)</label><textarea id="brdToBe" rows="3" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Manfaat Bisnis (Benefits)</label><textarea id="brdBenefit" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">D. Ruang Lingkup & Risiko</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Ruang Lingkup (In Scope)</label><textarea id="brdInScope" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Di Luar Lingkup (Out Scope)</label><textarea id="brdOutScope" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Asumsi & Ketergantungan</label><textarea id="brdAssumptions" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Risiko & Constraint</label><textarea id="brdRisks" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest">E. Business Requirements</h3>
                    <span class="text-[10px] text-slate-500 italic">Daftar kebutuhan fungsional/non-fungsional</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Nama Requirement</label><input type="text" id="brdSubName" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Jenis</label><select id="brdSubType" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300"><option value="Functional">Functional</option><option value="Non-Functional">Non-Functional</option></select></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Prioritas</label><select id="brdSubPriority" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300"><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Tgl Identifikasi</label><input type="date" id="brdSubDate" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Stakeholder</label><input type="text" id="brdSubStakeholder" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Deskripsi</label><input type="text" id="brdSubDesc" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Acceptance Criteria</label><input type="text" id="brdSubCriteria" class="glass-input w-full px-3 py-2 rounded text-xs"></div>

                    <button type="button" onclick="addSubBRD()" class="md:col-span-12 bg-fuchsia-600 hover:bg-fuchsia-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-fuchsia-500/20 mt-2">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Requirement
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[1000px]">
                        <thead class="bg-fuchsia-900/30 text-fuchsia-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Requirement</th>
                                <th class="p-3 border-b border-white/10 text-center">Jenis</th>
                                <th class="p-3 border-b border-white/10 text-center">Prioritas</th>
                                <th class="p-3 border-b border-white/10">Deskripsi</th>
                                <th class="p-3 border-b border-white/10">Stakeholder</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="brdSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="brdSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada requirement.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">F. Persetujuan & Dokumen</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Metode Pengumpulan</label><input type="text" id="brdMethod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Interview, Workshop..."></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tools</label><input type="text" id="brdTools" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumentasi</label><input type="text" id="brdDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Dokumen Pendukung</label><input type="text" id="brdFiles" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="brdImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div class="col-span-2 bg-fuchsia-900/10 p-4 rounded-xl border border-fuchsia-500/20 grid grid-cols-2 gap-4">
                         <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Analisis</label><textarea id="brdAnalysisNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                         <div><label class="block text-xs text-slate-400 mb-1">Hasil Review</label><textarea id="brdReviewResult" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                         <div><label class="block text-xs text-slate-400 mb-1">Change Request</label><textarea id="brdChangeRequest" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                         
                         <div>
                            <label class="block text-xs text-fuchsia-300 mb-1 font-bold">Status Persetujuan Akhir</label>
                            <select id="brdFinalStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Disetujui">Disetujui</option><option value="Revisi">Revisi</option><option value="Ditolak">Ditolak</option></select>
                         </div>
                         <div><label class="block text-xs text-slate-400 mb-1">Catatan Persetujuan</label><input type="text" id="brdApprovalNotes" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    </div>
                </div>
            </div>
        </form>
        `;
    }
  // --- LOGIKA BRD PROJECT ---
    function addSubBRD() {
        const name = document.getElementById('brdSubName').value;
        const type = document.getElementById('brdSubType').value;
        if(!name) return alert("Nama Requirement wajib diisi!");

        const newSub = {
            id: generateId(),
            name: name,
            type: type,
            priority: document.getElementById('brdSubPriority').value,
            date: document.getElementById('brdSubDate').value || '-',
            stakeholder: document.getElementById('brdSubStakeholder').value || '-',
            desc: document.getElementById('brdSubDesc').value || '-',
            criteria: document.getElementById('brdSubCriteria').value || '-'
        };

        tempSubBRDs.push(newSub);
        renderSubBRDTable();
        
        document.getElementById('brdSubName').value = '';
        document.getElementById('brdSubDesc').value = '';
        document.getElementById('brdSubCriteria').value = '';
    }

    function removeSubBRD(id) {
        tempSubBRDs = tempSubBRDs.filter(s => s.id !== id);
        renderSubBRDTable();
    }

    function renderSubBRDTable() {
        const tbody = document.getElementById('brdSubListBody');
        const emptyDiv = document.getElementById('brdSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubBRDs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubBRDs.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-center text-xs bg-white/5">${s.type}</td>
                    <td class="p-3 text-center text-xs text-slate-400">${s.priority}</td>
                    <td class="p-3 text-xs text-slate-400 truncate max-w-[150px]">${s.desc}</td>
                    <td class="p-3 text-xs text-slate-400">${s.stakeholder}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubBRD('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI KE SAVE & POPULATE ---
    
    // 1. POPULATE (EDIT)
    function populateBRDForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('brdTitle', p.brdTitle); setVal('brdCode', p.brdCode); setVal('brdDesc', p.brdDesc);
        setVal('brdCategory', p.brdCategory); setVal('brdType', p.brdType);
        setVal('brdOwner', p.brdOwner); setVal('brdPM', p.brdPM); setVal('brdBA', p.brdBA);
        setVal('brdStartDate', p.brdStartDate); setVal('brdEndDate', p.brdEndDate);
        setVal('brdStartTime', p.brdStartTime); setVal('brdEndTime', p.brdEndTime);
        
        setVal('brdStatus', p.status); setVal('brdProjStatus', p.brdProjStatus);
        setVal('brdNature', p.brdNature); setVal('brdPriority', p.brdPriority);
        
        setVal('brdBackground', p.brdBackground); setVal('brdGoal', p.brdGoal);
        setVal('brdAsIs', p.brdAsIs); setVal('brdToBe', p.brdToBe); setVal('brdBenefit', p.brdBenefit);
        setVal('brdInScope', p.brdInScope); setVal('brdOutScope', p.brdOutScope);
        setVal('brdAssumptions', p.brdAssumptions); setVal('brdRisks', p.brdRisks);
        
        setVal('brdMethod', p.brdMethod); setVal('brdTools', p.brdTools);
        setVal('brdDocLink', p.brdDocLink); setVal('brdFiles', p.brdFiles); setVal('brdImage', p.image);
        
        setVal('brdAnalysisNotes', p.brdAnalysisNotes); setVal('brdReviewResult', p.brdReviewResult);
        setVal('brdChangeRequest', p.brdChangeRequest); setVal('brdFinalStatus', p.brdFinalStatus);
        setVal('brdApprovalNotes', p.brdApprovalNotes);

        tempSubBRDs = p.subBRDs || [];
        renderSubBRDTable();
    }
function createBRDCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.brdImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-fuchsia-600 shadow-lg tracking-wider border border-white/10 shadow-fuchsia-500/20">BRD PLAN</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-fuchsia-300 transition-colors tracking-tight">${p.brdTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.brdDesc || 'Tidak ada ringkasan project.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">${p.brdOwner ? p.brdOwner.charAt(0).toUpperCase() : '?'}</div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Business Analyst</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.brdBA || '-'}</span>
                        </div>
                    </div>
                    <div class="text-[10px] font-bold text-fuchsia-200 bg-fuchsia-500/10 px-3 py-1.5 rounded-lg border border-fuchsia-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-file-contract text-[9px]"></i> ${p.brdCode || '-'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
   function getBRDDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.brdImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subBRDs || []).map(s => `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-center text-xs bg-white/5">${s.type}</td>
                <td class="p-3 text-center text-xs text-fuchsia-300 font-bold">${s.priority}</td>
                <td class="p-3 text-xs text-slate-400 italic">${s.desc}</td>
                <td class="p-3 text-xs text-slate-400">${s.stakeholder}</td>
            </tr>`).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-fuchsia-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-fuchsia-200 text-[10px] uppercase tracking-widest border border-fuchsia-500/30">BRD</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.brdCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.brdTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-fuchsia-500"></i> Owner: ${p.brdOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-glasses text-fuchsia-500"></i> BA: ${p.brdBA || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                
                <div class="lg:col-span-2 space-y-8">
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Status Project</span><span class="text-xl font-bold text-white">${p.brdProjStatus || '-'}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Prioritas</span><span class="text-xl font-bold text-fuchsia-300">${p.brdPriority || '-'}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Approval</span><span class="text-xl font-bold text-emerald-400">${p.brdFinalStatus || 'Pending'}</span></div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl space-y-6">
                        <div>
                            <h4 class="text-fuchsia-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Deskripsi Project</h4>
                            <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.brdDesc || '-'}</p>
                        </div>
                        <div class="pt-4 border-t border-white/5">
                            <h4 class="text-fuchsia-400 font-bold text-xs uppercase mb-2">Tujuan Bisnis</h4>
                            <p class="text-slate-400 text-sm leading-relaxed">${p.brdGoal || '-'}</p>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl space-y-6">
                        <div><h4 class="text-fuchsia-400 font-bold text-xs uppercase mb-3">Latar Belakang</h4><p class="text-slate-300 text-sm leading-relaxed text-justify">${p.brdBackground || '-'}</p></div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-white/5">
                            <div><h4 class="text-rose-400 font-bold text-xs uppercase mb-2">As-Is (Saat Ini)</h4><p class="text-slate-400 text-xs leading-relaxed">${p.brdAsIs || '-'}</p></div>
                            <div><h4 class="text-emerald-400 font-bold text-xs uppercase mb-2">To-Be (Harapan)</h4><p class="text-slate-400 text-xs leading-relaxed">${p.brdToBe || '-'}</p></div>
                        </div>

                        <div class="pt-4 border-t border-white/5">
                            <h4 class="text-emerald-400 font-bold text-xs uppercase mb-2"><i class="fa-solid fa-gift mr-1"></i> Manfaat Bisnis</h4>
                            <p class="text-slate-300 text-sm leading-relaxed">${p.brdBenefit || '-'}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><h4 class="text-fuchsia-300 font-bold text-xs uppercase mb-2">In Scope</h4><p class="text-slate-400 text-xs leading-relaxed">${p.brdInScope || '-'}</p></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><h4 class="text-slate-400 font-bold text-xs uppercase mb-2">Out of Scope</h4><p class="text-slate-500 text-xs leading-relaxed">${p.brdOutScope || '-'}</p></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><h4 class="text-blue-400 font-bold text-xs uppercase mb-2">Asumsi & Ketergantungan</h4><p class="text-slate-400 text-xs leading-relaxed">${p.brdAssumptions || '-'}</p></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><h4 class="text-rose-400 font-bold text-xs uppercase mb-2">Risiko & Constraint</h4><p class="text-slate-400 text-xs leading-relaxed">${p.brdRisks || '-'}</p></div>
                    </div>

                    <div>
                        <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Business Requirements</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[600px]"><thead class="bg-fuchsia-900/20 text-fuchsia-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Requirement</th><th class="p-3 text-center">Jenis</th><th class="p-3 text-center">Prioritas</th><th class="p-3">Deskripsi</th><th class="p-3">Stakeholder</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada requirement.</td></tr>'}</tbody></table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-5 bg-[#1e293b] border border-white/10 rounded-2xl">
                            <h4 class="text-slate-300 font-bold text-xs uppercase mb-2">Hasil Review Stakeholder</h4>
                            <p class="text-slate-400 text-xs leading-relaxed mb-4">${p.brdReviewResult || '-'}</p>
                            
                            <h4 class="text-amber-400 font-bold text-xs uppercase mb-2 pt-2 border-t border-white/5">Change Request</h4>
                            <p class="text-slate-400 text-xs leading-relaxed">${p.brdChangeRequest || '-'}</p>
                        </div>

                        <div class="p-5 bg-[#1e293b] border-l-4 border-l-fuchsia-500 border-white/10 rounded-r-2xl">
                            <h4 class="text-fuchsia-300 font-bold text-xs uppercase mb-2">Catatan Analisis</h4>
                            <p class="text-slate-400 text-xs italic mb-4">"${p.brdAnalysisNotes || '-'}"</p>
                            
                            <h4 class="text-emerald-300 font-bold text-xs uppercase mb-2 pt-2 border-t border-white/5">Catatan Persetujuan</h4>
                            <p class="text-slate-400 text-xs italic">"${p.brdApprovalNotes || '-'}"</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Project</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Kategori</span><span class="text-slate-200 text-right">${p.brdCategory}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Jenis</span><span class="text-slate-200 text-right">${p.brdType}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">PM</span><span class="text-fuchsia-300 text-right font-bold">${p.brdPM || '-'}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Sifat</span><span class="text-slate-200 text-right">${p.brdNature || '-'}</span></li>
                            
      <li class=" flex justify-between text-xs"><span class="text-slate-500">Method</span><span class="text-slate-200 text-right">${p.brdMethod || '-'}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Tools</span><span class="text-slate-200 text-right">${p.brdTools || '-'}</span></li>

                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Mulai</span><div class="text-right"><div class="text-white">${formatDate(p.brdStartDate)}</div><div class="text-[10px] text-fuchsia-400 font-mono">${p.brdStartTime || ''}</div></div></li>
                            <li class="flex justify-between items-start text-xs"><span class="text-slate-500 mt-1">Selesai</span><div class="text-right"><div class="text-white">${formatDate(p.brdEndDate)}</div><div class="text-[10px] text-fuchsia-400 font-mono">${p.brdEndTime || ''}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.brdDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-fuchsia-500/50 hover:bg-fuchsia-500/10 transition text-xs text-fuchsia-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-book group-hover:scale-110 transition"></i> Link Dokumentasi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                         <a href="${p.brdFiles || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-fuchsia-500/50 hover:bg-fuchsia-500/10 transition text-xs text-fuchsia-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-folder-open group-hover:scale-110 transition"></i> Dokumen Pendukung</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                         <a href="${img}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-fuchsia-500/50 hover:bg-fuchsia-500/10 transition text-xs text-slate-400 group"><span class="flex items-center gap-2"><i class="fa-regular fa-image group-hover:scale-110 transition"></i> Link Cover Image</span><i class="fa-solid fa-link"></i></a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center border-t border-white/5">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-fuchsia-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
  
  
  
  
  
  
  
// --- LOGIKA OKR SYSTEM ---
  function getOKRFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="OKR">

            <div class="space-y-4">
                <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Objective (Tujuan Besar)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Objective Title *</label>
                        <input type="text" id="okrTitle" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Menjadi Market Leader di Asia Tenggara">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode OKR</label><input type="text" id="okrCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="OKR-Q1-2026"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Tipe OKR</label>
                        <select id="okrType" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Committed">Committed (Wajib Capai)</option>
                            <option value="Aspirational">Aspirational (Ambisius)</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-lime-300 mb-1">Owner (Penanggung Jawab)</label><input type="text" id="okrOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-lime-300 mb-1">Divisi / Tim</label><input type="text" id="okrTeam" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Deskripsi & Konteks</label><textarea id="okrDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Periode & Progress</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Periode</label>
                        <select id="okrPeriod" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Q1">Q1 (Jan-Mar)</option><option value="Q2">Q2 (Apr-Jun)</option><option value="Q3">Q3 (Jul-Sep)</option><option value="Q4">Q4 (Okt-Des)</option><option value="Tahunan">Tahunan</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tahun</label><input type="number" id="okrYear" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="2026"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Status</label><select id="okrStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Draft">Draft</option><option value="On Track">On Track</option><option value="At Risk">At Risk</option><option value="Completed">Completed</option></select></div>
                    
                    <div>
                        <label class="block text-xs text-lime-400 font-bold mb-1">Total Progress (%)</label>
                        <input type="text" id="okrProgress" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-black/50 text-lime-300 text-center cursor-not-allowed" value="0%">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Mulai</label><input type="date" id="okrStartDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Selesai</label><input type="date" id="okrEndDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest">C. Key Results (Hasil Kunci)</h3>
                    <span class="text-[10px] text-slate-500 italic">*Progress dihitung dari rata-rata KR</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Judul Key Result (Harus Terukur)</label><input type="text" id="okrSubTitle" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Contoh: Meningkatkan retensi user dari 40% ke 60%"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Satuan</label><select id="okrSubUnit" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300"><option value="%">%</option><option value="Angka">Angka</option><option value="IDR">IDR</option><option value="USD">USD</option></select></div>
                    
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Target</label><input type="number" id="okrSubTarget" class="glass-input w-full px-3 py-2 rounded text-xs font-bold text-lime-300 bg-lime-900/20" placeholder="Target"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Realisasi</label><input type="number" id="okrSubReal" class="glass-input w-full px-3 py-2 rounded text-xs font-bold text-white bg-white/10" placeholder="Real"></div>
                    
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Bobot (%)</label><input type="number" id="okrSubWeight" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Default: Rata"></div>
                    <div class="md:col-span-9"><label class="block text-[10px] text-slate-400 mb-1">Cara Pengukuran / Notes</label><input type="text" id="okrSubNote" class="glass-input w-full px-3 py-2 rounded text-xs"></div>

                    <button type="button" onclick="addSubOKR()" class="md:col-span-12 bg-lime-600 hover:bg-lime-500 text-black py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-lime-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Key Result
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-lime-900/30 text-lime-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Key Result</th>
                                <th class="p-3 border-b border-white/10 text-center">Bobot</th>
                                <th class="p-3 border-b border-white/10 text-center">Target</th>
                                <th class="p-3 border-b border-white/10 text-center">Real</th>
                                <th class="p-3 border-b border-white/10 text-center">Progress</th>
                                <th class="p-3 border-b border-white/10 text-center">Skor</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="okrSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="okrSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada Key Result.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">D. Dokumentasi & Evaluasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen / Dashboard</label><input type="text" id="okrDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="okrImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Hambatan Utama</label><textarea id="okrBlocker" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Rencana Tindak Lanjut (Next Step)</label><textarea id="okrNextStep" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }  
    function calculateOKRTotal() {
        if (tempSubOKRs.length === 0) {
            document.getElementById('okrProgress').value = '0%';
            return;
        }

        let totalScore = 0;
        let totalWeight = 0;

        tempSubOKRs.forEach(s => {
            // Jika user tidak isi bobot, anggap rata
            const weight = parseFloat(s.weight) || (100 / tempSubOKRs.length);
            const progress = parseFloat(s.progress) || 0;
            
            totalScore += (progress * weight);
            totalWeight += weight;
        });

        // Normalisasi jika bobot tidak 100
        const finalProgress = totalWeight > 0 ? (totalScore / totalWeight) : 0;
        
        // Cap max 100% (kecuali mau lebih)
        const displayProg = finalProgress > 100 ? 100 : finalProgress; 
        
        const elProg = document.getElementById('okrProgress');
        if(elProg) elProg.value = displayProg.toFixed(1) + '%';
    }

    function addSubOKR() {
        const title = document.getElementById('okrSubTitle').value;
        const target = parseFloat(document.getElementById('okrSubTarget').value) || 0;
        const real = parseFloat(document.getElementById('okrSubReal').value) || 0;
        
        if(!title) return alert("Judul Key Result wajib diisi!");
        if(target === 0) return alert("Target tidak boleh 0!");

        // Hitung Progress Item
        let itemProg = (real / target) * 100;
        // Skor Google Style (0.0 - 1.0)
        let googleScore = (itemProg / 100).toFixed(1);
        if(googleScore > 1.0) googleScore = 1.0;

        const newSub = {
            id: generateId(),
            title: title,
            unit: document.getElementById('okrSubUnit').value,
            target: target,
            real: real,
            weight: document.getElementById('okrSubWeight').value, // Bisa kosong
            note: document.getElementById('okrSubNote').value || '-',
            progress: itemProg.toFixed(1),
            score: googleScore
        };

        tempSubOKRs.push(newSub);
        renderSubOKRTable();
        calculateOKRTotal();
        
        // Reset Inputs
        document.getElementById('okrSubTitle').value = '';
        document.getElementById('okrSubTarget').value = '';
        document.getElementById('okrSubReal').value = '';
        document.getElementById('okrSubNote').value = '';
    }

    function removeSubOKR(id) {
        tempSubOKRs = tempSubOKRs.filter(s => s.id !== id);
        renderSubOKRTable();
        calculateOKRTotal();
    }

    function renderSubOKRTable() {
        const tbody = document.getElementById('okrSubListBody');
        const emptyDiv = document.getElementById('okrSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubOKRs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubOKRs.forEach(s => {
                // Warna Skor Google
                const scoreVal = parseFloat(s.score);
                let scoreClass = 'text-red-400';
                if(scoreVal >= 0.7) scoreClass = 'text-lime-400';
                else if(scoreVal >= 0.4) scoreClass = 'text-yellow-400';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.title}</td>
                    <td class="p-3 text-center text-xs text-slate-400 bg-white/5">${s.weight ? s.weight + '%' : 'Auto'}</td>
                    <td class="p-3 text-center text-xs font-bold text-lime-300 bg-lime-900/10">${s.target} ${s.unit}</td>
                    <td class="p-3 text-center text-xs font-bold text-white bg-white/10">${s.real} ${s.unit}</td>
                    <td class="p-3 text-center text-xs font-bold text-blue-400">${s.progress}%</td>
                    <td class="p-3 text-center text-xs font-bold ${scoreClass}">${s.score}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubOKR('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateOKRForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('okrTitle', p.okrTitle); setVal('okrCode', p.okrCode); setVal('okrType', p.okrType);
        setVal('okrOwner', p.okrOwner); setVal('okrTeam', p.okrTeam); setVal('okrDesc', p.okrDesc);
        setVal('okrPeriod', p.okrPeriod); setVal('okrYear', p.okrYear); setVal('okrStatus', p.status);
        setVal('okrStartDate', p.okrStartDate); setVal('okrEndDate', p.okrEndDate);
        setVal('okrProgress', p.okrProgress);
        setVal('okrDocLink', p.okrDocLink); setVal('okrImage', p.image);
        setVal('okrBlocker', p.okrBlocker); setVal('okrNextStep', p.okrNextStep);

        tempSubOKRs = p.subOKRs || [];
        renderSubOKRTable();
        calculateOKRTotal();
    }

    
function createOKRCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        // Logika Gambar (Safe Fallback)
        const rawImg = p.image || p.okrImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        
        const statusClass = getStatusColor(p.status);
        const ownerInitial = p.okrOwner ? p.okrOwner.charAt(0).toUpperCase() : '?';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-lime-400 shadow-lg tracking-wider border border-lime-300 shadow-lime-500/20">OBJECTIVE</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-lime-400 font-bold uppercase tracking-wider border border-lime-500/30 px-2 py-0.5 rounded bg-lime-500/10">
                        ${p.okrType || 'Committed'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-lime-300 transition-colors tracking-tight">${p.okrTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.okrDesc || 'Tidak ada deskripsi objective.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${ownerInitial}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Owner</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.okrOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-lime-200 bg-lime-500/10 px-3 py-1.5 rounded-lg border border-lime-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-calendar-week text-[9px]"></i> ${p.okrPeriod || '-'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }    
    function getOKRDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.okrImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subOKRs || []).map(s => {
            const scoreVal = parseFloat(s.score);
            let scoreColor = scoreVal >= 0.7 ? 'text-lime-400' : (scoreVal >= 0.4 ? 'text-yellow-400' : 'text-red-400');
            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.title}</td>
                <td class="p-3 text-center text-xs font-bold text-lime-300 bg-lime-500/10">${s.target} ${s.unit}</td>
                <td class="p-3 text-center text-xs font-bold text-white bg-white/10">${s.real} ${s.unit}</td>
                <td class="p-3 text-center text-xs font-bold text-blue-400">${s.progress}%</td>
                <td class="p-3 text-center text-xs font-bold ${scoreColor}">${s.score}</td>
                <td class="p-3 text-xs text-slate-400 italic">${s.note}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-lime-500 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-lime-200 text-[10px] uppercase tracking-widest border border-lime-500/30">OBJECTIVE</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.okrCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.okrTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-lime-500"></i> Owner: ${p.okrOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-users text-lime-500"></i> Team: ${p.okrTeam || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Periode</span><span class="text-xl font-bold text-white">${p.okrPeriod} ${p.okrYear}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Total Progress</span><span class="text-2xl font-bold text-lime-400">${p.okrProgress || '0%'}</span></div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-lime-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Konteks Objective</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.okrDesc || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-lime-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Key Results (KR)</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[600px]"><thead class="bg-lime-900/20 text-lime-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Key Result</th><th class="p-3 text-center">Target</th><th class="p-3 text-center">Real</th><th class="p-3 text-center">Prog</th><th class="p-3 text-center">Score</th><th class="p-3">Notes</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="6" class="p-4 text-center italic text-slate-500 text-xs">Belum ada KR.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-lime-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-lime-300 font-bold text-xs uppercase mb-2">Hambatan (Blocker)</h4>
                        <p class="text-slate-400 text-sm italic mb-4">"${p.okrBlocker || '-'}"</p>
                        <div class="pt-4 border-t border-white/5">
                             <h4 class="text-blue-300 font-bold text-xs uppercase mb-2">Next Steps</h4>
                             <p class="text-slate-300 text-sm">${p.okrNextStep || '-'}</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi OKR</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Tipe</span><span class="text-lime-300 text-right font-bold">${p.okrType}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Periode</span><span class="text-slate-200 text-right">${p.okrPeriod}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Mulai</span><div class="text-right"><div class="text-white">${formatDate(p.okrStartDate)}</div></div></li>
                            <li class="flex justify-between items-start text-xs"><span class="text-slate-500 mt-1">Selesai</span><div class="text-right"><div class="text-white">${formatDate(p.okrEndDate)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.okrDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-lime-500/50 hover:bg-lime-500/10 transition text-xs text-lime-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-book group-hover:scale-110 transition"></i> Link Dokumentasi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center border-t border-white/5">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-lime-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
   
   
   
   
   
   
   
   
   
   
// --- LOGIKA RISK MANAGEMENT ---


    function getRiskFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="Risk">

            <div class="space-y-4">
                <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Profil Risiko</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul Dokumen Risiko *</label>
                        <input type="text" id="rskTitle" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Analisis Risiko Proyek X">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Dokumen</label><input type="text" id="rskCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="RSK-2026-001"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Kategori Risiko</label>
                        <select id="rskCategory" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Operational">Operational</option>
                            <option value="Financial">Financial</option>
                            <option value="Strategic">Strategic</option>
                            <option value="Compliance">Compliance</option>
                            <option value="Technical">Technical</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Level Kritis (Overall)</label>
                        <select id="rskLevel" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                    
                    <div><label class="block text-xs text-red-300 mb-1">PIC (Risk Owner)</label><input type="text" id="rskOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Departemen / Divisi</label><input type="text" id="rskDept" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Deskripsi Umum</label><textarea id="rskDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">B. Status & Waktu</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Mitigasi</label>
                        <select id="rskStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Identified">Identified (Baru)</option>
                            <option value="Mitigated">Mitigated (Ditangani)</option>
                            <option value="Occurred">Occurred (Terjadi)</option>
                            <option value="Closed">Closed (Selesai)</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Probabilitas</label><select id="rskProb" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300"><option value="Kecil">Kecil</option><option value="Sedang">Sedang</option><option value="Besar">Besar</option></select></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Identifikasi</label><input type="date" id="rskDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Review</label><input type="date" id="rskReviewDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest">C. Daftar Potensi Risiko & Dampak</h3>
                    <span class="text-[10px] text-slate-500 italic">Identifikasi detail risiko</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Potensi Risiko</label><input type="text" id="rskSubName" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Server Down"></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Penyebab (Root Cause)</label><input type="text" id="rskSubCause" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Dampak (Impact)</label><input type="text" id="rskSubImpact" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Rencana Mitigasi</label><input type="text" id="rskSubPlan" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Status Item</label><select id="rskSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300"><option value="Open">Open</option><option value="Closed">Closed</option><option value="Monitoring">Monitoring</option></select></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Level</label><select id="rskSubLevel" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300"><option value="Low">Low</option><option value="Med">Med</option><option value="High">High</option></select></div>

                    <button type="button" onclick="addSubRisk()" class="md:col-span-12 bg-red-600 hover:bg-red-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-red-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Risiko
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[1000px]">
                        <thead class="bg-red-900/30 text-red-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Risiko</th>
                                <th class="p-3 border-b border-white/10">Penyebab</th>
                                <th class="p-3 border-b border-white/10">Dampak</th>
                                <th class="p-3 border-b border-white/10">Mitigasi</th>
                                <th class="p-3 border-b border-white/10 text-center">Level</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rskSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="rskSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada risiko teridentifikasi.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">D. Dokumentasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen SOP/Kebijakan</label><input type="text" id="rskDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="rskImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Tambahan</label><textarea id="rskNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
    function addSubRisk() {
        const name = document.getElementById('rskSubName').value;
        if(!name) return alert("Nama Risiko wajib diisi!");

        const newSub = {
            id: generateId(),
            name: name,
            cause: document.getElementById('rskSubCause').value || '-',
            impact: document.getElementById('rskSubImpact').value || '-',
            plan: document.getElementById('rskSubPlan').value || '-',
            status: document.getElementById('rskSubStatus').value,
            level: document.getElementById('rskSubLevel').value
        };

        tempSubRisks.push(newSub);
        renderSubRiskTable();
        
        // Reset Inputs
        document.getElementById('rskSubName').value = '';
        document.getElementById('rskSubCause').value = '';
        document.getElementById('rskSubImpact').value = '';
        document.getElementById('rskSubPlan').value = '';
    }

    function removeSubRisk(id) {
        tempSubRisks = tempSubRisks.filter(s => s.id !== id);
        renderSubRiskTable();
    }

    function renderSubRiskTable() {
        const tbody = document.getElementById('rskSubListBody');
        const emptyDiv = document.getElementById('rskSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubRisks.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubRisks.forEach(s => {
                // Warna Level
                let lvlColor = 'text-slate-400';
                if(s.level === 'High') lvlColor = 'text-red-400 font-bold';
                else if(s.level === 'Med') lvlColor = 'text-amber-400';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-xs text-slate-400">${s.cause}</td>
                    <td class="p-3 text-xs text-slate-400">${s.impact}</td>
                    <td class="p-3 text-xs text-emerald-300/80">${s.plan}</td>
                    <td class="p-3 text-center text-xs ${lvlColor}">${s.level}</td>
                    <td class="p-3 text-center text-xs text-white bg-white/5 rounded">${s.status}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubRisk('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateRiskForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('rskTitle', p.rskTitle); setVal('rskCode', p.rskCode); 
        setVal('rskCategory', p.rskCategory); setVal('rskLevel', p.rskLevel);
        setVal('rskOwner', p.rskOwner); setVal('rskDept', p.rskDept); setVal('rskDesc', p.rskDesc);
        setVal('rskStatus', p.status); setVal('rskProb', p.rskProb);
        setVal('rskDate', p.rskDate); setVal('rskReviewDate', p.rskReviewDate);
        setVal('rskDocLink', p.rskDocLink); setVal('rskImage', p.image); setVal('rskNotes', p.rskNotes);

        tempSubRisks = p.subRisks || [];
        renderSubRiskTable();
    }

    
function createRiskCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.rskImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const ownerInitial = p.rskOwner ? p.rskOwner.charAt(0).toUpperCase() : '?';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-red-600 shadow-lg tracking-wider border border-white/10 shadow-red-500/20">RISK MGMT</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2 flex gap-2">
                    <span class="text-[9px] text-red-400 font-bold uppercase tracking-wider border border-red-500/30 px-2 py-0.5 rounded bg-red-500/10">${p.rskCategory || 'General'}</span>
                    <span class="text-[9px] text-white font-bold uppercase tracking-wider border border-white/10 px-2 py-0.5 rounded bg-white/5">${p.rskLevel || 'Low'}</span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-red-300 transition-colors tracking-tight">${p.rskTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.rskDesc || 'Tidak ada deskripsi risiko.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${ownerInitial}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">PIC</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.rskOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-red-200 bg-red-500/10 px-3 py-1.5 rounded-lg border border-red-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-triangle-exclamation text-[9px]"></i> ${p.rskProb || '-'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
 function getRiskDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.rskImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subRisks || []).map(s => {
            let lvlColor = s.level === 'High' ? 'text-red-400 font-bold' : (s.level === 'Med' ? 'text-amber-400' : 'text-slate-400');
            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-xs text-slate-400 italic">${s.cause}</td>
                <td class="p-3 text-xs text-slate-300">${s.impact}</td>
                <td class="p-3 text-xs text-emerald-300/80">${s.plan}</td>
                <td class="p-3 text-center text-xs ${lvlColor}">${s.level}</td>
                <td class="p-3 text-center text-xs text-white bg-white/5">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-red-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-red-200 text-[10px] uppercase tracking-widest border border-red-500/30">RISK</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.rskCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.rskTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-shield text-red-500"></i> PIC: ${p.rskOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-building text-red-500"></i> Dept: ${p.rskDept || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Level Kritis</span><span class="text-xl font-bold text-red-400">${p.rskLevel || '-'}</span></div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5"><span class="text-[10px] text-slate-500 uppercase block mb-1">Probabilitas</span><span class="text-xl font-bold text-white">${p.rskProb || '-'}</span></div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-red-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Konteks Risiko</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.rskDesc || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Daftar Potensi Risiko</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-red-900/20 text-red-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Risiko</th><th class="p-3">Penyebab</th><th class="p-3">Dampak</th><th class="p-3">Rencana Mitigasi</th><th class="p-3 text-center">Level</th><th class="p-3 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="6" class="p-4 text-center italic text-slate-500 text-xs">Belum ada risiko.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-red-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-red-300 font-bold text-xs uppercase mb-2">Catatan Tambahan</h4>
                        <p class="text-slate-400 text-sm italic">"${p.rskNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Dokumen</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Kategori</span><span class="text-red-300 text-right font-bold">${p.rskCategory}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status Mitigasi</span><span class="text-slate-200 text-right">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Identifikasi</span><div class="text-right"><div class="text-white">${formatDate(p.rskDate)}</div></div></li>
                            <li class="flex justify-between items-start text-xs"><span class="text-slate-500 mt-1">Review Next</span><div class="text-right"><div class="text-white">${formatDate(p.rskReviewDate)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.rskDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-red-500/50 hover:bg-red-500/10 transition text-xs text-red-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-book group-hover:scale-110 transition"></i> Link SOP/Dokumen</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center border-t border-white/5">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-red-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }  
   
   
   
   
   
   
   function getQCDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.qcImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const total = (p.subQCs || []).length;
        const passCount = (p.subQCs || []).filter(x => x.status === 'Pass').length;
        const failCount = total - passCount;
        const passRate = total > 0 ? Math.round((passCount / total) * 100) : 0;

        const subRows = (p.subQCs || []).map(s => {
            let statusBadge = 'text-slate-400';
            if(s.status === 'Pass') statusBadge = 'text-emerald-400 font-bold';
            else if(s.status === 'Fail') statusBadge = 'text-red-400 font-bold';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.param}</td>
                <td class="p-3 text-center text-xs text-slate-400 italic">${s.std}</td>
                <td class="p-3 text-center text-xs text-white font-mono bg-white/5">${s.result}</td>
                <td class="p-3 text-center text-xs ${statusBadge}">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-emerald-600 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-emerald-200 text-[10px] uppercase tracking-widest border border-emerald-500/30">QC LOG</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.qcBatch || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.qcProduct}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-check text-emerald-500"></i> Inspector: ${p.qcInspector || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-emerald-500"></i> Date: ${formatDate(p.qcDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 text-center">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Total Tests</span>
                            <span class="text-xl font-bold text-white">${total}</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 text-center">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Pass Rate</span>
                            <span class="text-xl font-bold text-emerald-400">${passRate}%</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 text-center">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Defects</span>
                            <span class="text-xl font-bold text-red-400">${failCount}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-emerald-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Catatan Inspeksi</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.qcDesc || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Hasil Pengujian</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[600px]"><thead class="bg-emerald-900/20 text-emerald-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Parameter</th><th class="p-3 text-center">Standar</th><th class="p-3 text-center">Actual</th><th class="p-3 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada tes.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-emerald-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-emerald-300 font-bold text-xs uppercase mb-2">Rekomendasi / Tindakan Lanjut</h4>
                        <p class="text-slate-400 text-sm italic">"${p.qcAction || 'Tidak ada tindakan khusus.'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Batch</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">ID Batch</span><span class="text-emerald-300 text-right font-bold">${p.qcBatch}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Lokasi</span><span class="text-slate-200 text-right">${p.qcLocation || '-'}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Tanggal Cek</span><div class="text-right"><div class="text-white">${formatDate(p.qcDate)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.qcDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-emerald-500/50 hover:bg-emerald-500/10 transition text-xs text-emerald-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-camera group-hover:scale-110 transition"></i> Foto / Bukti</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center border-t border-white/5">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-emerald-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
   function createQCCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        // Logika Gambar
        const rawImg = p.image || p.qcImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        
        const statusClass = getStatusColor(p.status);
        const inspectorInitial = p.qcInspector ? p.qcInspector.charAt(0).toUpperCase() : '?';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-emerald-400 shadow-lg tracking-wider border border-emerald-300 shadow-emerald-500/20">QC LOG</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-emerald-300 transition-colors tracking-tight">${p.qcProduct}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.qcDesc || 'Tidak ada catatan inspeksi.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${inspectorInitial}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Inspector</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.qcInspector || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-emerald-200 bg-emerald-500/10 px-3 py-1.5 rounded-lg border border-emerald-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-barcode text-[9px]"></i> ${p.qcBatch || '-'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- LOGIKA QC LOG ---
    
    function addSubQC() {
        const param = document.getElementById('qcSubParam').value;
        if(!param) return alert("Parameter Tes wajib diisi!");

        const newSub = {
            id: generateId(),
            param: param,
            std: document.getElementById('qcSubStd').value || '-',
            result: document.getElementById('qcSubResult').value || '-',
            status: document.getElementById('qcSubStatus').value
        };

        tempSubQCs.push(newSub);
        renderSubQCTable();
        
        // Reset Inputs
        document.getElementById('qcSubParam').value = '';
        document.getElementById('qcSubResult').value = '';
    }

    function removeSubQC(id) {
        tempSubQCs = tempSubQCs.filter(s => s.id !== id);
        renderSubQCTable();
    }

    function renderSubQCTable() {
        const tbody = document.getElementById('qcSubListBody');
        const emptyDiv = document.getElementById('qcSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubQCs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubQCs.forEach(s => {
                // Warna Status
                let statusBadge = 'bg-slate-700 text-slate-300';
                if(s.status === 'Pass') statusBadge = 'bg-emerald-500 text-black font-bold shadow-[0_0_10px_rgba(16,185,129,0.5)]';
                else if(s.status === 'Fail') statusBadge = 'bg-red-500 text-white font-bold shadow-[0_0_10px_rgba(239,68,68,0.5)]';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.param}</td>
                    <td class="p-3 text-center text-xs text-slate-400 italic">${s.std}</td>
                    <td class="p-3 text-center text-xs text-white font-mono">${s.result}</td>
                    <td class="p-3 text-center"><span class="text-[10px] px-2 py-1 rounded uppercase ${statusBadge}">${s.status}</span></td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubQC('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateQCForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('qcProduct', p.qcProduct); setVal('qcBatch', p.qcBatch); 
        setVal('qcInspector', p.qcInspector); setVal('qcDate', p.qcDate); 
        setVal('qcStatus', p.status); setVal('qcLocation', p.qcLocation);
        setVal('qcDesc', p.qcDesc);
        setVal('qcDocLink', p.qcDocLink); setVal('qcImage', p.image); setVal('qcAction', p.qcAction);

        tempSubQCs = p.subQCs || [];
        renderSubQCTable();
    }

    function getQCFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="QC">

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Informasi Inspeksi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Produk / Layanan *</label>
                        <input type="text" id="qcProduct" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Batch Produksi A-99">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Batch / ID</label><input type="text" id="qcBatch" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="BATCH-2026-X"></div>
                    
                    <div><label class="block text-xs text-emerald-300 mb-1">Inspektor (QC Officer)</label><input type="text" id="qcInspector" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Cek</label><input type="date" id="qcDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Akhir</label>
                        <select id="qcStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Inspection">Inspection (Sedang Cek)</option>
                            <option value="Passed">Passed (Lulus)</option>
                            <option value="Failed">Failed (Gagal)</option>
                            <option value="On Hold">On Hold (Tahan)</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Lokasi / Line Produksi</label><input type="text" id="qcLocation" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Line 1 / Warehouse A"></div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Deskripsi / Catatan Umum</label><textarea id="qcDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Kondisi umum sampel..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest">B. Parameter & Hasil Tes</h3>
                    <span class="text-[10px] text-slate-500 italic">Input hasil pengukuran</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-4"><label class="block text-[10px] text-emerald-300 mb-1">Parameter Tes</label><input type="text" id="qcSubParam" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Berat Bersih"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Standar (Acuan)</label><input type="text" id="qcSubStd" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="100gr  2gr"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Hasil Ukur (Actual)</label><input type="text" id="qcSubResult" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="99.5gr"></div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Status</label>
                        <select id="qcSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Pass">Pass</option>
                            <option value="Fail">Fail</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubQC()" class="md:col-span-12 bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-emerald-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Hasil Tes
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-emerald-900/30 text-emerald-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Parameter</th>
                                <th class="p-3 border-b border-white/10 text-center">Standar</th>
                                <th class="p-3 border-b border-white/10 text-center">Hasil Ukur</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="qcSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="qcSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada data tes.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Bukti & Validasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Foto / Bukti</label><input type="text" id="qcDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image (Produk)</label><input type="text" id="qcImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2 bg-emerald-900/10 p-4 rounded-xl border border-emerald-500/20">
                         <label class="block text-xs text-emerald-300 mb-1 font-bold">Rekomendasi / Tindakan Lanjut</label>
                         <textarea id="qcAction" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Jika gagal, apa yang harus dilakukan? (Rework/Scrap)"></textarea>
                    </div>
                </div>
            </div>
        </form>
        `;
    }
 function getStakeholderFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="Stakeholder">

            <div class="space-y-4">
                <h3 class="text-teal-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Konteks Proyek</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Proyek / Inisiatif *</label>
                        <input type="text" id="stkTitle" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Implementasi ERP Finance">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Dokumen</label><input type="text" id="stkCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="STK-2026-001"></div>
                    
                    <div><label class="block text-xs text-teal-300 mb-1">Pembuat Analisis (Creator)</label><input type="text" id="stkCreator" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Analisis</label><input type="date" id="stkDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="stkStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Active">Active</option>
                            <option value="Review">Review</option>
                            <option value="Final">Final</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Versi Dokumen</label><input type="text" id="stkVersion" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="v1.0"></div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Deskripsi Singkat</label><textarea id="stkDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-teal-400 font-bold uppercase text-xs tracking-widest">B. Identifikasi & Matriks</h3>
                    <span class="text-[10px] text-slate-500 italic">Analisis Power vs Interest</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Nama Stakeholder</label><input type="text" id="stkSubName" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Peran / Posisi</label><input type="text" id="stkSubRole" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-teal-300 mb-1">Power (Pengaruh)</label>
                        <select id="stkSubPower" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="High">High</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-teal-300 mb-1">Interest (Minat)</label>
                        <select id="stkSubInterest" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="High">High</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-[10px] text-slate-400 mb-1">Strategi Komunikasi / Engagement</label>
                        <input type="text" id="stkSubStrategy" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Auto-suggest based on Matrix...">
                    </div>

                    <button type="button" onclick="addSubStakeholder()" class="md:col-span-12 bg-teal-600 hover:bg-teal-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-teal-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Stakeholder
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-teal-900/30 text-teal-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Nama</th>
                                <th class="p-3 border-b border-white/10">Peran</th>
                                <th class="p-3 border-b border-white/10 text-center">Power</th>
                                <th class="p-3 border-b border-white/10 text-center">Interest</th>
                                <th class="p-3 border-b border-white/10">Strategi</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="stkSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="stkSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada stakeholder.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-teal-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi & Notes</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Peta Stakeholder</label><input type="text" id="stkLinkMap" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen Komunikasi</label><input type="text" id="stkLinkComm" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="stkImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Tambahan</label><textarea id="stkNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
    // --- LOGIKA STAKEHOLDER ANALYSIS ---
    
    // Auto-fill Strategy logic helper
    function getStrategySuggestion(power, interest) {
        if (power === 'High' && interest === 'High') return 'Manage Closely (Kelola Ketat)';
        if (power === 'High' && interest === 'Low') return 'Keep Satisfied (Jaga Kepuasan)';
        if (power === 'Low' && interest === 'High') return 'Keep Informed (Jaga Informasi)';
        return 'Monitor (Pantau)'; // Low Power & Low Interest
    }

    function addSubStakeholder() {
        const name = document.getElementById('stkSubName').value;
        if(!name) return alert("Nama Stakeholder wajib diisi!");

        const power = document.getElementById('stkSubPower').value;
        const interest = document.getElementById('stkSubInterest').value;
        
        // Auto Suggestion if empty
        let strategy = document.getElementById('stkSubStrategy').value;
        if(!strategy) strategy = getStrategySuggestion(power, interest);

        const newSub = {
            id: generateId(),
            name: name,
            role: document.getElementById('stkSubRole').value || '-',
            power: power,
            interest: interest,
            strategy: strategy
        };

        tempSubStakeholders.push(newSub);
        renderSubStakeholderTable();
        
        // Reset Inputs
        document.getElementById('stkSubName').value = '';
        document.getElementById('stkSubRole').value = '';
        document.getElementById('stkSubStrategy').value = '';
    }

    function removeSubStakeholder(id) {
        tempSubStakeholders = tempSubStakeholders.filter(s => s.id !== id);
        renderSubStakeholderTable();
    }

    function renderSubStakeholderTable() {
        const tbody = document.getElementById('stkSubListBody');
        const emptyDiv = document.getElementById('stkSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubStakeholders.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubStakeholders.forEach(s => {
                // Warna Matrix Logic
                let strategyColor = 'text-slate-400';
                if(s.power === 'High' && s.interest === 'High') strategyColor = 'text-teal-300 font-bold';
                else if(s.power === 'High') strategyColor = 'text-amber-300';
                else if(s.interest === 'High') strategyColor = 'text-blue-300';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-xs text-slate-400">${s.role}</td>
                    <td class="p-3 text-center text-xs font-bold ${s.power === 'High' ? 'text-red-400' : 'text-slate-500'}">${s.power}</td>
                    <td class="p-3 text-center text-xs font-bold ${s.interest === 'High' ? 'text-blue-400' : 'text-slate-500'}">${s.interest}</td>
                    <td class="p-3 text-xs ${strategyColor}">${s.strategy}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubStakeholder('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateStakeholderForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('stkTitle', p.stkTitle); setVal('stkCode', p.stkCode); 
        setVal('stkCreator', p.stkCreator); setVal('stkDate', p.stkDate); 
        setVal('stkStatus', p.status); setVal('stkVersion', p.stkVersion);
        setVal('stkDesc', p.stkDesc);
        setVal('stkLinkMap', p.stkLinkMap); setVal('stkLinkComm', p.stkLinkComm);
        setVal('stkImage', p.image); setVal('stkNotes', p.stkNotes);

        tempSubStakeholders = p.subStakeholders || [];
        renderSubStakeholderTable();
    }

    function createStakeholderCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.stkImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Hitung jumlah stakeholder
        const count = (p.subStakeholders || []).length;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-teal-600 shadow-lg tracking-wider border border-white/10 shadow-teal-500/20">STAKEHOLDER</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-teal-400 font-bold uppercase tracking-wider border border-teal-500/30 px-2 py-0.5 rounded bg-teal-500/10">
                        ${p.stkVersion || 'v1.0'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-teal-300 transition-colors tracking-tight">${p.stkTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.stkDesc || 'Tidak ada deskripsi analisis.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.stkCreator ? p.stkCreator.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Creator</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.stkCreator || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-teal-200 bg-teal-500/10 px-3 py-1.5 rounded-lg border border-teal-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-users text-[9px]"></i> ${count} Entitas
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getStakeholderDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.stkImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subStakeholders || []).map(s => {
            let stratColor = 'text-slate-400';
            if(s.power === 'High' && s.interest === 'High') stratColor = 'text-teal-300 font-bold';
            
            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-xs text-slate-400">${s.role}</td>
                <td class="p-3 text-center text-xs font-bold ${s.power === 'High' ? 'text-red-400' : 'text-slate-500'}">${s.power}</td>
                <td class="p-3 text-center text-xs font-bold ${s.interest === 'High' ? 'text-blue-400' : 'text-slate-500'}">${s.interest}</td>
                <td class="p-3 text-xs ${stratColor}">${s.strategy}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-teal-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-teal-200 text-[10px] uppercase tracking-widest border border-teal-500/30">STAKEHOLDER</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.stkCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.stkTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-pen text-teal-500"></i> Creator: ${p.stkCreator || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-teal-500"></i> Tgl: ${formatDate(p.stkDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-teal-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Deskripsi Analisis</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.stkDesc || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-teal-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Daftar Pemangku Kepentingan</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-teal-900/20 text-teal-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Nama</th><th class="p-3">Peran</th><th class="p-3 text-center">Power</th><th class="p-3 text-center">Interest</th><th class="p-3">Strategi</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada data.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-teal-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-teal-300 font-bold text-xs uppercase mb-2">Catatan Tambahan</h4>
                        <p class="text-slate-400 text-sm italic">"${p.stkNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Dokumen</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Versi</span><span class="text-teal-300 text-right font-bold">${p.stkVersion}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Tanggal Analisis</span><div class="text-right"><div class="text-white">${formatDate(p.stkDate)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.stkLinkMap || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-teal-500/50 hover:bg-teal-500/10 transition text-xs text-teal-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-map group-hover:scale-110 transition"></i> Link Peta Stakeholder</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                         <a href="${p.stkLinkComm || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-teal-500/50 hover:bg-teal-500/10 transition text-xs text-teal-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-comments group-hover:scale-110 transition"></i> Dokumen Komunikasi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>

                    <div class="text-[10px] text-slate-600 pt-4 text-center border-t border-white/5">
                        <div class="mb-1">Dibuat: <span class="text-slate-500">${formatDate(p.createdAt)}</span></div>
                        <div>Update Terakhir: <span class="text-teal-500/70">${formatDate(p.updatedAt)}</span></div>
                    </div>
                </div>
            </div>
        `;
    }
function getProcurementFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="Procurement">

            <div class="space-y-4">
                <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Detail Permintaan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul Pengadaan *</label>
                        <input type="text" id="prcTitle" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Pengadaan Laptop Divisi IT">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Nomor Request (PR No)</label><input type="text" id="prcCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="PR-2026-IT-001"></div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Departemen Requestor</label><input type="text" id="prcDept" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Dibutuhkan</label><input type="date" id="prcDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Approval</label>
                        <select id="prcStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Pending Approval">Pending Approval</option>
                            <option value="Approved">Approved</option>
                            <option value="Ordered">Ordered (Dipesan)</option>
                            <option value="Received">Received (Diterima)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Total Anggaran (Estimasi)</label>
                        <input type="text" id="prcTotal" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-emerald-400 cursor-not-allowed" value="Rp 0">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Alasan Pengadaan / Justifikasi</label><textarea id="prcReason" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest">B. Daftar Barang / Jasa</h3>
                    <span class="text-[10px] text-slate-500 italic">Rincian item yang diminta</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Nama Barang</label><input type="text" id="prcSubName" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Nama Item"></div>
                    <div class="md:col-span-5"><label class="block text-[10px] text-slate-400 mb-1">Spesifikasi</label><input type="text" id="prcSubSpec" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Warna, Ukuran, Merk..."></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Vendor Target</label><input type="text" id="prcSubVendor" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Jumlah</label><input type="number" id="prcSubQty" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="0"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Satuan</label><input type="text" id="prcSubUnit" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Pcs/Unit"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Harga Satuan (Rp)</label><input type="number" id="prcSubPrice" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="0"></div>
                    <div class="md:col-span-5"><label class="block text-[10px] text-slate-400 mb-1">Total Sub (Otomatis)</label><input type="text" disabled class="glass-input w-full px-3 py-2 rounded text-xs bg-slate-800" placeholder="-"></div>

                    <button type="button" onclick="addSubProcurement()" class="md:col-span-12 bg-slate-600 hover:bg-slate-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-slate-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-cart-plus mr-1"></i> Tambah ke Daftar
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[1000px]">
                        <thead class="bg-slate-700/50 text-slate-200 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Barang</th>
                                <th class="p-3 border-b border-white/10">Spesifikasi</th>
                                <th class="p-3 border-b border-white/10 text-center">Qty</th>
                                <th class="p-3 border-b border-white/10 text-right">Harga Satuan</th>
                                <th class="p-3 border-b border-white/10 text-right">Total</th>
                                <th class="p-3 border-b border-white/10">Vendor</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="prcSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="prcSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada barang.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Lampiran</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Penawaran (Quotation)</label><input type="text" id="prcDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image (Foto Barang)</label><input type="text" id="prcImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>
        </form>
        `;
    }
  // --- LOGIKA PROCUREMENT PLAN ---
    
    function calculateProcurementTotal() {
        let total = 0;
        tempSubProcs.forEach(s => {
            total += (parseFloat(s.qty) * parseFloat(s.price));
        });
        
        const el = document.getElementById('prcTotal');
        if(el) el.value = 'Rp ' + total.toLocaleString('id-ID');
        return total; // Return value untuk disimpan
    }

    function addSubProcurement() {
        const name = document.getElementById('prcSubName').value;
        const qty = parseFloat(document.getElementById('prcSubQty').value) || 0;
        const price = parseFloat(document.getElementById('prcSubPrice').value) || 0;
        
        if(!name) return alert("Nama Barang wajib diisi!");
        if(qty <= 0) return alert("Jumlah barang harus lebih dari 0!");

        const newSub = {
            id: generateId(),
            name: name,
            spec: document.getElementById('prcSubSpec').value || '-',
            vendor: document.getElementById('prcSubVendor').value || '-',
            qty: qty,
            unit: document.getElementById('prcSubUnit').value || 'Pcs',
            price: price,
            total: qty * price
        };

        tempSubProcs.push(newSub);
        renderSubProcurementTable();
        calculateProcurementTotal();
        
        // Reset Inputs
        document.getElementById('prcSubName').value = '';
        document.getElementById('prcSubSpec').value = '';
        document.getElementById('prcSubQty').value = '';
        document.getElementById('prcSubPrice').value = '';
    }

    function removeSubProcurement(id) {
        tempSubProcs = tempSubProcs.filter(s => s.id !== id);
        renderSubProcurementTable();
        calculateProcurementTotal();
    }

    function renderSubProcurementTable() {
        const tbody = document.getElementById('prcSubListBody');
        const emptyDiv = document.getElementById('prcSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubProcs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubProcs.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-xs text-slate-400 italic">${s.spec}</td>
                    <td class="p-3 text-center text-xs text-white bg-white/5 font-mono">${s.qty} ${s.unit}</td>
                    <td class="p-3 text-right text-xs text-slate-300">Rp ${parseInt(s.price).toLocaleString('id-ID')}</td>
                    <td class="p-3 text-right text-xs font-bold text-emerald-400">Rp ${parseInt(s.total).toLocaleString('id-ID')}</td>
                    <td class="p-3 text-xs text-slate-400">${s.vendor}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubProcurement('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---
function createProcurementCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.prcImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const totalDisplay = parseInt(p.prcTotal || 0).toLocaleString('id-ID');

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-slate-600 shadow-lg tracking-wider border border-slate-500 shadow-slate-500/20">PROCUREMENT</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider border border-slate-500/30 px-2 py-0.5 rounded bg-slate-500/10">
                        ${p.prcCode || 'PR-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-slate-300 transition-colors tracking-tight">${p.prcTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.prcReason || 'Tidak ada alasan pengadaan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Requestor</span>
                        <span class="text-xs text-slate-200 font-medium">${p.prcDept || '-'}</span>
                    </div>
                    
                    <div class="text-right">
                        <span class="text-[9px] text-emerald-500 uppercase tracking-wider font-bold mb-0.5 block">Total Budget</span>
                        <span class="text-sm font-bold text-white font-mono">Rp ${totalDisplay}</span>
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function populateProcurementForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('prcTitle', p.prcTitle); setVal('prcCode', p.prcCode); 
        setVal('prcDept', p.prcDept); setVal('prcDate', p.prcDate); 
        setVal('prcStatus', p.status); setVal('prcReason', p.prcReason);
        setVal('prcDocLink', p.prcDocLink); setVal('prcImage', p.image);

        tempSubProcs = p.subProcs || [];
        renderSubProcurementTable();
        calculateProcurementTotal(); // Recalculate total for display
    }
function getProcurementDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.prcImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        const totalDisplay = parseInt(p.prcTotal || 0).toLocaleString('id-ID');

        const subRows = (p.subProcs || []).map(s => `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-xs text-slate-400 italic">${s.spec}</td>
                <td class="p-3 text-center text-xs text-white font-mono bg-white/5">${s.qty} ${s.unit}</td>
                <td class="p-3 text-right text-xs text-slate-300">Rp ${parseInt(s.price).toLocaleString('id-ID')}</td>
                <td class="p-3 text-right text-xs font-bold text-emerald-400">Rp ${parseInt(s.total).toLocaleString('id-ID')}</td>
                <td class="p-3 text-xs text-slate-400">${s.vendor}</td>
            </tr>`).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-slate-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-200 text-[10px] uppercase tracking-widest border border-slate-500/30">PROCUREMENT</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.prcCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.prcTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-building-user text-slate-400"></i> Dept: ${p.prcDept || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-slate-400"></i> Needed: ${formatDate(p.prcDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Jumlah Item</span>
                            <span class="text-xl font-bold text-white">${(p.subProcs || []).length} Item</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Total Anggaran</span>
                            <span class="text-2xl font-bold text-emerald-400 font-mono">Rp ${totalDisplay}</span>
                            <div class="absolute top-0 right-0 p-3 opacity-10 text-emerald-500 text-4xl"><i class="fa-solid fa-money-bill-wave"></i></div>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-slate-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Justifikasi Pengadaan</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.prcReason || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Rincian Barang</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-slate-700/50 text-slate-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Barang</th><th class="p-3">Spek</th><th class="p-3 text-center">Qty</th><th class="p-3 text-right">Harga</th><th class="p-3 text-right">Total</th><th class="p-3">Vendor</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="6" class="p-4 text-center italic text-slate-500 text-xs">Belum ada item.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Status</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.prcDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-slate-500/50 hover:bg-slate-500/10 transition text-xs text-slate-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-invoice-dollar group-hover:scale-110 transition"></i> Link Penawaran</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    function getRecruitmentFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="Recruitment">

            <div class="space-y-4">
                <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Detail Lowongan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Posisi Jabatan *</label>
                        <input type="text" id="recPosition" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Senior UI/UX Designer">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Lowongan (Job ID)</label><input type="text" id="recCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="JOB-2026-IT-05"></div>
                    
                    <div><label class="block text-xs text-pink-300 mb-1">Departemen</label><input type="text" id="recDept" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Hiring Manager</label><input type="text" id="recManager" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Tgl Dibuka</label><input type="date" id="recOpenDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Target Tutup</label><input type="date" id="recCloseDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Lowongan</label>
                        <select id="recStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Open">Open (Dibuka)</option>
                            <option value="On Hold">On Hold (Ditahan)</option>
                            <option value="Closed">Closed (Ditutup)</option>
                            <option value="Draft">Draft</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Target Hiring (Orang)</label>
                        <input type="number" id="recTarget" class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-pink-400" placeholder="1">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Kualifikasi Utama</label><textarea id="recQual" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Skill wajib..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest">B. Pipeline Kandidat</h3>
                    <span class="text-[10px] text-slate-500 italic">Daftar pelamar dan tahapan</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Nama Kandidat</label><input type="text" id="recSubName" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1">Tahapan Saat Ini</label>
                        <select id="recSubStage" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Screening">Screening CV</option>
                            <option value="Psikotes">Psikotes</option>
                            <option value="Interview HR">Interview HR</option>
                            <option value="Interview User">Interview User</option>
                            <option value="Offering">Offering</option>
                        </select>
                    </div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Skor (0-100)</label><input type="number" id="recSubScore" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="0"></div>
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1">Status Kandidat</label>
                        <select id="recSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="In Process">In Process</option>
                            <option value="Lolos (Hired)">Lolos (Hired)</option>
                            <option value="Gugur">Gugur</option>
                            <option value="Hold">Hold</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubRecruit()" class="md:col-span-12 bg-pink-600 hover:bg-pink-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-pink-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-user-plus mr-1"></i> Tambah Kandidat
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-pink-900/30 text-pink-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Nama Kandidat</th>
                                <th class="p-3 border-b border-white/10">Tahapan</th>
                                <th class="p-3 border-b border-white/10 text-center">Skor</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="recSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="recSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada kandidat.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Berkas & Progress</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Job Description (JD)</label><input type="text" id="recDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="recImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Progress Hiring (Otomatis)</label>
                        <input type="text" id="recProgress" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-black/50 text-pink-400 cursor-not-allowed">
                    </div>
                </div>
            </div>
        </form>
        `;
    }
 // --- LOGIKA RECRUITMENT TRACKER ---
    
    function calculateHiringProgress() {
        const target = parseFloat(document.getElementById('recTarget').value) || 1;
        const hired = tempSubRecruits.filter(s => s.status === 'Lolos (Hired)').length;
        
        const el = document.getElementById('recProgress');
        if(el) el.value = `${hired} dari ${target} Posisi Terisi`;
        return hired;
    }

    function addSubRecruit() {
        const name = document.getElementById('recSubName').value;
        
        if(!name) return alert("Nama Kandidat wajib diisi!");

        const newSub = {
            id: generateId(),
            name: name,
            stage: document.getElementById('recSubStage').value,
            score: document.getElementById('recSubScore').value || '0',
            status: document.getElementById('recSubStatus').value
        };

        tempSubRecruits.push(newSub);
        renderSubRecruitTable();
        calculateHiringProgress();
        
        // Reset Inputs
        document.getElementById('recSubName').value = '';
        document.getElementById('recSubScore').value = '';
    }

    function removeSubRecruit(id) {
        tempSubRecruits = tempSubRecruits.filter(s => s.id !== id);
        renderSubRecruitTable();
        calculateHiringProgress();
    }

    function renderSubRecruitTable() {
        const tbody = document.getElementById('recSubListBody');
        const emptyDiv = document.getElementById('recSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubRecruits.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubRecruits.forEach(s => {
                // Warna Status & Badge
                let statusClass = 'bg-slate-700 text-slate-300';
                if(s.status === 'Lolos (Hired)') statusClass = 'bg-emerald-500 text-black font-bold shadow-[0_0_10px_rgba(16,185,129,0.5)]';
                else if(s.status === 'Gugur') statusClass = 'bg-red-500 text-white shadow-[0_0_10px_rgba(239,68,68,0.5)]';
                else if(s.status === 'In Process') statusClass = 'bg-blue-500 text-white';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.name}</td>
                    <td class="p-3 text-xs text-slate-300">${s.stage}</td>
                    <td class="p-3 text-center text-xs text-pink-300 font-mono font-bold">${s.score}</td>
                    <td class="p-3 text-center"><span class="text-[10px] px-2 py-1 rounded uppercase ${statusClass}">${s.status}</span></td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubRecruit('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateRecruitmentForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('recPosition', p.recPosition); setVal('recCode', p.recCode); 
        setVal('recDept', p.recDept); setVal('recManager', p.recManager);
        setVal('recOpenDate', p.recOpenDate); setVal('recCloseDate', p.recCloseDate);
        setVal('recStatus', p.status); setVal('recTarget', p.recTarget);
        setVal('recQual', p.recQual);
        setVal('recDocLink', p.recDocLink); setVal('recImage', p.image);

        tempSubRecruits = p.subRecruits || [];
        renderSubRecruitTable();
        calculateHiringProgress();
    }
function createRecruitmentCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.recImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Data counts (disimpan jika ingin ditampilkan di tempat lain, tapi bar visual dihapus)
        const target = parseInt(p.recTarget || 1);
        const hired = parseInt(p.recHiredCount || 0);

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-pink-500 shadow-lg tracking-wider border border-pink-400 shadow-pink-500/20">HIRING</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-pink-400 font-bold uppercase tracking-wider border border-pink-500/30 px-2 py-0.5 rounded bg-pink-500/10">
                        ${p.recCode || 'JOB-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-pink-300 transition-colors tracking-tight">${p.recPosition}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.recQual || 'Belum ada kualifikasi spesifik.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.recManager ? p.recManager.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Hiring Mgr</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.recManager || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-pink-200 bg-pink-500/10 px-3 py-1.5 rounded-lg border border-pink-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-building-user text-[9px]"></i> ${p.recDept || '-'}
                    </div>
                </div>
            </div>
        `;
        return div;
    } 
    function getRecruitmentDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.recImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        
        const hiredCount = parseInt(p.recHiredCount || 0);
        const target = parseInt(p.recTarget || 1);

        const subRows = (p.subRecruits || []).map(s => {
            let statusClass = 'text-slate-400';
            if(s.status === 'Lolos (Hired)') statusClass = 'text-emerald-400 font-bold';
            else if(s.status === 'Gugur') statusClass = 'text-red-400';
            else statusClass = 'text-blue-400';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.name}</td>
                <td class="p-3 text-center text-xs text-slate-300 bg-white/5">${s.stage}</td>
                <td class="p-3 text-center text-xs text-pink-300 font-bold">${s.score}</td>
                <td class="p-3 text-center text-xs ${statusClass}">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-pink-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-pink-200 text-[10px] uppercase tracking-widest border border-pink-500/30">RECRUITMENT</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.recCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.recPosition}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-briefcase text-pink-500"></i> Dept: ${p.recDept || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-pink-500"></i> Manager: ${p.recManager || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Target Hiring</span>
                            <span class="text-xl font-bold text-white">${target} Orang</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Sudah Diterima (Hired)</span>
                            <span class="text-2xl font-bold text-pink-400 font-mono">${hiredCount}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-pink-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Kualifikasi & Requirements</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.recQual || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-pink-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-users-viewfinder"></i> Pipeline Kandidat</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-pink-900/20 text-pink-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Nama Kandidat</th><th class="p-3 text-center">Tahapan</th><th class="p-3 text-center">Skor</th><th class="p-3 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada kandidat.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Jadwal Seleksi</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuka</span><div class="text-right"><div class="text-white">${formatDate(p.recOpenDate)}</div></div></li>
                            <li class="flex justify-between items-start text-xs"><span class="text-slate-500 mt-1">Target Tutup</span><div class="text-right"><div class="text-white">${formatDate(p.recCloseDate)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.recDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-pink-500/50 hover:bg-pink-500/10 transition text-xs text-pink-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-pdf group-hover:scale-110 transition"></i> Job Description</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }  
  function getAppraisalFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="Appraisal">

            <div class="space-y-4">
                <h3 class="text-indigo-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Data Karyawan & Reviewer</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Karyawan *</label>
                        <input type="text" id="aprName" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Nama Lengkap">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">NIK / Employee ID</label><input type="text" id="aprId" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="EMP-001"></div>
                    
                    <div><label class="block text-xs text-indigo-300 mb-1">Posisi / Jabatan</label><input type="text" id="aprPosition" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Departemen</label><input type="text" id="aprDept" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div><label class="block text-xs text-indigo-300 mb-1">Penilai (Reviewer)</label><input type="text" id="aprReviewer" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Periode Review</label>
                        <select id="aprPeriod" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="H1-2026">H1 2026 (Jan-Jun)</option>
                            <option value="H2-2026">H2 2026 (Jul-Des)</option>
                            <option value="Annual-2026">Annual 2026</option>
                            <option value="Probation">Probation</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="aprStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="In Review">In Review</option>
                            <option value="Discussed">Discussed (Sudah Diskusi)</option>
                            <option value="Finalized">Finalized (Selesai)</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Review</label><input type="date" id="aprDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-indigo-400 font-bold uppercase text-xs tracking-widest">B. Kompetensi & Perilaku</h3>
                    <span class="text-[10px] text-slate-500 italic">Core Competencies & Values</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Kompetensi (Leadership/Teamwork, dll)</label><input type="text" id="aprSubComp" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Problem Solving"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-indigo-300 mb-1">Skor (1-5)</label><input type="number" id="aprSubScore" class="glass-input w-full px-3 py-2 rounded text-xs" min="1" max="5" placeholder="0"></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Target Pengembangan</label><input type="text" id="aprSubTarget" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Training/Mentoring..."></div>
                    
                    <div class="md:col-span-12"><label class="block text-[10px] text-slate-400 mb-1">Feedback / Bukti Perilaku</label><input type="text" id="aprSubFeed" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Contoh perilaku yang diamati..."></div>

                    <button type="button" onclick="addSubAppraisal()" class="md:col-span-12 bg-indigo-600 hover:bg-indigo-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Kompetensi
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-indigo-900/30 text-indigo-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Kompetensi</th>
                                <th class="p-3 border-b border-white/10 text-center">Skor</th>
                                <th class="p-3 border-b border-white/10">Feedback</th>
                                <th class="p-3 border-b border-white/10">Target Pengembangan</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="aprSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="aprSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada kompetensi dinilai.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-indigo-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Kesimpulan Akhir</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs text-indigo-300 font-bold mb-1">Rata-rata Skor (Otomatis)</label>
                        <input type="text" id="aprFinalScore" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-black/50 text-white cursor-not-allowed">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen Tanda Tangan</label><input type="text" id="aprDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image (Foto Profil)</label><input type="text" id="aprImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Komentar Akhir Penilai</label><textarea id="aprFinalComment" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
  // --- LOGIKA PERFORMANCE APPRAISAL ---
    
    function calculateAppraisalScore() {
        if (tempSubAppraisals.length === 0) {
            document.getElementById('aprFinalScore').value = '0.0';
            return 0;
        }

        let total = 0;
        tempSubAppraisals.forEach(s => {
            total += parseFloat(s.score) || 0;
        });
        
        const avg = (total / tempSubAppraisals.length).toFixed(2);
        const el = document.getElementById('aprFinalScore');
        if(el) el.value = avg + ' / 5.0';
        return avg;
    }

    function addSubAppraisal() {
        const comp = document.getElementById('aprSubComp').value;
        const score = parseFloat(document.getElementById('aprSubScore').value) || 0;
        
        if(!comp) return alert("Kompetensi wajib diisi!");
        if(score < 1 || score > 5) return alert("Skor harus antara 1 sampai 5!");

        const newSub = {
            id: generateId(),
            comp: comp,
            score: score,
            feed: document.getElementById('aprSubFeed').value || '-',
            target: document.getElementById('aprSubTarget').value || '-'
        };

        tempSubAppraisals.push(newSub);
        renderSubAppraisalTable();
        calculateAppraisalScore();
        
        // Reset Inputs
        document.getElementById('aprSubComp').value = '';
        document.getElementById('aprSubScore').value = '';
        document.getElementById('aprSubFeed').value = '';
        document.getElementById('aprSubTarget').value = '';
    }

    function removeSubAppraisal(id) {
        tempSubAppraisals = tempSubAppraisals.filter(s => s.id !== id);
        renderSubAppraisalTable();
        calculateAppraisalScore();
    }

    function renderSubAppraisalTable() {
        const tbody = document.getElementById('aprSubListBody');
        const emptyDiv = document.getElementById('aprSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubAppraisals.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubAppraisals.forEach(s => {
                // Warna Skor
                let scoreColor = 'text-red-400';
                if(s.score >= 4) scoreColor = 'text-emerald-400 font-bold';
                else if(s.score >= 3) scoreColor = 'text-indigo-300';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.comp}</td>
                    <td class="p-3 text-center text-xs font-mono text-lg ${scoreColor}">${s.score}</td>
                    <td class="p-3 text-xs text-slate-400 italic">${s.feed}</td>
                    <td class="p-3 text-xs text-indigo-300">${s.target}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubAppraisal('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
function getAppraisalDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.aprImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.aprName)}&background=312e81&color=fff&size=500`;
        const score = p.aprAvgScore || '0.0';

        const subRows = (p.subAppraisals || []).map(s => {
            let scoreColor = 'text-slate-400';
            if(s.score >= 4) scoreColor = 'text-emerald-400 font-bold';
            else if(s.score >= 3) scoreColor = 'text-indigo-300';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.comp}</td>
                <td class="p-3 text-center text-lg font-mono ${scoreColor}">${s.score}</td>
                <td class="p-3 text-xs text-slate-400 italic">${s.feed}</td>
                <td class="p-3 text-xs text-indigo-300">${s.target}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-indigo-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-indigo-200 text-[10px] uppercase tracking-widest border border-indigo-500/30">APPRAISAL</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.aprPeriod || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-2 drop-shadow-2xl">${p.aprName}</h1>
                    <p class="text-lg text-indigo-300 mb-4">${p.aprPosition} <span class="text-slate-500 text-sm mx-2">|</span> ${p.aprDept}</p>
                    
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-pen text-indigo-500"></i> Reviewer: ${p.aprReviewer || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-day text-indigo-500"></i> Date: ${formatDate(p.aprDate)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Rata-rata Kompetensi</span>
                            <span class="text-3xl font-bold text-white font-mono">${score} <span class="text-sm text-slate-500">/ 5.0</span></span>
                            <div class="absolute top-0 right-0 p-3 opacity-10 text-indigo-500 text-4xl"><i class="fa-solid fa-star"></i></div>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Jumlah Kompetensi</span>
                            <span class="text-xl font-bold text-white">${(p.subAppraisals || []).length} Item</span>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-indigo-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Detail Penilaian</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-indigo-900/20 text-indigo-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Kompetensi</th><th class="p-3 text-center">Skor</th><th class="p-3">Feedback</th><th class="p-3">Target Dev</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada penilaian.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-indigo-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-indigo-300 font-bold text-xs uppercase mb-2">Komentar Penilai</h4>
                        <p class="text-slate-400 text-sm italic">"${p.aprFinalComment || 'Tidak ada komentar.'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Identitas</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">ID Karyawan</span><span class="text-indigo-300 text-right font-bold">${p.aprId || '-'}</span></li>
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Departemen</span><span class="text-slate-200 text-right">${p.aprDept || '-'}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.aprDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-indigo-500/50 hover:bg-indigo-500/10 transition text-xs text-indigo-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-signature group-hover:scale-110 transition"></i> Dokumen Final</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    // --- INTEGRASI POPULATE & SAVE ---
function createAppraisalCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.aprImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.aprName)}&background=312e81&color=fff&size=500`;
        const statusClass = getStatusColor(p.status);
        const score = p.aprAvgScore || '0.0';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-indigo-600 shadow-lg tracking-wider border border-indigo-500 shadow-indigo-500/20">PA</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-indigo-400 font-bold uppercase tracking-wider border border-indigo-500/30 px-2 py-0.5 rounded bg-indigo-500/10">
                        ${p.aprPeriod || 'Period?'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-1 truncate group-hover:text-indigo-300 transition-colors tracking-tight">${p.aprName}</h3>
                <p class="text-xs text-slate-400 mb-4 truncate">${p.aprPosition || '-'}</p>
                
                <div class="mb-4 flex items-center gap-2">
                    <div class="text-2xl font-bold text-white font-mono">${score}</div>
                    <div class="text-[10px] text-slate-500 uppercase font-bold mt-2">Avg Score</div>
                </div>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.aprReviewer ? p.aprReviewer.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Reviewer</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.aprReviewer || '-'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function populateAppraisalForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('aprName', p.aprName); setVal('aprId', p.aprId); 
        setVal('aprPosition', p.aprPosition); setVal('aprDept', p.aprDept);
        setVal('aprReviewer', p.aprReviewer); setVal('aprPeriod', p.aprPeriod);
        setVal('aprStatus', p.status); setVal('aprDate', p.aprDate);
        setVal('aprDocLink', p.aprDocLink); setVal('aprImage', p.image);
        setVal('aprFinalComment', p.aprFinalComment);

        tempSubAppraisals = p.subAppraisals || [];
        renderSubAppraisalTable();
        calculateAppraisalScore();
    }

    // --- DI DALAM FUNGSI saveProject TAMBAHKAN INI ---
    /* 
    */
  
  
  function getTrainingFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="Training">

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Detail Pelatihan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul Training *</label>
                        <input type="text" id="trnTitle" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Advanced Leadership Workshop">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Training</label><input type="text" id="trnCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="TRN-2026-HR-01"></div>
                    
                    <div><label class="block text-xs text-cyan-300 mb-1">Trainer / Fasilitator</label><input type="text" id="trnTrainer" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Lokasi (Onsite/Online)</label><input type="text" id="trnLocation" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Mulai</label><input type="date" id="trnStartDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Selesai</label><input type="date" id="trnEndDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Pelaksanaan</label>
                        <select id="trnStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Planned">Planned (Direncanakan)</option>
                            <option value="In Progress">In Progress (Berjalan)</option>
                            <option value="Completed">Completed (Selesai)</option>
                            <option value="Canceled">Canceled (Batal)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Anggaran (Budget)</label>
                        <input type="number" id="trnBudget" class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-cyan-400" placeholder="0">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Tujuan Pembelajaran (Learning Objective)</label><textarea id="trnObjective" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest">B. Silabus & Sesi</h3>
                    <span class="text-[10px] text-slate-500 italic">Rincian materi dan peserta</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-5"><label class="block text-[10px] text-slate-400 mb-1">Nama Sesi / Materi</label><input type="text" id="trnSubSession" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Durasi (Jam)</label><input type="number" id="trnSubDuration" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="0"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Peserta Wajib</label><input type="text" id="trnSubParticipants" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Divisi/Nama"></div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Status</label>
                        <select id="trnSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Wajib">Wajib</option>
                            <option value="Opsional">Opsional</option>
                            <option value="Selesai">Selesai</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubTraining()" class="md:col-span-12 bg-cyan-600 hover:bg-cyan-500 text-black py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-cyan-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Sesi
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-cyan-900/30 text-cyan-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Sesi / Materi</th>
                                <th class="p-3 border-b border-white/10 text-center">Durasi</th>
                                <th class="p-3 border-b border-white/10">Peserta</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="trnSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="trnSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada sesi materi.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Modul / Materi</label><input type="text" id="trnDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="trnImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Total Durasi (Otomatis)</label>
                        <input type="text" id="trnTotalHours" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-black/50 text-white cursor-not-allowed">
                    </div>
                </div>
            </div>
        </form>
        `;
    }
  // --- LOGIKA TRAINING (LMS) ---
    
    function calculateTrainingHours() {
        let total = 0;
        tempSubTrainings.forEach(s => {
            total += parseFloat(s.duration) || 0;
        });
        
        const el = document.getElementById('trnTotalHours');
        if(el) el.value = total + ' Jam';
        return total;
    }

    function addSubTraining() {
        const session = document.getElementById('trnSubSession').value;
        const duration = parseFloat(document.getElementById('trnSubDuration').value) || 0;
        
        if(!session) return alert("Nama Sesi wajib diisi!");

        const newSub = {
            id: generateId(),
            session: session,
            duration: duration,
            participants: document.getElementById('trnSubParticipants').value || '-',
            status: document.getElementById('trnSubStatus').value
        };

        tempSubTrainings.push(newSub);
        renderSubTrainingTable();
        calculateTrainingHours();
        
        // Reset Inputs
        document.getElementById('trnSubSession').value = '';
        document.getElementById('trnSubDuration').value = '';
        document.getElementById('trnSubParticipants').value = '';
    }

    function removeSubTraining(id) {
        tempSubTrainings = tempSubTrainings.filter(s => s.id !== id);
        renderSubTrainingTable();
        calculateTrainingHours();
    }

    function renderSubTrainingTable() {
        const tbody = document.getElementById('trnSubListBody');
        const emptyDiv = document.getElementById('trnSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubTrainings.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubTrainings.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium">${s.session}</td>
                    <td class="p-3 text-center text-xs text-cyan-300 font-mono">${s.duration} Jam</td>
                    <td class="p-3 text-xs text-slate-400">${s.participants}</td>
                    <td class="p-3 text-center text-xs text-white bg-white/5 rounded">${s.status}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubTraining('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateTrainingForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('trnTitle', p.trnTitle); setVal('trnCode', p.trnCode); 
        setVal('trnTrainer', p.trnTrainer); setVal('trnLocation', p.trnLocation);
        setVal('trnStartDate', p.trnStartDate); setVal('trnEndDate', p.trnEndDate);
        setVal('trnStatus', p.status); setVal('trnBudget', p.trnBudget);
        setVal('trnObjective', p.trnObjective);
        setVal('trnDocLink', p.trnDocLink); setVal('trnImage', p.image);

        tempSubTrainings = p.subTrainings || [];
        renderSubTrainingTable();
        calculateTrainingHours();
    }
function createTrainingCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.trnImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const budgetDisplay = parseInt(p.trnBudget || 0).toLocaleString('id-ID');

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-cyan-400 shadow-lg tracking-wider border border-cyan-300 shadow-cyan-500/20">LMS</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-cyan-400 font-bold uppercase tracking-wider border border-cyan-500/30 px-2 py-0.5 rounded bg-cyan-500/10">
                        ${p.trnCode || 'TRN-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-cyan-300 transition-colors tracking-tight">${p.trnTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.trnObjective || 'Tidak ada tujuan pembelajaran.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.trnTrainer ? p.trnTrainer.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Trainer</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.trnTrainer || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <span class="text-[9px] text-cyan-500 uppercase tracking-wider font-bold mb-0.5 block">Budget</span>
                        <span class="text-sm font-bold text-white font-mono">Rp ${budgetDisplay}</span>
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getTrainingDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.trnImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        const budgetDisplay = parseInt(p.trnBudget || 0).toLocaleString('id-ID');

        const subRows = (p.subTrainings || []).map(s => `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.session}</td>
                <td class="p-3 text-center text-xs text-cyan-300 font-mono">${s.duration} Jam</td>
                <td class="p-3 text-xs text-slate-400">${s.participants}</td>
                <td class="p-3 text-center text-xs text-white bg-white/5">${s.status}</td>
            </tr>`).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-cyan-600 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-cyan-200 text-[10px] uppercase tracking-widest border border-cyan-500/30">TRAINING</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.trnCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.trnTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-chalkboard-user text-cyan-500"></i> Trainer: ${p.trnTrainer || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-location-dot text-cyan-500"></i> Lokasi: ${p.trnLocation || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Total Durasi</span>
                            <span class="text-xl font-bold text-white">${p.trnTotalHours || 0} Jam</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Anggaran</span>
                            <span class="text-2xl font-bold text-cyan-400 font-mono">Rp ${budgetDisplay}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-cyan-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> Tujuan Pembelajaran</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.trnObjective || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-cyan-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-ol"></i> Silabus & Sesi</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-cyan-900/20 text-cyan-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Sesi / Materi</th><th class="p-3 text-center">Durasi</th><th class="p-3">Peserta</th><th class="p-3 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada sesi.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Jadwal Training</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Mulai</span><div class="text-right"><div class="text-white">${formatDate(p.trnStartDate)}</div></div></li>
                            <li class="flex justify-between items-start text-xs"><span class="text-slate-500 mt-1">Selesai</span><div class="text-right"><div class="text-white">${formatDate(p.trnEndDate)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.trnDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-cyan-500/50 hover:bg-cyan-500/10 transition text-xs text-cyan-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-book-open group-hover:scale-110 transition"></i> Materi / Modul</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
  function getChangeRequestDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.crImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        const costDisplay = parseInt(p.crTotalCost || 0).toLocaleString('id-ID');

        const subRows = (p.subCRs || []).map(s => `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-3 text-white font-medium">${s.comp}</td>
                <td class="p-3 text-xs text-slate-400 italic">${s.impact}</td>
                <td class="p-3 text-right text-sm text-fuchsia-300 font-mono">Rp ${parseInt(s.cost).toLocaleString('id-ID')}</td>
            </tr>`).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-fuchsia-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-fuchsia-200 text-[10px] uppercase tracking-widest border border-fuchsia-500/30">CHANGE REQ</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.crCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.crTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-pen text-fuchsia-500"></i> Requestor: ${p.crRequestor || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-folder-tree text-fuchsia-500"></i> Project: ${p.crProject || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Jumlah Dampak</span>
                            <span class="text-xl font-bold text-white">${(p.subCRs || []).length} Komponen</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Biaya Tambahan</span>
                            <span class="text-2xl font-bold text-fuchsia-400 font-mono">Rp ${costDisplay}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-fuchsia-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Alasan Perubahan</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.crReason || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Analisis Dampak</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-fuchsia-900/20 text-fuchsia-200 text-[10px] uppercase font-bold"><tr><th class="p-3">Komponen</th><th class="p-3">Dampak</th><th class="p-3 text-right">Biaya</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="3" class="p-4 text-center italic text-slate-500 text-xs">Belum ada analisis.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-fuchsia-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-fuchsia-300 font-bold text-xs uppercase mb-2">Catatan Approver</h4>
                        <p class="text-slate-400 text-sm italic">"${p.crApproverNotes || 'Menunggu review.'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Status & Waktu</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Diajukan Pada</span><div class="text-right"><div class="text-white">${formatDate(p.crDate)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.crDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-fuchsia-500/50 hover:bg-fuchsia-500/10 transition text-xs text-fuchsia-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-contract group-hover:scale-110 transition"></i> Dokumen CR</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    } 
  function createChangeRequestCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.crImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const costDisplay = parseInt(p.crTotalCost || 0).toLocaleString('id-ID');

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-fuchsia-600 shadow-lg tracking-wider border border-fuchsia-500 shadow-fuchsia-500/20">CHANGE REQ</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-fuchsia-400 font-bold uppercase tracking-wider border border-fuchsia-500/30 px-2 py-0.5 rounded bg-fuchsia-500/10">
                        ${p.crCode || 'CR-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-fuchsia-300 transition-colors tracking-tight">${p.crTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.crReason || 'Tidak ada justifikasi.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex flex-col">
                        <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Requestor</span>
                        <span class="text-xs text-slate-200 font-medium">${p.crRequestor || '-'}</span>
                    </div>
                    
                    <div class="text-right">
                        <span class="text-[9px] text-fuchsia-500 uppercase tracking-wider font-bold mb-0.5 block">Add. Cost</span>
                        <span class="text-sm font-bold text-white font-mono">Rp ${costDisplay}</span>
                    </div>
                </div>
            </div>
        `;
        return div;
    }
  // --- LOGIKA CHANGE REQUEST ---
    
    function calculateCRTotal() {
        let total = 0;
        tempSubCRs.forEach(s => {
            total += parseFloat(s.cost) || 0;
        });
        
        const el = document.getElementById('crTotalCost');
        if(el) el.value = 'Rp ' + total.toLocaleString('id-ID');
        return total;
    }

    function addSubCR() {
        const comp = document.getElementById('crSubComp').value;
        const impact = document.getElementById('crSubImpact').value;
        
        if(!impact) return alert("Deskripsi Dampak wajib diisi!");

        const newSub = {
            id: generateId(),
            comp: comp,
            impact: impact,
            cost: parseFloat(document.getElementById('crSubCost').value) || 0
        };

        tempSubCRs.push(newSub);
        renderSubCRTable();
        calculateCRTotal();
        
        // Reset Inputs
        document.getElementById('crSubImpact').value = '';
        document.getElementById('crSubCost').value = '';
    }

    function removeSubCR(id) {
        tempSubCRs = tempSubCRs.filter(s => s.id !== id);
        renderSubCRTable();
        calculateCRTotal();
    }

    function renderSubCRTable() {
        const tbody = document.getElementById('crSubListBody');
        const emptyDiv = document.getElementById('crSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubCRs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubCRs.forEach(s => {
                // Icon based on component
                let icon = '<i class="fa-solid fa-circle-question"></i>';
                if(s.comp === 'Cost') icon = '<i class="fa-solid fa-coins text-yellow-400"></i>';
                if(s.comp === 'Time') icon = '<i class="fa-solid fa-clock text-blue-400"></i>';
                if(s.comp === 'Scope') icon = '<i class="fa-solid fa-expand text-fuchsia-400"></i>';
                if(s.comp === 'Risk') icon = '<i class="fa-solid fa-triangle-exclamation text-red-400"></i>';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-slate-300 font-medium text-xs flex items-center gap-2">${icon} ${s.comp}</td>
                    <td class="p-3 text-white text-sm">${s.impact}</td>
                    <td class="p-3 text-right text-xs text-fuchsia-300 font-mono">Rp ${parseInt(s.cost).toLocaleString('id-ID')}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10">
                        <button onclick="removeSubCR('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateChangeRequestForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('crTitle', p.crTitle); setVal('crCode', p.crCode); 
        setVal('crRequestor', p.crRequestor); setVal('crProject', p.crProject);
        setVal('crStatus', p.status); setVal('crDate', p.crDate);
        setVal('crReason', p.crReason);
        setVal('crDocLink', p.crDocLink); setVal('crImage', p.image);
        setVal('crApproverNotes', p.crApproverNotes);

        tempSubCRs = p.subCRs || [];
        renderSubCRTable();
        calculateCRTotal();
    }

    function getChangeRequestFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="ChangeRequest">

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Detail Permintaan Perubahan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Judul Perubahan *</label>
                        <input type="text" id="crTitle" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Penambahan Fitur Payment Gateway">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Nomor CR</label><input type="text" id="crCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="CR-2026-001"></div>
                    
                    <div><label class="block text-xs text-fuchsia-300 mb-1">Requestor (Pemohon)</label><input type="text" id="crRequestor" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Proyek Terkait</label><input type="text" id="crProject" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Approval</label>
                        <select id="crStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Submitted">Submitted (Diajukan)</option>
                            <option value="Approved">Approved (Disetujui)</option>
                            <option value="Rejected">Rejected (Ditolak)</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Diajukan</label><input type="date" id="crDate" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Total Biaya Tambahan</label>
                        <input type="text" id="crTotalCost" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-fuchsia-400 cursor-not-allowed" value="Rp 0">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Alasan Perubahan (Justifikasi)</label><textarea id="crReason" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest">B. Analisis Dampak</h3>
                    <span class="text-[10px] text-slate-500 italic">Rincian komponen yang terdampak</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-fuchsia-300 mb-1">Komponen</label>
                        <select id="crSubComp" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Scope">Scope (Lingkup)</option>
                            <option value="Cost">Cost (Biaya)</option>
                            <option value="Time">Time (Waktu)</option>
                            <option value="Quality">Quality (Mutu)</option>
                            <option value="Risk">Risk (Risiko)</option>
                        </select>
                    </div>
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Deskripsi Dampak</label><input type="text" id="crSubImpact" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Penjelasan dampak..."></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Biaya Tambahan (Rp)</label><input type="number" id="crSubCost" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="0"></div>

                    <button type="button" onclick="addSubCR()" class="md:col-span-12 bg-fuchsia-600 hover:bg-fuchsia-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-fuchsia-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-magnifying-glass-chart mr-1"></i> Tambah Analisis
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-fuchsia-900/30 text-fuchsia-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10">Komponen</th>
                                <th class="p-3 border-b border-white/10">Analisis Dampak</th>
                                <th class="p-3 border-b border-white/10 text-right">Biaya Tambahan</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="crSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="crSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada analisis dampak.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-fuchsia-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Persetujuan & Dokumen</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen CR</label><input type="text" id="crDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="crImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Approver</label><textarea id="crApproverNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
  function getKPADetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.kpaImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.kpaName)}&background=581c87&color=fff&size=800`;
        const score = p.kpaFinalScore || 0;

        let scoreClass = 'text-red-400';
        if(score >= 90) scoreClass = 'text-purple-400';
        else if(score >= 75) scoreClass = 'text-emerald-400';
        else if(score >= 60) scoreClass = 'text-yellow-400';

        const subRows = (p.subKPAs || []).map(s => {
            const weightedVal = ((s.score * s.weight) / 100).toFixed(2);
            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.area}</td>
                <td class="p-4 text-sm text-slate-300 align-top">${s.indicator}</td>
                <td class="p-4 text-center text-sm text-purple-300 font-mono align-top">${s.weight}%</td>
                <td class="p-4 text-center text-sm font-bold text-white font-mono align-top bg-white/5">${s.score}</td>
                <td class="p-4 text-right text-sm text-slate-400 font-mono align-top">${weightedVal}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.kpaName)}&background=581c87&color=fff&size=800'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-purple-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-purple-200 text-[10px] uppercase tracking-widest border border-purple-500/30">KPA</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.kpaPeriod || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-2 drop-shadow-2xl">${p.kpaName}</h1>
                    <p class="text-xl text-purple-300 mb-4">${p.kpaJobTitle || '-'}</p>
                    
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-purple-500"></i> Evaluator: ${p.kpaSupervisor || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-check text-purple-500"></i> Date: ${formatDate(p.createdAt)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-purple-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-briefcase"></i> Ringkasan Tanggung Jawab</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.kpaDesc || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-purple-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-ol"></i> Detail Penilaian</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-purple-900/20 text-purple-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/3">Area Kinerja</th><th class="p-4">Indikator</th><th class="p-4 text-center">Bobot</th><th class="p-4 text-center">Nilai</th><th class="p-4 text-right">Total</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada penilaian.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-purple-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-purple-300 font-bold text-xs uppercase mb-2">Feedback & Komentar</h4>
                        <p class="text-slate-400 text-sm italic">"${p.kpaFeedback || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6 relative overflow-hidden text-center">
                        <span class="text-xs text-slate-500 uppercase tracking-widest block mb-2">Final Weighted Score</span>
                        <div class="text-6xl font-bold ${scoreClass} mb-2 drop-shadow-lg">${score}</div>
                        <div class="text-xs text-slate-400">Scale 0 - 100</div>
                    </div>

                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Lampiran</h3>
                        <div class="space-y-3">
                             <a href="${p.kpaDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-purple-500/50 hover:bg-purple-500/10 transition text-xs text-purple-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-folder-open group-hover:scale-110 transition"></i> Bukti Kinerja</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    function createKPACard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.kpaImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.kpaName)}&background=581c87&color=fff&size=500`;
        const statusClass = getStatusColor(p.status);
        const score = p.kpaFinalScore || 0;

        // Score Badge Color
        let scoreBg = 'bg-slate-700 text-slate-300';
        if (score >= 90) scoreBg = 'bg-purple-500 text-white shadow-purple-500/50';
        else if (score >= 75) scoreBg = 'bg-emerald-500 text-white';
        else if (score >= 60) scoreBg = 'bg-yellow-500 text-black';
        else scoreBg = 'bg-red-500 text-white';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-purple-600 shadow-lg tracking-wider border border-purple-500 shadow-purple-500/20">KPA</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-purple-400 font-bold uppercase tracking-wider border border-purple-500/30 px-2 py-0.5 rounded bg-purple-500/10">
                        ${p.kpaPeriod || 'Period?'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-1 truncate group-hover:text-purple-300 transition-colors tracking-tight">${p.kpaName}</h3>
                <p class="text-xs text-slate-400 mb-4 truncate">${p.kpaJobTitle || 'No Title'}</p>
                
                <div class="mb-4 flex items-center justify-between bg-white/5 p-3 rounded-lg border border-white/5">
                    <span class="text-xs text-slate-400">Performance Score</span>
                    <span class="text-xl font-bold px-3 py-1 rounded-lg ${scoreBg} shadow-lg">${score}</span>
                </div>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.kpaSupervisor ? p.kpaSupervisor.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Penilai</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.kpaSupervisor || '-'}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- LOGIKA KPA FRAMEWORK ---
    
    function calculateKPAScore() {
        let totalWeight = 0;
        let finalScore = 0;

        tempSubKPAs.forEach(s => {
            const w = parseFloat(s.weight) || 0;
            const sc = parseFloat(s.score) || 0;
            totalWeight += w;
            finalScore += (sc * w) / 100;
        });
        
        // Update UI Summary Table
        const elWeight = document.getElementById('kpaTotalWeight');
        const elScoreDisplay = document.getElementById('kpaTotalScoreDisplay');
        const elFinalInput = document.getElementById('kpaFinalScore');

        if(elWeight) {
            elWeight.innerText = totalWeight + '%';
            elWeight.className = `p-3 text-center ${totalWeight === 100 ? 'text-emerald-400' : 'text-red-400'}`;
        }
        if(elScoreDisplay) elScoreDisplay.innerText = finalScore.toFixed(2);
        if(elFinalInput) elFinalInput.value = finalScore.toFixed(2);

        return finalScore;
    }

    function addSubKPA() {
        const area = document.getElementById('kpaSubArea').value;
        const weight = parseFloat(document.getElementById('kpaSubWeight').value) || 0;
        const score = parseFloat(document.getElementById('kpaSubScore').value) || 0;
        
        if(!area) return alert("Area Kinerja wajib diisi!");
        if(weight <= 0) return alert("Bobot harus lebih dari 0!");

        const newSub = {
            id: generateId(),
            area: area,
            indicator: document.getElementById('kpaSubInd').value || '-',
            weight: weight,
            score: score
        };

        tempSubKPAs.push(newSub);
        renderSubKPATable();
        calculateKPAScore();
        
        // Reset Inputs
        document.getElementById('kpaSubArea').value = '';
        document.getElementById('kpaSubInd').value = '';
        document.getElementById('kpaSubWeight').value = '';
        document.getElementById('kpaSubScore').value = '';
    }

    function removeSubKPA(id) {
        tempSubKPAs = tempSubKPAs.filter(s => s.id !== id);
        renderSubKPATable();
        calculateKPAScore();
    }

    function renderSubKPATable() {
        const tbody = document.getElementById('kpaSubListBody');
        const emptyDiv = document.getElementById('kpaSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubKPAs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubKPAs.forEach(s => {
                const weightedVal = ((s.score * s.weight) / 100).toFixed(2);
                
                // Color Score
                let scoreColor = 'text-red-400';
                if(s.score >= 90) scoreColor = 'text-purple-400 font-bold';
                else if(s.score >= 75) scoreColor = 'text-emerald-400';
                else if(s.score >= 60) scoreColor = 'text-yellow-400';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.area}</td>
                    <td class="p-3 text-xs text-slate-300 align-top">${s.indicator}</td>
                    <td class="p-3 text-center text-xs text-purple-300 font-mono align-top">${s.weight}%</td>
                    <td class="p-3 text-center text-sm font-mono align-top ${scoreColor}">${s.score}</td>
                    <td class="p-3 text-center text-sm font-bold text-white font-mono align-top bg-white/5">${weightedVal}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubKPA('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateKPAForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('kpaName', p.kpaName); setVal('kpaJobTitle', p.kpaJobTitle);
        setVal('kpaSupervisor', p.kpaSupervisor); setVal('kpaPeriod', p.kpaPeriod); 
        setVal('kpaStatus', p.status); setVal('kpaDesc', p.kpaDesc);
        setVal('kpaDocLink', p.kpaDocLink); setVal('kpaImage', p.image);
        setVal('kpaFeedback', p.kpaFeedback);

        tempSubKPAs = p.subKPAs || [];
        renderSubKPATable();
        calculateKPAScore();
    }

    function getKPAFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="KPA">

            <div class="space-y-4">
                <h3 class="text-purple-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Identitas Penilaian</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Karyawan *</label>
                        <input type="text" id="kpaName" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Nama Lengkap">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Job Title / Jabatan</label><input type="text" id="kpaJobTitle" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Contoh: HR Specialist"></div>
                    
                    <div><label class="block text-xs text-purple-300 mb-1">Atasan Langsung (Penilai)</label><input type="text" id="kpaSupervisor" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Periode Penilaian</label><input type="text" id="kpaPeriod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Semester 1 2026"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="kpaStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Submitted">Submitted (Diajukan)</option>
                            <option value="Reviewed">Reviewed (Dinilai)</option>
                            <option value="Finalized">Finalized (Selesai)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Skor Akhir (Weighted)</label>
                        <input type="text" id="kpaFinalScore" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-purple-400 cursor-not-allowed" value="0.0">
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Ringkasan Tanggung Jawab</label><textarea id="kpaDesc" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Deskripsi singkat peran karyawan ini..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-purple-400 font-bold uppercase text-xs tracking-widest">B. Key Performance Areas</h3>
                    <span class="text-[10px] text-slate-500 italic">Total Bobot harus 100%</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-purple-300 mb-1">Area Kinerja Utama</label><input type="text" id="kpaSubArea" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Contoh: Kedisiplinan / Kualitas Kerja"></div>
                    
                    <div class="md:col-span-8"><label class="block text-[10px] text-slate-400 mb-1">Indikator Keberhasilan</label><input type="text" id="kpaSubInd" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Ukuran sukses..."></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Bobot (%)</label><input type="number" id="kpaSubWeight" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="20"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Nilai (1-100)</label><input type="number" id="kpaSubScore" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="0"></div>

                    <button type="button" onclick="addSubKPA()" class="md:col-span-12 bg-purple-600 hover:bg-purple-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-purple-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus-minus mr-1"></i> Tambah Area Kinerja
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-purple-900/30 text-purple-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/4">Area Kinerja</th>
                                <th class="p-3 border-b border-white/10">Indikator</th>
                                <th class="p-3 border-b border-white/10 text-center">Bobot</th>
                                <th class="p-3 border-b border-white/10 text-center">Nilai</th>
                                <th class="p-3 border-b border-white/10 text-center text-white font-bold">Total</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="kpaSubListBody" class="divide-y divide-white/5"></tbody>
                        <tfoot class="bg-purple-900/10 font-bold text-slate-200">
                            <tr>
                                <td colspan="2" class="p-3 text-right text-xs uppercase tracking-widest">Total Bobot & Nilai:</td>
                                <td class="p-3 text-center text-purple-300" id="kpaTotalWeight">0%</td>
                                <td class="p-3 text-center">-</td>
                                <td class="p-3 text-center text-white text-lg" id="kpaTotalScoreDisplay">0.0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                    <div id="kpaSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada area kinerja.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-purple-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Umpan Balik</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="kpaImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Bukti Kinerja</label><input type="text" id="kpaDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Komentar Penilai</label><textarea id="kpaFeedback" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
  
// --- LOGIKA PIP FRAMEWORK ---
// --- LOGIKA KEY RESULT AREAS (KRA) ---
    
    function calculateKRAScore() {
        let totalWeight = 0;
        let weightedScore = 0;

        tempSubKRAs.forEach(s => {
            const w = parseFloat(s.weight) || 0;
            const r = parseFloat(s.rating) || 0;
            totalWeight += w;
            if(r > 0) {
                // Konversi rating 1-5 ke skor proporsional bobot
                // Jika rating 5 (max), maka dapat full bobot
                weightedScore += (w * (r / 5)); 
            }
        });
        
        // Update UI Total Bobot
        const elWeight = document.getElementById('kraTotalWeight');
        if(elWeight) {
            elWeight.value = totalWeight + '%';
            elWeight.style.color = totalWeight === 100 ? '#4ade80' : (totalWeight > 100 ? '#f87171' : '#fbbf24');
        }

        // Update UI Final Score (Skala 0 - 100)
        const elScore = document.getElementById('kraFinalScore');
        if(elScore) elScore.value = weightedScore.toFixed(1) + ' / 100';
        
        return { totalWeight, weightedScore };
    }
    function addSubKRA() {
        const task = document.getElementById('kraSubTask').value;
        const weight = parseFloat(document.getElementById('kraSubWeight').value) || 0;
        
        if(!task) return alert("Key Task wajib diisi!");
        if(weight <= 0) return alert("Bobot harus lebih dari 0!");

        const newSub = {
            id: generateId(),
            task: task,
            weight: weight,
            target: document.getElementById('kraSubTarget').value || '-',
            metric: document.getElementById('kraSubMetric').value || '-',
            rating: document.getElementById('kraSubRating').value || 0
        };

        tempSubKRAs.push(newSub);
        renderSubKRATable();
        calculateKRAScore();
        
        // Reset Inputs
        document.getElementById('kraSubTask').value = '';
        document.getElementById('kraSubWeight').value = '';
        document.getElementById('kraSubTarget').value = '';
        document.getElementById('kraSubMetric').value = '';
        document.getElementById('kraSubRating').value = '';
    }
    function removeSubKRA(id) {
        tempSubKRAs = tempSubKRAs.filter(s => s.id !== id);
        renderSubKRATable();
        calculateKRAScore();
    }
    function renderSubKRATable() {
        const tbody = document.getElementById('kraSubListBody');
        const emptyDiv = document.getElementById('kraSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubKRAs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubKRAs.forEach(s => {
                // Visual Rating
                let ratingDisplay = '-';
                if(s.rating > 0) {
                    let starColor = s.rating >= 4 ? 'text-blue-400' : (s.rating >= 3 ? 'text-yellow-400' : 'text-red-400');
                    ratingDisplay = `<span class="font-bold ${starColor}">${s.rating}</span> <span class="text-xs text-slate-500">/5</span>`;
                }

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top">${s.task}</td>
                    <td class="p-3 text-center text-xs text-blue-300 font-bold align-top">${s.weight}%</td>
                    <td class="p-3 text-xs text-slate-300 align-top">${s.target}</td>
                    <td class="p-3 text-xs text-slate-400 italic align-top">${s.metric}</td>
                    <td class="p-3 text-center text-sm align-top">${ratingDisplay}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubKRA('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }


// --- LOGIKA CSF FRAMEWORK ---
    function getCSFFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="CSF">

            <div class="space-y-4">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Strategic Goal</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Strategic Goal (Tujuan Besar) *</label>
                        <input type="text" id="csfGoal" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Zero Downtime selama Black Friday">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode CSF</label><input type="text" id="csfCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="CSF-2026-OPS"></div>
                    
                    <div class="col-span-2 md:col-span-2"><label class="block text-xs text-amber-300 mb-1">Misi Terkait</label><input type="text" id="csfMission" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Misi perusahaan yang didukung..."></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Tingkat Urgensi</label>
                        <select id="csfUrgency" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="High">High (Sangat Mendesak)</option>
                            <option value="Medium">Medium (Penting)</option>
                            <option value="Low">Low (Rutin)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Keseluruhan</label>
                        <select id="csfStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Safe">Safe (Aman)</option>
                            <option value="Watchlist">Watchlist (Pantau)</option>
                            <option value="Critical">Critical (Bahaya)</option>
                        </select>
                    </div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Periode Pantau</label><input type="text" id="csfPeriod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Q1 2026"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">PIC Utama</label><input type="text" id="csfOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest">B. Key Success Factors</h3>
                    <span class="text-[10px] text-slate-500 italic">Faktor penentu keberhasilan</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-5"><label class="block text-[10px] text-amber-300 mb-1">Success Factor</label><input type="text" id="csfSubFactor" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Faktor kunci..."></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">KPI Pengukur</label><input type="text" id="csfSubKPI" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Target</label><input type="text" id="csfSubTarget" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-[10px] text-slate-400 mb-1">Status</label>
                        <select id="csfSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Safe">Safe</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubCSF()" class="md:col-span-12 bg-amber-600 hover:bg-amber-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-amber-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Faktor
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-amber-900/30 text-amber-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Success Factor</th>
                                <th class="p-3 border-b border-white/10">KPI Pengukur</th>
                                <th class="p-3 border-b border-white/10 text-center">Target</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="csfSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="csfSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada faktor sukses.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen Strategi</label><input type="text" id="csfDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="csfImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Analisis</label><textarea id="csfNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
    function addSubCSF() {
        const factor = document.getElementById('csfSubFactor').value;
        const kpi = document.getElementById('csfSubKPI').value;
        
        if(!factor) return alert("Success Factor wajib diisi!");

        const newSub = {
            id: generateId(),
            factor: factor,
            kpi: kpi || '-',
            target: document.getElementById('csfSubTarget').value || '-',
            status: document.getElementById('csfSubStatus').value
        };

        tempSubCSFs.push(newSub);
        renderSubCSFTable();
        
        // Reset Inputs
        document.getElementById('csfSubFactor').value = '';
        document.getElementById('csfSubKPI').value = '';
        document.getElementById('csfSubTarget').value = '';
    }

    function removeSubCSF(id) {
        tempSubCSFs = tempSubCSFs.filter(s => s.id !== id);
        renderSubCSFTable();
    }

    function renderSubCSFTable() {
        const tbody = document.getElementById('csfSubListBody');
        const emptyDiv = document.getElementById('csfSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubCSFs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubCSFs.forEach(s => {
                // Warna Status Item
                let statusBadge = 'bg-slate-700 text-slate-300';
                if(s.status === 'Safe') statusBadge = 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30';
                else if(s.status === 'Critical') statusBadge = 'bg-red-500 text-white font-bold animate-pulse shadow-red-500/50';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top">${s.factor}</td>
                    <td class="p-3 text-xs text-slate-300 align-top">${s.kpi}</td>
                    <td class="p-3 text-center text-xs text-amber-300 font-mono align-top">${s.target}</td>
                    <td class="p-3 text-center align-top"><span class="text-[10px] px-2 py-1 rounded uppercase ${statusBadge}">${s.status}</span></td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubCSF('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateCSFForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('csfGoal', p.csfGoal); setVal('csfMission', p.csfMission);
        setVal('csfCode', p.csfCode); setVal('csfUrgency', p.csfUrgency); 
        setVal('csfOwner', p.csfOwner); setVal('csfStatus', p.status); 
        setVal('csfPeriod', p.csfPeriod);
        setVal('csfDocLink', p.csfDocLink); setVal('csfImage', p.image);
        setVal('csfNotes', p.csfNotes);

        tempSubCSFs = p.subCSFs || [];
        renderSubCSFTable();
    }



// --- LOGIKA MBO FRAMEWORK ---
  function getMBOFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="MBO">

            <div class="space-y-4">
                <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Hierarki Tujuan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Corporate Objective (Tujuan Perusahaan) *</label>
                        <input type="text" id="mboCorpObj" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Meningkatkan Efisiensi Operasional Global">
                    </div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Tahun Fiskal</label><input type="number" id="mboYear" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="2026"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode Dokumen</label><input type="text" id="mboCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="MBO-2026-OPS"></div>
                    
                    <div><label class="block text-xs text-slate-300 mb-1">Manager Reviewer</label><input type="text" id="mboReviewer" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-300 mb-1">Karyawan (Assignee)</label><input type="text" id="mboEmployee" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="mboStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Active">Active (Berjalan)</option>
                            <option value="Reviewed">Reviewed (Dinilai)</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Periode Evaluasi</label><input type="text" id="mboPeriod" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Q1 - Q4"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest">B. Individual Objectives</h3>
                    <span class="text-[10px] text-slate-500 italic">Turunan tujuan untuk karyawan</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-slate-300 mb-1">Individual Objective</label><input type="text" id="mboSubObj" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Tujuan spesifik..."></div>
                    
                    <div class="md:col-span-6"><label class="block text-[10px] text-slate-400 mb-1">Standar Evaluasi</label><input type="text" id="mboSubStd" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Kriteria keberhasilan"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Deadline</label><input type="date" id="mboSubDead" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1">Hasil Review</label>
                        <select id="mboSubResult" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Pending">Pending</option>
                            <option value="Met">Met (Tercapai)</option>
                            <option value="Exceeded">Exceeded (Melampaui)</option>
                            <option value="Missed">Missed (Gagal)</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubMBO()" class="md:col-span-12 bg-slate-600 hover:bg-slate-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-slate-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-list-check mr-1"></i> Tambah Objective
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-slate-700/50 text-slate-200 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Objective</th>
                                <th class="p-3 border-b border-white/10">Standar Evaluasi</th>
                                <th class="p-3 border-b border-white/10 text-center">Deadline</th>
                                <th class="p-3 border-b border-white/10 text-center">Hasil</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="mboSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="mboSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada objective.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Persetujuan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen Kontrak</label><input type="text" id="mboDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="mboImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Manager</label><textarea id="mboNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }  
    function addSubMBO() {
        const obj = document.getElementById('mboSubObj').value;
        const std = document.getElementById('mboSubStd').value;
        
        if(!obj) return alert("Objective wajib diisi!");

        const newSub = {
            id: generateId(),
            obj: obj,
            std: std || '-',
            deadline: document.getElementById('mboSubDead').value || '-',
            result: document.getElementById('mboSubResult').value
        };

        tempSubMBOs.push(newSub);
        renderSubMBOTable();
        
        // Reset Inputs
        document.getElementById('mboSubObj').value = '';
        document.getElementById('mboSubStd').value = '';
        document.getElementById('mboSubDead').value = '';
    }

    function removeSubMBO(id) {
        tempSubMBOs = tempSubMBOs.filter(s => s.id !== id);
        renderSubMBOTable();
    }

    function renderSubMBOTable() {
        const tbody = document.getElementById('mboSubListBody');
        const emptyDiv = document.getElementById('mboSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubMBOs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubMBOs.forEach(s => {
                // Warna Hasil
                let resultBadge = 'text-slate-400';
                if(s.result === 'Met') resultBadge = 'text-blue-400 font-bold';
                else if(s.result === 'Exceeded') resultBadge = 'text-emerald-400 font-bold';
                else if(s.result === 'Missed') resultBadge = 'text-red-400 font-bold';

                // Format Tanggal
                const dateDisplay = s.deadline !== '-' ? new Date(s.deadline).toLocaleDateString('id-ID') : '-';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.obj}</td>
                    <td class="p-3 text-xs text-slate-300 align-top">${s.std}</td>
                    <td class="p-3 text-center text-xs text-slate-400 font-mono align-top">${dateDisplay}</td>
                    <td class="p-3 text-center text-xs ${resultBadge} align-top">${s.result}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubMBO('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

 // --- LOGIKA WIGs (4DX) ---
    
    function addSubWIG() {
        const desc = document.getElementById('wigSubDesc').value;
        const type = document.getElementById('wigSubType').value;
        
        if(!desc) return alert("Deskripsi Measure wajib diisi!");

        const newSub = {
            id: generateId(),
            type: type,
            desc: desc,
            target: document.getElementById('wigSubTarget').value || '-',
            score: document.getElementById('wigSubScore').value || '-'
        };

        tempSubWIGs.push(newSub);
        renderSubWIGTable();
        
        // Reset Inputs
        document.getElementById('wigSubDesc').value = '';
        document.getElementById('wigSubTarget').value = '';
        document.getElementById('wigSubScore').value = '';
    }

    function removeSubWIG(id) {
        tempSubWIGs = tempSubWIGs.filter(s => s.id !== id);
        renderSubWIGTable();
    }

    function renderSubWIGTable() {
        const tbody = document.getElementById('wigSubListBody');
        const emptyDiv = document.getElementById('wigSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubWIGs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubWIGs.forEach(s => {
                // Warna Badge Tipe
                let typeBadge = 'bg-slate-700 text-slate-300';
                if(s.type === 'Lead Measure') typeBadge = 'bg-rose-500 text-white font-bold';
                else if(s.type === 'Lag Measure') typeBadge = 'bg-slate-500 text-white italic';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-center align-top"><span class="text-[10px] px-2 py-1 rounded uppercase ${typeBadge}">${s.type}</span></td>
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.desc}</td>
                    <td class="p-3 text-center text-xs text-rose-300 font-mono align-top">${s.target}</td>
                    <td class="p-3 text-center text-xs text-white font-mono align-top font-bold">${s.score}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubWIG('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateWIGForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('wigTitle', p.wigTitle); setVal('wigCode', p.wigCode);
        setVal('wigX', p.wigX); setVal('wigY', p.wigY); setVal('wigWhen', p.wigWhen);
        setVal('wigStatus', p.status); setVal('wigOwner', p.wigOwner); setVal('wigTeam', p.wigTeam);
        setVal('wigSession', p.wigSession); setVal('wigImage', p.image);
        setVal('wigCommitment', p.wigCommitment);

        tempSubWIGs = p.subWIGs || [];
        renderSubWIGTable();
    }

    function getWIGFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="WIG">

            <div class="space-y-4">
                <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">Discipline 1: Focus on the WIG</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">The WIG Statement (Verb) *</label>
                        <input type="text" id="wigTitle" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Meningkatkan Pendapatan Tahunan">
                    </div>
                    
                    <div class="col-span-2 bg-rose-900/20 p-4 rounded-xl border border-rose-500/20 grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-[10px] text-rose-300 font-bold mb-1">From Point X</label>
                            <input type="number" id="wigX" class="glass-input w-full p-2 rounded text-sm text-center" placeholder="0">
                        </div>
                        <div>
                            <label class="block text-[10px] text-rose-300 font-bold mb-1">To Point Y</label>
                            <input type="number" id="wigY" class="glass-input w-full p-2 rounded text-sm text-center" placeholder="100">
                        </div>
                        <div>
                            <label class="block text-[10px] text-rose-300 font-bold mb-1">By When (Deadline)</label>
                            <input type="date" id="wigWhen" class="glass-input w-full p-2 rounded text-sm text-center [color-scheme:dark]">
                        </div>
                    </div>

                    <div><label class="block text-xs text-slate-400 mb-1">Kode WIG</label><input type="text" id="wigCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="WIG-2026-01"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Eksekusi</label>
                        <select id="wigStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="On Track">On Track</option>
                            <option value="Off Track">Off Track</option>
                            <option value="WIG Achieved">WIG Achieved</option>
                        </select>
                    </div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">WIG Owner</label><input type="text" id="wigOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Team / Unit</label><input type="text" id="wigTeam" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest">Discipline 2 & 3: Measures & Scoreboard</h3>
                    <span class="text-[10px] text-slate-500 italic">Lead (Prediktif) & Lag (Hasil)</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-rose-300 mb-1">Tipe Measure</label>
                        <select id="wigSubType" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Lead Measure">Lead Measure (Tindakan)</option>
                            <option value="Lag Measure">Lag Measure (Hasil)</option>
                        </select>
                    </div>
                    <div class="md:col-span-9"><label class="block text-[10px] text-slate-400 mb-1">Deskripsi Ukuran</label><input type="text" id="wigSubDesc" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Contoh: Jumlah prospecting call per hari..."></div>
                    
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Target Mingguan</label><input type="text" id="wigSubTarget" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="10 Calls"></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Scoreboard (Aktual)</label><input type="text" id="wigSubScore" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="8 Calls"></div>
                    
                    <button type="button" onclick="addSubWIG()" class="md:col-span-4 bg-rose-600 hover:bg-rose-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-rose-500/20 mt-5 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Measure
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-rose-900/30 text-rose-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 text-center w-1/6">Tipe</th>
                                <th class="p-3 border-b border-white/10">Deskripsi Measure</th>
                                <th class="p-3 border-b border-white/10 text-center">Target</th>
                                <th class="p-3 border-b border-white/10 text-center">Scoreboard</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="wigSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="wigSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada measure.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">Discipline 4: Accountability</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Jadwal WIG Session</label><input type="text" id="wigSession" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Setiap Senin, 09:00 WIB"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="wigImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Komitmen Minggu Ini</label><textarea id="wigCommitment" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Apa 1 hal yang bisa saya lakukan minggu ini?"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
    // --- INTEGRASI POPULATE & SAVE ---
function createWIGCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.wigImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        const x = p.wigX || 'X';
        const y = p.wigY || 'Y';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-rose-600 shadow-lg tracking-wider border border-rose-500 shadow-rose-500/20">WIG 4DX</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-3">
                    <div class="flex items-center gap-2 justify-between text-xs font-mono font-bold text-rose-300 bg-rose-900/20 p-2 rounded-lg border border-rose-500/20">
                        <span>FROM: ${x}</span>
                        <i class="fa-solid fa-arrow-right-long text-white"></i>
                        <span>TO: ${y}</span>
                    </div>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-rose-300 transition-colors tracking-tight">${p.wigTitle}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-2 leading-relaxed mb-4 min-h-[3rem]">
                    Fokus utama: Menggerakkan lead measures untuk mencapai hasil.
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.wigOwner ? p.wigOwner.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Owner</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.wigOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-rose-200 bg-rose-500/10 px-3 py-1.5 rounded-lg border border-rose-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        <i class="fa-solid fa-users text-[9px]"></i> ${p.wigTeam || 'Team'}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- LOGIKA V2MOM FRAMEWORK ---
    function getWIGDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.wigImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subWIGs || []).map(s => {
            let typeColor = s.type === 'Lead Measure' ? 'text-rose-400 font-bold' : 'text-slate-400 italic';
            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-xs ${typeColor} align-top uppercase tracking-wider">${s.type}</td>
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.desc}</td>
                <td class="p-4 text-center text-sm text-slate-300 font-mono align-top">${s.target}</td>
                <td class="p-4 text-center text-sm text-white font-mono align-top font-bold bg-white/5">${s.score}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-rose-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-rose-200 text-[10px] uppercase tracking-widest border border-rose-500/30">4DX WIG</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.wigCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.wigTitle}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-shield text-rose-500"></i> Owner: ${p.wigOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-people-group text-rose-500"></i> Team: ${p.wigTeam || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="text-center">
                            <span class="block text-[10px] text-slate-500 uppercase tracking-widest mb-1">From Point X</span>
                            <span class="text-3xl font-bold text-slate-400 font-mono">${p.wigX || '0'}</span>
                        </div>
                        <div class="text-rose-500 text-2xl animate-pulse"><i class="fa-solid fa-arrow-right"></i></div>
                        <div class="text-center">
                            <span class="block text-[10px] text-rose-400 uppercase tracking-widest mb-1 font-bold">To Point Y</span>
                            <span class="text-4xl font-bold text-white font-mono">${p.wigY || '0'}</span>
                        </div>
                        <div class="text-slate-600 text-2xl hidden md:block">|</div>
                        <div class="text-center">
                            <span class="block text-[10px] text-slate-500 uppercase tracking-widest mb-1">By When</span>
                            <span class="text-lg font-bold text-rose-300">${formatDate(p.wigWhen)}</span>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-rose-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Players Scoreboard</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-rose-900/20 text-rose-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/6">Type</th><th class="p-4">Measure</th><th class="p-4 text-center">Target</th><th class="p-4 text-center">Actual Score</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada measures.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-rose-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-rose-300 font-bold text-xs uppercase mb-2">Komitmen Minggu Ini</h4>
                        <p class="text-slate-400 text-sm italic">"${p.wigCommitment || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Cadence of Accountability</h3>
                        <ul class="space-y-4">
                            <li class="flex flex-col gap-1 text-xs"><span class="text-slate-500">Jadwal WIG Session</span><span class="text-white font-medium">${p.wigSession || '-'}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
    }
    function addSubV2MOM() {
        const method = document.getElementById('v2SubMethod').value;
        if(!method) return alert("Method wajib diisi!");

        const newSub = {
            id: generateId(),
            method: method,
            obstacle: document.getElementById('v2SubObstacle').value || '-',
            measure: document.getElementById('v2SubMeasure').value || '-',
            status: document.getElementById('v2SubStatus').value
        };

        tempSubV2MOMs.push(newSub);
        renderSubV2MOMTable();
        
        // Reset Inputs
        document.getElementById('v2SubMethod').value = '';
        document.getElementById('v2SubObstacle').value = '';
        document.getElementById('v2SubMeasure').value = '';
    }

    function removeSubV2MOM(id) {
        tempSubV2MOMs = tempSubV2MOMs.filter(s => s.id !== id);
        renderSubV2MOMTable();
    }

    function renderSubV2MOMTable() {
        const tbody = document.getElementById('v2SubListBody');
        const emptyDiv = document.getElementById('v2SubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubV2MOMs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubV2MOMs.forEach(s => {
                // Warna Status
                let statusBadge = 'text-slate-400';
                if(s.status === 'On Track') statusBadge = 'text-sky-400 font-bold';
                else if(s.status === 'Blocked') statusBadge = 'text-rose-400 font-bold';
                else if(s.status === 'Done') statusBadge = 'text-emerald-400 font-bold';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.method}</td>
                    <td class="p-3 text-xs text-rose-300 align-top">${s.obstacle}</td>
                    <td class="p-3 text-xs text-emerald-300 font-mono align-top">${s.measure}</td>
                    <td class="p-3 text-center text-xs ${statusBadge} align-top">${s.status}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubV2MOM('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // --- INTEGRASI POPULATE & SAVE ---

    function populateV2MOMForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('v2Vision', p.v2Vision); setVal('v2Values', p.v2Values);
        setVal('v2Year', p.v2Year); setVal('v2Status', p.status); 
        setVal('v2Owner', p.v2Owner); setVal('v2Dept', p.v2Dept);
        setVal('v2DocLink', p.v2DocLink); setVal('v2Image', p.image);

        tempSubV2MOMs = p.subV2MOMs || [];
        renderSubV2MOMTable();
    }

    function getV2MOMFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="V2MOM">

            <div class="space-y-4">
                <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Vision & Values</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Vision (Visi Besar) *</label>
                        <input type="text" id="v2Vision" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Apa yang ingin Anda capai? (Contoh: Menjadi #1 CRM Platform)">
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-xs text-sky-300 mb-1">Values (Nilai Inti)</label>
                        <textarea id="v2Values" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Prinsip apa yang memandu kita? (Trust, Growth, Innovation...)"></textarea>
                    </div>

                    <div><label class="block text-xs text-slate-400 mb-1">Tahun Fiskal</label><input type="text" id="v2Year" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="FY26"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Penyelarasan</label>
                        <select id="v2Status" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Aligned">Aligned (Selaras)</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Achieved">Achieved</option>
                        </select>
                    </div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Owner (Pemilik V2MOM)</label><input type="text" id="v2Owner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Departemen</label><input type="text" id="v2Dept" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest">B. Execution Plan (M-O-M)</h3>
                    <span class="text-[10px] text-slate-500 italic">Cara, Hambatan, dan Ukuran</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-sky-300 mb-1">Method (Cara Mencapai Visi)</label><input type="text" id="v2SubMethod" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Tindakan spesifik..."></div>
                    
                    <div class="md:col-span-6"><label class="block text-[10px] text-rose-400 mb-1">Obstacle (Hambatan Potensial)</label><input type="text" id="v2SubObstacle" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Apa yang menghalangi?"></div>
                    <div class="md:col-span-6"><label class="block text-[10px] text-emerald-400 mb-1">Measure (Ukuran Sukses/KPI)</label><input type="text" id="v2SubMeasure" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Bagaimana kita tahu berhasil?"></div>
                    
                    <div class="md:col-span-4">
                        <label class="block text-[10px] text-slate-400 mb-1">Status Item</label>
                        <select id="v2SubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="On Track">On Track</option>
                            <option value="Blocked">Blocked</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubV2MOM()" class="md:col-span-8 bg-sky-600 hover:bg-sky-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-sky-500/20 mt-5 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Method
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-sky-900/30 text-sky-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Method</th>
                                <th class="p-3 border-b border-white/10">Obstacle</th>
                                <th class="p-3 border-b border-white/10">Measure</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="v2SubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="v2SubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada method.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Referensi</label><input type="text" id="v2DocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="v2Image" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>
        </form>
        `;
    }
function createV2MOMCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.v2Image; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        const methodCount = (p.subV2MOMs || []).length;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-sky-400 shadow-lg tracking-wider border border-sky-300 shadow-sky-500/20">V2MOM</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-sky-400 font-bold uppercase tracking-wider border border-sky-500/30 px-2 py-0.5 rounded bg-sky-500/10">
                        ${p.v2Year || 'FY-??'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-sky-300 transition-colors tracking-tight">${p.v2Vision}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.v2Values || 'Values belum didefinisikan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.v2Owner ? p.v2Owner.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Owner</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.v2Owner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-sky-200 bg-sky-500/10 px-3 py-1.5 rounded-lg border border-sky-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        ${methodCount} Methods
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getV2MOMDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.v2Image;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subV2MOMs || []).map(s => {
            let statusBadge = 'text-slate-400';
            if(s.status === 'On Track') statusBadge = 'text-sky-400 font-bold';
            else if(s.status === 'Blocked') statusBadge = 'text-rose-400 font-bold';
            else if(s.status === 'Done') statusBadge = 'text-emerald-400 font-bold';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-white font-medium align-top leading-relaxed w-1/3">${s.method}</td>
                <td class="p-4 text-sm text-rose-300 align-top w-1/4">${s.obstacle}</td>
                <td class="p-4 text-sm text-emerald-300 font-mono align-top w-1/4">${s.measure}</td>
                <td class="p-4 text-center text-xs ${statusBadge} align-top">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-sky-600 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-sky-200 text-[10px] uppercase tracking-widest border border-sky-500/30">V2MOM</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.v2Year || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.v2Vision}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-sky-500"></i> Owner: ${p.v2Owner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-building text-sky-500"></i> Dept: ${p.v2Dept || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-sky-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-heart"></i> Values (Nilai Inti)</h4>
                        <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-line">${p.v2Values || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-sky-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> Execution Plan (Method, Obstacle, Measure)</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-sky-900/20 text-sky-200 text-[10px] uppercase font-bold"><tr><th class="p-4">Method (Cara)</th><th class="p-4">Obstacle (Hambatan)</th><th class="p-4">Measure (Ukuran)</th><th class="p-4 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada method.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.v2DocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-sky-500/50 hover:bg-sky-500/10 transition text-xs text-sky-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-link group-hover:scale-110 transition"></i> Link Referensi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    function populateMBOForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('mboCorpObj', p.mboCorpObj); setVal('mboYear', p.mboYear);
        setVal('mboCode', p.mboCode); setVal('mboReviewer', p.mboReviewer); 
        setVal('mboEmployee', p.mboEmployee); setVal('mboStatus', p.status); 
        setVal('mboPeriod', p.mboPeriod);
        setVal('mboDocLink', p.mboDocLink); setVal('mboImage', p.image);
        setVal('mboNotes', p.mboNotes);

        tempSubMBOs = p.subMBOs || [];
        renderSubMBOTable();
    }
function createMBOCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.mboImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Hitung Rata-rata Progress (Achievement Rate)
        let totalProgress = 0;
        let count = 0;
        if(p.subMBOs && p.subMBOs.length > 0) {
            count = p.subMBOs.length;
            p.subMBOs.forEach(s => {
                totalProgress += parseFloat(s.progress || 0);
            });
        }
        const avgRate = count > 0 ? Math.round(totalProgress / count) : 0;

        // Tentukan warna badge footer berdasarkan achievement
        let footerBadgeColor = 'text-slate-400 border-slate-500/30 bg-slate-500/10';
        if (avgRate >= 80) footerBadgeColor = 'text-emerald-400 border-emerald-500/50 bg-emerald-500/10';
        else if (avgRate >= 50) footerBadgeColor = 'text-yellow-400 border-yellow-500/50 bg-yellow-500/10';
        else if (avgRate > 0) footerBadgeColor = 'text-red-400 border-red-500/50 bg-red-500/10';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-slate-600 shadow-lg tracking-wider border border-slate-500 shadow-slate-500/20">MBO</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider border border-slate-500/30 px-2 py-0.5 rounded bg-slate-500/10">
                        FY-${p.mboYear || '????'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-slate-300 transition-colors tracking-tight">${p.mboCorpObj}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.mboNotes || 'Belum ada deskripsi penyelarasan tujuan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.mboReviewer ? p.mboReviewer.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Manager</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.mboReviewer || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold px-3 py-1.5 rounded-lg border uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0 ${footerBadgeColor}">
                        <i class="fa-solid fa-chart-pie text-[9px]"></i> ${avgRate}% Achieved
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getMBODetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.mboImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subMBOs || []).map(s => {
            let resultBadge = 'text-slate-400';
            if(s.result === 'Met') resultBadge = 'text-blue-400 font-bold';
            else if(s.result === 'Exceeded') resultBadge = 'text-emerald-400 font-bold';
            else if(s.result === 'Missed') resultBadge = 'text-red-400 font-bold';

            const dateDisplay = s.deadline !== '-' ? new Date(s.deadline).toLocaleDateString('id-ID') : '-';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.obj}</td>
                <td class="p-4 text-sm text-slate-300 align-top">${s.std}</td>
                <td class="p-4 text-center text-sm text-slate-400 font-mono align-top">${dateDisplay}</td>
                <td class="p-4 text-center text-xs ${resultBadge} align-top">${s.result}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-slate-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-200 text-[10px] uppercase tracking-widest border border-slate-500/30">MBO</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.mboCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.mboCorpObj}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-slate-400"></i> Reviewer: ${p.mboReviewer || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-building text-slate-400"></i> Fiscal Year: ${p.mboYear || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-slate-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-arrow-down-long"></i> Cascading Context</h4>
                        <div class="grid grid-cols-1 gap-4 text-sm">
                            <div class="flex justify-between border-b border-white/5 pb-2">
                                <span class="text-slate-500">Corporate Objective</span>
                                <span class="text-white font-medium text-right">${p.mboCorpObj}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-500">Assignee (Employee)</span>
                                <span class="text-slate-300 text-right">${p.mboEmployee || '-'}</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-slate-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> Individual Objectives</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-slate-700/50 text-slate-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/3">Objective</th><th class="p-4">Standar Evaluasi</th><th class="p-4 text-center">Deadline</th><th class="p-4 text-center">Hasil Review</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada objective.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-slate-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-slate-300 font-bold text-xs uppercase mb-2">Catatan Manager</h4>
                        <p class="text-slate-400 text-sm italic">"${p.mboNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi MBO</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Periode</span><div class="text-right"><div class="text-white">${p.mboPeriod}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.mboDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-slate-500/50 hover:bg-slate-500/10 transition text-xs text-slate-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-contract group-hover:scale-110 transition"></i> Dokumen Kontrak</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }   
    function createCSFCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.csfImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Count Critical Factors
        const critCount = (p.subCSFs || []).filter(s => s.status === 'Critical').length;
        const totalCount = (p.subCSFs || []).length;

        // Visual alert for critical
        let alertIcon = '';
        if(critCount > 0) alertIcon = `<div class="absolute top-3 right-16 w-8 h-8 rounded-full bg-red-600 animate-pulse flex items-center justify-center text-white shadow-[0_0_15px_rgba(220,38,38,0.7)] z-20"><i class="fa-solid fa-triangle-exclamation text-xs"></i></div>`;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                ${alertIcon}

                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-amber-400 shadow-lg tracking-wider border border-amber-300 shadow-amber-500/20">CSF</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2 flex gap-2">
                    <span class="text-[9px] text-amber-400 font-bold uppercase tracking-wider border border-amber-500/30 px-2 py-0.5 rounded bg-amber-500/10">
                        ${p.csfUrgency || 'Normal'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-amber-300 transition-colors tracking-tight">${p.csfGoal}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.csfMission || 'Tidak ada misi terkait.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.csfOwner ? p.csfOwner.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">PIC</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.csfOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold ${critCount > 0 ? 'text-red-400 bg-red-500/10 border-red-500/20' : 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20'} px-3 py-1.5 rounded-lg border uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        ${critCount} Critical / ${totalCount}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    // --- INTEGRASI POPULATE & SAVE ---
function getCSFDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.csfImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subCSFs || []).map(s => {
            let statusBadge = 'text-slate-400';
            let rowClass = 'hover:bg-white/5';
            if(s.status === 'Safe') statusBadge = 'text-emerald-400 font-bold';
            else if(s.status === 'Critical') {
                statusBadge = 'text-red-500 font-bold uppercase animate-pulse';
                rowClass = 'bg-red-500/5 hover:bg-red-500/10 border-red-500/20';
            }

            return `
            <tr class="border-b border-white/5 transition ${rowClass}">
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.factor}</td>
                <td class="p-4 text-sm text-slate-300 align-top">${s.kpi}</td>
                <td class="p-4 text-center text-sm text-amber-300 font-mono align-top">${s.target}</td>
                <td class="p-4 text-center text-xs ${statusBadge} align-top">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-amber-500 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-amber-200 text-[10px] uppercase tracking-widest border border-amber-500/30">CSF</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.csfCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.csfGoal}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-shield text-amber-500"></i> PIC: ${p.csfOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-amber-500"></i> Urgency: ${p.csfUrgency || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-amber-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-rocket"></i> Misi Terkait</h4>
                        <p class="text-slate-300 text-sm leading-relaxed">${p.csfMission || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-amber-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Key Success Factors</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-amber-900/20 text-amber-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/3">Factor</th><th class="p-4">KPI</th><th class="p-4 text-center">Target</th><th class="p-4 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada faktor.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-amber-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-amber-300 font-bold text-xs uppercase mb-2">Catatan Analisis</h4>
                        <p class="text-slate-400 text-sm italic">"${p.csfNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi CSF</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Periode</span><div class="text-right"><div class="text-amber-300 font-bold">${p.csfPeriod}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.csfDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-amber-500/50 hover:bg-amber-500/10 transition text-xs text-amber-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-shield group-hover:scale-110 transition"></i> Dokumen Strategi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
    function populateKRAForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('kraRole', p.kraRole); setVal('kraCode', p.kraCode);
        setVal('kraPic', p.kraPic); setVal('kraManager', p.kraManager); 
        setVal('kraPeriod', p.kraPeriod); setVal('kraStatus', p.status); 
        setVal('kraPurpose', p.kraPurpose); 
        setVal('kraDocLink', p.kraDocLink); setVal('kraImage', p.image);
        setVal('kraNotes', p.kraNotes);

        tempSubKRAs = p.subKRAs || [];
        renderSubKRATable();
        calculateKRAScore();
    }
    function getKRAFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="KRA">

            <div class="space-y-4">
                <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Detail Jabatan</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Jabatan / Departemen *</label>
                        <input type="text" id="kraRole" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Head of Marketing">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Kode KRA</label><input type="text" id="kraCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="KRA-2026-MKT"></div>
                    
                    <div><label class="block text-xs text-blue-300 mb-1">Penanggung Jawab (PIC)</label><input type="text" id="kraPic" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Atasan Langsung</label><input type="text" id="kraManager" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Periode</label>
                        <select id="kraPeriod" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="FY-2026">FY 2026</option>
                            <option value="H1-2026">H1 2026</option>
                            <option value="H2-2026">H2 2026</option>
                            <option value="Q1-2026">Q1 2026</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Dokumen</label>
                        <select id="kraStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Draft">Draft</option>
                            <option value="Active">Active</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Tujuan Utama Jabatan (Role Purpose)</label><textarea id="kraPurpose" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Ringkasan tujuan keberadaan jabatan ini..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest">B. Key Result Areas (Rincian)</h3>
                    <span class="text-[10px] text-slate-500 italic">Total Bobot harus 100%</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-6"><label class="block text-[10px] text-blue-300 mb-1">Key Task (Tugas Utama)</label><input type="text" id="kraSubTask" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Tugas spesifik..."></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Bobot (%)</label><input type="number" id="kraSubWeight" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="0-100"></div>
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Target Output</label><input type="text" id="kraSubTarget" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Hasil yang diharapkan"></div>
                    
                    <div class="md:col-span-9"><label class="block text-[10px] text-slate-400 mb-1">Ukuran Keberhasilan (KPI/Metrics)</label><input type="text" id="kraSubMetric" class="glass-input w-full px-3 py-2 rounded text-xs"></div>
                    <div class="md:col-span-3"><label class="block text-[10px] text-slate-400 mb-1">Rating (1-5)</label><input type="number" id="kraSubRating" class="glass-input w-full px-3 py-2 rounded text-xs" min="1" max="5" placeholder="Opsional"></div>

                    <button type="button" onclick="addSubKRA()" class="md:col-span-12 bg-blue-600 hover:bg-blue-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Area Kinerja
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-blue-900/30 text-blue-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/4">Key Task</th>
                                <th class="p-3 border-b border-white/10 text-center">Bobot</th>
                                <th class="p-3 border-b border-white/10">Target Output</th>
                                <th class="p-3 border-b border-white/10">KPI / Metric</th>
                                <th class="p-3 border-b border-white/10 text-center">Rating</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="kraSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="kraSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada tugas didefinisikan.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Evaluasi & Dokumen</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-300 font-bold mb-1">Total Bobot (Harus 100%)</label>
                        <input type="text" id="kraTotalWeight" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-white cursor-not-allowed">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Nilai Akhir (Weighted)</label><input type="text" id="kraFinalScore" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-blue-400 cursor-not-allowed"></div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen JD/KPI</label><input type="text" id="kraDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="kraImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Evaluasi</label><textarea id="kraNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
function createKRACard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.kraImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        const score = p.kraFinalScore || '0.0';

        // Tentukan warna badge footer berdasarkan skor
        let footerColor = 'text-blue-200 bg-blue-500/10 border-blue-500/20';
        const numScore = parseFloat(score);
        if(numScore >= 4) footerColor = 'text-emerald-300 bg-emerald-500/10 border-emerald-500/20'; // Skala 1-5 asumsi
        else if(numScore >= 3) footerColor = 'text-blue-300 bg-blue-500/10 border-blue-500/20';
        else footerColor = 'text-yellow-300 bg-yellow-500/10 border-yellow-500/20';

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-blue-600 shadow-lg tracking-wider border border-blue-500 shadow-blue-500/20">KRA</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-blue-400 font-bold uppercase tracking-wider border border-blue-500/30 px-2 py-0.5 rounded bg-blue-500/10">
                        ${p.kraPeriod || 'Period?'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-blue-300 transition-colors tracking-tight">${p.kraRole}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.kraPurpose || 'Belum ada deskripsi tanggung jawab utama.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.kraPic ? p.kraPic.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">PIC</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.kraPic || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold px-3 py-1.5 rounded-lg border uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0 ${footerColor}">
                        <i class="fa-solid fa-star text-[9px]"></i> Score: ${score}
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getKRADetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.kraImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;
        const score = p.kraFinalScore || '0.0';

        const subRows = (p.subKRAs || []).map(s => {
            let ratingDisplay = '-';
            if(s.rating > 0) {
                let starColor = s.rating >= 4 ? 'text-blue-400' : 'text-slate-400';
                ratingDisplay = `<span class="font-bold ${starColor} text-sm">${s.rating}</span>`;
            }

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.task}</td>
                <td class="p-4 text-center text-sm text-blue-300 font-bold align-top">${s.weight}%</td>
                <td class="p-4 text-sm text-slate-300 align-top">${s.target}</td>
                <td class="p-4 text-sm text-slate-400 italic align-top">${s.metric}</td>
                <td class="p-4 text-center align-top">${ratingDisplay}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-blue-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-blue-200 text-[10px] uppercase tracking-widest border border-blue-500/30">KRA</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.kraCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.kraRole}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-check text-blue-500"></i> PIC: ${p.kraPic || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-sitemap text-blue-500"></i> Manager: ${p.kraManager || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Total Bobot</span>
                            <span class="text-xl font-bold ${p.kraTotalWeight == 100 ? 'text-emerald-400' : 'text-red-400'}">${p.kraTotalWeight || 0}%</span>
                        </div>
                        <div class="p-5 bg-[#161b2e] rounded-2xl border border-white/5 relative overflow-hidden">
                            <span class="text-[10px] text-slate-500 uppercase block mb-1">Skor Kinerja</span>
                            <span class="text-2xl font-bold text-blue-400 font-mono">${score}</span>
                        </div>
                    </div>

                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-blue-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> Tujuan Jabatan</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.kraPurpose || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-blue-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Key Result Areas</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-blue-900/20 text-blue-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/3">Key Task</th><th class="p-4 text-center">Bobot</th><th class="p-4">Target Output</th><th class="p-4">Metric</th><th class="p-4 text-center">Rating</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada area kinerja.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-blue-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-blue-300 font-bold text-xs uppercase mb-2">Catatan Evaluasi</h4>
                        <p class="text-slate-400 text-sm italic">"${p.kraNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Dokumen</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Periode</span><span class="text-blue-300 text-right font-bold">${p.kraPeriod}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.kraDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-blue-500/50 hover:bg-blue-500/10 transition text-xs text-blue-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-contract group-hover:scale-110 transition"></i> Dokumen KRA/KPI</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
function getPIPFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="PIP">

            <div class="space-y-4">
                <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Detail Karyawan & Masalah</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2 md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1">Nama Karyawan (Under-perform) *</label>
                        <input type="text" id="pipName" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Nama Lengkap">
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">NIK / ID</label><input type="text" id="pipID" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="EMP-XXX"></div>
                    
                    <div><label class="block text-xs text-red-300 mb-1">Supervisor / Manager</label><input type="text" id="pipManager" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Durasi Program</label>
                        <select id="pipDuration" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="30 Hari">30 Hari (Short Term)</option>
                            <option value="60 Hari">60 Hari (Standard)</option>
                            <option value="90 Hari">90 Hari (Long Term)</option>
                        </select>
                    </div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Mulai</label><input type="date" id="pipStart" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tanggal Selesai</label><input type="date" id="pipEnd" class="glass-input w-full p-3 rounded-lg text-sm [color-scheme:dark]"></div>
                    
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Saat Ini</label>
                        <select id="pipStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="Active">Active</option>
                            <option value="Reviewing">Reviewing</option>
                            <option value="Passed">Passed (Lulus)</option>
                            <option value="Failed/Terminated">Failed/Terminated</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-300 font-bold mb-1">Success Rate (Otomatis)</label>
                        <input type="text" id="pipSuccessRate" readonly class="glass-input w-full p-3 rounded-lg text-sm font-bold bg-slate-800 text-red-400 cursor-not-allowed" value="0%">
                    </div>

                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Masalah Utama (Root Cause)</label><textarea id="pipIssue" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Jelaskan area kinerja yang di bawah standar..."></textarea></div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest">B. Ekspektasi & Checkpoints</h3>
                    <span class="text-[10px] text-slate-500 italic">Target perbaikan mingguan/bulanan</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-red-300 mb-1">Ekspektasi Perbaikan (Goal)</label><input type="text" id="pipSubGoal" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Apa yang harus dicapai?"></div>
                    
                    <div class="md:col-span-4"><label class="block text-[10px] text-slate-400 mb-1">Jadwal Checkpoint</label><input type="date" id="pipSubCheckDate" class="glass-input w-full px-3 py-2 rounded text-xs [color-scheme:dark]"></div>
                    <div class="md:col-span-5"><label class="block text-[10px] text-slate-400 mb-1">Hasil Review (Notes)</label><input type="text" id="pipSubNotes" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Catatan progress..."></div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1">Keputusan Checkpoint</label>
                        <select id="pipSubResult" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="Pending">Pending</option>
                            <option value="Met">Met (Tercapai)</option>
                            <option value="Missed">Missed (Gagal)</option>
                            <option value="Partial">Partial</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubPIP()" class="md:col-span-12 bg-red-600 hover:bg-red-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-red-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-list-check mr-1"></i> Tambah Checkpoint
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-red-900/30 text-red-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Ekspektasi / Goal</th>
                                <th class="p-3 border-b border-white/10 text-center">Tgl Checkpoint</th>
                                <th class="p-3 border-b border-white/10">Catatan Review</th>
                                <th class="p-3 border-b border-white/10 text-center">Hasil</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="pipSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="pipSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada checkpoint.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Keputusan Akhir</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-2 bg-red-900/10 p-4 rounded-xl border border-red-500/20">
                         <label class="block text-xs text-red-300 mb-1 font-bold">Rekomendasi Akhir (HR & Manager)</label>
                         <textarea id="pipConclusion" rows="2" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="Apakah karyawan lulus, perpanjang PIP, atau terminasi?"></textarea>
                    </div>
                    <div><label class="block text-xs text-slate-400 mb-1">Link Dokumen Resmi</label><input type="text" id="pipDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="pipImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                </div>
            </div>
        </form>
        `;
    }
    function calculatePIPSuccess() {
        if (tempSubPIPs.length === 0) {
            const el = document.getElementById('pipSuccessRate');
            if(el) el.value = '0%';
            return 0;
        }

        const validItems = tempSubPIPs.filter(s => s.result !== 'Pending');
        if(validItems.length === 0) return 0;

        const metCount = validItems.filter(s => s.result === 'Met').length;
        // Partial dihitung 0.5
        const partialCount = validItems.filter(s => s.result === 'Partial').length;
        
        const rate = Math.round(((metCount + (partialCount * 0.5)) / validItems.length) * 100);
        
        const el = document.getElementById('pipSuccessRate');
        if(el) {
            el.value = rate + '%';
            el.style.color = rate >= 80 ? '#4ade80' : (rate >= 50 ? '#facc15' : '#f87171');
        }
        return rate;
    }
    function addSubPIP() {
        const goal = document.getElementById('pipSubGoal').value;
        const checkDate = document.getElementById('pipSubCheckDate').value;
        
        if(!goal) return alert("Ekspektasi/Goal wajib diisi!");

        const newSub = {
            id: generateId(),
            goal: goal,
            checkDate: checkDate || '-',
            notes: document.getElementById('pipSubNotes').value || '-',
            result: document.getElementById('pipSubResult').value
        };

        tempSubPIPs.push(newSub);
        renderSubPIPTable();
        calculatePIPSuccess();
        
        // Reset Inputs
        document.getElementById('pipSubGoal').value = '';
        document.getElementById('pipSubCheckDate').value = '';
        document.getElementById('pipSubNotes').value = '';
    }
    function removeSubPIP(id) {
        tempSubPIPs = tempSubPIPs.filter(s => s.id !== id);
        renderSubPIPTable();
        calculatePIPSuccess();
    }
    function renderSubPIPTable() {
        const tbody = document.getElementById('pipSubListBody');
        const emptyDiv = document.getElementById('pipSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubPIPs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubPIPs.forEach(s => {
                // Warna Status
                let statusBadge = 'text-slate-400';
                if(s.result === 'Met') statusBadge = 'text-emerald-400 font-bold';
                else if(s.result === 'Missed') statusBadge = 'text-red-500 font-bold';
                else if(s.result === 'Partial') statusBadge = 'text-yellow-400';

                const dateDisplay = s.checkDate !== '-' ? new Date(s.checkDate).toLocaleDateString('id-ID') : '-';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top leading-relaxed">${s.goal}</td>
                    <td class="p-3 text-center text-xs text-slate-400 font-mono align-top">${dateDisplay}</td>
                    <td class="p-3 text-sm text-slate-300 align-top italic">${s.notes}</td>
                    <td class="p-3 text-center text-xs ${statusBadge} align-top uppercase">${s.result}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubPIP('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
    // --- INTEGRASI POPULATE & SAVE ---
    function populatePIPForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('pipName', p.pipName); setVal('pipID', p.pipID);
        setVal('pipManager', p.pipManager); setVal('pipDuration', p.pipDuration); 
        setVal('pipStart', p.pipStart); setVal('pipEnd', p.pipEnd);
        setVal('pipStatus', p.status); setVal('pipIssue', p.pipIssue);
        setVal('pipDocLink', p.pipDocLink); setVal('pipImage', p.image);
        setVal('pipConclusion', p.pipConclusion);

        tempSubPIPs = p.subPIPs || [];
        renderSubPIPTable();
        calculatePIPSuccess();
    }
function getOGSMFormHtml() {
        return `
        <form id="projectForm" class="space-y-8">
            <input type="hidden" id="projectId">
            <input type="hidden" id="pCategory" value="OGSM">

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">A. Objective & Goals</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-slate-400 mb-1">Objective (Tujuan Kualitatif Besar) *</label>
                        <input type="text" id="ogsmObj" class="glass-input w-full p-3 rounded-lg text-sm font-bold text-white" placeholder="Contoh: Menjadi Market Leader Produk Organik di Asia">
                    </div>
                    
                    <div class="col-span-2 md:col-span-2">
                        <label class="block text-xs text-emerald-300 mb-1">Goals (Target Angka Utama)</label>
                        <textarea id="ogsmGoals" rows="2" class="glass-input w-full p-3 rounded-lg text-sm font-mono" placeholder="1. Revenue $50M&#10;2. Market Share 25%"></textarea>
                    </div>

                    <div><label class="block text-xs text-slate-400 mb-1">Kode Strategi</label><input type="text" id="ogsmCode" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="STRAT-2026-01"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Tahun Fiskal</label><input type="number" id="ogsmYear" class="glass-input w-full p-3 rounded-lg text-sm" placeholder="2026"></div>
                    
                    <div><label class="block text-xs text-slate-400 mb-1">Owner (Direktur/VP)</label><input type="text" id="ogsmOwner" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Status Eksekusi</label>
                        <select id="ogsmStatus" class="glass-input w-full p-3 rounded-lg text-sm text-slate-300">
                            <option value="On Track">On Track</option>
                            <option value="Off Track">Off Track</option>
                            <option value="At Risk">At Risk</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="space-y-4 bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest">B. Strategies & Measures</h3>
                    <span class="text-[10px] text-slate-500 italic">Cara mencapai (Strategies) & Alat Ukur (Measures)</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 p-4 bg-black/30 rounded-xl border border-white/5 mb-6">
                    <div class="md:col-span-12"><label class="block text-[10px] text-emerald-300 mb-1">Strategy (How to win)</label><input type="text" id="ogsmSubStrat" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Digitalisasi supply chain..."></div>
                    
                    <div class="md:col-span-5"><label class="block text-[10px] text-slate-400 mb-1">Measure (KPI)</label><input type="text" id="ogsmSubMeasure" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="Misal: Cost Reduction %"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Target</label><input type="text" id="ogsmSubTarget" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="15%"></div>
                    <div class="md:col-span-2"><label class="block text-[10px] text-slate-400 mb-1">Aktual</label><input type="text" id="ogsmSubActual" class="glass-input w-full px-3 py-2 rounded text-xs" placeholder="5%"></div>
                    
                    <div class="md:col-span-3">
                        <label class="block text-[10px] text-slate-400 mb-1">Status Item</label>
                        <select id="ogsmSubStatus" class="glass-input w-full px-3 py-2 rounded text-xs text-slate-300">
                            <option value="On Track">On Track</option>
                            <option value="Action Needed">Action Needed</option>
                            <option value="Done">Done</option>
                        </select>
                    </div>

                    <button type="button" onclick="addSubOGSM()" class="md:col-span-12 bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-emerald-500/20 mt-2 transition-colors">
                        <i class="fa-solid fa-plus mr-1"></i> Tambah Strategi
                    </button>
                </div>

                <div class="overflow-x-auto pb-4 custom-scrollbar">
                    <table class="w-full text-left text-xs text-slate-300 min-w-[900px]">
                        <thead class="bg-emerald-900/30 text-emerald-100 uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-3 border-b border-white/10 w-1/3">Strategy</th>
                                <th class="p-3 border-b border-white/10">Measure</th>
                                <th class="p-3 border-b border-white/10 text-center">Target</th>
                                <th class="p-3 border-b border-white/10 text-center">Actual</th>
                                <th class="p-3 border-b border-white/10 text-center">Status</th>
                                <th class="p-3 border-b border-white/10 text-right sticky right-0 bg-[#1e2336]">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="ogsmSubListBody" class="divide-y divide-white/5"></tbody>
                    </table>
                    <div id="ogsmSubEmpty" class="py-4 text-center text-slate-500 text-xs italic">Belum ada strategi.</div>
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest border-b border-white/10 pb-2">C. Dokumentasi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-400 mb-1">Link Deck Presentasi</label><input type="text" id="ogsmDocLink" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div><label class="block text-xs text-slate-400 mb-1">Cover Image</label><input type="text" id="ogsmImage" class="glass-input w-full p-3 rounded-lg text-sm"></div>
                    <div class="col-span-2"><label class="block text-xs text-slate-400 mb-1">Catatan Eksekutif</label><textarea id="ogsmNotes" rows="2" class="glass-input w-full p-3 rounded-lg text-sm"></textarea></div>
                </div>
            </div>
        </form>
        `;
    }
// --- LOGIKA OGSM FRAMEWORK ---
    function addSubOGSM() {
        const strat = document.getElementById('ogsmSubStrat').value;
        const measure = document.getElementById('ogsmSubMeasure').value;
        
        if(!strat) return alert("Strategy wajib diisi!");

        const newSub = {
            id: generateId(),
            strat: strat,
            measure: measure || '-',
            target: document.getElementById('ogsmSubTarget').value || '-',
            actual: document.getElementById('ogsmSubActual').value || '-',
            status: document.getElementById('ogsmSubStatus').value
        };

        tempSubOGSMs.push(newSub);
        renderSubOGSMTable();
        
        // Reset Inputs
        document.getElementById('ogsmSubStrat').value = '';
        document.getElementById('ogsmSubMeasure').value = '';
        document.getElementById('ogsmSubTarget').value = '';
        document.getElementById('ogsmSubActual').value = '';
    }
    function removeSubOGSM(id) {
        tempSubOGSMs = tempSubOGSMs.filter(s => s.id !== id);
        renderSubOGSMTable();
    }
    function renderSubOGSMTable() {
        const tbody = document.getElementById('ogsmSubListBody');
        const emptyDiv = document.getElementById('ogsmSubEmpty');
        if(!tbody) return;
        tbody.innerHTML = '';
        
        if(tempSubOGSMs.length === 0) {
            emptyDiv.style.display = 'block';
        } else {
            emptyDiv.style.display = 'none';
            tempSubOGSMs.forEach(s => {
                // Warna Status Item
                let statusBadge = 'text-slate-400';
                if(s.status === 'On Track') statusBadge = 'text-emerald-400 font-bold';
                else if(s.status === 'Action Needed') statusBadge = 'text-red-400 font-bold';
                else if(s.status === 'Done') statusBadge = 'text-blue-400 font-bold';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5 hover:bg-white/5 transition';
                tr.innerHTML = `
                    <td class="p-3 text-white font-medium align-top">${s.strat}</td>
                    <td class="p-3 text-xs text-slate-300 align-top">${s.measure}</td>
                    <td class="p-3 text-center text-xs text-emerald-300 font-mono align-top">${s.target}</td>
                    <td class="p-3 text-center text-xs text-white font-mono align-top">${s.actual}</td>
                    <td class="p-3 text-center text-xs ${statusBadge} align-top">${s.status}</td>
                    <td class="p-3 text-right sticky right-0 bg-[#1e1b2e] border-b border-white/10 align-top">
                        <button onclick="removeSubOGSM('${s.id}')" class="w-7 h-7 rounded-lg bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white transition flex items-center justify-center ml-auto"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }
    // --- INTEGRASI POPULATE & SAVE ---
    function populateOGSMForm(p) {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
        setVal('ogsmObj', p.ogsmObj); setVal('ogsmGoals', p.ogsmGoals);
        setVal('ogsmCode', p.ogsmCode); setVal('ogsmYear', p.ogsmYear); 
        setVal('ogsmOwner', p.ogsmOwner); setVal('ogsmStatus', p.status); 
        setVal('ogsmDocLink', p.ogsmDocLink); setVal('ogsmImage', p.image);
        setVal('ogsmNotes', p.ogsmNotes);

        tempSubOGSMs = p.subOGSMs || [];
        renderSubOGSMTable();
    }
function createOGSMCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.ogsmImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/500/300`;
        const statusClass = getStatusColor(p.status);
        
        // Count Strategies
        const stratCount = (p.subOGSMs || []).length;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100" onerror="this.src='https://picsum.photos/seed/${p.id}/500/300'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass}">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-black uppercase rounded bg-emerald-400 shadow-lg tracking-wider border border-emerald-300 shadow-emerald-500/20">OGSM</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-emerald-400 font-bold uppercase tracking-wider border border-emerald-500/30 px-2 py-0.5 rounded bg-emerald-500/10">
                        ${p.ogsmYear || 'FY-???'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-3 truncate group-hover:text-emerald-300 transition-colors tracking-tight">${p.ogsmObj}</h3>
                
                <p class="text-sm text-slate-400 line-clamp-3 leading-relaxed mb-6 min-h-[4.5rem]">
                    ${p.ogsmGoals || 'Belum ada goals didefinisikan.'}
                </p>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-sm text-white border border-white/10 shadow-inner shrink-0">
                            ${p.ogsmOwner ? p.ogsmOwner.charAt(0).toUpperCase() : '?'}
                        </div>
                        <div class="flex flex-col justify-center">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wider font-bold mb-0.5">Owner</span>
                            <span class="text-sm text-slate-200 truncate w-24 font-medium leading-tight">${p.ogsmOwner || '-'}</span>
                        </div>
                    </div>
                    
                    <div class="text-[10px] font-bold text-emerald-200 bg-emerald-500/10 px-3 py-1.5 rounded-lg border border-emerald-500/20 uppercase tracking-wider shadow-sm flex items-center gap-1 shrink-0">
                        ${stratCount} Strategies
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getOGSMDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.ogsmImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://picsum.photos/seed/${p.id}/1200/600`;

        const subRows = (p.subOGSMs || []).map(s => {
            let statusBadge = 'text-slate-400';
            if(s.status === 'On Track') statusBadge = 'text-emerald-400 font-bold';
            else if(s.status === 'Action Needed') statusBadge = 'text-red-400 font-bold';

            return `
            <tr class="border-b border-white/5 hover:bg-white/5 transition">
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.strat}</td>
                <td class="p-4 text-sm text-slate-300 align-top">${s.measure}</td>
                <td class="p-4 text-center text-sm text-emerald-300 font-mono align-top">${s.target}</td>
                <td class="p-4 text-center text-sm text-white font-mono align-top">${s.actual}</td>
                <td class="p-4 text-center text-xs ${statusBadge} align-top">${s.status}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://picsum.photos/seed/${p.id}/1200/600'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-emerald-600 text-black text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-emerald-200 text-[10px] uppercase tracking-widest border border-emerald-500/30">OGSM</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.ogsmCode || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-4 drop-shadow-2xl">${p.ogsmObj}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-emerald-500"></i> Owner: ${p.ogsmOwner || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-calendar-check text-emerald-500"></i> Fiscal Year: ${p.ogsmYear || '-'}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-emerald-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> Key Goals</h4>
                        <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-line font-mono">${p.ogsmGoals || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-emerald-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-chess"></i> Execution Plan (Strategies & Measures)</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-emerald-900/20 text-emerald-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/3">Strategies</th><th class="p-4">Measures</th><th class="p-4 text-center">Target</th><th class="p-4 text-center">Actual</th><th class="p-4 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="5" class="p-4 text-center italic text-slate-500 text-xs">Belum ada strategi.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-emerald-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-emerald-300 font-bold text-xs uppercase mb-2">Executive Notes</h4>
                        <p class="text-slate-400 text-sm italic">"${p.ogsmNotes || '-'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Informasi Strategis</h3>
                        <ul class="space-y-4">
                            <li class="flex justify-between text-xs"><span class="text-slate-500">Status</span><span class="text-white font-bold px-2 py-0.5 rounded bg-slate-700">${p.status}</span></li>
                            <li class="flex justify-between items-start text-xs pt-2 border-t border-white/5"><span class="text-slate-500 mt-1">Dibuat Pada</span><div class="text-right"><div class="text-white">${formatDate(p.createdAt)}</div></div></li>
                        </ul>
                    </div>

                    <div class="space-y-3">
                         <a href="${p.ogsmDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-emerald-500/50 hover:bg-emerald-500/10 transition text-xs text-emerald-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-presentation-screen group-hover:scale-110 transition"></i> Deck Presentasi</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    </div>
                </div>
            </div>
        `;
    }
function createPIPCard(p) {
        const div = document.createElement('div');
        div.className = 'glass-card rounded-2xl overflow-hidden cursor-pointer flex flex-col group h-full relative transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_rgba(0,0,0,0.5)] border border-white/5';
        div.onclick = () => openDetail(p.id);

        const rawImg = p.image || p.pipImage; 
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.pipName)}&background=7f1d1d&color=fff&size=500`;
        const statusClass = getStatusColor(p.status);
        const rate = p.pipSuccessRate || 0;

        // Visual alert
        let alertIcon = '';
        if(p.status === 'Active') alertIcon = `<div class="absolute top-3 right-16 px-2 py-1 rounded bg-red-600/80 text-white text-[10px] font-bold border border-red-400/50 animate-pulse">ACTION REQ</div>`;

        div.innerHTML = `
            <div class="h-48 overflow-hidden relative shrink-0">
                <img src="${img}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-transparent to-black/30"></div>
                ${alertIcon}
                
                <div class="absolute top-3 left-3 flex gap-2 z-20">
                    <button onclick="quickDuplicate('${p.id}', event)" class="w-8 h-8 rounded-lg bg-black/40 hover:bg-white/20 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-copy text-xs"></i></button>
                    <button onclick="quickDelete('${p.id}', event)" class="w-8 h-8 rounded-lg bg-red-500/60 hover:bg-red-500/80 backdrop-blur-md border border-white/20 text-white flex items-center justify-center transition shadow-lg hover:scale-105"><i class="fa-solid fa-trash text-xs"></i></button>
                </div>

                <div class="absolute top-3 right-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded-lg border border-white/10 backdrop-blur-md shadow-lg ${statusClass} z-20">${p.status}</div>
                <div class="absolute bottom-3 left-3 px-3 py-1 text-[10px] font-bold text-white uppercase rounded bg-red-600 shadow-lg tracking-wider border border-red-500 shadow-red-500/20 z-20">PIP</div>
            </div>

            <div class="p-6 flex-1 flex flex-col relative z-10 bg-[#0f172a]/60 backdrop-blur-sm">
                <div class="mb-2">
                    <span class="text-[9px] text-red-400 font-bold uppercase tracking-wider border border-red-500/30 px-2 py-0.5 rounded bg-red-500/10">
                        ${p.pipDuration || 'Duration?'}
                    </span>
                </div>
                
                <h3 class="font-bold text-white text-xl mb-1 truncate group-hover:text-red-300 transition-colors tracking-tight">${p.pipName}</h3>
                <p class="text-xs text-slate-400 mb-4 truncate">${p.pipManager ? 'Mgr: ' + p.pipManager : '-'}</p>
                
                <div class="mb-4">
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-xs text-slate-400">Success Rate</span>
                        <span class="text-2xl font-bold text-white font-mono leading-none">${rate}%</span>
                    </div>
                    <div class="w-full bg-slate-700/50 h-1.5 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-red-500 to-orange-500 shadow-[0_0_10px_currentColor]" style="width: ${rate}%"></div>
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-2 text-xs text-red-400">
                        <i class="fa-solid fa-flag-checkered"></i>
                        <span>End: ${p.pipEnd ? new Date(p.pipEnd).toLocaleDateString('id-ID') : '-'}</span>
                    </div>
                </div>
            </div>
        `;
        return div;
    }
    function getPIPDetailHtml(p) {
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
        const rawImg = p.image || p.pipImage;
        const img = (rawImg && rawImg !== 'undefined') ? rawImg : `https://ui-avatars.com/api/?name=${encodeURIComponent(p.pipName)}&background=7f1d1d&color=fff&size=800`;
        const rate = p.pipSuccessRate || 0;

        const subRows = (p.subPIPs || []).map(s => {
            let statusBadge = 'text-slate-400';
            let rowClass = 'hover:bg-white/5';
            if(s.result === 'Met') {
                statusBadge = 'text-emerald-400 font-bold';
            } else if(s.result === 'Missed') {
                statusBadge = 'text-red-500 font-bold';
                rowClass = 'bg-red-500/5 hover:bg-red-500/10';
            } else if(s.result === 'Partial') {
                statusBadge = 'text-yellow-400 font-bold';
            }

            const dateDisplay = s.checkDate !== '-' ? new Date(s.checkDate).toLocaleDateString('id-ID') : '-';

            return `
            <tr class="border-b border-white/5 transition ${rowClass}">
                <td class="p-4 text-white font-medium align-top leading-relaxed">${s.goal}</td>
                <td class="p-4 text-center text-sm text-slate-400 font-mono align-top">${dateDisplay}</td>
                <td class="p-4 text-sm text-slate-300 align-top italic">${s.notes}</td>
                <td class="p-4 text-center text-xs ${statusBadge} align-top uppercase">${s.result}</td>
            </tr>`;
        }).join('');

        return `
            <div class="relative w-full h-80 shrink-0">
                <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.pipName)}&background=7f1d1d&color=fff&size=800'">
                <div class="absolute inset-0 bg-gradient-to-t from-[#0f172a] via-[#0f172a]/90 to-transparent"></div>
                <div class="absolute bottom-0 left-0 w-full p-8 md:p-10 z-10">
                    <div class="flex flex-wrap gap-3 mb-4">
                         <span class="px-3 py-1 rounded-lg bg-red-600 text-white text-[10px] font-bold uppercase tracking-widest shadow-lg">${p.status}</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-red-200 text-[10px] uppercase tracking-widest border border-red-500/30">PIP</span>
                         <span class="px-3 py-1 rounded-lg bg-white/10 border border-white/10 text-slate-300 text-[10px] uppercase tracking-widest">${p.pipDuration || '-'}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight mb-2 drop-shadow-2xl">${p.pipName}</h1>
                    <div class="flex items-center gap-6 text-sm text-slate-300">
                        <span class="flex items-center gap-2"><i class="fa-solid fa-user-tie text-red-500"></i> Mgr: ${p.pipManager || '-'}</span>
                        <span class="flex items-center gap-2"><i class="fa-solid fa-hourglass-end text-red-500"></i> Ends: ${formatDate(p.pipEnd)}</span>
                    </div>
                </div>
            </div>

            <div class="p-8 md:p-10 grid grid-cols-1 lg:grid-cols-3 gap-8 bg-[#0f172a]">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-[#1e293b]/40 border border-white/5 p-6 rounded-2xl">
                        <h4 class="text-red-400 font-bold text-xs uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Masalah Utama (Root Cause)</h4>
                        <p class="text-slate-300 text-sm leading-relaxed text-justify">${p.pipIssue || '-'}</p>
                    </div>

                    <div>
                        <h3 class="text-red-400 font-bold uppercase text-xs tracking-widest mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> Checkpoints Progress</h3>
                        <div class="overflow-x-auto rounded-xl border border-white/10 bg-[#161b2e]">
                             <table class="w-full text-left text-sm min-w-[800px]"><thead class="bg-red-900/20 text-red-200 text-[10px] uppercase font-bold"><tr><th class="p-4 w-1/3">Ekspektasi</th><th class="p-4 text-center">Tanggal Cek</th><th class="p-4">Hasil Review</th><th class="p-4 text-center">Status</th></tr></thead><tbody class="divide-y divide-white/5">${subRows || '<tr><td colspan="4" class="p-4 text-center italic text-slate-500 text-xs">Belum ada checkpoint.</td></tr>'}</tbody></table>
                        </div>
                    </div>
                    
                    <div class="bg-[#1e1b2e] border border-l-4 border-l-red-500 border-white/5 p-6 rounded-r-2xl">
                        <h4 class="text-red-300 font-bold text-xs uppercase mb-2">Keputusan Akhir</h4>
                        <p class="text-slate-400 text-sm italic">"${p.pipConclusion || 'Belum ada keputusan.'}"</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6 relative overflow-hidden text-center">
                        <span class="text-xs text-slate-500 uppercase tracking-widest block mb-2">Checkpoint Success Rate</span>
                        <div class="text-5xl font-bold text-white mb-2">${rate}%</div>
                        <div class="text-xs ${rate>=80?'text-emerald-400':'text-red-400'} font-bold">
                            ${rate >= 80 ? 'ON TRACK' : 'NEEDS ATTENTION'}
                        </div>
                    </div>

                    <div class="bg-[#161b2e] border border-white/5 rounded-2xl p-6">
                        <h3 class="text-white font-bold text-sm mb-4 border-b border-white/5 pb-2">Dokumentasi</h3>
                        <div class="space-y-3">
                             <a href="${p.pipDocLink || '#'}" target="_blank" class="flex items-center justify-between w-full p-3 bg-[#1e293b] border border-white/10 rounded-xl hover:border-red-500/50 hover:bg-red-500/10 transition text-xs text-red-300 group"><span class="flex items-center gap-2"><i class="fa-solid fa-file-contract group-hover:scale-110 transition"></i> Dokumen PIP</span><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    // --- INIT ---
    switchCategory('Dashboard');
    searchInput.addEventListener('input', renderProjects);
    filterInput.addEventListener('change', renderProjects);
    // --- INIT ---
    startTimeWidget(); // Start jam
    switchCategory('Dashboard'); // Load Default
    searchInput.addEventListener('input', renderProjects);
    filterInput.addEventListener('change', renderProjects);
    let tempSubSops = []; 
    let tempSubBSCs = [];
    let tempSubKpis = [];
    let tempSubAgiles = [];
    let tempSubOKRs = [];
    let tempSubBRDs = []; 
    let tempSubRisks = [];
    let tempSubStakeholders = [];
    let tempSubSwots = [];
    let tempSubQCs = [];
    let tempSubProcs = [];
    let tempSubTrainings = [];
    let tempSubRecruits = [];
    let tempSubAppraisals = [];
    let tempSubCRs = [];
    let tempSubOGSMs = [];
    let tempSubKRAs = [];
    let tempSubCSFs = [];
    let tempSubMBOs = [];
    let tempSubV2MOMs = [];
    let tempSubWIGs = [];
    let tempSubMOSTs = [];
    let tempSubKRIs = [];
    let tempSubKCIs = [];
    let tempSubFMEAs = [];
    let tempSubSLAs = [];
    let tempSub5S = [];
    let tempSubSIPOCs = [];
    let tempSubGaps = [];
    let tempSubRICEs = [];
    let tempSubPostMortems = [];
    let tempSubIDPs = [];
    let tempSubPIPs = [];
    let tempSubKPAs = [];
     //
      // Penampung Sub BRD (Requirements)
</script>
</body>
</html>